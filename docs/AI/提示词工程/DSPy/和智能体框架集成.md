# å¦‚ä½•å°† DSPy è®­ç»ƒæ¨¡å‹é›†æˆåˆ° CrewAI/Agno æ™ºèƒ½ä½“æ¡†æ¶

æœ¬æ–‡æ¡£è¯¦ç»†ä»‹ç»äº†åœ¨è·å¾—æ»¡æ„çš„ DSPy è®­ç»ƒç»“æœï¼ˆå³ `litreview_dspy_model.json` æƒé‡æ–‡ä»¶ï¼‰åï¼Œå¦‚ä½•åœ¨ CrewAI æˆ– Agno ç­‰æ™ºèƒ½ä½“æ¡†æ¶ä¸­ä½¿ç”¨è¯¥æ¨¡å‹ã€‚

æˆ‘ä»¬æä¾›äº†ä¸¤ç§ä¸»è¦çš„é›†æˆç­–ç•¥ï¼Œ**å¼ºçƒˆæ¨èæ–¹æ¡ˆä¸€**ã€‚

## æ–¹æ¡ˆä¸€ï¼šå°è£…ä¸ºè‡ªå®šä¹‰å·¥å…· (Custom Tool) - ğŸ”¥ æ¨è

è¿™æ˜¯æœ€ç¬¦åˆè½¯ä»¶å·¥ç¨‹åŸåˆ™çš„æ–¹æ¡ˆã€‚æˆ‘ä»¬å°† DSPy æ¨¡å—å°è£…ä¸ºä¸€ä¸ªç‹¬ç«‹çš„å·¥å…·ï¼ˆToolï¼‰ï¼ŒAgent åƒè°ƒç”¨æ™®é€šå‡½æ•°ä¸€æ ·è°ƒç”¨å®ƒã€‚è¿™ç§æ–¹å¼å®ç°äº†æ¨¡å—è§£è€¦ï¼Œä¸”èƒ½å……åˆ†åˆ©ç”¨ DSPy çš„æ¨ç†èƒ½åŠ›ã€‚

### 1. å®ç°åŸç†

CrewAI çš„ Agent ä¸ç›´æ¥åŒ…å« DSPy çš„æƒé‡ï¼Œè€Œæ˜¯æ‹¥æœ‰ä¸€ä¸ªâ€œå·¥å…·â€ï¼Œè¯¥å·¥å…·å†…éƒ¨åŠ è½½ JSON æƒé‡æ–‡ä»¶å¹¶æ‰§è¡Œæ¨ç†ã€‚

### 2. ä»£ç å®ç°

åœ¨é¡¹ç›®ä¸­åˆ›å»º `tools/litreview_tool.py`ï¼š

```python
from crewai.tools import BaseTool
from pydantic import Field
import dspy
import os

# --- DSPy å®šä¹‰éƒ¨åˆ† (å¿…é¡»ä¸è®­ç»ƒè„šæœ¬ train_litreview_dspy.py ä¿æŒå®Œå…¨ä¸€è‡´) ---

class GenerateLitReview(dspy.Signature):
    """
    æ ¹æ®æä¾›çš„ã€ç›¸å…³æ–‡çŒ®æ‘˜è¦åˆ—è¡¨ã€‘æˆ–ã€è®ºæ–‡æ‘˜è¦ã€‘ï¼Œæ’°å†™ä¸€ä»½é«˜è´¨é‡çš„ä¸­æ–‡æ–‡çŒ®ç»¼è¿°ã€‚
    
    è¦æ±‚ï¼š
    1. å¦‚æœè¾“å…¥åŒ…å«å¤šç¯‡æ–‡çŒ®æ‘˜è¦ï¼Œè¯·ç»¼åˆå½’çº³è¿™äº›æ–‡çŒ®çš„è§‚ç‚¹ã€æ–¹æ³•å’Œç»“è®ºã€‚
    2. ç»“æ„åº”åŒ…å«ï¼šæ ¸å¿ƒæ¦‚å¿µå®šä¹‰ã€ä¸»è¦ç†è®ºåŸºç¡€ã€ç ”ç©¶ç°çŠ¶ï¼ˆåˆ†ç±»ç»¼è¿°ï¼‰ã€ç°æœ‰ç ”ç©¶çš„ä¸è¶³ä¸è¶‹åŠ¿ã€‚
    3. è¯­è¨€å­¦æœ¯è§„èŒƒï¼Œé€»è¾‘ä¸¥å¯†ã€‚
    """
    abstract = dspy.InputField(desc="æ–‡æœ¬å†…å®¹ï¼Œå¯ä»¥æ˜¯å•ç¯‡è®ºæ–‡çš„æ‘˜è¦ï¼Œä¹Ÿå¯ä»¥æ˜¯å¤šç¯‡å‚è€ƒæ–‡çŒ®æ‘˜è¦çš„é›†åˆåˆ—è¡¨ã€‚")
    literature_review = dspy.OutputField(desc="ç”Ÿæˆçš„ä¸­æ–‡æ–‡çŒ®ç»¼è¿°ç« èŠ‚ã€‚")

class LitReviewModule(dspy.Module):
    def __init__(self):
        super().__init__()
        self.generate = dspy.ChainOfThought(GenerateLitReview)
    
    def forward(self, abstract):
        return self.generate(abstract=abstract)

# --- CrewAI å·¥å…·å®šä¹‰éƒ¨åˆ† ---

class LiteratureReviewTool(BaseTool):
    name: str = "Literature Review Generator"
    description: str = (
        "ä¸“é—¨ç”¨äºç”Ÿæˆå­¦æœ¯æ–‡çŒ®ç»¼è¿°çš„å·¥å…·ã€‚è¾“å…¥å¯ä»¥æ˜¯å•ç¯‡æ‘˜è¦ï¼Œä¹Ÿå¯ä»¥æ˜¯å¤šç¯‡æ‘˜è¦çš„åˆ—è¡¨æ–‡æœ¬ã€‚"
        "è¯¥å·¥å…·å†…éƒ¨åŠ è½½äº†ç»è¿‡ä¼˜åŒ–çš„ DSPy æ¨¡å‹ï¼Œèƒ½ç”Ÿæˆç»“æ„ä¸¥è°¨çš„ä¸­æ–‡ç»¼è¿°ã€‚"
    )
    model_path: str = Field(..., description="DSPy JSON æ¨¡å‹æ–‡ä»¶çš„ç›¸å¯¹æˆ–ç»å¯¹è·¯å¾„")

    def _run(self, abstract_content: str) -> str:
        try:
            # 1. ç¯å¢ƒä¸é…ç½®æ£€æŸ¥
            # å»ºè®®åœ¨é¡¹ç›®å…¥å£å¤„ç»Ÿä¸€é…ç½®ï¼Œè¿™é‡Œåšé˜²å¾¡æ€§ç¼–ç¨‹
            from dotenv import load_dotenv
            load_dotenv()
            
            if not dspy.settings.lm:
                # å¦‚æœæ²¡æœ‰å…¨å±€é…ç½®ï¼Œåˆ™åˆå§‹åŒ–ä¸€ä¸ª
                lm = dspy.LM(
                    model="deepseek/deepseek-chat", # æˆ–ä»ç¯å¢ƒå˜é‡è¯»å–
                    api_key=os.getenv("DEEPSEEK_API_KEY"),
                    api_base=os.getenv("DEEPSEEK_BASE_URL"),
                    max_tokens=4000
                )
                dspy.configure(lm=lm)
            
            # 2. å®ä¾‹åŒ–å¹¶åŠ è½½æƒé‡
            module = LitReviewModule()
            
            if os.path.exists(self.model_path):
                # å…³é”®æ­¥éª¤ï¼šåŠ è½½è®­ç»ƒå¥½çš„æƒé‡
                module.load(self.model_path)
            else:
                return f"Error: DSPy model file not found at {self.model_path}"
            
            # 3. æ‰§è¡Œæ¨ç†
            pred = module(abstract=abstract_content)
            
            return pred.literature_review
            
        except Exception as e:
            return f"Error generating review using DSPy tool: {str(e)}"
```

### 3. åœ¨ CrewAI ä¸­è°ƒç”¨

åœ¨ä½ çš„ `main.py` æˆ– `crew.py` ä¸­ï¼š

```python
from crewai import Agent, Task, Crew
from tools.litreview_tool import LiteratureReviewTool

# 1. å®ä¾‹åŒ–å·¥å…·
lit_tool = LiteratureReviewTool(
    model_path="scripts/litreview_dspy_model.json" 
)

# 2. åˆ›å»º Agent
researcher = Agent(
    role='Academic Researcher',
    goal='æ’°å†™é«˜è´¨é‡çš„æ–‡çŒ®ç»¼è¿°',
    backstory='ä½ æ˜¯ä¸€åèµ„æ·±çš„å­¦æœ¯ç ”ç©¶å‘˜ï¼Œæ“…é•¿ä»å¤§é‡æ–‡çŒ®ä¸­æç‚¼è§‚ç‚¹ã€‚',
    tools=[lit_tool],  # å°†å·¥å…·èµ‹äºˆ Agent
    verbose=True
)

# 3. åˆ›å»º Task
task = Task(
    description='è¯·é˜…è¯»ä»¥ä¸‹æ–‡çŒ®æ‘˜è¦åˆ—è¡¨ï¼š\n{abstracts}\n\nä½¿ç”¨ä½ çš„æ–‡çŒ®ç»¼è¿°ç”Ÿæˆå·¥å…·ï¼Œå†™ä¸€ç¯‡å®Œæ•´çš„ç»¼è¿°ã€‚',
    expected_output='ä¸€ç¯‡ç»“æ„å®Œæ•´çš„ä¸­æ–‡æ–‡çŒ®ç»¼è¿°',
    agent=researcher
)

# 4. è¿è¡Œ
crew = Crew(agents=[researcher], tasks=[task])
result = crew.kickoff(inputs={'abstracts': '...è¿™é‡Œä¼ å…¥ä½ çš„æ‘˜è¦æ–‡æœ¬...'
```

---

## æ–¹æ¡ˆäºŒï¼šæå– Prompt (ç¡¬ç¼–ç ) - âš¡ ä»…é™è½»é‡çº§ä½¿ç”¨

å¦‚æœä½ ä¸æƒ³åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä¾èµ– `dspy` åº“ï¼Œæˆ–è€…ä½ éœ€è¦å°† Prompt è¿ç§»åˆ°é Python ç¯å¢ƒï¼Œå¯ä»¥ä½¿ç”¨æ­¤æ–¹æ³•ã€‚

**åŸç†**ï¼šDSPy çš„äº§ç‰© `litreview_dspy_model.json` æœ¬è´¨ä¸ŠåŒ…å«äº†ä¸€ç»„ç»è¿‡ç­›é€‰çš„ Few-Shot Examplesï¼ˆåŒ…å«æ¨ç†è¿‡ç¨‹ CoTï¼‰ã€‚æˆ‘ä»¬å¯ä»¥æŠŠè¿™äº› Prompt æå–å‡ºæ¥ï¼Œç›´æ¥ä½œä¸º Agent çš„ `backstory` æˆ– `system_prompt`ã€‚

### 1. æå– Prompt

åˆ›å»ºä¸€ä¸ªä¸´æ—¶è„šæœ¬ `scripts/inspect_prompt.py`ï¼š

```python
import dspy
from scripts.train_litreview_dspy import setup_dspy, LitReviewModule

lm = setup_dspy()
module = LitReviewModule()
module.load("scripts/litreview_dspy_model.json")

# å¿…é¡»è¿è¡Œä¸€æ¬¡è™šæ‹Ÿæ¨ç†æ‰èƒ½æ„å»ºå®Œæ•´çš„ Prompt
module(abstract="test input")

# è·å–æœ€åä¸€æ¬¡å‘é€ç»™ LLM çš„å®Œæ•´ Prompt
last_prompt = lm.history[-1]
print("=== æŠŠä¸‹é¢çš„å†…å®¹å¤åˆ¶å‡ºæ¥ ===")
if 'messages' in last_prompt:
    for msg in last_prompt['messages']:
        print(f"[{msg['role']}]: {msg['content']}")
else:
    print(last_prompt['prompt'])
```

### 2. ç¡¬ç¼–ç åˆ° Agent

å°†æ‰“å°å‡ºæ¥çš„ Promptï¼ˆé€šå¸¸åŒ…å« `--- Example 1 ---`, `Reasoning: ...` ç­‰å†…å®¹ï¼‰æ•´ç†åï¼Œæ”¾å…¥ Agent å®šä¹‰ä¸­ï¼š

```python
agent = Agent(
    role="Review Writer",
    backstory="""ä½ æ˜¯ä¸€ä¸ªå­¦æœ¯å†™ä½œä¸“å®¶ã€‚
    åœ¨æ’°å†™æ–‡çŒ®ç»¼è¿°æ—¶ï¼Œè¯·ä¸¥æ ¼å‚è€ƒä»¥ä¸‹æ€ç»´è¿‡ç¨‹å’ŒèŒƒä¾‹ï¼š
    
    [è¿™é‡Œç²˜è´´ä½ ä» DSPy æå–å‡ºæ¥çš„ Few-Shot Examples]
    
    ç°åœ¨ï¼Œè¯·ä¸ºæ–°çš„è¾“å…¥æ’°å†™ç»¼è¿°ã€‚
    """
)
```

## æ€»ç»“

| ç‰¹æ€§ | æ–¹æ¡ˆä¸€ (è‡ªå®šä¹‰å·¥å…·) | æ–¹æ¡ˆäºŒ (æå– Prompt) |
| :--- | :--- | :--- |
| **é›†æˆéš¾åº¦** | ä½ (ç›´æ¥å¤ç”¨ä»£ç ) | ä¸­ (éœ€è¦æ‰‹åŠ¨æå–å’Œæ‹¼æ¥å­—ç¬¦ä¸²) |
| **ç»´æŠ¤æ€§** | **é«˜** (é‡æ–°è®­ç»ƒåªéœ€æ›¿æ¢ json æ–‡ä»¶) | ä½ (éœ€æ‰‹åŠ¨æ›´æ–° Prompt å­—ç¬¦ä¸²) |
| **ä¾èµ–æ€§** | éœ€è¦ `dspy` åº“ | æ— éœ€ `dspy` åº“ |
| **æ¨ç†ä¸€è‡´æ€§** | **å®Œå…¨ä¸€è‡´** (å¤ç”¨ DSPy é€»è¾‘) | å¯èƒ½åå·® (å®Œå…¨ä¾èµ– LLM ç†è§£é•¿æ–‡æœ¬) |
| **é€‚ç”¨åœºæ™¯** | **ç”Ÿäº§ç¯å¢ƒã€å¤æ‚æµç¨‹** | ä¸´æ—¶æµ‹è¯•ã€è·¨è¯­è¨€ç¯å¢ƒ |

**å»ºè®®ï¼š** åœ¨ `thesis_crew` é¡¹ç›®ä¸­ï¼Œè¯·ä¼˜å…ˆä½¿ç”¨ **æ–¹æ¡ˆä¸€**ã€‚
