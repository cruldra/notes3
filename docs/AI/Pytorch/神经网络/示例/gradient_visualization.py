import marimo

__generated_with = "0.19.2"
app = marimo.App(width="medium")


@app.cell(hide_code=True)
def _():
    import marimo as mo
    import matplotlib.pyplot as plt
    import numpy as np

    # è§£å†³Matplotlibä¸­æ–‡ä¹±ç é—®é¢˜
    # è®¾ç½®å­—ä½“ä¸ºé»‘ä½“ç­‰å¸¸è§ä¸­æ–‡å­—ä½“
    plt.rcParams['font.sans-serif'] = ['SimHei', 'Microsoft YaHei', 'Arial Unicode MS']
    # è§£å†³è´Ÿå·æ˜¾ç¤ºä¸ºæ–¹å—çš„é—®é¢˜
    plt.rcParams['axes.unicode_minus'] = False
    return mo, np, plt


@app.cell(hide_code=True)
def _(mo):
    mo.md("""
    # ğŸ”ï¸ ä»ä¸‹å±±åˆ°å¤§æ¨¡å‹è®­ç»ƒï¼šç›´è§‚ç†è§£æ¢¯åº¦

    åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆèŠèŠå½“ä¸‹æœ€ç«çš„**å¤§æ¨¡å‹è®­ç»ƒ (LLM Training)**ã€‚

    è®­ç»ƒä¸€ä¸ªç¥ç»ç½‘ç»œï¼ˆæ¯”å¦‚ GPTï¼‰ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ª**å¯»æ‰¾æœ€ä¼˜è§£**çš„è¿‡ç¨‹ã€‚

    *   **æ¨¡å‹å‚æ•° (Weights)**: å¯ä»¥çœ‹ä½œæ˜¯æˆ‘ä»¬åœ¨åœ°å›¾ä¸Šçš„**åæ ‡ä½ç½®**ã€‚
    *   **æŸå¤±å‡½æ•° (Loss Function)**: å¯ä»¥çœ‹ä½œæ˜¯å½“å‰ä½ç½®çš„**æµ·æ‹”é«˜åº¦**ã€‚æŸå¤±è¶Šä½ï¼Œæ¨¡å‹è¡¨ç°è¶Šå¥½ã€‚

    **è®­ç»ƒçš„ç›®æ ‡**ï¼šæ‰¾åˆ°æµ·æ‹”æœ€ä½çš„å±±è°·ï¼ˆæœ€å°åŒ–æŸå¤±ï¼‰ã€‚

    **æ€ä¹ˆæ‰¾ï¼Ÿ** å¦‚æœä½ è¢«è’™ä½åŒçœ¼ç«™åœ¨å±±ä¸Šï¼Œæœ€å¥½çš„åŠæ³•å°±æ˜¯ç”¨è„šæ¢ä¸€æ¢ï¼Œæ„Ÿè§‰å“ªä¸ªæ–¹å‘**ä¸‹å¡æœ€é™¡**ï¼Œå°±å¾€é‚£è¾¹èµ°ä¸€æ­¥ã€‚

    è¿™ä¸ªâ€œä¸‹å¡æœ€é™¡çš„æ–¹å‘â€ï¼Œå°±æ˜¯**è´Ÿæ¢¯åº¦**çš„æ–¹å‘ã€‚è€Œ**æ¢¯åº¦**æœ¬èº«ï¼ŒæŒ‡å‘ä¸Šå¡æœ€é™¡çš„æ–¹å‘ã€‚

    ---
    """)
    return


@app.cell(hide_code=True)
def _(mo):
    mo.md("""
    ## 1. æ–œç‡ (Slope)ï¼šç›´çº¿çš„â€œé™¡å³­ç¨‹åº¦â€

    æ–œç‡æ˜¯ä½ ä¸­å­¦æ•°å­¦å°±æ¥è§¦è¿‡çš„æ¦‚å¿µï¼Œé€šå¸¸ç”¨äºç›´çº¿ã€‚

    *   **ç›´è§‚å®šä¹‰**ï¼šå¦‚æœä½ åœ¨çˆ¬å¡ï¼Œæ–œç‡å°±æ˜¯å¡åº¦ã€‚
    *   **æ•°å­¦å®šä¹‰**ï¼šæ°´å¹³æ¯å‰è¿›ä¸€ä¸ªå•ä½ï¼Œå‚ç›´æ–¹å‘ä¸Šå‡ï¼ˆæˆ–ä¸‹é™ï¼‰äº†å¤šå°‘ã€‚
    *   **å…¬å¼**ï¼š$m = \\frac{\\Delta y}{\\Delta x}$ï¼ˆå‚ç›´å˜åŒ–é‡é™¤ä»¥æ°´å¹³å˜åŒ–é‡ï¼‰ã€‚

    **æ–œç‡çš„å«ä¹‰**ï¼š
    *   **æ­£æ–œç‡** ($m > 0$)ï¼šå¾€å³èµ°ï¼Œé«˜åº¦ä¸Šå‡ (ä¸Šå¡)ã€‚
    *   **è´Ÿæ–œç‡** ($m < 0$)ï¼šå¾€å³èµ°ï¼Œé«˜åº¦ä¸‹é™ (ä¸‹å¡)ã€‚
    *   **é›¶æ–œç‡** ($m = 0$)ï¼šå¹³åœ°ã€‚

    æ‹–åŠ¨ä¸‹é¢çš„æ»‘å—ï¼Œçœ‹çœ‹ä¸åŒæ–œç‡ä¸ä»…æ”¹å˜äº†çº¿çš„é™¡å³­ç¨‹åº¦ï¼Œä¹Ÿæ”¹å˜äº†æ–¹å‘ã€‚
    """)
    return


@app.cell
def _(mo):
    slope_slider = mo.ui.slider(start=-5.0, stop=5.0, step=0.5, value=1.0, label="è°ƒæ•´æ–œç‡ m")
    return slope_slider,


@app.cell
def _(mo, np, plt, slope_slider):
    def plot_linear_slope(m):
        fig, ax = plt.subplots(figsize=(8, 4))
        x = np.linspace(-5, 5, 100)
        y = m * x

        # ç»˜åˆ¶ç›´çº¿
        ax.plot(x, y, color='purple', linewidth=2, label=f'y = {m}x')

        # ç»˜åˆ¶è¾…åŠ©ä¸‰è§’å½¢ (å±•ç¤º dy/dx)
        if m != 0:
            # é€‰æ‹©ä¸€ä¸ªç‚¹ç”»ä¸‰è§’å½¢ï¼Œæ¯”å¦‚ä» x=1 åˆ° x=2
            x0, x1 = 1, 2
            y0, y1 = m * x0, m * x1

            # æ°´å¹³çº¿ dx
            ax.plot([x0, x1], [y0, y0], 'k--', alpha=0.5)
            # å‚ç›´çº¿ dy
            ax.plot([x1, x1], [y0, y1], 'k--', alpha=0.5)

            # æ ‡æ³¨
            ax.text((x0+x1)/2, y0 - 0.5, r'$\Delta x=1$', ha='center', fontsize=10)
            ax.text(x1 + 0.2, (y0+y1)/2, rf'$\Delta y={m}$', va='center', fontsize=10)

        ax.axhline(0, color='black', linewidth=1, alpha=0.3)
        ax.axvline(0, color='black', linewidth=1, alpha=0.3)
        ax.set_xlim(-4, 4)
        ax.set_ylim(-5, 5)
        ax.set_title(f"ç›´çº¿æ–œç‡ m = {m}", fontsize=12)
        ax.grid(True, linestyle='--', alpha=0.3)
        ax.legend()
        return fig

    # è§£é‡Šæ–‡æœ¬
    m_val = slope_slider.value
    if m_val > 0:
        desc = "ğŸ”¥ ä¸Šå¡ (æ­£æ–œç‡)"
    elif m_val < 0:
        desc = "ğŸŒŠ ä¸‹å¡ (è´Ÿæ–œç‡)"
    else:
        desc = "ğŸ˜ å¹³åœ° (é›¶æ–œç‡)"

    mo.vstack([
        slope_slider,
        mo.md(f"### {desc}"),
        plot_linear_slope(m_val)
    ])
    return


@app.cell(hide_code=True)
def _(mo):
    mo.md("""
    ### ğŸ’¡ é‚£ä¸ªä¸‰è§’å½¢ $\Delta$ æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ

    è¿™ä¸ªä¸‰è§’å½¢ç¬¦å·æ˜¯å¸Œè…Šå­—æ¯ **$\Delta$ (Delta)**ã€‚åœ¨æ•°å­¦ã€ç‰©ç†å’Œè®¡ç®—æœºç§‘å­¦ä¸­ï¼Œå®ƒé€šå¸¸ä»£è¡¨ **â€œå˜åŒ–é‡â€ (Change)** æˆ– **â€œå·®å€¼â€ (Difference)**ã€‚

    #### 1. å®ƒçš„æ•°å­¦å«ä¹‰
    å½“ä½ çœ‹åˆ° $\Delta x$ æˆ– $\Delta y$ æ—¶ï¼Œä½ å¯ä»¥æŠŠå®ƒç›´æ¥è¯»ä½œ â€œ$x$ çš„å˜åŒ–â€ æˆ– â€œ$y$ çš„å˜åŒ–â€ã€‚

    åœ¨è®¡ç®—æ–œç‡ $m$ æ—¶ï¼š
    *   $\Delta y = y_2 - y_1$ ï¼ˆçºµå‘åæ ‡çš„å˜åŒ–ï¼Œå³â€œä¸Šå‡äº†å¤šå°‘â€ï¼‰
    *   $\Delta x = x_2 - x_1$ ï¼ˆæ¨ªå‘åæ ‡çš„å˜åŒ–ï¼Œå³â€œå‰è¿›äº†å¤šå°‘â€ï¼‰

    **ä¸¾ä¸ªç®€å•çš„ä¾‹å­**ï¼š
    æƒ³è±¡ä½ åœ¨çˆ¬æ¥¼æ¢¯ï¼š
    *   ä½ ä»åœ°é¢å‰è¿›äº† 3ç±³ï¼ˆè¿™æ˜¯ $\Delta x$ï¼‰ã€‚
    *   ä½ ä¸Šå‡çš„é«˜åº¦å¢åŠ äº† 2ç±³ï¼ˆè¿™æ˜¯ $\Delta y$ï¼‰ã€‚
    *   é‚£ä¹ˆè¿™ä¸ªæ¥¼æ¢¯çš„å¡åº¦ï¼ˆæ–œç‡ï¼‰$m$ å°±æ˜¯ $\\frac{\\Delta y}{\\Delta x} = \\frac{2}{3} \\approx 0.67$ã€‚

    #### 2. åœ¨å¤§æ¨¡å‹å­¦ä¹ ä¸­æ„å‘³ç€ä»€ä¹ˆï¼Ÿ
    åœ¨æœºå™¨å­¦ä¹ çš„è¯­å¢ƒä¸‹ï¼Œè¿™ä¸ªâ€œä¸‰è§’å½¢â€æ˜¯ç†è§£ **â€œå­¦ä¹ â€** è¿‡ç¨‹çš„æ ¸å¿ƒï¼š

    *   **$\Delta x$ (å‚æ•°çš„å˜åŒ–)**ï¼šæŒ‡çš„æ˜¯æˆ‘ä»¬å¯¹æ¨¡å‹é‡Œçš„ä¸€ä¸ªå‚æ•°ï¼ˆæ¯”å¦‚æƒé‡ï¼‰åšäº†ä¸€ç‚¹ç‚¹å¾®è°ƒã€‚
    *   **$\Delta y$ (è¯¯å·®çš„å˜åŒ–)**ï¼šæŒ‡çš„æ˜¯å› ä¸ºè¿™ä¸€ç‚¹ç‚¹å¾®è°ƒï¼Œæ¨¡å‹çš„é¢„æµ‹é”™è¯¯ (Loss) å‡å°‘äº†å¤šå°‘ã€‚

    å¤§æ¨¡å‹çš„ç›®æ ‡å°±æ˜¯é€šè¿‡è®¡ç®— $\\frac{\\Delta y}{\\Delta x}$ï¼ˆä¹Ÿå°±æ˜¯å¯¼æ•°/æ¢¯åº¦ï¼‰ï¼Œæ‰¾åˆ°ä¸€ä¸ªæ–¹å‘ï¼Œè®©æ¯ä¸€æ¬¡å¾®å°çš„å‚æ•°è°ƒæ•´ ($\\Delta x$) éƒ½èƒ½å¸¦æ¥æœ€å¤§çš„è¯¯å·®ä¸‹é™ ($\\Delta y$)ã€‚
    """)
    return


@app.cell(hide_code=True)
def _(mo):
    mo.md("""
    ## 2. åŸºç¡€æ¦‚å¿µï¼šå¯¼æ•° (Derivative)

    æˆ‘ä»¬å·²ç»äº†è§£äº†ç›´çº¿çš„æ–œç‡ã€‚ä½†å¯¹äº**æ›²çº¿**ï¼ˆåƒå±±å¡ä¸€æ ·ï¼‰æ¯ä¸ªåœ°æ–¹çš„é™¡å³­ç¨‹åº¦éƒ½ä¸ä¸€æ ·ã€‚

    **å¯¼æ•°**å°±æ˜¯**æ›²çº¿åœ¨æŸä¸€ç‚¹çš„åˆ‡çº¿çš„æ–œç‡**ã€‚
    *   å®ƒå‘Šè¯‰æˆ‘ä»¬åœ¨è¿™ä¸€ç‚¹ï¼Œå¦‚æœæˆ‘ä»¬æŠŠ $x$ ç¨å¾®å¢åŠ ä¸€ç‚¹ç‚¹ï¼Œ$y$ ä¼šå˜åŒ–å¤šå°‘ã€‚
    *   åœ¨å¾®ç§¯åˆ†ä¸­ï¼Œå¯¼æ•°è®°ä½œ $f'(x)$ æˆ– $\frac{dy}{dx}$ã€‚

    > **å…³é”®ç‚¹**: åœ¨ä¸€ç»´æƒ…å†µä¸‹ï¼Œ**æ¢¯åº¦ = å¯¼æ•°**ã€‚

    è®©æˆ‘ä»¬é€šè¿‡ç§»åŠ¨ä¸‹é¢çš„æ»‘å—ï¼Œè§‚å¯ŸæŠ›ç‰©çº¿ $y=x^2$ ä¸Šä¸åŒä½ç½®çš„åˆ‡çº¿æ–œç‡ï¼ˆå¯¼æ•°ï¼‰ã€‚
    """)
    return


@app.cell
def _(np):
    # ==========================================
    # å®šä¹‰æ•°å­¦å‡½æ•°
    # ==========================================

    # å®šä¹‰å‡½æ•° y = x^2
    def f_1d(x):
        # è®¡ç®— x çš„å¹³æ–¹
        return x ** 2

    # å®šä¹‰å¯¼æ•°å‡½æ•° (å³æ–œç‡) y' = 2x
    def df_1d(x):
        # x^2 çš„å¯¼æ•°æ˜¯ 2x
        return 2 * x

    # ==========================================
    # å‡†å¤‡ç»˜å›¾æ•°æ®
    # ==========================================
    # ç”Ÿæˆä» -5 åˆ° 5 çš„ 100 ä¸ªç‚¹ï¼Œç”¨äºç»˜åˆ¶å¹³æ»‘çš„æ›²çº¿
    x_range = np.linspace(-5, 5, 100)
    # è®¡ç®—å¯¹åº”çš„ y å€¼
    y_range = f_1d(x_range)
    return df_1d, f_1d, x_range, y_range


@app.cell
def _(mo):
    # åˆ›å»ºä¸€ä¸ªäº¤äº’å¼æ»‘å—
    # start/stop: æ»‘åŠ¨èŒƒå›´
    # step: æ­¥é•¿
    # value: åˆå§‹å€¼
    x_slider = mo.ui.slider(start=-4.0, stop=4.0, step=0.1, value=2.0, label="é€‰æ‹© x ç‚¹ä½ç½®")

    # æ˜¾ç¤ºæ»‘å—
    mo.callout(x_slider, kind="info")
    return (x_slider,)


@app.cell
def _(df_1d, f_1d, mo, np, plt, x_range, x_slider, y_range):
    # å®šä¹‰ç»˜å›¾å‡½æ•°ï¼Œæ ¹æ®æ»‘å—çš„ x å€¼åŠ¨æ€ç»˜åˆ¶å›¾åƒ
    def plot_1d_gradient(x_val):
        # åˆ›å»ºç”»å¸ƒï¼Œå¤§å°ä¸º 10x6 è‹±å¯¸
        fig, ax = plt.subplots(figsize=(10, 6))

        # 1. ç»˜åˆ¶ä¸»å‡½æ•°æ›²çº¿ (è“è‰²å®çº¿)
        # alpha=0.6 è®¾ç½®é€æ˜åº¦ï¼Œè®©å®ƒç¨å¾®æ·¡ä¸€ç‚¹
        ax.plot(x_range, y_range, 'b-', alpha=0.6, label=u'$f(x) = x^2$')

        # 2. ç»˜åˆ¶å½“å‰é€‰ä¸­çš„ç‚¹ (çº¢ç‚¹)
        y_val = f_1d(x_val)
        # zorder=5 ç¡®ä¿ç‚¹æ˜¾ç¤ºåœ¨çº¿çš„ä¸Šæ–¹
        ax.scatter([x_val], [y_val], color='red', s=100, zorder=5, label=u'å½“å‰ç‚¹')

        # 3. è®¡ç®—åˆ‡çº¿ (æ¢¯åº¦)
        # å¯¼æ•°å°±æ˜¯è¯¥ç‚¹çš„æ–œç‡
        slope = df_1d(x_val)
        # æ ¹æ®ç‚¹æ–œå¼æ–¹ç¨‹ y - y0 = k(x - x0) è®¡ç®—æˆªè·
        # y = kx + b  =>  b = y - kx
        intercept = y_val - slope * x_val

        # 4. ç»˜åˆ¶åˆ‡çº¿
        # æˆ‘ä»¬åªåœ¨å½“å‰ç‚¹é™„è¿‘ç»˜åˆ¶åˆ‡çº¿ï¼Œä¸è¦ç”»æ»¡å…¨å›¾
        tangent_x = np.linspace(x_val - 2, x_val + 2, 20)
        tangent_y = slope * tangent_x + intercept

        # å¦‚æœæ–œç‡å¤§äº0(ä¸Šå¡)ç”¨æ©™è‰²ï¼Œå°äº0(ä¸‹å¡)ç”¨ç»¿è‰²
        color = 'orange' if slope > 0 else 'green'
        ax.plot(tangent_x, tangent_y, '--', color=color, linewidth=2, label=f'åˆ‡çº¿ (æ–œç‡/æ¢¯åº¦={slope:.2f})')

        # 5. è®¾ç½®å›¾è¡¨æ ‡æ³¨
        ax.set_title(u'å¯¼æ•°å¯è§†åŒ–: åˆ‡çº¿çš„æ–œç‡å°±æ˜¯å¯¼æ•°', fontsize=14)
        ax.set_xlabel('x')
        ax.set_ylabel('y')
        ax.grid(True, linestyle='--', alpha=0.3) # æ·»åŠ è™šçº¿ç½‘æ ¼
        ax.legend() # æ˜¾ç¤ºå›¾ä¾‹

        return fig

    # ==========================================
    # ç»„åˆ UI å’Œ å›¾åƒ
    # ==========================================

    # è·å–å½“å‰æ»‘å—å¯¹åº”çš„å¯¼æ•°å€¼
    _slope = df_1d(x_slider.value)

    # æ ¹æ®å¯¼æ•°æ­£è´Ÿåˆ¤æ–­æ–¹å‘
    if _slope > 0:
        _direction = "â†—ï¸ æ­£åœ¨ä¸Šå‡ (å¯¼æ•°ä¸ºæ­£)"
    elif _slope < 0:
        _direction = "â†˜ï¸ æ­£åœ¨ä¸‹é™ (å¯¼æ•°ä¸ºè´Ÿ)"
    else:
        _direction = "â¡ï¸ è°·åº•/æå€¼ç‚¹ (å¯¼æ•°ä¸º0)"

    # ä½¿ç”¨ vstack å‚ç›´å †å  Markdown è¯´æ˜å’Œ å›¾åƒ
    mo.vstack([
        mo.md(f"### å½“å‰ X: `{x_slider.value}` | å¯¼æ•° (æ–œç‡): `{_slope:.2f}` | {_direction}"),
        plot_1d_gradient(x_slider.value)
    ])
    return


@app.cell(hide_code=True)
def _(mo):
    mo.md("""
    ---
    ## 3. è¿›é˜¶ï¼šæ¢¯åº¦ (Gradient) æ˜¯å‘é‡

    ç°å®ä¸–ç•Œï¼ˆå’Œç¥ç»ç½‘ç»œå‚æ•°ï¼‰é€šå¸¸ä¸æ­¢ä¸€ä¸ªç»´åº¦ã€‚
    å½“æˆ‘ä»¬æœ‰ä¸¤ä¸ªå˜é‡ $x$ å’Œ $y$ æ—¶ï¼ˆæ¯”å¦‚åœ°å›¾ä¸Šçš„ç»åº¦å’Œçº¬åº¦ï¼‰ï¼Œå‡½æ•°å›¾åƒå°±å˜æˆäº†ä¸€ä¸ªæ›²é¢ï¼ˆåƒä¸ªç¢—ï¼‰ã€‚

    è¿™æ—¶å€™ï¼Œ**å¯¼æ•°**å˜æˆäº†**æ¢¯åº¦**ã€‚

    $$ \nabla f = \left[ \frac{\partial f}{\partial x}, \frac{\partial f}{\partial y} \right] $$

    *   **å®ƒæ˜¯ä¸€ä¸ªå‘é‡**: ä¸ä»…æœ‰å¤§å°ï¼ˆé™¡å³­ç¨‹åº¦ï¼‰ï¼Œè¿˜æœ‰**æ–¹å‘**ã€‚
    *   **å®ƒçš„å«ä¹‰**: ç«™åœ¨å½“å‰ä½ç½®ï¼Œå¾€å“ªä¸ªæ–¹å‘èµ°ï¼Œæµ·æ‹”ä¸Šå‡æœ€å¿«ï¼Ÿ

    ä¸‹å›¾ä¸­ï¼š
    *   **<font color="red">çº¢è‰²ç®­å¤´ (æ¢¯åº¦)</font>**: æŒ‡å‘ä¸Šå¡æœ€å¿«çš„æ–¹å‘ã€‚
    *   **<font color="green">ç»¿è‰²ç®­å¤´ (è´Ÿæ¢¯åº¦)</font>**: æŒ‡å‘ä¸‹å¡æœ€å¿«çš„æ–¹å‘ï¼ˆè¿™å°±æ˜¯**æ¢¯åº¦ä¸‹é™**ç®—æ³•ä¸­æˆ‘ä»¬ç§»åŠ¨çš„æ–¹å‘ï¼‰ã€‚
    """)
    return


@app.cell
def _(np):
    # ==========================================
    # å®šä¹‰äºŒç»´å‡½æ•°å’Œæ¢¯åº¦
    # ==========================================

    # å®šä¹‰äºŒç»´æ›²é¢å‡½æ•° (æ¯”å¦‚ Loss Function)
    def f_2d(x, y):
        # ä¸€ä¸ªç®€å•çš„ç¢—çŠ¶æ›²é¢
        return x**2 + y**2

    # è®¡ç®—æ¢¯åº¦ (åå¯¼æ•°)
    # å¯¹ x æ±‚å¯¼: 2x, å¯¹ y æ±‚å¯¼: 2y
    def grad_2d(x, y):
        return 2*x, 2*y

    # ==========================================
    # å‡†å¤‡å‘é‡åœºæ•°æ®
    # ==========================================
    # åˆ›å»ºç½‘æ ¼ç‚¹ï¼Œç”¨äºç»˜åˆ¶èƒŒæ™¯çš„ç°è‰²ç®­å¤´åœº
    grid_x = np.linspace(-3, 3, 20)
    grid_y = np.linspace(-3, 3, 20)
    # ç”Ÿæˆç½‘æ ¼çŸ©é˜µ
    X, Y = np.meshgrid(grid_x, grid_y)
    # è®¡ç®—ç½‘æ ¼ä¸Šæ¯ä¸ªç‚¹çš„é«˜åº¦ Z
    Z = f_2d(X, Y)
    # è®¡ç®—ç½‘æ ¼ä¸Šæ¯ä¸ªç‚¹çš„æ¢¯åº¦å‘é‡ (U, V)
    U, V = grad_2d(X, Y) 
    return U, V, X, Y, Z, grad_2d


@app.cell
def _(mo):
    # åˆ›å»ºä¸¤ä¸ªæ»‘å—åˆ†åˆ«æ§åˆ¶ X å’Œ Y åæ ‡
    x2_slider = mo.ui.slider(-2.5, 2.5, 0.1, 1.0, label="X åæ ‡")
    y2_slider = mo.ui.slider(-2.5, 2.5, 0.1, 1.0, label="Y åæ ‡")

    # æ°´å¹³æ’åˆ—ä¸¤ä¸ªæ»‘å—
    mo.hstack([x2_slider, y2_slider], justify="center")
    return x2_slider, y2_slider


@app.cell
def _(U, V, X, Y, Z, grad_2d, mo, plt, x2_slider, y2_slider):
    def plot_2d_gradient(x_val, y_val):
        fig, ax = plt.subplots(figsize=(10, 8))

        # 1. ç»˜åˆ¶ç­‰é«˜çº¿ (ä»ä¸Šå¾€ä¸‹çœ‹çš„åœ°å½¢å›¾)
        # levels=15 è¡¨ç¤ºç”»15æ¡ç­‰é«˜çº¿
        contour = ax.contour(X, Y, Z, levels=15, cmap='Blues', alpha=0.6)
        # åœ¨ç­‰é«˜çº¿ä¸Šæ ‡è®°é«˜åº¦æ•°å€¼
        ax.clabel(contour, inline=True, fontsize=8)

        # 2. ç»˜åˆ¶èƒŒæ™¯æ¢¯åº¦åœº (ç°è‰²å°ç®­å¤´)
        # å±•ç¤ºæ•´ä¸ªç©ºé—´ä¸­æ¯ä¸ªä½ç½®çš„è¶‹åŠ¿
        ax.quiver(X, Y, U, V, alpha=0.1, color='gray')

        # 3. ç»˜åˆ¶å½“å‰ä½ç½® (é»‘ç‚¹)
        ax.scatter([x_val], [y_val], color='black', s=100, zorder=10, label=u'å½“å‰ä½ç½®')

        # 4. è®¡ç®—å¹¶ç»˜åˆ¶å½“å‰ç‚¹çš„æ¢¯åº¦å‘é‡
        gx, gy = grad_2d(x_val, y_val)

        # ç»˜åˆ¶çº¢è‰²ç®­å¤´ (æ¢¯åº¦ï¼šä¸Šå¡æ–¹å‘)
        # head_width/length æ§åˆ¶ç®­å¤´å¤´éƒ¨å¤§å°
        ax.arrow(x_val, y_val, gx*0.3, gy*0.3, head_width=0.15, head_length=0.2, 
                 fc='red', ec='red', width=0.02, label=u'æ¢¯åº¦ (ä¸Šå¡æ–¹å‘)')

        # ç»˜åˆ¶ç»¿è‰²ç®­å¤´ (è´Ÿæ¢¯åº¦ï¼šä¸‹å¡æ–¹å‘) - è¿™æ˜¯æ¨¡å‹è®­ç»ƒèµ°çš„æ–¹å‘ï¼
        ax.arrow(x_val, y_val, -gx*0.3, -gy*0.3, head_width=0.15, head_length=0.2, 
                 fc='green', ec='green', width=0.02, label=u'è´Ÿæ¢¯åº¦ (ä¸‹å¡/ä¼˜åŒ–æ–¹å‘)')

        # 5. å›¾è¡¨è®¾ç½®
        ax.set_title(u'äºŒç»´æ¢¯åº¦å¯è§†åŒ–: çº¢è‰²=æ¢¯åº¦, ç»¿è‰²=è´Ÿæ¢¯åº¦', fontsize=14)
        ax.set_xlabel('X')
        ax.set_ylabel('Y')
        ax.set_aspect('equal') # ä¿æŒ XY è½´æ¯”ä¾‹ä¸€è‡´ï¼Œä¸æ‹‰ä¼¸
        ax.grid(True, alpha=0.3)
        ax.legend(loc='upper left')

        return fig

    # è®¡ç®—å½“å‰æ•°å€¼ç”¨äºæ˜¾ç¤ºæ–‡æœ¬
    _gx, _gy = grad_2d(x2_slider.value, y2_slider.value)

    mo.vstack([
        mo.md(f"""
        ### å½“å‰ä½ç½®: `({x2_slider.value}, {y2_slider.value})`
        - æ¢¯åº¦å‘é‡ $\\nabla f$: `[{_gx:.2f}, {_gy:.2f}]`
        - **çº¢è‰²ç®­å¤´**æŒ‡å‘å‡½æ•°å€¼å¢åŠ çš„æ–¹å‘ (ç¦»åœ†å¿ƒè¶Šè¿œè¶Šé«˜)
        - **ç»¿è‰²ç®­å¤´**æŒ‡å‘å‡½æ•°å€¼å‡å°çš„æ–¹å‘ (æŒ‡å‘åœ†å¿ƒ/æœ€ä½ç‚¹)
        """),
        plot_2d_gradient(x2_slider.value, y2_slider.value)
    ])
    return


@app.cell(hide_code=True)
def _(mo):
    mo.md("""
    ## æ€»ç»“

    1.  **æ–œç‡ (Slope)** æ˜¯ç›´çº¿çš„é™¡å³­ç¨‹åº¦ï¼Œæè¿°äº† $y$ éš $x$ çš„å˜åŒ–ç‡ã€‚
    2.  **å¯¼æ•° (Derivative)** æ˜¯ä¸€ç»´æ›²çº¿çš„æ–œç‡ï¼Œå‘Šè¯‰æˆ‘ä»¬å¾€å“ªè¾¹èµ°ä¼šä¸Šå¡ã€‚
    3.  **æ¢¯åº¦ (Gradient)** æ˜¯å¤šç»´æ›²é¢çš„å¯¼æ•°å‘é‡ï¼ŒæŒ‡å‘**æœ€é™¡çš„ä¸Šå¡æ–¹å‘**ã€‚
    4.  åœ¨å¤§æ¨¡å‹è®­ç»ƒä¸­ï¼Œæˆ‘ä»¬é€šè¿‡**åå‘ä¼ æ’­**ç®—å‡ºæ¢¯åº¦ï¼Œç„¶åæ²¿ç€**è´Ÿæ¢¯åº¦**ï¼ˆåæ–¹å‘ï¼‰æ›´æ–°å‚æ•°ï¼Œä»è€Œé™ä½ Lossï¼Œè®©æ¨¡å‹å˜èªæ˜ã€‚
    """)
    return


if __name__ == "__main__":
    app.run()
