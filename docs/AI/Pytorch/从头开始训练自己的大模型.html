<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-AI/Pytorch/ä»å¤´å¼€å§‹è®­ç»ƒè‡ªå·±çš„å¤§æ¨¡å‹" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">ä»å¤´å¼€å§‹è®­ç»ƒè‡ªå·±çš„å¤§æ¨¡å‹ - æµç¨‹å›¾ | Cruldra</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://your-docusaurus-site.example.com/notes3/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://your-docusaurus-site.example.com/notes3/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://your-docusaurus-site.example.com/notes3/docs/AI/Pytorch/ä»å¤´å¼€å§‹è®­ç»ƒè‡ªå·±çš„å¤§æ¨¡å‹"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="ä»å¤´å¼€å§‹è®­ç»ƒè‡ªå·±çš„å¤§æ¨¡å‹ - æµç¨‹å›¾ | Cruldra"><meta data-rh="true" name="description" content="åŸºäº ä»å¤´å¼€å§‹è®­ç»ƒè‡ªå·±çš„å¤§æ¨¡å‹.py ä»£ç çš„è®­ç»ƒæµç¨‹åˆ†æã€‚"><meta data-rh="true" property="og:description" content="åŸºäº ä»å¤´å¼€å§‹è®­ç»ƒè‡ªå·±çš„å¤§æ¨¡å‹.py ä»£ç çš„è®­ç»ƒæµç¨‹åˆ†æã€‚"><link data-rh="true" rel="icon" href="/notes3/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://your-docusaurus-site.example.com/notes3/docs/AI/Pytorch/ä»å¤´å¼€å§‹è®­ç»ƒè‡ªå·±çš„å¤§æ¨¡å‹"><link data-rh="true" rel="alternate" href="https://your-docusaurus-site.example.com/notes3/docs/AI/Pytorch/ä»å¤´å¼€å§‹è®­ç»ƒè‡ªå·±çš„å¤§æ¨¡å‹" hreflang="en"><link data-rh="true" rel="alternate" href="https://your-docusaurus-site.example.com/notes3/docs/AI/Pytorch/ä»å¤´å¼€å§‹è®­ç»ƒè‡ªå·±çš„å¤§æ¨¡å‹" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"ä»å¤´å¼€å§‹è®­ç»ƒè‡ªå·±çš„å¤§æ¨¡å‹ - æµç¨‹å›¾","item":"https://your-docusaurus-site.example.com/notes3/docs/AI/Pytorch/ä»å¤´å¼€å§‹è®­ç»ƒè‡ªå·±çš„å¤§æ¨¡å‹"}]}</script><link rel="alternate" type="application/rss+xml" href="/notes3/blog/rss.xml" title="Cruldra RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/notes3/blog/atom.xml" title="Cruldra Atom Feed"><link rel="stylesheet" href="/notes3/assets/css/styles.6f52c8a6.css">
<script src="/notes3/assets/js/runtime~main.502203ec.js" defer="defer"></script>
<script src="/notes3/assets/js/main.87f19176.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>document.documentElement.setAttribute("data-theme",window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),document.documentElement.setAttribute("data-theme-choice","system"),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/notes3/img/logo.svg"><style data-mantine-styles="classes">@media (max-width: 35.99375em) {.mantine-visible-from-xs {display: none !important;}}@media (min-width: 36em) {.mantine-hidden-from-xs {display: none !important;}}@media (max-width: 47.99375em) {.mantine-visible-from-sm {display: none !important;}}@media (min-width: 48em) {.mantine-hidden-from-sm {display: none !important;}}@media (max-width: 61.99375em) {.mantine-visible-from-md {display: none !important;}}@media (min-width: 62em) {.mantine-hidden-from-md {display: none !important;}}@media (max-width: 74.99375em) {.mantine-visible-from-lg {display: none !important;}}@media (min-width: 75em) {.mantine-hidden-from-lg {display: none !important;}}@media (max-width: 87.99375em) {.mantine-visible-from-xl {display: none !important;}}@media (min-width: 88em) {.mantine-hidden-from-xl {display: none !important;}}</style><div role="region" aria-label="Skip to main content"><a class="skipToContent_aA1M" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/notes3/"><div class="navbar__logo"><img src="/notes3/img/logo.svg" alt="My Site Logo" class="themedComponent_E3Xm themedComponent--light_DVqC"><img src="/notes3/img/logo.svg" alt="My Site Logo" class="themedComponent_E3Xm themedComponent--dark_B_L3"></div><b class="navbar__title text--truncate">Cruldra</b></a><a class="navbar__item navbar__link" href="/notes3/docs/category/è®¾è®¡æ¨¡å¼">JVM</a><a class="navbar__item navbar__link" href="/notes3/docs/category/css">å‰ç«¯</a><a class="navbar__item navbar__link" href="/notes3/docs/category/astrbot">å·¥å…·</a><a class="navbar__item navbar__link" href="/notes3/docs/category/aiç”µç«é…’åº—">ä¸ªäºº</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/notes3/docs/AI/ACP/æ¶æ„">AI</a><a class="navbar__item navbar__link" href="/notes3/docs/category/å†…ç½®æ¨¡å—">Python</a><a class="navbar__item navbar__link" href="/notes3/docs/category/actix-web">Rust</a><a class="navbar__item navbar__link" href="/notes3/docs/category/æ•°æ®åº“ç³»ç»Ÿ">è½¯ä»¶å·¥ç¨‹</a><a class="navbar__item navbar__link" href="/notes3/docs/category/ä¸Šå¤å·è½´5">æ¸¸æˆ</a><a class="navbar__item navbar__link" href="/notes3/docs/Go/Go-Python-Javaä¸‰è¯­è¨€å…¨æ–¹ä½å¯¹æ¯”">Go</a><a class="navbar__item navbar__link" href="/notes3/docs/Hardware/GPUå·¥ä½œåŸç†">ç¡¬ä»¶</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><div class="navbarSearchContainer_PufJ"><div class="navbar__search searchBarContainer_r6C1" dir="ltr"><input placeholder="Search" aria-label="Search" class="navbar__search-input searchInput_G4_y" value=""><div class="loadingRing__Zfe searchBarLoadingRing_f0pn"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_ctfR"><div class="docsWrapper_ByIB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_KwvU" type="button"></button><div class="docRoot_hD6z"><aside class="theme-doc-sidebar-container docSidebarContainer_KuHC"><div class="sidebarViewport_LCjr"><div class="sidebar_L77d"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_VYAF"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_NhDl menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/notes3/docs/AI/ACP/æ¶æ„"><span title="ACP" class="categoryLinkLabel_FHN4">ACP</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_NhDl menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/notes3/docs/AI/Agent Skills/ä»€ä¹ˆæ˜¯Skills"><span title="Agent Skills" class="categoryLinkLabel_FHN4">Agent Skills</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_NhDl menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/notes3/docs/AI/Agno/ä»‹ç»"><span title="Agno" class="categoryLinkLabel_FHN4">Agno</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_NhDl menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/notes3/docs/AI/CrewAI/CLI"><span title="CrewAI" class="categoryLinkLabel_FHN4">CrewAI</span></a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/notes3/docs/AI/DALLEæˆæœ¬è®¡ç®—"><span title="DALL-E ç”»å›¾æˆæœ¬è®¡ç®—" class="linkLabel__RqX">DALL-E ç”»å›¾æˆæœ¬è®¡ç®—</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_NhDl menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/notes3/docs/AI/LLamaIndex/CitationQueryEngine"><span title="LLamaIndex" class="categoryLinkLabel_FHN4">LLamaIndex</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_NhDl menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/notes3/docs/AI/MCP/MCP-Python-SDK"><span title="MCP" class="categoryLinkLabel_FHN4">MCP</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_NhDl menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/notes3/docs/AI/Pytorch/ä»‹ç»"><span title="Pytorch" class="categoryLinkLabel_FHN4">Pytorch</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes3/docs/AI/Pytorch/ä»‹ç»"><span title="ä»‹ç»" class="linkLabel__RqX">ä»‹ç»</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_NhDl menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/notes3/docs/AI/Pytorch/ç¥ç»ç½‘ç»œ/ç®€ä»‹"><span title="ç¥ç»ç½‘ç»œ" class="categoryLinkLabel_FHN4">ç¥ç»ç½‘ç»œ</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_NhDl menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/notes3/docs/AI/Pytorch/CUDA/grad_scaler"><span title="CUDA" class="categoryLinkLabel_FHN4">CUDA</span></a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes3/docs/AI/Pytorch/arange"><span title="arange" class="linkLabel__RqX">arange</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes3/docs/AI/Pytorch/cat"><span title="cat" class="linkLabel__RqX">cat</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes3/docs/AI/Pytorch/outer"><span title="outer" class="linkLabel__RqX">outer</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/notes3/docs/AI/Pytorch/ä»å¤´å¼€å§‹è®­ç»ƒè‡ªå·±çš„å¤§æ¨¡å‹"><span title="ä»å¤´å¼€å§‹è®­ç»ƒè‡ªå·±çš„å¤§æ¨¡å‹ - æµç¨‹å›¾" class="linkLabel__RqX">ä»å¤´å¼€å§‹è®­ç»ƒè‡ªå·±çš„å¤§æ¨¡å‹ - æµç¨‹å›¾</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_NhDl menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/notes3/docs/AI/Pytorch/ä¼˜åŒ–/ç®€ä»‹"><span title="ä¼˜åŒ–" class="categoryLinkLabel_FHN4">ä¼˜åŒ–</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_NhDl menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/notes3/docs/AI/Pytorch/åˆ†å¸ƒå¼è®­ç»ƒ/DistributedDataParallel"><span title="åˆ†å¸ƒå¼è®­ç»ƒ" class="categoryLinkLabel_FHN4">åˆ†å¸ƒå¼è®­ç»ƒ</span></a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes3/docs/AI/Pytorch/åˆ†è¯å™¨ä¸è¯åµŒå…¥å®Œæ•´æµç¨‹æ¼”ç¤º"><span title="åˆ†è¯å™¨ä¸è¯åµŒå…¥å®Œæ•´æµç¨‹æ¼”ç¤º" class="linkLabel__RqX">åˆ†è¯å™¨ä¸è¯åµŒå…¥å®Œæ•´æµç¨‹æ¼”ç¤º</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_NhDl menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/notes3/docs/AI/Pytorch/å‚è€ƒ/1"><span title="å‚è€ƒ" class="categoryLinkLabel_FHN4">å‚è€ƒ</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_NhDl menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/notes3/docs/AI/Pytorch/å·¥å…·/ç®€ä»‹"><span title="å·¥å…·" class="categoryLinkLabel_FHN4">å·¥å…·</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_NhDl menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/notes3/docs/AI/Pytorch/å¼ é‡/å¦‚ä½•çœ‹æ‡‚å¼ é‡å½¢çŠ¶"><span title="å¼ é‡" class="categoryLinkLabel_FHN4">å¼ é‡</span></a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes3/docs/AI/Pytorch/æ··åˆç²¾åº¦æµ®ç‚¹æ•°"><span title="æ··åˆç²¾åº¦æµ®ç‚¹æ•°" class="linkLabel__RqX">æ··åˆç²¾åº¦æµ®ç‚¹æ•°</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_NhDl menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/notes3/docs/AI/SentencePiece/ç®€ä»‹"><span title="SentencePiece" class="categoryLinkLabel_FHN4">SentencePiece</span></a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/notes3/docs/AI/Transformer"><span title="Transformer" class="linkLabel__RqX">Transformer</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/notes3/docs/AI/cv_graph"><span title="è®¡ç®—æœºè§†è§‰ (CV) çŸ¥è¯†å›¾è°±" class="linkLabel__RqX">è®¡ç®—æœºè§†è§‰ (CV) çŸ¥è¯†å›¾è°±</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_NhDl menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/notes3/docs/AI/datasets/demo"><span title="datasets" class="categoryLinkLabel_FHN4">datasets</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_NhDl menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/notes3/docs/AI/huggingface_hub/ç®€ä»‹"><span title="huggingface_hub" class="categoryLinkLabel_FHN4">huggingface_hub</span></a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/notes3/docs/AI/llm_graph"><span title="LLM çŸ¥è¯†å›¾è°±" class="linkLabel__RqX">LLM çŸ¥è¯†å›¾è°±</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_NhDl menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/notes3/docs/AI/tiktoken/ç®€ä»‹"><span title="tiktoken" class="categoryLinkLabel_FHN4">tiktoken</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_NhDl menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/notes3/docs/AI/tokenizers/å’Œtiktokençš„åŒºåˆ«"><span title="tokenizers" class="categoryLinkLabel_FHN4">tokenizers</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_NhDl menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/notes3/docs/AI/transformers/åˆ†è¯å™¨/PreTrainedTokenizer"><span title="transformers" class="categoryLinkLabel_FHN4">transformers</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_NhDl menu__link menu__link--sublist" href="/notes3/docs/AI/vllm"><span title="vLLM å­¦ä¹ èµ„æ–™" class="categoryLinkLabel_FHN4">vLLM å­¦ä¹ èµ„æ–™</span></a><button aria-label="Expand sidebar category &#x27;vLLM å­¦ä¹ èµ„æ–™&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_NhDl menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/notes3/docs/AI/wandb/ç®€ä»‹"><span title="wandb" class="categoryLinkLabel_FHN4">wandb</span></a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/notes3/docs/AI/ä¸€äº›æ¦‚å¿µ1"><span title="ä¸€äº›æ¦‚å¿µ1" class="linkLabel__RqX">ä¸€äº›æ¦‚å¿µ1</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/notes3/docs/AI/ä¸€äº›æ¦‚å¿µ2"><span title="ä¸€äº›æ¦‚å¿µ2" class="linkLabel__RqX">ä¸€äº›æ¦‚å¿µ2</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/notes3/docs/AI/ä¸€äº›æ¦‚å¿µ3"><span title="ä¸€äº›æ¦‚å¿µ3" class="linkLabel__RqX">ä¸€äº›æ¦‚å¿µ3</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/notes3/docs/AI/ä¸€äº›æ¦‚å¿µ4"><span title="ä¸€äº›æ¦‚å¿µ4" class="linkLabel__RqX">ä¸€äº›æ¦‚å¿µ4</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/notes3/docs/AI/ä¸€äº›æ¦‚å¿µ5"><span title="ä¸€äº›æ¦‚å¿µ5" class="linkLabel__RqX">ä¸€äº›æ¦‚å¿µ5</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/notes3/docs/AI/å€™é€‰æ¨¡å‹"><span title="å€™é€‰æ¨¡å‹" class="linkLabel__RqX">å€™é€‰æ¨¡å‹</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/notes3/docs/AI/å˜åˆ†è‡ªç¼–ç å™¨è¯¦è§£"><span title="å˜åˆ†è‡ªç¼–ç å™¨ï¼ˆVAEï¼‰è¯¦è§£" class="linkLabel__RqX">å˜åˆ†è‡ªç¼–ç å™¨ï¼ˆVAEï¼‰è¯¦è§£</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/notes3/docs/AI/å¤§æ¨¡å‹æ ¸å¿ƒæ¦‚å¿µé€šä¿—è§£é‡Š"><span title="å¤§æ¨¡å‹æ ¸å¿ƒæ¦‚å¿µé€šä¿—è§£é‡Š" class="linkLabel__RqX">å¤§æ¨¡å‹æ ¸å¿ƒæ¦‚å¿µé€šä¿—è§£é‡Š</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/notes3/docs/AI/å¤§æ¨¡å‹è®­ç»ƒä¸­çš„éšæœºç§å­ï¼šä¸ºä»€ä¹ˆéœ€è¦å®ƒï¼Ÿ"><span title="å¤§æ¨¡å‹è®­ç»ƒä¸­çš„éšæœºç§å­ï¼šä¸ºä»€ä¹ˆéœ€è¦å®ƒï¼Ÿ" class="linkLabel__RqX">å¤§æ¨¡å‹è®­ç»ƒä¸­çš„éšæœºç§å­ï¼šä¸ºä»€ä¹ˆéœ€è¦å®ƒï¼Ÿ</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/notes3/docs/AI/å¦‚ä½•çœ‹æ‡‚æ•°å­¦å…¬å¼"><span title="å¦‚ä½•çœ‹æ‡‚æ•°å­¦å…¬å¼" class="linkLabel__RqX">å¦‚ä½•çœ‹æ‡‚æ•°å­¦å…¬å¼</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_NhDl menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/notes3/docs/AI/åµŒå…¥å’Œå‘é‡/Chromaä¸PGVectorå¯¹æ¯”"><span title="åµŒå…¥å’Œå‘é‡" class="categoryLinkLabel_FHN4">åµŒå…¥å’Œå‘é‡</span></a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/notes3/docs/AI/æ„ŸçŸ¥æœº"><span title="æ„ŸçŸ¥æœº" class="linkLabel__RqX">æ„ŸçŸ¥æœº</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_NhDl menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/notes3/docs/AI/æç¤ºè¯å·¥ç¨‹/DSPy/API/ä¼˜åŒ–å™¨/BetterTogether"><span title="æç¤ºè¯å·¥ç¨‹" class="categoryLinkLabel_FHN4">æç¤ºè¯å·¥ç¨‹</span></a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/notes3/docs/AI/æ™ºèƒ½ä½“"><span title="æ™ºèƒ½ä½“(Agent)" class="linkLabel__RqX">æ™ºèƒ½ä½“(Agent)</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_NhDl menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/notes3/docs/AI/æ·±åº¦å­¦ä¹ /å…¥é—¨"><span title="æ·±åº¦å­¦ä¹ " class="categoryLinkLabel_FHN4">æ·±åº¦å­¦ä¹ </span></a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/notes3/docs/AI/ç†è§£å¤§æ¨¡å‹ï¼šä»å‡½æ•°è§†è§’çœ‹AIçš„æœ¬è´¨"><span title="ç†è§£å¤§æ¨¡å‹ï¼šä»å‡½æ•°è§†è§’çœ‹AIçš„æœ¬è´¨" class="linkLabel__RqX">ç†è§£å¤§æ¨¡å‹ï¼šä»å‡½æ•°è§†è§’çœ‹AIçš„æœ¬è´¨</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_NhDl menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/notes3/docs/AI/ç›¸å…³æ¦‚å¿µ/Gradient"><span title="ç›¸å…³æ¦‚å¿µ" class="categoryLinkLabel_FHN4">ç›¸å…³æ¦‚å¿µ</span></a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/notes3/docs/AI/è”é‚¦å­¦ä¹ æ¦‚å¿µ"><span title="è”é‚¦å­¦ä¹ æ¦‚å¿µ" class="linkLabel__RqX">è”é‚¦å­¦ä¹ æ¦‚å¿µ</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_NhDl menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/notes3/docs/AI/é€šä¹‰åƒé—®/é˜¿é‡Œäº‘ç™¾ç‚¼"><span title="é€šä¹‰åƒé—®" class="categoryLinkLabel_FHN4">é€šä¹‰åƒé—®</span></a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/notes3/docs/AI/é‡‘ä¸é›€å‘å¸ƒå’ŒABæµ‹è¯•"><span title="é‡‘ä¸é›€å‘å¸ƒå’ŒABæµ‹è¯•" class="linkLabel__RqX">é‡‘ä¸é›€å‘å¸ƒå’ŒABæµ‹è¯•</span></a></li></ul></nav></div></div></aside><main class="docMainContainer_WxcZ"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_Zd2x"><div class="docItemContainer_EEW4"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_xL_w" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/notes3/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_zA1U"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Pytorch</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">ä»å¤´å¼€å§‹è®­ç»ƒè‡ªå·±çš„å¤§æ¨¡å‹ - æµç¨‹å›¾</span></li></ul></nav><div class="tocCollapsible_aZGz theme-doc-toc-mobile tocMobile_ShCt"><button type="button" class="clean-btn tocCollapsibleButton_fxzH">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>ä»å¤´å¼€å§‹è®­ç»ƒè‡ªå·±çš„å¤§æ¨¡å‹ - æµç¨‹å›¾</h1></header>
<p>åŸºäº <code>ä»å¤´å¼€å§‹è®­ç»ƒè‡ªå·±çš„å¤§æ¨¡å‹.py</code> ä»£ç çš„è®­ç»ƒæµç¨‹åˆ†æã€‚</p>
<h2 class="anchor anchorTargetStickyNavbar_aDle" id="1-æ•´ä½“è®­ç»ƒæµç¨‹">1. æ•´ä½“è®­ç»ƒæµç¨‹<a href="#1-æ•´ä½“è®­ç»ƒæµç¨‹" class="hash-link" aria-label="Direct link to 1. æ•´ä½“è®­ç»ƒæµç¨‹" title="Direct link to 1. æ•´ä½“è®­ç»ƒæµç¨‹" translate="no">â€‹</a></h2>
<!-- -->
<h2 class="anchor anchorTargetStickyNavbar_aDle" id="2-è®­ç»ƒå¾ªç¯è¯¦æƒ…-train_epoch">2. è®­ç»ƒå¾ªç¯è¯¦æƒ… (train_epoch)<a href="#2-è®­ç»ƒå¾ªç¯è¯¦æƒ…-train_epoch" class="hash-link" aria-label="Direct link to 2. è®­ç»ƒå¾ªç¯è¯¦æƒ… (train_epoch)" title="Direct link to 2. è®­ç»ƒå¾ªç¯è¯¦æƒ… (train_epoch)" translate="no">â€‹</a></h2>
<!-- -->
<h2 class="anchor anchorTargetStickyNavbar_aDle" id="3-æ¨¡å‹ç»„ä»¶æ¶æ„-class-diagram">3. æ¨¡å‹ç»„ä»¶æ¶æ„ (Class Diagram)<a href="#3-æ¨¡å‹ç»„ä»¶æ¶æ„-class-diagram" class="hash-link" aria-label="Direct link to 3. æ¨¡å‹ç»„ä»¶æ¶æ„ (Class Diagram)" title="Direct link to 3. æ¨¡å‹ç»„ä»¶æ¶æ„ (Class Diagram)" translate="no">â€‹</a></h2>
<!-- -->
<h2 class="anchor anchorTargetStickyNavbar_aDle" id="4-å…³é”®ç»„ä»¶è¯´æ˜">4. å…³é”®ç»„ä»¶è¯´æ˜<a href="#4-å…³é”®ç»„ä»¶è¯´æ˜" class="hash-link" aria-label="Direct link to 4. å…³é”®ç»„ä»¶è¯´æ˜" title="Direct link to 4. å…³é”®ç»„ä»¶è¯´æ˜" translate="no">â€‹</a></h2>
<ul>
<li class=""><strong>MiniMindConfig</strong>: æ¨¡å‹çš„é…ç½®ä¸­å¿ƒï¼Œå®šä¹‰äº†æ¨¡å‹å¤§å°ã€å±‚æ•°ã€å¤´æ•°ä»¥åŠæ˜¯å¦å¼€å¯ MoE ç­‰å…³é”®è¶…å‚æ•°ã€‚</li>
<li class=""><strong>MiniMindForCausalLM</strong>: é¡¶å±‚å°è£…ï¼ŒåŒ…å«åŸºç¡€ Transformer æ¨¡å‹ (<code>MiniMindModel</code>) å’Œè¯­è¨€æ¨¡å‹å¤´ (<code>lm_head</code>)ï¼Œç”¨äºç”Ÿæˆä»»åŠ¡ã€‚</li>
<li class=""><strong>MiniMindModel</strong>: ä¸å« Head çš„åŸºç¡€æ¨¡å‹ï¼Œè´Ÿè´£ Token Embeddingã€å¤šå±‚ Decoder å †å ä»¥åŠæœ€ç»ˆçš„ RMSNormã€‚</li>
<li class=""><strong>MiniMindBlock</strong>: å•ä¸ª Transformer Decoder å±‚ï¼Œé‡‡ç”¨ Pre-Norm ç»“æ„ï¼ŒåŒ…å« Self-Attention å’Œ FFN/MoEã€‚</li>
<li class=""><strong>Attention</strong>: æ”¯æŒ GQA (Grouped Query Attention) å’Œ RoPE (Rotary Positional Embeddings) çš„æ³¨æ„åŠ›æœºåˆ¶ï¼ŒåŒ…å« Flash Attention ä¼˜åŒ–ã€‚</li>
<li class=""><strong>FeedForward (SwiGLU)</strong>: æ ‡å‡†çš„ SwiGLU å‰é¦ˆç½‘ç»œï¼Œç”¨äº Dense æ¨¡å¼æˆ–ä½œä¸º MoE çš„ä¸“å®¶å•å…ƒã€‚</li>
<li class=""><strong>MOEFeedForward</strong>: æ··åˆä¸“å®¶æ¨¡å—ï¼ŒåŒ…å«ä¸€ä¸ªé—¨æ§ç½‘ç»œ (<code>MoEGate</code>) å’Œå¤šä¸ªä¸“å®¶ç½‘ç»œ (<code>experts</code>/<code>shared_experts</code>)ã€‚</li>
<li class=""><strong>MoEGate</strong>: è·¯ç”±ç½‘ç»œï¼Œè®¡ç®—è¾“å…¥ Token å¯¹å„ä¸ªä¸“å®¶çš„æƒé‡ï¼ˆTop-K è·¯ç”±ï¼‰ã€‚</li>
</ul>
<hr>
<p>ä¸ºäº†è®©ä½ å½»åº•çœ‹æ‡‚è¿™æ®µä»£ç ï¼Œæˆ‘ä»¬å°†è´¯ç©¿ä½¿ç”¨ä¸€ä¸ªæ ¸å¿ƒä¾‹å­ï¼š<strong>æ•™ä¸€ä¸ªå®Œå…¨ä¸æ‡‚ä¸­æ–‡çš„å¤–å›½ç•™å­¦ç”Ÿ&quot;å°æ˜&quot;ï¼ˆMiniMindï¼‰å­¦ä¹ å†™ä¸­æ–‡å°è¯´ã€‚</strong></p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_aDle" id="ä¸€å¼€åœºå‡†å¤‡è®¾ç½®éšæœºç§å­-setup_seed">ä¸€ã€å¼€åœºå‡†å¤‡ï¼šè®¾ç½®éšæœºç§å­ (<code>setup_seed</code>)<a href="#ä¸€å¼€åœºå‡†å¤‡è®¾ç½®éšæœºç§å­-setup_seed" class="hash-link" aria-label="Direct link to ä¸€å¼€åœºå‡†å¤‡è®¾ç½®éšæœºç§å­-setup_seed" title="Direct link to ä¸€å¼€åœºå‡†å¤‡è®¾ç½®éšæœºç§å­-setup_seed" translate="no">â€‹</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-ä»£ç ç‰‡æ®µ-ç¬¬-114-121-è¡Œ">ğŸ“ ä»£ç ç‰‡æ®µ (ç¬¬ 114-121 è¡Œ)<a href="#-ä»£ç ç‰‡æ®µ-ç¬¬-114-121-è¡Œ" class="hash-link" aria-label="Direct link to ğŸ“ ä»£ç ç‰‡æ®µ (ç¬¬ 114-121 è¡Œ)" title="Direct link to ğŸ“ ä»£ç ç‰‡æ®µ (ç¬¬ 114-121 è¡Œ)" translate="no">â€‹</a></h3>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">setup_seed</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">seed</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    random</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">seed</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">seed</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">random</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">seed</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">seed</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">manual_seed</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">seed</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cuda</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">manual_seed</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">seed</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cuda</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">manual_seed_all</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">seed</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">backends</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cudnn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">deterministic </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">backends</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cudnn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">benchmark </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">False</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-éšå–»ç¿»è¯‘å›ºå®šè€ƒè¯•é¢˜åº“çš„é¡ºåº">ğŸ¯ éšå–»ç¿»è¯‘ï¼šå›ºå®šè€ƒè¯•é¢˜åº“çš„é¡ºåº<a href="#-éšå–»ç¿»è¯‘å›ºå®šè€ƒè¯•é¢˜åº“çš„é¡ºåº" class="hash-link" aria-label="Direct link to ğŸ¯ éšå–»ç¿»è¯‘ï¼šå›ºå®šè€ƒè¯•é¢˜åº“çš„é¡ºåº" title="Direct link to ğŸ¯ éšå–»ç¿»è¯‘ï¼šå›ºå®šè€ƒè¯•é¢˜åº“çš„é¡ºåº" translate="no">â€‹</a></h3>
<p>æƒ³è±¡ä¸€ä¸‹ï¼Œä½ è¦æ•™å°æ˜å†™å°è¯´ï¼Œå‡†å¤‡äº† 1000 é“ç»ƒä¹ é¢˜ã€‚</p>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="é—®é¢˜åœºæ™¯">é—®é¢˜åœºæ™¯ï¼š<a href="#é—®é¢˜åœºæ™¯" class="hash-link" aria-label="Direct link to é—®é¢˜åœºæ™¯ï¼š" title="Direct link to é—®é¢˜åœºæ™¯ï¼š" translate="no">â€‹</a></h4>
<p>å¦‚æœæ¯æ¬¡ç»ƒä¹ æ—¶éƒ½<strong>éšæœºæ‰“ä¹±</strong>é¢˜ç›®é¡ºåºï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</p>
<ul>
<li class=""><strong>ä»Šå¤©</strong>ï¼šå°æ˜å…ˆå­¦ä¹ &quot;å¦‚ä½•æå†™äººç‰©&quot;ï¼Œå†å­¦&quot;å¦‚ä½•æ„å»ºæƒ…èŠ‚&quot;</li>
<li class=""><strong>æ˜å¤©</strong>ï¼šå°æ˜å…ˆå­¦ä¹ &quot;å¦‚ä½•æ„å»ºæƒ…èŠ‚&quot;ï¼Œå†å­¦&quot;å¦‚ä½•æå†™äººç‰©&quot;</li>
<li class=""><strong>ç»“æœ</strong>ï¼šä¸¤å¤©åå¯¹æ¯”å°æ˜çš„è¿›æ­¥æ—¶ï¼Œä½ æ— æ³•åˆ¤æ–­åˆ°åº•æ˜¯æ•™å­¦æ–¹æ³•æ”¹è¿›äº†ï¼Œè¿˜æ˜¯çº¯ç²¹å› ä¸ºé¢˜ç›®é¡ºåºå˜äº†</li>
</ul>
<p>è¿™å°±åƒç§‘å­¦å®éªŒä¸­çš„<strong>ä¸å¯é‡å¤æ€§é—®é¢˜</strong>â€”â€”ä½ æ— æ³•ç¡®è®¤ç»“æœæ˜¯ç”±ä½ çš„æ”¹è¿›å¯¼è‡´çš„ï¼Œè¿˜æ˜¯è¿æ°”å¥½ç¢°åˆ°äº†ç®€å•çš„é¢˜ã€‚</p>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="è§£å†³æ–¹æ¡ˆå›ºå®šéšæœºç§å­--å›ºå®šé¢˜åº“é¡ºåº">è§£å†³æ–¹æ¡ˆï¼š<strong>å›ºå®šéšæœºç§å­</strong> = å›ºå®šé¢˜åº“é¡ºåº<a href="#è§£å†³æ–¹æ¡ˆå›ºå®šéšæœºç§å­--å›ºå®šé¢˜åº“é¡ºåº" class="hash-link" aria-label="Direct link to è§£å†³æ–¹æ¡ˆå›ºå®šéšæœºç§å­--å›ºå®šé¢˜åº“é¡ºåº" title="Direct link to è§£å†³æ–¹æ¡ˆå›ºå®šéšæœºç§å­--å›ºå®šé¢˜åº“é¡ºåº" translate="no">â€‹</a></h4>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">random</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">seed</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">seed</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># å›ºå®š Python å†…ç½®éšæœºæ•°ç”Ÿæˆå™¨</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">random</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">seed</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">seed</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">       </span><span class="token comment" style="color:#999988;font-style:italic"># å›ºå®š NumPy çš„éšæœºæ•°ç”Ÿæˆå™¨  </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">manual_seed</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">seed</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># å›ºå®š PyTorch CPU ä¸Šçš„éšæœºæ•°</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cuda</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">manual_seed</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">seed</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">       </span><span class="token comment" style="color:#999988;font-style:italic"># å›ºå®šå•ä¸ª GPU çš„éšæœºæ•°</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cuda</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">manual_seed_all</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">seed</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># å›ºå®šæ‰€æœ‰ GPU çš„éšæœºæ•°</span><br></span></code></pre></div></div>
<p><strong>éšå–»å¯¹åº”</strong>ï¼š</p>
<ul>
<li class=""><code>random.seed(seed)</code>ï¼šå›ºå®š Python è‡ªå·±çš„é¢˜åº“æ´—ç‰Œæ–¹å¼</li>
<li class=""><code>np.random.seed(seed)</code>ï¼šå›ºå®šæ•°æ®é¢„å¤„ç†ï¼ˆæ¯”å¦‚å›¾ç‰‡å¢å¼ºï¼‰çš„éšæœºæ€§</li>
<li class=""><code>torch.manual_seed(seed)</code>ï¼šå›ºå®šæ¨¡å‹åˆå§‹åŒ–æ—¶çš„&quot;å¤§è„‘åˆå§‹è¿æ¥æ–¹å¼&quot;</li>
<li class=""><code>torch.cuda.manual_seed_all(seed)</code>ï¼šå¦‚æœå°æ˜æœ‰å¤šä¸ª&quot;å‰¯å¤§è„‘&quot;ï¼ˆå¤šGPUï¼‰ï¼Œè®©å®ƒä»¬çš„åˆå§‹çŠ¶æ€ä¹Ÿä¸€è‡´</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="é¢å¤–çš„ä¸¥æ ¼æªæ–½å…³é—­è‡ªåŠ¨ä¼˜åŒ–">é¢å¤–çš„ä¸¥æ ¼æªæ–½ï¼šå…³é—­è‡ªåŠ¨ä¼˜åŒ–<a href="#é¢å¤–çš„ä¸¥æ ¼æªæ–½å…³é—­è‡ªåŠ¨ä¼˜åŒ–" class="hash-link" aria-label="Direct link to é¢å¤–çš„ä¸¥æ ¼æªæ–½ï¼šå…³é—­è‡ªåŠ¨ä¼˜åŒ–" title="Direct link to é¢å¤–çš„ä¸¥æ ¼æªæ–½ï¼šå…³é—­è‡ªåŠ¨ä¼˜åŒ–" translate="no">â€‹</a></h4>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">backends</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cudnn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">deterministic </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># å¼ºåˆ¶ä½¿ç”¨ç¡®å®šæ€§ç®—æ³•</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">backends</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cudnn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">benchmark </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">False</span><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic"># ç¦ç”¨è‡ªåŠ¨ç®—æ³•é€‰æ‹©</span><br></span></code></pre></div></div>
<p><strong>éšå–»</strong>ï¼š</p>
<ul>
<li class=""><code>deterministic = True</code>ï¼šå¼ºåˆ¶è¦æ±‚&quot;æ¯æ¬¡è®¡ç®—éƒ½ç”¨ç›¸åŒçš„è§£é¢˜æ­¥éª¤&quot;ï¼Œå“ªæ€•æ…¢ä¸€ç‚¹<!-- -->
<ul>
<li class="">ç±»ä¼¼äºï¼šè¦æ±‚å°æ˜æ¯æ¬¡å†™ä½œæ–‡éƒ½ä¸¥æ ¼æŒ‰ç…§&quot;å¼€å¤´-å‘å±•-é«˜æ½®-ç»“å°¾&quot;çš„æ­¥éª¤ï¼Œä¸å…è®¸è·³æ­¥</li>
</ul>
</li>
<li class=""><code>benchmark = False</code>ï¼šå…³é—­&quot;è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜ç®—æ³•&quot;åŠŸèƒ½<!-- -->
<ul>
<li class="">ç±»ä¼¼äºï¼šç¦æ­¢å°æ˜åœ¨è€ƒè¯•æ—¶&quot;çœ‹é¢˜ç›®éš¾åº¦ä¸´æ—¶è°ƒæ•´ç­”é¢˜ç­–ç•¥&quot;ï¼Œå¿…é¡»ç”¨å›ºå®šå¥—è·¯</li>
</ul>
</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¹ˆåš">ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¹ˆåšï¼Ÿ<a href="#ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¹ˆåš" class="hash-link" aria-label="Direct link to ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¹ˆåšï¼Ÿ" title="Direct link to ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¹ˆåšï¼Ÿ" translate="no">â€‹</a></h4>
<table><thead><tr><th>åœºæ™¯</th><th>ä¸è®¾ç½®éšæœºç§å­</th><th>è®¾ç½®éšæœºç§å­</th></tr></thead><tbody><tr><td><strong>å®éªŒå¯¹æ¯”</strong></td><td>æ— æ³•ç¡®è®¤æ”¹è¿›æ˜¯å¦æœ‰æ•ˆ</td><td>å¯ä»¥ç²¾ç¡®å¯¹æ¯”ä¸åŒæ–¹æ³•çš„æ•ˆæœ</td></tr><tr><td><strong>Bug è°ƒè¯•</strong></td><td>æ¯æ¬¡è¿è¡Œç»“æœä¸åŒï¼Œæ— æ³•å®šä½é—®é¢˜</td><td>æ¯æ¬¡è¿è¡Œç»“æœä¸€è‡´ï¼Œæ–¹ä¾¿æ’æŸ¥</td></tr><tr><td><strong>è®ºæ–‡å¤ç°</strong></td><td>åˆ«äººæ— æ³•å¤ç°ä½ çš„ç»“æœ</td><td>æä¾›ç§å­å€¼åï¼Œåˆ«äººå¯ä»¥å®Œå…¨å¤ç°</td></tr><tr><td><strong>åä½œå¼€å‘</strong></td><td>å›¢é˜Ÿæˆå‘˜çœ‹åˆ°ä¸åŒçš„è®­ç»ƒæ›²çº¿</td><td>å¤§å®¶çœ‹åˆ°ç›¸åŒçš„è®­ç»ƒè¿‡ç¨‹</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-ç±»æ¯”æ€»ç»“">ğŸ’¡ ç±»æ¯”æ€»ç»“<a href="#-ç±»æ¯”æ€»ç»“" class="hash-link" aria-label="Direct link to ğŸ’¡ ç±»æ¯”æ€»ç»“" title="Direct link to ğŸ’¡ ç±»æ¯”æ€»ç»“" translate="no">â€‹</a></h3>
<p>è®¾ç½®éšæœºç§å­å°±åƒï¼š</p>
<ol>
<li class=""><strong>æ‘„å½±æ£šæ‰“å…‰</strong>ï¼šæ¯æ¬¡æ‹æ‘„éƒ½ç”¨ç›¸åŒçš„ç¯å…‰å¸ƒç½®ï¼Œè¿™æ ·å¯¹æ¯”ç…§ç‰‡æ—¶ï¼Œå·®å¼‚åªæ¥è‡ªæ¼”å‘˜è¡¨ç°ï¼Œè€Œä¸æ˜¯å…‰çº¿å˜åŒ–</li>
<li class=""><strong>è€ƒè¯•æ ‡å‡†åŒ–</strong>ï¼šè®©æ‰€æœ‰å­¦ç”ŸåšåŒä¸€å¥—å·å­ï¼Œå…¬å¹³æ¯”è¾ƒè°å­¦å¾—æ›´å¥½</li>
<li class=""><strong>èœè°±é…æ–¹</strong>ï¼šä¸¥æ ¼æŒ‰ç…§&quot;ç›5å…‹ã€ç³–10å…‹&quot;çš„é…æ–¹ï¼Œè€Œä¸æ˜¯&quot;é€‚é‡&quot;ï¼Œè¿™æ ·æ‰èƒ½ç¨³å®šå¤ç°ç¾å‘³</li>
</ol>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="ï¸-æ³¨æ„äº‹é¡¹">âš ï¸ æ³¨æ„äº‹é¡¹<a href="#ï¸-æ³¨æ„äº‹é¡¹" class="hash-link" aria-label="Direct link to âš ï¸ æ³¨æ„äº‹é¡¹" title="Direct link to âš ï¸ æ³¨æ„äº‹é¡¹" translate="no">â€‹</a></h3>
<ol>
<li class="">
<p><strong>æ€§èƒ½ä»£ä»·</strong>ï¼š</p>
<ul>
<li class="">è®¾ç½® <code>deterministic=True</code> ä¼š<strong>ç‰ºç‰²ä¸€äº›é€Ÿåº¦</strong>ï¼Œå› ä¸ºç¦ç”¨äº†æŸäº›å¿«é€Ÿä½†éç¡®å®šæ€§çš„ç®—æ³•</li>
<li class="">é€‚åˆ<strong>å®éªŒéªŒè¯é˜¶æ®µ</strong>ï¼Œç”Ÿäº§ç¯å¢ƒå¯ä»¥å…³é—­ä»¥æé€Ÿ</li>
</ul>
</li>
<li class="">
<p><strong>å¹¶ä¸æ˜¯100%ç¡®å®šæ€§</strong>ï¼š</p>
<ul>
<li class="">å³ä½¿è®¾ç½®äº†ç§å­ï¼Œåœ¨<strong>ä¸åŒç¡¬ä»¶</strong>ï¼ˆå¦‚ä¸åŒå‹å·çš„GPUï¼‰æˆ–<strong>ä¸åŒPyTorchç‰ˆæœ¬</strong>ä¸Šï¼Œç»“æœä»å¯èƒ½ç•¥æœ‰å·®å¼‚</li>
<li class="">å°±åƒç›¸åŒèœè°±åœ¨ä¸åŒå“ç‰Œçš„çƒ¤ç®±é‡Œï¼Œæ¸©åº¦æ›²çº¿ä¼šæœ‰å¾®å°åŒºåˆ«</li>
</ul>
</li>
<li class="">
<p><strong>ç§å­å€¼çš„é€‰æ‹©</strong>ï¼š</p>
<ul>
<li class="">é€šå¸¸é€‰æ‹© <code>42</code>ï¼ˆç¨‹åºå‘˜æ¢—ï¼Œæºè‡ªã€Šé“¶æ²³ç³»æ¼«æ¸¸æŒ‡å—ã€‹ï¼‰ã€<code>0</code>ã€<code>1234</code> ç­‰ä»»æ„æ•´æ•°</li>
<li class="">åªè¦ä¿æŒä¸€è‡´å³å¯ï¼Œå…·ä½“æ•°å€¼å¹¶ä¸é‡è¦</li>
</ul>
</li>
</ol>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_aDle" id="äºŒè®¾è®¡å¤§è„‘è“å›¾minimindconfig-é…ç½®ç±»">äºŒã€è®¾è®¡å¤§è„‘è“å›¾ï¼šMiniMindConfig é…ç½®ç±»<a href="#äºŒè®¾è®¡å¤§è„‘è“å›¾minimindconfig-é…ç½®ç±»" class="hash-link" aria-label="Direct link to äºŒã€è®¾è®¡å¤§è„‘è“å›¾ï¼šMiniMindConfig é…ç½®ç±»" title="Direct link to äºŒã€è®¾è®¡å¤§è„‘è“å›¾ï¼šMiniMindConfig é…ç½®ç±»" translate="no">â€‹</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-ä»£ç ç‰‡æ®µ-ç¬¬-27-102-è¡Œ">ğŸ“ ä»£ç ç‰‡æ®µ (ç¬¬ 27-102 è¡Œ)<a href="#-ä»£ç ç‰‡æ®µ-ç¬¬-27-102-è¡Œ" class="hash-link" aria-label="Direct link to ğŸ“ ä»£ç ç‰‡æ®µ (ç¬¬ 27-102 è¡Œ)" title="Direct link to ğŸ“ ä»£ç ç‰‡æ®µ (ç¬¬ 27-102 è¡Œ)" translate="no">â€‹</a></h3>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">MiniMindConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">PretrainedConfig</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    model_type </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;minimind&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__init__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dropout</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">float</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        bos_token_id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        eos_token_id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hidden_act</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;silu&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hidden_size</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">512</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        intermediate_size</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        max_position_embeddings</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">32768</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        num_attention_heads</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        num_hidden_layers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        num_key_value_heads</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        vocab_size</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6400</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rms_norm_eps</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">float</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1e-05</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        rope_theta</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000000.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        inference_rope_scaling</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">bool</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        flash_attn</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">bool</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">####################################################</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Here are the specific configurations of MOE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># When use_moe is false, the following is invalid</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">####################################################</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        use_moe</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">bool</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        num_experts_per_tok</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        n_routed_experts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        n_shared_experts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        scoring_func</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;softmax&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        aux_loss_alpha</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">float</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.01</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        seq_aux</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">bool</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        norm_topk_prob</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">bool</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">**</span><span class="token plain">kwargs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token builtin">super</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">__init__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">**</span><span class="token plain">kwargs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dropout </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> dropout</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bos_token_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> bos_token_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">eos_token_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> eos_token_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hidden_act </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> hidden_act</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hidden_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> hidden_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">intermediate_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> intermediate_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">max_position_embeddings </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> max_position_embeddings</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">num_attention_heads </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> num_attention_heads</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">num_hidden_layers </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> num_hidden_layers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">num_key_value_heads </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> num_key_value_heads</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">vocab_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> vocab_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">rms_norm_eps </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> rms_norm_eps</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">rope_theta </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> rope_theta</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">inference_rope_scaling </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> inference_rope_scaling</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># å¤–æ¨é•¿åº¦ = factor * original_max_position_embeddings = 32768</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">rope_scaling </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;beta_fast&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;beta_slow&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;factor&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;original_max_position_embeddings&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2048</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;attention_factor&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string" style="color:#e3116c">&quot;type&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;yarn&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">inference_rope_scaling</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flash_attn </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> flash_attn</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">####################################################</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># Here are the specific configurations of MOE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># When use_moe is false, the following is invalid</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">####################################################</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">use_moe </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> use_moe</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">num_experts_per_tok </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> num_experts_per_tok  </span><span class="token comment" style="color:#999988;font-style:italic"># æ¯ä¸ªtokené€‰æ‹©çš„ä¸“å®¶æ•°é‡</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">n_routed_experts </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> n_routed_experts  </span><span class="token comment" style="color:#999988;font-style:italic"># æ€»çš„ä¸“å®¶æ•°é‡</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">n_shared_experts </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> n_shared_experts  </span><span class="token comment" style="color:#999988;font-style:italic"># å…±äº«ä¸“å®¶</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">scoring_func </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> scoring_func  </span><span class="token comment" style="color:#999988;font-style:italic"># è¯„åˆ†å‡½æ•°,é»˜è®¤ä¸º&#x27;softmax&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">aux_loss_alpha </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> aux_loss_alpha  </span><span class="token comment" style="color:#999988;font-style:italic"># è¾…åŠ©æŸå¤±çš„alphaå‚æ•°</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">seq_aux </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> seq_aux  </span><span class="token comment" style="color:#999988;font-style:italic"># æ˜¯å¦åœ¨åºåˆ—çº§åˆ«ä¸Šè®¡ç®—è¾…åŠ©æŸå¤±</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">norm_topk_prob </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> norm_topk_prob  </span><span class="token comment" style="color:#999988;font-style:italic"># æ˜¯å¦æ ‡å‡†åŒ–top-kæ¦‚ç‡</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-éšå–»ç¿»è¯‘è®¾è®¡å°æ˜çš„å¤§è„‘è“å›¾">ğŸ¯ éšå–»ç¿»è¯‘ï¼šè®¾è®¡å°æ˜çš„å¤§è„‘è“å›¾<a href="#-éšå–»ç¿»è¯‘è®¾è®¡å°æ˜çš„å¤§è„‘è“å›¾" class="hash-link" aria-label="Direct link to ğŸ¯ éšå–»ç¿»è¯‘ï¼šè®¾è®¡å°æ˜çš„å¤§è„‘è“å›¾" title="Direct link to ğŸ¯ éšå–»ç¿»è¯‘ï¼šè®¾è®¡å°æ˜çš„å¤§è„‘è“å›¾" translate="no">â€‹</a></h3>
<p>åœ¨æ•™å°æ˜å†™å°è¯´ä¹‹å‰,æˆ‘ä»¬éœ€è¦<strong>ç»™å°æ˜è®¾è®¡ä¸€ä¸ª&quot;å¤§è„‘&quot;</strong>ã€‚MiniMindConfig å°±åƒæ˜¯å¤§è„‘çš„è®¾è®¡å›¾çº¸,ä¸Šé¢æ ‡æ³¨äº†å„ç§å‚æ•°:è®°å¿†å®¹é‡å¤šå¤§ã€æ€è€ƒé€Ÿåº¦å¤šå¿«ã€æ³¨æ„åŠ›æœºåˆ¶æ€ä¹ˆå·¥ä½œç­‰ç­‰ã€‚</p>
<p>è®©æˆ‘ä»¬é€ä¸ªæ‹†è§£è¿™äº›å‚æ•°:</p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-æ ¸å¿ƒç»“æ„å‚æ•°">ğŸ§  æ ¸å¿ƒç»“æ„å‚æ•°<a href="#-æ ¸å¿ƒç»“æ„å‚æ•°" class="hash-link" aria-label="Direct link to ğŸ§  æ ¸å¿ƒç»“æ„å‚æ•°" title="Direct link to ğŸ§  æ ¸å¿ƒç»“æ„å‚æ•°" translate="no">â€‹</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="1-hidden_size-int--512-å¤§è„‘çš„ç¥ç»å…ƒæ€»æ•°">1. <code>hidden_size: int = 512</code> (å¤§è„‘çš„&quot;ç¥ç»å…ƒæ€»æ•°&quot;)<a href="#1-hidden_size-int--512-å¤§è„‘çš„ç¥ç»å…ƒæ€»æ•°" class="hash-link" aria-label="Direct link to 1-hidden_size-int--512-å¤§è„‘çš„ç¥ç»å…ƒæ€»æ•°" title="Direct link to 1-hidden_size-int--512-å¤§è„‘çš„ç¥ç»å…ƒæ€»æ•°" translate="no">â€‹</a></h4>
<p><strong>ä»£ç ä½ç½®</strong>: ç¬¬ 36 è¡Œ</p>
<p><strong>ä½œç”¨</strong>: å†³å®šæ¨¡å‹å†…éƒ¨è¡¨ç¤ºçš„ç»´åº¦å¤§å°ã€‚</p>
<p><strong>éšå–»è§£é‡Š</strong>:</p>
<p>æƒ³è±¡å°æ˜çš„å¤§è„‘æœ‰ <strong>512 ä¸ªç¥ç»å…ƒç»†èƒ</strong>ã€‚æ¯å½“å°æ˜è¯»åˆ°ä¸€ä¸ªè¯(æ¯”å¦‚&quot;çˆ±æƒ…&quot;),è¿™ä¸ªè¯ä¼šè¢«è½¬æ¢æˆä¸€ä¸ªåŒ…å« 512 ä¸ªæ•°å­—çš„å‘é‡(ç±»ä¼¼äº 512 ä¸ªç¥ç»å…ƒçš„æ¿€æ´»çŠ¶æ€)ã€‚</p>
<ul>
<li class=""><strong><code>hidden_size=512</code></strong>: å°æ˜æœ‰ 512 ä¸ªç¥ç»å…ƒ,é€‚åˆç†è§£ç®€å•çš„æ•…äº‹æƒ…èŠ‚</li>
<li class=""><strong><code>hidden_size=4096</code></strong> (åƒ Llama-7B): å°æ˜æœ‰ 4096 ä¸ªç¥ç»å…ƒ,èƒ½å¤„ç†æ›´å¤æ‚çš„é€»è¾‘å’Œç»†èŠ‚</li>
</ul>
<p><strong>ç±»æ¯”</strong>:</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">hidden_size = å¤§è„‘çš„&quot;åƒç´ åˆ†è¾¨ç‡&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- hidden_size=128  â†’ çœ‹ä¸–ç•Œå°±åƒ 16x16 çš„é©¬èµ›å…‹å›¾ç‰‡</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- hidden_size=512  â†’ çœ‹ä¸–ç•Œå°±åƒ 480p çš„æ ‡æ¸…è§†é¢‘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- hidden_size=4096 â†’ çœ‹ä¸–ç•Œå°±åƒ 4K è¶…æ¸…ç”»é¢</span><br></span></code></pre></div></div>
<p><strong>æŠ€æœ¯ç»†èŠ‚</strong>:</p>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># åœ¨ä»£ç ä¸­çš„åº”ç”¨ç¤ºä¾‹</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">embed_tokens </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Embedding</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">vocab_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> hidden_size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># æŠŠæ¯ä¸ªè¯(vocab_sizeç§)æ˜ å°„æˆ hidden_size ç»´çš„å‘é‡</span><br></span></code></pre></div></div>
<hr>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="2-num_hidden_layers-int--8-å¤§è„‘çš„æ€è€ƒå±‚æ•°">2. <code>num_hidden_layers: int = 8</code> (å¤§è„‘çš„&quot;æ€è€ƒå±‚æ•°&quot;)<a href="#2-num_hidden_layers-int--8-å¤§è„‘çš„æ€è€ƒå±‚æ•°" class="hash-link" aria-label="Direct link to 2-num_hidden_layers-int--8-å¤§è„‘çš„æ€è€ƒå±‚æ•°" title="Direct link to 2-num_hidden_layers-int--8-å¤§è„‘çš„æ€è€ƒå±‚æ•°" translate="no">â€‹</a></h4>
<p><strong>ä»£ç ä½ç½®</strong>: ç¬¬ 40 è¡Œ</p>
<p><strong>ä½œç”¨</strong>: å†³å®šæ¨¡å‹å †å äº†å¤šå°‘å±‚ Transformer Blockã€‚</p>
<p><strong>éšå–»è§£é‡Š</strong>:</p>
<p>å°æ˜å¤„ç†ä¸€ä¸ªé—®é¢˜æ—¶,ä¼šç»è¿‡ <strong>8 è½®æ·±åº¦æ€è€ƒ</strong>:</p>
<ol>
<li class=""><strong>ç¬¬ 1 å±‚</strong>: è¯†åˆ«åŸºæœ¬è¯è¯­(&quot;ç«ç‘°&quot;ã€&quot;çˆ±æƒ…&quot;)</li>
<li class=""><strong>ç¬¬ 2 å±‚</strong>: ç†è§£ç®€å•å…³ç³»(&quot;ç«ç‘°è±¡å¾çˆ±æƒ…&quot;)</li>
<li class=""><strong>ç¬¬ 3 å±‚</strong>: æŠŠæ¡å¥å­ç»“æ„(&quot;ä»–é€å¥¹ä¸€æœµç«ç‘°&quot;)</li>
<li class=""><strong>ç¬¬ 4 å±‚</strong>: ç†è§£æƒ…æ„Ÿè‰²å½©(&quot;æš—ç¤ºçˆ±æ„çš„è¡¨è¾¾&quot;)</li>
<li class=""><strong>ç¬¬ 5-8 å±‚</strong>: æ›´é«˜çº§çš„é€»è¾‘æ¨ç†ã€éšå–»ç†è§£ã€æƒ…èŠ‚è¿è´¯æ€§...</li>
</ol>
<p><strong>å±‚æ•°è¶Šå¤š</strong> = æ€è€ƒè¶Šæ·±å…¥,ä½†ä¹Ÿéœ€è¦æ›´å¤š&quot;è®¡ç®—æ—¶é—´&quot;(æ›´æ…¢,æ›´è€—æ˜¾å­˜)ã€‚</p>
<p><strong>ç±»æ¯”</strong>:</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">å†™ä½œæ–‡æ—¶çš„æ€è€ƒæ­¥éª¤:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">num_layers=1  â†’ çœ‹åˆ°é¢˜ç›®å°±ç›´æ¥å†™(å¹¼å„¿å›­æ°´å¹³)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">num_layers=8  â†’ å®¡é¢˜â†’æ„æ€â†’åˆ—æçº²â†’å†™è‰ç¨¿â†’ä¿®æ”¹æ¶¦è‰²(ä¸­å­¦ç”Ÿæ°´å¹³)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">num_layers=32 â†’ æ·±åº¦å“²å­¦æ€è¾¨ã€åå¤æ¨æ•²ç»†èŠ‚(å­¦æœ¯è®ºæ–‡æ°´å¹³,å¦‚ Llama-70B)</span><br></span></code></pre></div></div>
<p><strong>ç»éªŒæ³•åˆ™</strong>:</p>
<table><thead><tr><th>æ¨¡å‹è§„æ¨¡</th><th>å±‚æ•°</th><th>å¯¹åº”èƒ½åŠ›</th></tr></thead><tbody><tr><td>å°æ¨¡å‹ (&lt; 1B)</td><td>8-12 å±‚</td><td>ç®€å•å¯¹è¯ã€åŸºç¡€é—®ç­”</td></tr><tr><td>ä¸­æ¨¡å‹ (1B-10B)</td><td>24-32 å±‚</td><td>ä»£ç ç”Ÿæˆã€é•¿æ–‡æ‘˜è¦</td></tr><tr><td>å¤§æ¨¡å‹ (&gt; 10B)</td><td>40-80 å±‚</td><td>å¤æ‚æ¨ç†ã€åˆ›æ„å†™ä½œ</td></tr></tbody></table>
<hr>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="3-num_attention_heads-int--8-å¤§è„‘çš„æ³¨æ„åŠ›æ¢ç…§ç¯æ•°é‡">3. <code>num_attention_heads: int = 8</code> (å¤§è„‘çš„&quot;æ³¨æ„åŠ›æ¢ç…§ç¯æ•°é‡&quot;)<a href="#3-num_attention_heads-int--8-å¤§è„‘çš„æ³¨æ„åŠ›æ¢ç…§ç¯æ•°é‡" class="hash-link" aria-label="Direct link to 3-num_attention_heads-int--8-å¤§è„‘çš„æ³¨æ„åŠ›æ¢ç…§ç¯æ•°é‡" title="Direct link to 3-num_attention_heads-int--8-å¤§è„‘çš„æ³¨æ„åŠ›æ¢ç…§ç¯æ•°é‡" translate="no">â€‹</a></h4>
<p><strong>ä»£ç ä½ç½®</strong>: ç¬¬ 39 è¡Œ</p>
<p><strong>ä½œç”¨</strong>: å†³å®šè‡ªæ³¨æ„åŠ›æœºåˆ¶ä¸­æœ‰å¤šå°‘ä¸ª&quot;æ³¨æ„åŠ›å¤´&quot;ã€‚</p>
<p><strong>éšå–»è§£é‡Š</strong>:</p>
<p>å°æ˜åœ¨é˜…è¯»ä¸€å¥è¯æ—¶,ä¼šåŒæ—¶ç”¨ <strong>8 ä¸ªæ¢ç…§ç¯</strong> å…³æ³¨ä¸åŒçš„é‡ç‚¹:</p>
<p><strong>ç¤ºä¾‹å¥å­</strong>: &quot;å°çº¢å¸½èµ°è¿›æ£®æ—,é‡åˆ°äº†å¤§ç°ç‹¼&quot;</p>
<ul>
<li class=""><strong>æ¢ç…§ç¯ 1</strong>: å…³æ³¨ä¸»è¯­(&quot;å°çº¢å¸½&quot;)</li>
<li class=""><strong>æ¢ç…§ç¯ 2</strong>: å…³æ³¨åŠ¨ä½œ(&quot;èµ°è¿›&quot;)</li>
<li class=""><strong>æ¢ç…§ç¯ 3</strong>: å…³æ³¨åœ°ç‚¹(&quot;æ£®æ—&quot;)</li>
<li class=""><strong>æ¢ç…§ç¯ 4</strong>: å…³æ³¨å› æœå…³ç³»(&quot;èµ°è¿›&quot; â†’ &quot;é‡åˆ°&quot;)</li>
<li class=""><strong>æ¢ç…§ç¯ 5</strong>: å…³æ³¨è§’è‰²å…³ç³»(&quot;å°çº¢å¸½&quot; vs &quot;å¤§ç°ç‹¼&quot;)</li>
<li class=""><strong>æ¢ç…§ç¯ 6-8</strong>: å…³æ³¨è¯­æ°”ã€æƒ…æ„Ÿã€æ½œåœ¨å±é™©æš—ç¤º...</li>
</ul>
<p><strong>ä¸ºä»€ä¹ˆéœ€è¦å¤šä¸ªå¤´?</strong></p>
<p>å•ä¸ªæ³¨æ„åŠ›å¤´å¯èƒ½åªå…³æ³¨ä¸€ç§æ¨¡å¼(æ¯”å¦‚åªçœ‹åè¯),è€Œå¤šä¸ªå¤´èƒ½<strong>å¹¶è¡Œå…³æ³¨ä¸åŒç»´åº¦çš„ä¿¡æ¯</strong>,ç„¶åç»¼åˆèµ·æ¥å½¢æˆå…¨é¢ç†è§£ã€‚</p>
<p><strong>ç±»æ¯”</strong>:</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">çœ‹ç”µå½±æ—¶çš„æ³¨æ„åŠ›åˆ†é…:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">num_heads=1  â†’ åªç›¯ç€ä¸»è§’,å¿½ç•¥èƒŒæ™¯å’Œé…è§’</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">num_heads=8  â†’ åŒæ—¶å…³æ³¨:ä¸»è§’è¡¨æƒ…ã€èƒŒæ™¯éŸ³ä¹ã€é•œå¤´è¿åŠ¨ã€é…è§’ååº”...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">num_heads=32 â†’ åƒä¸“ä¸šå½±è¯„äºº,è¿é“å…·ç»†èŠ‚ã€è‰²å½©éšå–»éƒ½ä¸æ”¾è¿‡</span><br></span></code></pre></div></div>
<p><strong>æŠ€æœ¯ç»†èŠ‚</strong>:</p>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># åœ¨æ³¨æ„åŠ›æœºåˆ¶ä¸­çš„åº”ç”¨</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">head_dim </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> hidden_size </span><span class="token operator" style="color:#393A34">//</span><span class="token plain"> num_attention_heads  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># æ¯ä¸ªæ³¨æ„åŠ›å¤´è´Ÿè´£çš„ç»´åº¦ = 512 / 8 = 64 ç»´</span><br></span></code></pre></div></div>
<hr>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="4-num_key_value_heads-int--2-åˆ†ç»„æŸ¥è¯¢æ³¨æ„åŠ›-gqa">4. <code>num_key_value_heads: int = 2</code> (åˆ†ç»„æŸ¥è¯¢æ³¨æ„åŠ› GQA)<a href="#4-num_key_value_heads-int--2-åˆ†ç»„æŸ¥è¯¢æ³¨æ„åŠ›-gqa" class="hash-link" aria-label="Direct link to 4-num_key_value_heads-int--2-åˆ†ç»„æŸ¥è¯¢æ³¨æ„åŠ›-gqa" title="Direct link to 4-num_key_value_heads-int--2-åˆ†ç»„æŸ¥è¯¢æ³¨æ„åŠ›-gqa" translate="no">â€‹</a></h4>
<p><strong>ä»£ç ä½ç½®</strong>: ç¬¬ 41 è¡Œ</p>
<p><strong>ä½œç”¨</strong>: åœ¨åˆ†ç»„æŸ¥è¯¢æ³¨æ„åŠ›(GQA)ä¸­,Key å’Œ Value ä½¿ç”¨çš„å¤´æ•°(é€šå¸¸å°‘äº Query çš„å¤´æ•°)ã€‚</p>
<p><strong>éšå–»è§£é‡Š</strong>:</p>
<p>è¿™æ˜¯ä¸€ä¸ª<strong>ä¼˜åŒ–æŠ€å·§</strong>,ç”¨æ¥èŠ‚çœå°æ˜çš„&quot;è®°å¿†å­˜å‚¨ç©ºé—´&quot;ã€‚</p>
<p><strong>æ ‡å‡†æ³¨æ„åŠ›æœºåˆ¶(MHA)</strong>:</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">Query (é—®é¢˜) æœ‰ 8 ä¸ªå¤´</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Key   (ç´¢å¼•) æœ‰ 8 ä¸ªå¤´  â† æ¯ä¸ªå¤´éƒ½æœ‰ç‹¬ç«‹çš„ Key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Value (ç­”æ¡ˆ) æœ‰ 8 ä¸ªå¤´  â† æ¯ä¸ªå¤´éƒ½æœ‰ç‹¬ç«‹çš„ Value</span><br></span></code></pre></div></div>
<p><strong>åˆ†ç»„æŸ¥è¯¢æ³¨æ„åŠ›(GQA)</strong>:</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">Query (é—®é¢˜) æœ‰ 8 ä¸ªå¤´</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Key   (ç´¢å¼•) æœ‰ 2 ä¸ªå¤´  â† å¤šä¸ª Query å…±äº«åŒä¸€ä¸ª Key</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Value (ç­”æ¡ˆ) æœ‰ 2 ä¸ªå¤´  â† å¤šä¸ª Query å…±äº«åŒä¸€ä¸ª Value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">åˆ†ç»„æ–¹å¼:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Queryå¤´ 0, 1, 2, 3 â†’ å…±äº« Key-Valueå¤´ 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Queryå¤´ 4, 5, 6, 7 â†’ å…±äº« Key-Valueå¤´ 1</span><br></span></code></pre></div></div>
<p><strong>ç±»æ¯”</strong>:</p>
<p>æƒ³è±¡å›¾ä¹¦é¦†çš„æ£€ç´¢ç³»ç»Ÿ:</p>
<ul>
<li class=""><strong>MHA</strong>(Multi-Head Attention): 8 ä¸ªè¯»è€…,æ¯äººæœ‰ä¸€æœ¬<strong>ä¸“å±çš„å›¾ä¹¦ç›®å½•</strong></li>
<li class=""><strong>GQA</strong>(Grouped Query Attention): 8 ä¸ªè¯»è€…,ä½†åªæœ‰ 2 æœ¬<strong>å…±äº«çš„å›¾ä¹¦ç›®å½•</strong>(æ¯ 4 äººå…±ç”¨ä¸€æœ¬)</li>
<li class=""><strong>å¥½å¤„</strong>: ç›®å½•å†Œå°‘äº†,å­˜å‚¨ç©ºé—´çœäº† 75%,ä½†æ£€ç´¢æ•ˆç‡åŸºæœ¬ä¸é™</li>
</ul>
<p><strong>å®é™…æ•ˆæœ</strong>:</p>
<ul>
<li class=""><strong>æ˜¾å­˜èŠ‚çœ</strong>: KV Cache ä» <code>8 * seq_len * head_dim</code> é™åˆ° <code>2 * seq_len * head_dim</code></li>
<li class=""><strong>é€Ÿåº¦æå‡</strong>: æ¨ç†æ—¶å‡å°‘å†…å­˜è®¿é—®,å°¤å…¶åœ¨é•¿æ–‡æœ¬ç”Ÿæˆæ—¶æ•ˆæœæ˜æ˜¾</li>
<li class=""><strong>æ€§èƒ½æŸå¤±</strong>: å‡ ä¹æ²¡æœ‰(Meta çš„ Llama 2 è®ºæ–‡è¯æ˜ GQA æ€§èƒ½æ¥è¿‘ MHA)</li>
</ul>
<hr>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="5-vocab_size-int--6400-å°æ˜çš„è¯æ±‡é‡">5. <code>vocab_size: int = 6400</code> (å°æ˜çš„&quot;è¯æ±‡é‡&quot;)<a href="#5-vocab_size-int--6400-å°æ˜çš„è¯æ±‡é‡" class="hash-link" aria-label="Direct link to 5-vocab_size-int--6400-å°æ˜çš„è¯æ±‡é‡" title="Direct link to 5-vocab_size-int--6400-å°æ˜çš„è¯æ±‡é‡" translate="no">â€‹</a></h4>
<p><strong>ä»£ç ä½ç½®</strong>: ç¬¬ 42 è¡Œ</p>
<p><strong>ä½œç”¨</strong>: æ¨¡å‹èƒ½è¯†åˆ«çš„ä¸åŒ token(è¯æˆ–å­—ç¬¦)æ•°é‡ã€‚</p>
<p><strong>éšå–»è§£é‡Š</strong>:</p>
<p>å°æ˜çš„è¯æ±‡è¡¨é‡Œæœ‰ <strong>6400 ä¸ªè¯</strong>ã€‚</p>
<p><strong>ä¾‹å­</strong>:</p>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">vocab </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&lt;PAD&gt;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># å¡«å……ç¬¦å·</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&lt;BOS&gt;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># å¥å­å¼€å§‹</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&lt;EOS&gt;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># å¥å­ç»“æŸ</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;æˆ‘&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;çˆ±&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ä½ &quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">6399</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;é‡å­çº ç¼ &quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p><strong>ä¸åŒ vocab_size çš„å¯¹æ¯”</strong>:</p>
<table><thead><tr><th>Vocab Size</th><th>è¦†ç›–è¯­è¨€</th><th>å…¸å‹åº”ç”¨</th></tr></thead><tbody><tr><td>6,400</td><td>ä¸­æ–‡å¸¸ç”¨å­— + åŸºç¡€è¯æ±‡</td><td>ä¸­æ–‡å°è¯´ç”Ÿæˆ</td></tr><tr><td>32,000</td><td>ä¸­è‹±æ–‡æ··åˆ</td><td>GPT-2</td></tr><tr><td>50,257</td><td>è‹±æ–‡ + ç‰¹æ®Šç¬¦å·</td><td>GPT-3</td></tr><tr><td>100,000+</td><td>å¤šè¯­è¨€ + ä»£ç </td><td>Llama 2</td></tr></tbody></table>
<p><strong>ä¸ºä»€ä¹ˆä¸è®¾ç½®å¾—è¶Šå¤§è¶Šå¥½?</strong></p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">è¯æ±‡é‡å¤ªå°(å¦‚ 1000):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ä¼˜ç‚¹: æ¨¡å‹å°,è®­ç»ƒå¿«</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ç¼ºç‚¹: å¾ˆå¤šè¯è¡¨è¾¾ä¸äº†,åªèƒ½ç”¨ç»„åˆ(å¦‚&quot;é‡å­&quot;+&quot;çº ç¼ &quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">è¯æ±‡é‡å¤ªå¤§(å¦‚ 100000):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ä¼˜ç‚¹: è¦†ç›–æ›´å¤šç”Ÿåƒ»è¯å’Œä¸“ä¸šæœ¯è¯­</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ç¼ºç‚¹: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  1. å¢åŠ æ¨¡å‹å‚æ•°é‡(åµŒå…¥å±‚å ç”¨ç©ºé—´å¤§)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  2. æ¯ä¸ªè¯çš„è®­ç»ƒæ ·æœ¬å˜å°‘(ç¨€ç–æ€§é—®é¢˜)</span><br></span></code></pre></div></div>
<p><strong>æŠ€æœ¯ç»†èŠ‚</strong>:</p>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># åµŒå…¥å±‚çš„å‚æ•°é‡è®¡ç®—</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">embedding_params </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> vocab_size </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> hidden_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 6400 * 512 = 3,276,800 ä¸ªå‚æ•°</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># å¦‚æœ vocab_size æ‰©å¤§åˆ° 64000,å‚æ•°é‡å°±ä¼š x10</span><br></span></code></pre></div></div>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="ï¸-ä¼˜åŒ–ä¸æŠ€å·§å‚æ•°">âš™ï¸ ä¼˜åŒ–ä¸æŠ€å·§å‚æ•°<a href="#ï¸-ä¼˜åŒ–ä¸æŠ€å·§å‚æ•°" class="hash-link" aria-label="Direct link to âš™ï¸ ä¼˜åŒ–ä¸æŠ€å·§å‚æ•°" title="Direct link to âš™ï¸ ä¼˜åŒ–ä¸æŠ€å·§å‚æ•°" translate="no">â€‹</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="6-intermediate_size-int--none-ffn-çš„ä¸­é—´å±‚æ‰©å¼ å€æ•°">6. <code>intermediate_size: int = None</code> (FFN çš„&quot;ä¸­é—´å±‚æ‰©å¼ å€æ•°&quot;)<a href="#6-intermediate_size-int--none-ffn-çš„ä¸­é—´å±‚æ‰©å¼ å€æ•°" class="hash-link" aria-label="Direct link to 6-intermediate_size-int--none-ffn-çš„ä¸­é—´å±‚æ‰©å¼ å€æ•°" title="Direct link to 6-intermediate_size-int--none-ffn-çš„ä¸­é—´å±‚æ‰©å¼ å€æ•°" translate="no">â€‹</a></h4>
<p><strong>ä»£ç ä½ç½®</strong>: ç¬¬ 37 è¡Œ</p>
<p><strong>ä½œç”¨</strong>: å‰é¦ˆç½‘ç»œ(FFN)ä¸­é—´å±‚çš„ç»´åº¦ã€‚å¦‚æœè®¾ä¸º <code>None</code>,ä»£ç ä¼šè‡ªåŠ¨è®¡ç®—ä¸º <code>hidden_size * 8/3</code>ã€‚</p>
<p><strong>éšå–»è§£é‡Š</strong>:</p>
<p>å°æ˜åœ¨æ€è€ƒæ—¶,ä¼šç»å†ä¸€ä¸ª&quot;<strong>å‘æ•£æ€ç»´ â†’ æ”¶æ•›æ€»ç»“</strong>&quot;çš„è¿‡ç¨‹:</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">è¾“å…¥(512 ç»´) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  â†“ </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ã€æ‰©å¼ ã€‘â†’ ä¸­é—´å±‚(1365 ç»´)  â† è¿™é‡Œæ˜¯ intermediate_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  â†“</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ã€å‹ç¼©ã€‘â†’ è¾“å‡º(512 ç»´)</span><br></span></code></pre></div></div>
<p><strong>ä¸ºä»€ä¹ˆè¦å…ˆæ‰©å¼ å†å‹ç¼©?</strong></p>
<p>ç±»æ¯”å†™ä½œæ–‡çš„æ€è€ƒè¿‡ç¨‹:</p>
<ol>
<li class="">
<p><strong>æ‰©å¼ é˜¶æ®µ</strong>(<code>gate_proj</code> + <code>up_proj</code>):</p>
<ul>
<li class="">çœ‹åˆ°ä¸»é¢˜è¯&quot;æ˜¥å¤©&quot;,å¤§è„‘ç¬é—´è”æƒ³åˆ°:<!-- -->
<ul>
<li class="">è§†è§‰: ç»¿è‰²ã€èŠ±æœµã€é˜³å…‰</li>
<li class="">å¬è§‰: é¸Ÿé¸£ã€æµæ°´</li>
<li class="">è§¦è§‰: æ¸©æš–ã€å¾®é£</li>
<li class="">æƒ…æ„Ÿ: å¸Œæœ›ã€æ´»åŠ›</li>
</ul>
</li>
<li class="">ä» 1 ä¸ªæ¦‚å¿µæ‰©å¼ åˆ° N ä¸ªç›¸å…³è”æƒ³</li>
</ul>
</li>
<li class="">
<p><strong>å‹ç¼©é˜¶æ®µ</strong>(<code>down_proj</code>):</p>
<ul>
<li class="">ä»æ‰€æœ‰è”æƒ³ä¸­,ç­›é€‰å‡ºæœ€ç›¸å…³çš„å‡ ä¸ª</li>
<li class="">åˆæˆæœ€ç»ˆè¾“å‡º:&quot;æ˜¥å¤©æ˜¯ä¸‡ç‰©å¤è‹çš„å­£èŠ‚&quot;</li>
</ul>
</li>
</ol>
<p><strong>é»˜è®¤é…ç½®è®¡ç®—</strong>:</p>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># åœ¨ FeedForward ç±»çš„ __init__ ä¸­(ç¬¬ 260-264 è¡Œ)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">intermediate_size </span><span class="token keyword" style="color:#00009f">is</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    intermediate_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hidden_size </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 512 * 8/3 â‰ˆ 1365</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># å¯¹é½åˆ° 64 çš„å€æ•°(ä¸ºäº† GPU è®¡ç®—æ•ˆç‡)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">intermediate_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">64</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">intermediate_size </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">64</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">//</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># æœ€ç»ˆ = 1408 (21 * 64)</span><br></span></code></pre></div></div>
<p><strong>ä¸ºä»€ä¹ˆæ˜¯ 8/3 å€?</strong></p>
<ul>
<li class="">è¿™æ˜¯ Llama æ¶æ„çš„ç»éªŒå€¼</li>
<li class="">åœ¨æ€§èƒ½å’Œè®¡ç®—æˆæœ¬ä¹‹é—´å–å¾—å¹³è¡¡</li>
<li class="">GPT ç³»åˆ—é€šå¸¸ç”¨ 4 å€(å¦‚ <code>hidden_size=768</code> â†’ <code>intermediate_size=3072</code>)</li>
</ul>
<hr>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="7-dropout-float--00-é˜²æ­¢æ­»è®°ç¡¬èƒŒçš„é—å¿˜ç‡">7. <code>dropout: float = 0.0</code> (é˜²æ­¢&quot;æ­»è®°ç¡¬èƒŒ&quot;çš„é—å¿˜ç‡)<a href="#7-dropout-float--00-é˜²æ­¢æ­»è®°ç¡¬èƒŒçš„é—å¿˜ç‡" class="hash-link" aria-label="Direct link to 7-dropout-float--00-é˜²æ­¢æ­»è®°ç¡¬èƒŒçš„é—å¿˜ç‡" title="Direct link to 7-dropout-float--00-é˜²æ­¢æ­»è®°ç¡¬èƒŒçš„é—å¿˜ç‡" translate="no">â€‹</a></h4>
<p><strong>ä»£ç ä½ç½®</strong>: ç¬¬ 32 è¡Œ</p>
<p><strong>ä½œç”¨</strong>: è®­ç»ƒæ—¶éšæœº&quot;å…³é—­&quot;ä¸€éƒ¨åˆ†ç¥ç»å…ƒ,é˜²æ­¢è¿‡æ‹Ÿåˆã€‚</p>
<p><strong>éšå–»è§£é‡Š</strong>:</p>
<p>å°æ˜åœ¨ç»ƒä¹ å†™ä½œæ–‡æ—¶,æˆ‘ä»¬ä¼šéšæœº&quot;å±è”½&quot;ä»–çš„ä¸€éƒ¨åˆ†è®°å¿†:</p>
<p><strong>åœºæ™¯</strong>:</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">å®Œæ•´è®°å¿†(dropout=0.0):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- å°æ˜è®°å¾—:&quot;å¼€å¤´å¿…é¡»ç”¨&#x27;åœ¨ä¸€ä¸ªé£å’Œæ—¥ä¸½çš„æ—©æ™¨&#x27;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ç»“æœ:å†™100ç¯‡ä½œæ–‡éƒ½æ˜¯è¿™ä¸ªå¼€å¤´(æ­»è®°ç¡¬èƒŒ,æ²¡æœ‰åˆ›é€ åŠ›)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">éšæœºé—å¿˜(dropout=0.1):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- è®­ç»ƒæ—¶,éšæœºè®©å°æ˜&quot;å¿˜è®°&quot; 10% çš„è®°å¿†</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- æœ‰æ—¶å¿˜äº†å›ºå®šå¼€å¤´,è¢«è¿«è‡ªå·±åˆ›é€ æ–°çš„å¼€å¤´</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ç»“æœ:å­¦ä¼šäº†ä¸¾ä¸€åä¸‰,è€Œä¸æ˜¯æ­»è®°æ¨¡æ¿</span><br></span></code></pre></div></div>
<p><strong>ä¸ºä»€ä¹ˆä»£ç é‡Œè®¾ç½®ä¸º 0.0?</strong></p>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">dropout</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">float</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># é»˜è®¤ä¸ä½¿ç”¨ Dropout</span><br></span></code></pre></div></div>
<p><strong>åŸå› </strong>:</p>
<ol>
<li class="">
<p><strong>å¤§æ¨¡å‹æ—¶ä»£çš„æ–°å‘ç°</strong>:</p>
<ul>
<li class="">åœ¨å°æ¨¡å‹(BERT/GPT-2)æ—¶ä»£,Dropout å¾ˆé‡è¦</li>
<li class="">ä½†åœ¨å¤§æ¨¡å‹(Llama/GPT-3+)æ—¶ä»£,å‘ç° Dropout æ•ˆæœä¸æ˜æ˜¾,ç”šè‡³æœ‰è´Ÿä½œç”¨</li>
</ul>
</li>
<li class="">
<p><strong>è®­ç»ƒæ•°æ®å¤Ÿå¤§</strong>:</p>
<ul>
<li class="">è®­ç»ƒæ•°æ®æœ‰å‡ ç™¾ GB æ—¶,æ¨¡å‹å¾ˆéš¾&quot;æ­»è®°ç¡¬èƒŒ&quot;æ‰€æœ‰æ•°æ®</li>
<li class="">å¤©ç„¶å°±æœ‰&quot;æ³›åŒ–èƒ½åŠ›&quot;</li>
</ul>
</li>
<li class="">
<p><strong>å…¶ä»–æ­£åˆ™åŒ–æ–¹æ³•</strong>:</p>
<ul>
<li class="">ä½¿ç”¨äº† Weight Decay(æƒé‡è¡°å‡)</li>
<li class="">æ•°æ®å¢å¼º(Data Augmentation)</li>
<li class="">è®­ç»ƒæ—¶çš„éšæœºæ€§(å¦‚ Batch é¡ºåº)</li>
</ul>
</li>
</ol>
<p><strong>å¦‚æœä½ çš„åœºæ™¯éœ€è¦ Dropout</strong>:</p>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> MiniMindConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dropout</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0.1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># å°æ•°æ®é›†æ—¶å¯ä»¥å°è¯•</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hidden_size</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">512</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<hr>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="8-max_position_embeddings-int--32768-å°æ˜çš„è®°å¿†é•¿åº¦ä¸Šé™">8. <code>max_position_embeddings: int = 32768</code> (å°æ˜çš„&quot;è®°å¿†é•¿åº¦ä¸Šé™&quot;)<a href="#8-max_position_embeddings-int--32768-å°æ˜çš„è®°å¿†é•¿åº¦ä¸Šé™" class="hash-link" aria-label="Direct link to 8-max_position_embeddings-int--32768-å°æ˜çš„è®°å¿†é•¿åº¦ä¸Šé™" title="Direct link to 8-max_position_embeddings-int--32768-å°æ˜çš„è®°å¿†é•¿åº¦ä¸Šé™" translate="no">â€‹</a></h4>
<p><strong>ä»£ç ä½ç½®</strong>: ç¬¬ 38 è¡Œ</p>
<p><strong>ä½œç”¨</strong>: æ¨¡å‹èƒ½å¤„ç†çš„æœ€å¤§åºåˆ—é•¿åº¦(token æ•°é‡)ã€‚</p>
<p><strong>éšå–»è§£é‡Š</strong>:</p>
<p>å°æ˜çš„çŸ­æœŸè®°å¿†æœ€å¤šèƒ½è®°ä½ <strong>32768 ä¸ªè¯</strong>ã€‚</p>
<p><strong>å®é™…å¯¹æ¯”</strong>:</p>
<table><thead><tr><th>é•¿åº¦</th><th>å¯¹åº”å†…å®¹</th></tr></thead><tbody><tr><td>512</td><td>ä¸€ç¯‡çŸ­æ–°é—»</td></tr><tr><td>2048</td><td>ä¸€ç¯‡ä¸­é•¿æ–‡ç« (GPT-3 é»˜è®¤)</td></tr><tr><td>4096</td><td>ä¸€æœ¬çŸ­ç¯‡å°è¯´çš„ä¸€ç« </td></tr><tr><td>32768</td><td>ä¸€æœ¬ä¸­ç¯‡å°è¯´ / ä¸€ä»½é•¿ç ”ç©¶æŠ¥å‘Š</td></tr><tr><td>128000</td><td>GPT-4 Turbo çš„é•¿åº¦,çº¦ä¸€æœ¬ã€Šå“ˆåˆ©æ³¢ç‰¹ã€‹</td></tr></tbody></table>
<p><strong>ä¸ºä»€ä¹ˆä¸è®¾ç½®å¾—è¶Šé•¿è¶Šå¥½?</strong></p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">é—®é¢˜ 1: è®¡ç®—å¤æ‚åº¦çˆ†ç‚¸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- æ³¨æ„åŠ›è®¡ç®—å¤æ‚åº¦ = O(seq_lenÂ²)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- é•¿åº¦ç¿»å€,è®¡ç®—é‡ç¿» 4 å€!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - 2048 token â†’ éœ€è¦è®¡ç®— 2048Â² = 419 ä¸‡æ¬¡æ³¨æ„åŠ›</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - 32768 token â†’ éœ€è¦è®¡ç®— 32768Â² = 10.7 äº¿æ¬¡æ³¨æ„åŠ›</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">é—®é¢˜ 2: æ˜¾å­˜å ç”¨æ¿€å¢</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- KV Cache å¤§å° = 2 * num_layers * seq_len * hidden_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- é•¿åº¦ç¿»å€,æ˜¾å­˜å ç”¨ä¹Ÿç¿»å€</span><br></span></code></pre></div></div>
<p><strong>æŠ€æœ¯ç»†èŠ‚</strong>:</p>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># åœ¨ precompute_freqs_cis å‡½æ•°ä¸­(ç¬¬ 608-690 è¡Œ)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># ä¼šé¢„å…ˆè®¡ç®— max_position_embeddings ä¸ªä½ç½®çš„æ—‹è½¬ç¼–ç </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">freqs_cos</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> freqs_sin </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> precompute_freqs_cis</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dim</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">head_dim</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">32768</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># æå‰è®¡ç®—å¥½ 32768 ä¸ªä½ç½®çš„ cos/sin å€¼</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rope_base</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">rope_theta</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<hr>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="9-rope_theta-int--10000000-ä½ç½®ç¼–ç çš„æ—¶é’Ÿé¢‘ç‡">9. <code>rope_theta: int = 1000000.0</code> (ä½ç½®ç¼–ç çš„&quot;æ—¶é’Ÿé¢‘ç‡&quot;)<a href="#9-rope_theta-int--10000000-ä½ç½®ç¼–ç çš„æ—¶é’Ÿé¢‘ç‡" class="hash-link" aria-label="Direct link to 9-rope_theta-int--10000000-ä½ç½®ç¼–ç çš„æ—¶é’Ÿé¢‘ç‡" title="Direct link to 9-rope_theta-int--10000000-ä½ç½®ç¼–ç çš„æ—¶é’Ÿé¢‘ç‡" translate="no">â€‹</a></h4>
<p><strong>ä»£ç ä½ç½®</strong>: ç¬¬ 44 è¡Œ</p>
<p><strong>ä½œç”¨</strong>: RoPE(æ—‹è½¬ä½ç½®ç¼–ç )çš„åŸºé¢‘å‚æ•°,å½±å“ä½ç½®ä¿¡æ¯çš„ç¼–ç æ–¹å¼ã€‚</p>
<p><strong>éšå–»è§£é‡Š</strong>:</p>
<p>æƒ³è±¡å°æ˜çš„å¤§è„‘é‡Œæœ‰ä¸€ä¸ª&quot;æ—¶é’Ÿç³»ç»Ÿ&quot;,ç”¨æ¥è®°å½•æ¯ä¸ªè¯åœ¨å¥å­ä¸­çš„ä½ç½®ã€‚</p>
<p><strong>ä¸¤ç§æ—¶é’Ÿå¯¹æ¯”</strong>:</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">å¿«é€Ÿæ—¶é’Ÿ(rope_theta=10000,GPT/BERT å¸¸ç”¨):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ä½ç½® 0: æŒ‡é’ˆæŒ‡å‘ 0Â°</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ä½ç½® 1: æŒ‡é’ˆæŒ‡å‘ 36Â°</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ä½ç½® 2: æŒ‡é’ˆæŒ‡å‘ 72Â°</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ä½ç½® 100: æŒ‡é’ˆè½¬äº† 10 åœˆ,åˆå›åˆ° 0Â°(äº§ç”Ÿæ··æ·†!)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">æ…¢é€Ÿæ—¶é’Ÿ(rope_theta=1000000,Llama å¸¸ç”¨):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ä½ç½® 0: æŒ‡é’ˆæŒ‡å‘ 0Â°</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ä½ç½® 1: æŒ‡é’ˆæŒ‡å‘ 0.36Â°</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ä½ç½® 2: æŒ‡é’ˆæŒ‡å‘ 0.72Â°</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ä½ç½® 10000: æŒ‡é’ˆæ‰è½¬ 3.6Â°(ä»ç„¶æ¸…æ™°å¯è¾¨)</span><br></span></code></pre></div></div>
<p><strong>ä¸ºä»€ä¹ˆç”¨ 1000000?</strong></p>
<p><strong>ç›®çš„</strong>: æ”¯æŒæ›´é•¿çš„åºåˆ—,é¿å…ä½ç½®ä¿¡æ¯&quot;å¾ªç¯æ··æ·†&quot;</p>
<p><strong>ç±»æ¯”</strong>:</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">å°±åƒé’Ÿè¡¨çš„è®¾è®¡:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ç§’é’ˆ: 60 ç§’è½¬ä¸€åœˆ(çŸ­å‘¨æœŸ,é€‚åˆè®¡æ—¶å‡ åˆ†é’Ÿ)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- åˆ†é’ˆ: 60 åˆ†é’Ÿè½¬ä¸€åœˆ(ä¸­å‘¨æœŸ)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- æ—¶é’ˆ: 12 å°æ—¶è½¬ä¸€åœˆ(é•¿å‘¨æœŸ,é€‚åˆè®¡æ—¶ä¸€æ•´å¤©)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rope_theta å°±æ˜¯æ§åˆ¶&quot;æ—¶é’ˆè½¬é€Ÿ&quot;çš„å‚æ•°</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- theta=10000   â†’ åƒç§’é’ˆ,é€‚åˆçŸ­æ–‡æœ¬</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- theta=1000000 â†’ åƒæ—¶é’ˆ,é€‚åˆé•¿æ–‡æœ¬</span><br></span></code></pre></div></div>
<p><strong>æŠ€æœ¯ç»†èŠ‚</strong>:</p>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># åœ¨ precompute_freqs_cis ä¸­çš„è®¡ç®—(ç¬¬ 632 è¡Œ)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">freqs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rope_base </span><span class="token operator" style="color:#393A34">**</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">arange</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dim</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">float</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> dim</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># rope_base=1000000 æ—¶,é¢‘ç‡ä¼šéå¸¸ä½,é€‚åˆç¼–ç é•¿åºåˆ—</span><br></span></code></pre></div></div>
<hr>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="10-flash_attn-bool--true-å¯ç”¨é—ªç”µæ³¨æ„åŠ›åŠ é€Ÿ">10. <code>flash_attn: bool = True</code> (å¯ç”¨&quot;é—ªç”µæ³¨æ„åŠ›&quot;åŠ é€Ÿ)<a href="#10-flash_attn-bool--true-å¯ç”¨é—ªç”µæ³¨æ„åŠ›åŠ é€Ÿ" class="hash-link" aria-label="Direct link to 10-flash_attn-bool--true-å¯ç”¨é—ªç”µæ³¨æ„åŠ›åŠ é€Ÿ" title="Direct link to 10-flash_attn-bool--true-å¯ç”¨é—ªç”µæ³¨æ„åŠ›åŠ é€Ÿ" translate="no">â€‹</a></h4>
<p><strong>ä»£ç ä½ç½®</strong>: ç¬¬ 46 è¡Œ</p>
<p><strong>ä½œç”¨</strong>: æ˜¯å¦ä½¿ç”¨ Flash Attention ç®—æ³•ä¼˜åŒ–æ³¨æ„åŠ›è®¡ç®—ã€‚</p>
<p><strong>éšå–»è§£é‡Š</strong>:</p>
<p><strong>æ™®é€šæ³¨æ„åŠ›è®¡ç®—</strong>:</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">å°æ˜é˜…è¯»ä¸€ç¯‡æ–‡ç« (1000 ä¸ªè¯):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1. å…ˆæŠŠæ‰€æœ‰è¯çš„å…³ç³»å†™åœ¨ä¸€å¼ å¤§è¡¨æ ¼ä¸Š(1000x1000 = 100 ä¸‡ä¸ªæ ¼å­)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. å†ä»è¡¨æ ¼ä¸­æŸ¥æ‰¾éœ€è¦çš„ä¿¡æ¯</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. æœ€åæŠŠè¡¨æ ¼æ‰”æ‰</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">é—®é¢˜: è¿™å¼ è¡¨æ ¼éå¸¸å åœ°æ–¹(æ˜¾å­˜),è€Œä¸”å¤§éƒ¨åˆ†ä¿¡æ¯å…¶å®ç”¨ä¸åˆ°</span><br></span></code></pre></div></div>
<p><strong>Flash Attention</strong>:</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">æ”¹è¿›æ–¹æ¡ˆ:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1. ä¸è¦ä¸€æ¬¡æ€§ç”Ÿæˆæ•´å¼ å¤§è¡¨æ ¼</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. åˆ†å—è®¡ç®—: æ¯æ¬¡åªç®— 64x64 çš„å°å—(4096 ä¸ªæ ¼å­)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. ç®—å®Œä¸€å—,ç«‹åˆ»ç”¨æ‰,å†ç®—ä¸‹ä¸€å—</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4. æœ€ç»ˆç»“æœå®Œå…¨ä¸€æ ·,ä½†èŠ‚çœäº† 95% çš„ä¸´æ—¶å­˜å‚¨ç©ºé—´!</span><br></span></code></pre></div></div>
<p><strong>å®é™…æ•ˆæœå¯¹æ¯”</strong>:</p>
<table><thead><tr><th>æŒ‡æ ‡</th><th>æ™®é€šæ³¨æ„åŠ›</th><th>Flash Attention</th></tr></thead><tbody><tr><td><strong>æ˜¾å­˜å ç”¨</strong></td><td>16 GB</td><td>4 GB</td></tr><tr><td><strong>é€Ÿåº¦</strong></td><td>100 ms</td><td>30 ms</td></tr><tr><td><strong>ç²¾åº¦</strong></td><td>å®Œå…¨ä¸€è‡´</td><td>å®Œå…¨ä¸€è‡´</td></tr></tbody></table>
<p><strong>ä»£ç ä¸­çš„åº”ç”¨</strong>(ç¬¬ 499-513 è¡Œ):</p>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flash </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">seq_len </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># ä½¿ç”¨ PyTorch å†…ç½®çš„é«˜æ•ˆå®ç°</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> F</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">scaled_dot_product_attention</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        xq</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> xk</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> xv</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dropout_p</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dropout </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">training </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        is_causal</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># è‡ªåŠ¨åº”ç”¨å› æœæ©ç </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># é™çº§åˆ°æ‰‹åŠ¨å®ç°(å…¼å®¹æ—§ç‰ˆæœ¬)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    scores </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">xq @ xk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">transpose</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> math</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sqrt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">head_dim</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><br></span></code></pre></div></div>
<p><strong>è¦æ±‚</strong>:</p>
<ul>
<li class="">PyTorch &gt;= 2.0</li>
<li class="">CUDA æ”¯æŒ</li>
</ul>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-ç‰¹æ®Štokenå‚æ•°">ğŸ”§ ç‰¹æ®ŠTokenå‚æ•°<a href="#-ç‰¹æ®Štokenå‚æ•°" class="hash-link" aria-label="Direct link to ğŸ”§ ç‰¹æ®ŠTokenå‚æ•°" title="Direct link to ğŸ”§ ç‰¹æ®ŠTokenå‚æ•°" translate="no">â€‹</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="11-12-bos_token_id-å’Œ-eos_token_id-å¥å­çš„èµ·æ­¢æ ‡è®°">11-12. <code>bos_token_id</code> å’Œ <code>eos_token_id</code> (å¥å­çš„&quot;èµ·æ­¢æ ‡è®°&quot;)<a href="#11-12-bos_token_id-å’Œ-eos_token_id-å¥å­çš„èµ·æ­¢æ ‡è®°" class="hash-link" aria-label="Direct link to 11-12-bos_token_id-å’Œ-eos_token_id-å¥å­çš„èµ·æ­¢æ ‡è®°" title="Direct link to 11-12-bos_token_id-å’Œ-eos_token_id-å¥å­çš„èµ·æ­¢æ ‡è®°" translate="no">â€‹</a></h4>
<p><strong>ä»£ç ä½ç½®</strong>: ç¬¬ 33-34 è¡Œ</p>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">bos_token_id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Beginning of Sequence</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eos_token_id</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># End of Sequence</span><br></span></code></pre></div></div>
<p><strong>éšå–»è§£é‡Š</strong>:</p>
<p>å°±åƒä¹¦é¢è¯­è¨€çš„æ ‡ç‚¹ç¬¦å·:</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">bos_token_id = ã€ (å·¦ä¹¦åå·,è¡¨ç¤º&quot;æ•…äº‹å¼€å§‹&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eos_token_id = ã€‘ (å³ä¹¦åå·,è¡¨ç¤º&quot;æ•…äº‹ç»“æŸ&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ç¤ºä¾‹:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">åŸå§‹æ–‡æœ¬: &quot;å°çº¢å¸½å»æ£®æ—&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ç¼–ç å:   [1, 453, 234, 789, 123, 2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">           â†‘                      â†‘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         å¼€å§‹                    ç»“æŸ</span><br></span></code></pre></div></div>
<p><strong>ä½œç”¨</strong>:</p>
<ol>
<li class=""><strong>è®­ç»ƒæ—¶</strong>: å‘Šè¯‰æ¨¡å‹&quot;è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„å¥å­&quot;</li>
<li class=""><strong>ç”Ÿæˆæ—¶</strong>:<!-- -->
<ul>
<li class="">é‡åˆ° <code>eos_token_id</code>,å°±åœæ­¢ç”Ÿæˆ</li>
<li class="">é¿å…æ¨¡å‹æ— ä¼‘æ­¢åœ°ç”Ÿæˆä¸‹å»</li>
</ul>
</li>
</ol>
<p><strong>ä¾‹å­</strong>(ç”Ÿæˆæ–‡æœ¬æ—¶):</p>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># æ¨¡å‹ç”Ÿæˆè¿‡ç¨‹</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input_ids </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># ä» &lt;BOS&gt; å¼€å§‹</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    next_token </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">generate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">input_ids</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> next_token </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># é‡åˆ° &lt;EOS&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">break</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    input_ids</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">next_token</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># æœ€ç»ˆç”Ÿæˆ: [1, 453, 234, ..., 789, 2]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># è§£ç : &quot;&lt;BOS&gt; å°çº¢å¸½å»æ£®æ— &lt;EOS&gt;&quot;</span><br></span></code></pre></div></div>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-é«˜çº§å‚æ•°">ğŸ”¬ é«˜çº§å‚æ•°<a href="#-é«˜çº§å‚æ•°" class="hash-link" aria-label="Direct link to ğŸ”¬ é«˜çº§å‚æ•°" title="Direct link to ğŸ”¬ é«˜çº§å‚æ•°" translate="no">â€‹</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="13-rms_norm_eps-float--1e-05-å½’ä¸€åŒ–è®¡ç®—çš„é˜²å´©æºƒä¿é™©">13. <code>rms_norm_eps: float = 1e-05</code> (å½’ä¸€åŒ–è®¡ç®—çš„&quot;é˜²å´©æºƒä¿é™©&quot;)<a href="#13-rms_norm_eps-float--1e-05-å½’ä¸€åŒ–è®¡ç®—çš„é˜²å´©æºƒä¿é™©" class="hash-link" aria-label="Direct link to 13-rms_norm_eps-float--1e-05-å½’ä¸€åŒ–è®¡ç®—çš„é˜²å´©æºƒä¿é™©" title="Direct link to 13-rms_norm_eps-float--1e-05-å½’ä¸€åŒ–è®¡ç®—çš„é˜²å´©æºƒä¿é™©" translate="no">â€‹</a></h4>
<p><strong>ä»£ç ä½ç½®</strong>: ç¬¬ 43 è¡Œ</p>
<p><strong>ä½œç”¨</strong>: RMSNorm è®¡ç®—æ—¶çš„æå°æ•°,é˜²æ­¢é™¤é›¶é”™è¯¯ã€‚</p>
<p><strong>éšå–»è§£é‡Š</strong>:</p>
<p>å°æ˜åœ¨è®¡ç®—å¹³å‡æˆç»©æ—¶:</p>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># RMSNorm çš„è®¡ç®—å…¬å¼(ç®€åŒ–ç‰ˆ)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rms </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sqrt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mean</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">xÂ²</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> eps</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> x </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> rms</span><br></span></code></pre></div></div>
<p><strong>å¦‚æœæ²¡æœ‰ eps ä¼šæ€æ ·?</strong></p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">å‡è®¾è¾“å…¥å…¨æ˜¯ 0:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">x = [0, 0, 0, 0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mean(xÂ²) = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sqrt(0) = 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">x / 0 = ??? (è®¡ç®—æœºå´©æºƒ!)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">åŠ ä¸Š eps å:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sqrt(0 + 0.00001) = 0.00316...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">x / 0.00316 = 0 (å®‰å…¨!)</span><br></span></code></pre></div></div>
<p><strong>ä¸ºä»€ä¹ˆæ˜¯ 1e-05?</strong></p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">ä¸èƒ½å¤ªå¤§: </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- å¦‚æœ eps=0.1,ä¼šå½±å“æ­£å¸¸è®¡ç®—ç»“æœ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ä¸èƒ½å¤ªå°:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- å¦‚æœ eps=1e-20,åœ¨ FP16 ç²¾åº¦ä¸‹ä¼šè¢«èˆå…¥ä¸º 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1e-05 æ˜¯ç»éªŒæœ€ä¼˜å€¼:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- è¶³å¤Ÿå°,ä¸å½±å“æ­£å¸¸æ•°å€¼</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- è¶³å¤Ÿå¤§,èƒ½é˜²æ­¢é™¤é›¶</span><br></span></code></pre></div></div>
<hr>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="14-hidden_act-str--silu-æ¿€æ´»å‡½æ•°ç±»å‹">14. <code>hidden_act: str = &quot;silu&quot;</code> (æ¿€æ´»å‡½æ•°ç±»å‹)<a href="#14-hidden_act-str--silu-æ¿€æ´»å‡½æ•°ç±»å‹" class="hash-link" aria-label="Direct link to 14-hidden_act-str--silu-æ¿€æ´»å‡½æ•°ç±»å‹" title="Direct link to 14-hidden_act-str--silu-æ¿€æ´»å‡½æ•°ç±»å‹" translate="no">â€‹</a></h4>
<p><strong>ä»£ç ä½ç½®</strong>: ç¬¬ 35 è¡Œ</p>
<p><strong>ä½œç”¨</strong>: æŒ‡å®šå‰é¦ˆç½‘ç»œä¸­ä½¿ç”¨çš„æ¿€æ´»å‡½æ•°ã€‚</p>
<p><strong>éšå–»è§£é‡Š</strong>:</p>
<p>æ¿€æ´»å‡½æ•°å†³å®šäº†ç¥ç»å…ƒçš„&quot;å…´å¥‹æ¨¡å¼&quot;ã€‚</p>
<p><strong>å¸¸è§æ¿€æ´»å‡½æ•°å¯¹æ¯”</strong>:</p>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># ReLU (è€å¼æ¿€æ´»å‡½æ•°)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">relu</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token builtin">max</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># è´Ÿæ•°å…¨éƒ¨å˜0,æ­£æ•°ä¿æŒä¸å˜</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">è¾“å…¥</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">è¾“å‡º</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  â† è´Ÿæ•°ä¿¡æ¯å®Œå…¨ä¸¢å¤±!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># SiLU (Swish,ç°ä»£æ¿€æ´»å‡½æ•°)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">silu</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> x </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> sigmoid</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># å¹³æ»‘æ›²çº¿,ä¿ç•™éƒ¨åˆ†è´Ÿæ•°ä¿¡æ¯</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">è¾“å…¥</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">è¾“å‡º</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">0.24</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">0.27</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.73</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.76</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  â† æ›´å¹³æ»‘</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">æ¢¯åº¦æ›´å¥½</span><br></span></code></pre></div></div>
<p><strong>ç±»æ¯”</strong>:</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">ReLU = ä¸¥æ ¼çš„è€å¸ˆ:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- å­¦ç”Ÿ(ç¥ç»å…ƒ)è¡¨ç°å¥½(x&gt;0) â†’ ç»™äºˆé¼“åŠ±</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- å­¦ç”Ÿè¡¨ç°ä¸å¥½(x&lt;0) â†’ ç›´æ¥æ‰“ 0 åˆ†(ä¿¡æ¯ä¸¢å¤±)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SiLU = æ¸©å’Œçš„è€å¸ˆ:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- å­¦ç”Ÿè¡¨ç°å¥½ â†’ å¤§åŠ›é¼“åŠ±</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- å­¦ç”Ÿè¡¨ç°ä¸å¥½ â†’ ä¹Ÿç»™äºˆä¸€äº›åé¦ˆ(ä¿ç•™ä¿¡æ¯)</span><br></span></code></pre></div></div>
<p><strong>ä¸ºä»€ä¹ˆ Llama é€‰æ‹© SiLU?</strong></p>
<ol>
<li class=""><strong>æ¢¯åº¦æµåŠ¨æ›´å¥½</strong>: è®­ç»ƒæ—¶ä¸ä¼šå‡ºç°&quot;æ¢¯åº¦æ¶ˆå¤±&quot;</li>
<li class=""><strong>æ€§èƒ½æ›´ä¼˜</strong>: å®éªŒè¡¨æ˜æ¯” ReLU æå‡ 1-2% å‡†ç¡®ç‡</li>
<li class=""><strong>è®¡ç®—æˆæœ¬</strong>: æ¯” ReLU ç•¥æ…¢,ä½†å¯æ¥å—</li>
</ol>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-æ··åˆä¸“å®¶moeå‚æ•°">ğŸ“ æ··åˆä¸“å®¶(MoE)å‚æ•°<a href="#-æ··åˆä¸“å®¶moeå‚æ•°" class="hash-link" aria-label="Direct link to ğŸ“ æ··åˆä¸“å®¶(MoE)å‚æ•°" title="Direct link to ğŸ“ æ··åˆä¸“å®¶(MoE)å‚æ•°" translate="no">â€‹</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="15-use_moe-bool--false-æ˜¯å¦å¯ç”¨ä¸“å®¶å›¢é˜Ÿæ¨¡å¼">15. <code>use_moe: bool = False</code> (æ˜¯å¦å¯ç”¨&quot;ä¸“å®¶å›¢é˜Ÿ&quot;æ¨¡å¼)<a href="#15-use_moe-bool--false-æ˜¯å¦å¯ç”¨ä¸“å®¶å›¢é˜Ÿæ¨¡å¼" class="hash-link" aria-label="Direct link to 15-use_moe-bool--false-æ˜¯å¦å¯ç”¨ä¸“å®¶å›¢é˜Ÿæ¨¡å¼" title="Direct link to 15-use_moe-bool--false-æ˜¯å¦å¯ç”¨ä¸“å®¶å›¢é˜Ÿæ¨¡å¼" translate="no">â€‹</a></h4>
<p><strong>ä»£ç ä½ç½®</strong>: ç¬¬ 51 è¡Œ</p>
<p><strong>ä½œç”¨</strong>: æ˜¯å¦ä½¿ç”¨æ··åˆä¸“å®¶(Mixture of Experts)æ¶æ„ã€‚</p>
<p><strong>éšå–»è§£é‡Š</strong>:</p>
<p><strong>æ™®é€šæ¨¡å¼</strong> (<code>use_moe=False</code>):</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">å°æ˜ä¸€ä¸ªäººå¤„ç†æ‰€æœ‰ä»»åŠ¡:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- å†™ç§‘å¹»å°è¯´ â†’ å°æ˜å†™</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- å†™çˆ±æƒ…æ•…äº‹ â†’ å°æ˜å†™  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- å†™å†å²è®ºæ–‡ â†’ å°æ˜å†™</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ç»“æœ: æ¯ç§ç±»å‹éƒ½åªèƒ½åšåˆ° 60 åˆ†(ä»€ä¹ˆéƒ½ä¼š,ä½†éƒ½ä¸ç²¾)</span><br></span></code></pre></div></div>
<p><strong>MoE æ¨¡å¼</strong> (<code>use_moe=True</code>):</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">ç»„å»ºä¸€ä¸ªå†™ä½œå›¢é˜Ÿ:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ä¸“å®¶A: æ“…é•¿ç§‘å¹»(è´Ÿè´£ç§‘å¹»ç±»)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ä¸“å®¶B: æ“…é•¿çˆ±æƒ…(è´Ÿè´£çˆ±æƒ…ç±»)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ä¸“å®¶C: æ“…é•¿å†å²(è´Ÿè´£å†å²ç±»)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ä¸“å®¶D: å…¨èƒ½å‹(ä½œä¸ºå¤‡é€‰)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">é‡åˆ°ä»»åŠ¡æ—¶:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1. è·¯ç”±å™¨(Gate)åˆ¤æ–­ä»»åŠ¡ç±»å‹</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. é€‰æ‹©æœ€åˆé€‚çš„ 2 ä¸ªä¸“å®¶å¤„ç†</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. ç»¼åˆä»–ä»¬çš„è¾“å‡º</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ç»“æœ: æ¯ç§ç±»å‹éƒ½èƒ½åšåˆ° 90 åˆ†(æœ¯ä¸šæœ‰ä¸“æ”»)</span><br></span></code></pre></div></div>
<p><strong>å®é™…åº”ç”¨</strong>(åœ¨ MiniMindBlock ä¸­,ç¬¬ 1019 è¡Œ):</p>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mlp </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FeedForward</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">use_moe </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> MOEFeedForward</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><strong>ä¼˜ç¼ºç‚¹</strong>:</p>
<table><thead><tr><th>æ–¹é¢</th><th>ä¼˜ç‚¹</th><th>ç¼ºç‚¹</th></tr></thead><tbody><tr><td><strong>å‚æ•°æ•ˆç‡</strong></td><td>æ€»å‚æ•°å¤š,ä½†æ¯æ¬¡åªæ¿€æ´»ä¸€éƒ¨åˆ†</td><td>å­˜å‚¨ç©ºé—´éœ€æ±‚å¤§</td></tr><tr><td><strong>æ€§èƒ½</strong></td><td>åŒç­‰æ¿€æ´»å‚æ•°ä¸‹,æ•ˆæœæ›´å¥½</td><td>è®­ç»ƒæ›´å¤æ‚</td></tr><tr><td><strong>é€‚ç”¨åœºæ™¯</strong></td><td>å¤šé¢†åŸŸã€å¤šè¯­è¨€ä»»åŠ¡</td><td>å•ä¸€é¢†åŸŸä»»åŠ¡æå‡æœ‰é™</td></tr></tbody></table>
<hr>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="16-17-n_routed_experts-å’Œ-num_experts_per_tok-ä¸“å®¶æ•°é‡é…ç½®">16-17. <code>n_routed_experts</code> å’Œ <code>num_experts_per_tok</code> (ä¸“å®¶æ•°é‡é…ç½®)<a href="#16-17-n_routed_experts-å’Œ-num_experts_per_tok-ä¸“å®¶æ•°é‡é…ç½®" class="hash-link" aria-label="Direct link to 16-17-n_routed_experts-å’Œ-num_experts_per_tok-ä¸“å®¶æ•°é‡é…ç½®" title="Direct link to 16-17-n_routed_experts-å’Œ-num_experts_per_tok-ä¸“å®¶æ•°é‡é…ç½®" translate="no">â€‹</a></h4>
<p><strong>ä»£ç ä½ç½®</strong>: ç¬¬ 52-53 è¡Œ</p>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">n_routed_experts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># æ€»å…±æœ‰ 4 ä¸ªä¸“å®¶</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">num_experts_per_tok</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># æ¯ä¸ªè¯é€‰æ‹© 2 ä¸ªä¸“å®¶å¤„ç†</span><br></span></code></pre></div></div>
<p><strong>éšå–»è§£é‡Š</strong>:</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">å†™ä½œå›¢é˜Ÿé…ç½®:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- æ‹›è˜äº† 4 ä¸ªä¸“ä¸šä½œå®¶(n_routed_experts=4)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- æ¯ä¸ªå†™ä½œä»»åŠ¡åˆ†é…ç»™ 2 ä¸ªä½œå®¶åŒæ—¶å¤„ç†(num_experts_per_tok=2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ç¤ºä¾‹:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">è¾“å…¥è¯: &quot;é‡å­&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">â†“</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">è·¯ç”±å™¨è¯„åˆ†:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ä¸“å®¶A(ç§‘å¹»): 0.9 åˆ† âœ“ é€‰ä¸­</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ä¸“å®¶B(çˆ±æƒ…): 0.1 åˆ†</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ä¸“å®¶C(å†å²): 0.3 åˆ†</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ä¸“å®¶D(é€šç”¨): 0.6 åˆ† âœ“ é€‰ä¸­</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">â†“</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">è¾“å‡º = 0.6 * ä¸“å®¶Açš„ç»“æœ + 0.4 * ä¸“å®¶Dçš„ç»“æœ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       (æƒé‡å½’ä¸€åŒ–: 0.9/(0.9+0.6)=0.6, 0.6/(0.9+0.6)=0.4)</span><br></span></code></pre></div></div>
<p><strong>é…ç½®ç­–ç•¥</strong>:</p>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># æ¿€è¿›é…ç½®(è¿½æ±‚æ€§èƒ½)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">n_routed_experts</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">16</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 16 ä¸ªä¸“å®¶</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">num_experts_per_tok</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">4</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># æ¯æ¬¡é€‰ 4 ä¸ª</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">â†’ è¡¨è¾¾èƒ½åŠ›å¼º</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">ä½†è®¡ç®—æˆæœ¬é«˜</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># ä¿å®ˆé…ç½®(è¿½æ±‚æ•ˆç‡)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">n_routed_experts</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">4</span><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic"># 4 ä¸ªä¸“å®¶</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">num_experts_per_tok</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># æ¯æ¬¡é€‰ 1 ä¸ª</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">â†’ è®¡ç®—å¿«</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">ä½†æ•ˆæœå¯èƒ½ä¸å¦‚æ™®é€šFFN</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># å¹³è¡¡é…ç½®(æ¨è)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">n_routed_experts</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">8</span><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic"># 8 ä¸ªä¸“å®¶</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">num_experts_per_tok</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># æ¯æ¬¡é€‰ 2 ä¸ª</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">â†’ åœ¨æ€§èƒ½å’Œæ•ˆç‡ä¹‹é—´å–å¾—å¹³è¡¡</span><br></span></code></pre></div></div>
<hr>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="18-n_shared_experts-int--1-é€šç”¨ä¸“å®¶æ•°é‡">18. <code>n_shared_experts: int = 1</code> (é€šç”¨ä¸“å®¶æ•°é‡)<a href="#18-n_shared_experts-int--1-é€šç”¨ä¸“å®¶æ•°é‡" class="hash-link" aria-label="Direct link to 18-n_shared_experts-int--1-é€šç”¨ä¸“å®¶æ•°é‡" title="Direct link to 18-n_shared_experts-int--1-é€šç”¨ä¸“å®¶æ•°é‡" translate="no">â€‹</a></h4>
<p><strong>ä»£ç ä½ç½®</strong>: ç¬¬ 54 è¡Œ</p>
<p><strong>ä½œç”¨</strong>: æ— è®ºä»€ä¹ˆä»»åŠ¡,éƒ½ä¼šè¢«æ¿€æ´»çš„&quot;é€šç”¨ä¸“å®¶&quot;æ•°é‡ã€‚</p>
<p><strong>éšå–»è§£é‡Š</strong>:</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">å†™ä½œå›¢é˜Ÿä¸­çš„&quot;ä¸‡é‡‘æ²¹&quot;æˆå‘˜:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">è·¯ç”±ä¸“å®¶(routed_experts):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ä¸“å®¶A: åªå¤„ç†è¢«åˆ†é…çš„ç§‘å¹»ä»»åŠ¡</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ä¸“å®¶B: åªå¤„ç†è¢«åˆ†é…çš„çˆ±æƒ…ä»»åŠ¡</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">å…±äº«ä¸“å®¶(shared_experts):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ä¸“å®¶S: æ— è®ºä»€ä¹ˆä»»åŠ¡,éƒ½ä¼šå‚ä¸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - è´Ÿè´£é€šç”¨æŠ€èƒ½:è¯­æ³•æ£€æŸ¥ã€é€»è¾‘è¿è´¯æ€§ã€æ–‡å­—æ¶¦è‰²</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">æœ€ç»ˆè¾“å‡º = è·¯ç”±ä¸“å®¶çš„ç»“æœ + å…±äº«ä¸“å®¶çš„ç»“æœ</span><br></span></code></pre></div></div>
<p><strong>ä»£ç å®ç°</strong>(åœ¨ MOEFeedForward.forward ä¸­,ç¬¬ 919-923 è¡Œ):</p>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">y </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">moe_infer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># è·¯ç”±ä¸“å®¶çš„è¾“å‡º</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">n_shared_experts </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> expert </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">shared_experts</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        y </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> y </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> expert</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">identity</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># å åŠ å…±äº«ä¸“å®¶çš„è¾“å‡º</span><br></span></code></pre></div></div>
<p><strong>ä¸ºä»€ä¹ˆéœ€è¦å…±äº«ä¸“å®¶?</strong></p>
<ol>
<li class=""><strong>ç¨³å®šæ€§</strong>: é˜²æ­¢æŸäº›ä¸“å®¶å®Œå…¨ä¸è¢«æ¿€æ´»</li>
<li class=""><strong>é€šç”¨çŸ¥è¯†</strong>: æ•æ‰è·¨é¢†åŸŸçš„å…±æ€§ç‰¹å¾</li>
<li class=""><strong>æ€§èƒ½æå‡</strong>: DeepSeek-MoE è®ºæ–‡è¯æ˜,åŠ å…¥å…±äº«ä¸“å®¶èƒ½æå‡ 2-3%</li>
</ol>
<hr>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="19-21-è¾…åŠ©æŸå¤±å‚æ•°">19-21. è¾…åŠ©æŸå¤±å‚æ•°<a href="#19-21-è¾…åŠ©æŸå¤±å‚æ•°" class="hash-link" aria-label="Direct link to 19-21. è¾…åŠ©æŸå¤±å‚æ•°" title="Direct link to 19-21. è¾…åŠ©æŸå¤±å‚æ•°" translate="no">â€‹</a></h4>
<p><strong>ä»£ç ä½ç½®</strong>: ç¬¬ 56-58 è¡Œ</p>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">aux_loss_alpha</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">float</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.01</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># è¾…åŠ©æŸå¤±çš„æƒé‡</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">seq_aux</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">bool</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token plain">           </span><span class="token comment" style="color:#999988;font-style:italic"># æ˜¯å¦ä½¿ç”¨åºåˆ—çº§è¾…åŠ©æŸå¤±</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">norm_topk_prob</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">bool</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">True</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># æ˜¯å¦å½’ä¸€åŒ– Top-K æ¦‚ç‡</span><br></span></code></pre></div></div>
<p><strong>éšå–»è§£é‡Š</strong>:</p>
<p><strong>é—®é¢˜åœºæ™¯</strong>:</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">å†™ä½œå›¢é˜Ÿçš„&quot;å·æ‡’&quot;é—®é¢˜:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ä¸“å®¶A å¤ªå—æ¬¢è¿,æ¯å¤©å¤„ç† 1000 ä¸ªä»»åŠ¡(è¿‡è½½!)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ä¸“å®¶B æ²¡äººæ‰¾,æ¯å¤©åªå¤„ç† 10 ä¸ªä»»åŠ¡(æ‘¸é±¼!)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ç»“æœ:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ä¸“å®¶A ç´¯åäº†,è´¨é‡ä¸‹é™</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ä¸“å®¶B æŠ€èƒ½é€€åŒ–</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- å›¢é˜Ÿæ•´ä½“æ•ˆç‡ä½ä¸‹</span><br></span></code></pre></div></div>
<p><strong>è§£å†³æ–¹æ¡ˆ</strong>: <strong>è¾…åŠ©æŸå¤±</strong>(Auxiliary Loss)</p>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># åœ¨è®­ç»ƒæ—¶é¢å¤–æ·»åŠ ä¸€ä¸ª&quot;è´Ÿè½½å‡è¡¡æŸå¤±&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">total_loss </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ä¸»ä»»åŠ¡æŸå¤± </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> aux_loss_alpha </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> è´Ÿè½½å‡è¡¡æŸå¤±</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">è´Ÿè½½å‡è¡¡æŸå¤± </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> é¼“åŠ±æ¯ä¸ªä¸“å®¶çš„å·¥ä½œé‡æ¥è¿‘å¹³å‡å€¼</span><br></span></code></pre></div></div>
<p><strong>å‚æ•°è¯¦è§£</strong>:</p>
<ol>
<li class="">
<p><strong><code>aux_loss_alpha=0.01</code></strong>:</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">æ§åˆ¶&quot;è´Ÿè½½å‡è¡¡&quot;çš„é‡è¦æ€§</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- å¤ªå°(å¦‚ 0.001): ä¸“å®¶ä»ç„¶ä¼šå·æ‡’</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- å¤ªå¤§(å¦‚ 0.1): ä¸ºäº†å‡è¡¡è´Ÿè½½,ç‰ºç‰²äº†ä»»åŠ¡æ•ˆæœ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- 0.01 æ˜¯ç»éªŒæœ€ä¼˜å€¼</span><br></span></code></pre></div></div>
</li>
<li class="">
<p><strong><code>seq_aux=True</code></strong>:</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">True:  åœ¨æ¯ä¸ªå¥å­å†…éƒ¨ä¿è¯è´Ÿè½½å‡è¡¡</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">False: åœ¨æ•´ä¸ªbatchä¸­ä¿è¯è´Ÿè½½å‡è¡¡</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ä¾‹å­:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">å¥å­A: &quot;è®¨è®ºé‡å­åŠ›å­¦&quot; â†’ åº”è¯¥å¤šç”¨ç§‘å­¦ä¸“å®¶</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">å¥å­B: &quot;æè¿°çˆ±æƒ…æ•…äº‹&quot; â†’ åº”è¯¥å¤šç”¨æ–‡å­¦ä¸“å®¶</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">seq_aux=True æ—¶,ä¼šåˆ†åˆ«ç»Ÿè®¡å¥å­Aå’Œå¥å­Bçš„ä¸“å®¶åˆ†å¸ƒ</span><br></span></code></pre></div></div>
</li>
<li class="">
<p><strong><code>norm_topk_prob=True</code></strong>:</p>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># è·¯ç”±å™¨è¾“å‡ºçš„åŸå§‹åˆ†æ•°</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">scores </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0.5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.15</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.05</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 4ä¸ªä¸“å®¶</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">top2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0.5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># é€‰æ‹©å‰2ä¸ª</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">norm_topk_prob</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ç›´æ¥ä½¿ç”¨ </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0.5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">norm_topk_prob</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  å½’ä¸€åŒ–ä¸º </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0.625</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.375</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0.5</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">0.8</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0.625</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.3</span><span class="token operator" style="color:#393A34">/</span><span class="token number" style="color:#36acaa">0.8</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0.375</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">å¥½å¤„</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> å½’ä¸€åŒ–åçš„æƒé‡å’Œä¸º</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">æ•°å€¼æ›´ç¨³å®š</span><br></span></code></pre></div></div>
</li>
</ol>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-é…ç½®æ€»ç»“è¡¨">ğŸ“Š é…ç½®æ€»ç»“è¡¨<a href="#-é…ç½®æ€»ç»“è¡¨" class="hash-link" aria-label="Direct link to ğŸ“Š é…ç½®æ€»ç»“è¡¨" title="Direct link to ğŸ“Š é…ç½®æ€»ç»“è¡¨" translate="no">â€‹</a></h3>
<table><thead><tr><th>å‚æ•°ç±»åˆ«</th><th>å‚æ•°å</th><th>é»˜è®¤å€¼</th><th>ä½œç”¨</th><th>ç±»æ¯”</th></tr></thead><tbody><tr><td><strong>æ ¸å¿ƒç»“æ„</strong></td><td><code>hidden_size</code></td><td>512</td><td>æ¨¡å‹ç»´åº¦</td><td>å¤§è„‘ç¥ç»å…ƒæ•°é‡</td></tr><tr><td></td><td><code>num_hidden_layers</code></td><td>8</td><td>Transformerå±‚æ•°</td><td>æ€è€ƒæ·±åº¦</td></tr><tr><td></td><td><code>num_attention_heads</code></td><td>8</td><td>æ³¨æ„åŠ›å¤´æ•°</td><td>åŒæ—¶å…³æ³¨çš„ç„¦ç‚¹æ•°</td></tr><tr><td></td><td><code>num_key_value_heads</code></td><td>2</td><td>KVå¤´æ•°(GQA)</td><td>å…±äº«è®°å¿†ç´¢å¼•æ•°</td></tr><tr><td></td><td><code>vocab_size</code></td><td>6400</td><td>è¯è¡¨å¤§å°</td><td>è¯æ±‡é‡</td></tr><tr><td><strong>æ€§èƒ½ä¼˜åŒ–</strong></td><td><code>intermediate_size</code></td><td>None (auto)</td><td>FFNä¸­é—´å±‚ç»´åº¦</td><td>è”æƒ³æ‰©å±•å€æ•°</td></tr><tr><td></td><td><code>dropout</code></td><td>0.0</td><td>Dropoutæ¯”ä¾‹</td><td>éšæœºé—å¿˜ç‡</td></tr><tr><td></td><td><code>flash_attn</code></td><td>True</td><td>æ˜¯å¦ç”¨Flash Attn</td><td>æ˜¯å¦ç”¨å¿«é€Ÿç®—æ³•</td></tr><tr><td><strong>ä½ç½®ç¼–ç </strong></td><td><code>max_position_embeddings</code></td><td>32768</td><td>æœ€å¤§åºåˆ—é•¿åº¦</td><td>çŸ­æœŸè®°å¿†å®¹é‡</td></tr><tr><td></td><td><code>rope_theta</code></td><td>1000000</td><td>RoPEåŸºé¢‘</td><td>ä½ç½®æ—¶é’Ÿçš„è½¬é€Ÿ</td></tr><tr><td><strong>ç‰¹æ®ŠToken</strong></td><td><code>bos_token_id</code></td><td>1</td><td>å¥å­å¼€å§‹ç¬¦</td><td>ã€</td></tr><tr><td></td><td><code>eos_token_id</code></td><td>2</td><td>å¥å­ç»“æŸç¬¦</td><td>ã€‘</td></tr><tr><td><strong>MoEæ¶æ„</strong></td><td><code>use_moe</code></td><td>False</td><td>æ˜¯å¦å¯ç”¨MoE</td><td>æ˜¯å¦ç”¨ä¸“å®¶å›¢é˜Ÿ</td></tr><tr><td></td><td><code>n_routed_experts</code></td><td>4</td><td>è·¯ç”±ä¸“å®¶æ•°</td><td>ä¸“ä¸šä½œå®¶æ•°é‡</td></tr><tr><td></td><td><code>num_experts_per_tok</code></td><td>2</td><td>æ¯è¯é€‰æ‹©ä¸“å®¶æ•°</td><td>æ¯ä»»åŠ¡åˆ†é…äººæ•°</td></tr><tr><td></td><td><code>n_shared_experts</code></td><td>1</td><td>å…±äº«ä¸“å®¶æ•°</td><td>é€šç”¨åŠ©æ‰‹æ•°é‡</td></tr><tr><td></td><td><code>aux_loss_alpha</code></td><td>0.01</td><td>è¾…åŠ©æŸå¤±æƒé‡</td><td>è´Ÿè½½å‡è¡¡é‡è¦æ€§</td></tr></tbody></table>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-é…ç½®å®æˆ˜å»ºè®®">ğŸ’¡ é…ç½®å®æˆ˜å»ºè®®<a href="#-é…ç½®å®æˆ˜å»ºè®®" class="hash-link" aria-label="Direct link to ğŸ’¡ é…ç½®å®æˆ˜å»ºè®®" title="Direct link to ğŸ’¡ é…ç½®å®æˆ˜å»ºè®®" translate="no">â€‹</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="åœºæ™¯1-è®­ç»ƒä¸­æ–‡å¯¹è¯å°æ¨¡å‹">åœºæ™¯1: è®­ç»ƒä¸­æ–‡å¯¹è¯å°æ¨¡å‹<a href="#åœºæ™¯1-è®­ç»ƒä¸­æ–‡å¯¹è¯å°æ¨¡å‹" class="hash-link" aria-label="Direct link to åœºæ™¯1: è®­ç»ƒä¸­æ–‡å¯¹è¯å°æ¨¡å‹" title="Direct link to åœºæ™¯1: è®­ç»ƒä¸­æ–‡å¯¹è¯å°æ¨¡å‹" translate="no">â€‹</a></h4>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> MiniMindConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hidden_size</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">512</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># å°æ¨¡å‹,é™ä½è®¡ç®—æˆæœ¬</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    num_hidden_layers</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># 8å±‚è¶³å¤Ÿç®€å•å¯¹è¯</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    num_attention_heads</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    num_key_value_heads</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># ä½¿ç”¨GQAèŠ‚çœæ˜¾å­˜</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vocab_size</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">6400</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># ä¸­æ–‡å¸¸ç”¨å­—</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    max_position_embeddings</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2048</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># çŸ­å¯¹è¯åœºæ™¯</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dropout</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">              </span><span class="token comment" style="color:#999988;font-style:italic"># å¤§è§„æ¨¡æ•°æ®ä¸éœ€è¦dropout</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    flash_attn</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># å¿…å¼€,æé€Ÿæ˜æ˜¾</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    use_moe</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># å•ä¸€ä»»åŠ¡ä¸éœ€è¦MoE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="åœºæ™¯2-è®­ç»ƒå¤šè¯­è¨€å¤§æ¨¡å‹">åœºæ™¯2: è®­ç»ƒå¤šè¯­è¨€å¤§æ¨¡å‹<a href="#åœºæ™¯2-è®­ç»ƒå¤šè¯­è¨€å¤§æ¨¡å‹" class="hash-link" aria-label="Direct link to åœºæ™¯2: è®­ç»ƒå¤šè¯­è¨€å¤§æ¨¡å‹" title="Direct link to åœºæ™¯2: è®­ç»ƒå¤šè¯­è¨€å¤§æ¨¡å‹" translate="no">â€‹</a></h4>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> MiniMindConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hidden_size</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2048</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">         </span><span class="token comment" style="color:#999988;font-style:italic"># å¤§æ¨¡å‹</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    num_hidden_layers</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">24</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic"># æ·±å±‚ç½‘ç»œ</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    num_attention_heads</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">32</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    num_key_value_heads</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vocab_size</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">64000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">         </span><span class="token comment" style="color:#999988;font-style:italic"># å¤šè¯­è¨€è¯è¡¨</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    max_position_embeddings</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">8192</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># æ”¯æŒé•¿æ–‡æ¡£</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    flash_attn</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    use_moe</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">             </span><span class="token comment" style="color:#999988;font-style:italic"># å¯ç”¨MoEå¤„ç†å¤šè¯­è¨€</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    n_routed_experts</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># 16ä¸ªè¯­è¨€ä¸“å®¶</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    num_experts_per_tok</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># æ¯è¯é€‰4ä¸ªä¸“å®¶</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    n_shared_experts</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">       </span><span class="token comment" style="color:#999988;font-style:italic"># 2ä¸ªé€šç”¨ä¸“å®¶</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    aux_loss_alpha</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0.01</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="åœºæ™¯3-æ¨ç†ä¼˜åŒ–é…ç½®é•¿æ–‡æœ¬ç”Ÿæˆ">åœºæ™¯3: æ¨ç†ä¼˜åŒ–é…ç½®(é•¿æ–‡æœ¬ç”Ÿæˆ)<a href="#åœºæ™¯3-æ¨ç†ä¼˜åŒ–é…ç½®é•¿æ–‡æœ¬ç”Ÿæˆ" class="hash-link" aria-label="Direct link to åœºæ™¯3: æ¨ç†ä¼˜åŒ–é…ç½®(é•¿æ–‡æœ¬ç”Ÿæˆ)" title="Direct link to åœºæ™¯3: æ¨ç†ä¼˜åŒ–é…ç½®(é•¿æ–‡æœ¬ç”Ÿæˆ)" translate="no">â€‹</a></h4>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> MiniMindConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hidden_size</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1024</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    num_hidden_layers</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">12</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    num_attention_heads</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    num_key_value_heads</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># GQAå¤§å¹…å‡å°‘KV Cache</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    max_position_embeddings</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">32768</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># æ”¯æŒé•¿æ–‡æœ¬</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rope_theta</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1000000.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic"># é•¿ä¸Šä¸‹æ–‡ä¸“ç”¨</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    inference_rope_scaling</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># å¯ç”¨YaRNå¤–æ¨</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    flash_attn</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># æ¨ç†æ—¶ä¹Ÿèƒ½åŠ é€Ÿ</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_aDle" id="ä¸‰å­¦ä¹ è¿›åº¦çš„å­˜æ¡£ä¸è¯»æ¡£æ¨¡å‹æ£€æŸ¥ç‚¹-lm_checkpoint">ä¸‰ã€å­¦ä¹ è¿›åº¦çš„å­˜æ¡£ä¸è¯»æ¡£ï¼šæ¨¡å‹æ£€æŸ¥ç‚¹ (lm_checkpoint)<a href="#ä¸‰å­¦ä¹ è¿›åº¦çš„å­˜æ¡£ä¸è¯»æ¡£æ¨¡å‹æ£€æŸ¥ç‚¹-lm_checkpoint" class="hash-link" aria-label="Direct link to ä¸‰ã€å­¦ä¹ è¿›åº¦çš„å­˜æ¡£ä¸è¯»æ¡£ï¼šæ¨¡å‹æ£€æŸ¥ç‚¹ (lm_checkpoint)" title="Direct link to ä¸‰ã€å­¦ä¹ è¿›åº¦çš„å­˜æ¡£ä¸è¯»æ¡£ï¼šæ¨¡å‹æ£€æŸ¥ç‚¹ (lm_checkpoint)" translate="no">â€‹</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-ä»£ç ç‰‡æ®µ-ç¬¬-124-246-è¡Œ">ğŸ“ ä»£ç ç‰‡æ®µ (ç¬¬ 124-246 è¡Œ)<a href="#-ä»£ç ç‰‡æ®µ-ç¬¬-124-246-è¡Œ" class="hash-link" aria-label="Direct link to ğŸ“ ä»£ç ç‰‡æ®µ (ç¬¬ 124-246 è¡Œ)" title="Direct link to ğŸ“ ä»£ç ç‰‡æ®µ (ç¬¬ 124-246 è¡Œ)" translate="no">â€‹</a></h3>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">lm_checkpoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lm_config</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    weight</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;full_sft&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    model</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    optimizer</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    epoch</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    step</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    wandb</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    save_dir</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;../checkpoints&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">**</span><span class="token plain">kwargs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    æ¨¡å‹æ£€æŸ¥ç‚¹ä¿å­˜ä¸åŠ è½½å‡½æ•°ã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Args:</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        lm_config: æ¨¡å‹é…ç½®å¯¹è±¡,ç”¨äºè·å– hidden_size å’Œæ˜¯å¦ä½¿ç”¨ MoEã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        weight: æƒé‡æ–‡ä»¶åæ ‡è¯†,é»˜è®¤ä¸º &#x27;full_sft&#x27;ã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        model: æ¨¡å‹å®ä¾‹ã€‚å¦‚æœä¸ä¸º None,åˆ™æ‰§è¡Œä¿å­˜æ“ä½œ;ä¸º None åˆ™æ‰§è¡ŒåŠ è½½æ“ä½œã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        optimizer: ä¼˜åŒ–å™¨å®ä¾‹,ä»…åœ¨ä¿å­˜æ—¶éœ€è¦ã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        epoch: å½“å‰è®­ç»ƒè½®æ•°ã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        step: å½“å‰è®­ç»ƒæ­¥æ•°ã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        wandb: Weights &amp; Biases å®ä¾‹,ç”¨äºè®°å½• run id ä»¥ä¾¿æ–­ç‚¹ç»­ä¼ ã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        save_dir: æ£€æŸ¥ç‚¹ä¿å­˜ç›®å½•ã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        **kwargs: å…¶ä»–éœ€è¦ä¿å­˜çš„å¯¹è±¡(å¦‚ scheduler),å¦‚æœå¯¹è±¡æœ‰ state_dict æ–¹æ³•ä¼šè‡ªåŠ¨è°ƒç”¨ã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Returns:</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        åŠ è½½æ¨¡å¼ä¸‹è¿”å›åŒ…å«æ¢å¤ä¿¡æ¯çš„å­—å…¸ (dict),å¦åˆ™è¿”å› Noneã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 1. å‡†å¤‡ä¿å­˜ç›®å½•å’Œè·¯å¾„</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">makedirs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">save_dir</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> exist_ok</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># ç¡®ä¿ç›®å½•å­˜åœ¨</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    moe_path </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;_moe&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> lm_config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">use_moe </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># MoE æ¨¡å‹æ·»åŠ ç‰¹æ®Šåç¼€</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># çº¯æƒé‡æ–‡ä»¶è·¯å¾„ (ä»…åŒ…å« model state_dict,ä½“ç§¯å°,ç”¨äºæ¨ç†)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ckp_path </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&quot;</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">save_dir</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">/</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">weight</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">_</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">lm_config</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">hidden_size</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">moe_path</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">.pth&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># æ¢å¤æ–‡ä»¶è·¯å¾„ (åŒ…å« model, optimizer, step, epoch ç­‰,ç”¨äºæ–­ç‚¹ç»­è®­)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    resume_path </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&quot;</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">save_dir</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">/</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">weight</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">_</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">lm_config</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">hidden_size</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">moe_path</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">_resume.pth&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> model </span><span class="token keyword" style="color:#00009f">is</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># ==================== ä¿å­˜æ¨¡å¼ ====================</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># 2. è§£åŒ…æ¨¡å‹ (Unwrap)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># å¦‚æœæ˜¯ DDP (åˆ†å¸ƒå¼) æ¨¡å‹,å–å…¶ .module</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        raw_model </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">module </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token builtin">isinstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> DistributedDataParallel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> model</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># å¦‚æœæ˜¯ torch.compile ç¼–è¯‘åçš„æ¨¡å‹,å–å…¶ _orig_mod</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        raw_model </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">getattr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">raw_model</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;_orig_mod&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> raw_model</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># 3. å¤„ç†æ¨¡å‹æƒé‡ (Save Model Weights)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        state_dict </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> raw_model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state_dict</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># å°†æƒé‡è½¬ä¸ºåŠç²¾åº¦ (FP16) å¹¶ç§»åŠ¨åˆ° CPU,èŠ‚çœå­˜å‚¨ç©ºé—´å’Œæ˜¾å­˜</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        state_dict </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">k</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">half</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cpu</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> k</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> state_dict</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">items</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># 4. åŸå­ä¿å­˜æƒé‡æ–‡ä»¶ (Atomic Save)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ckp_tmp </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ckp_path </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;.tmp&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">save</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">state_dict</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ckp_tmp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># å…ˆå†™å…¥ä¸´æ—¶æ–‡ä»¶</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">replace</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ckp_tmp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ckp_path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># åŸå­æ›¿æ¢,é˜²æ­¢å†™å…¥ä¸­æ–­å¯¼è‡´æ–‡ä»¶æŸå</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># 5. è·å– WandB Run ID (ç”¨äºæ¢å¤æ›²çº¿)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        wandb_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> wandb</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token builtin">hasattr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">wandb</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;get_run&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                run </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> wandb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                wandb_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">getattr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">run</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;id&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> run </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                wandb_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">getattr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">wandb</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;id&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># 6. æ„å»ºæ¢å¤æ•°æ®å­—å…¸ (Resume Data)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        resume_data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;model&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> state_dict</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># æ¨¡å‹æƒé‡</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;optimizer&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> optimizer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state_dict</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># ä¼˜åŒ–å™¨çŠ¶æ€</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;epoch&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> epoch</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># å½“å‰ Epoch</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;step&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> step</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># å½“å‰ Step</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;world_size&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> dist</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_world_size</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> dist</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">is_initialized</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># ä¿å­˜æ—¶çš„ GPU æ•°é‡</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;wandb_id&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> wandb_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># WandB ID</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># 7. å¤„ç†é¢å¤–çš„ kwargs (å¦‚ LR Scheduler)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> value </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> kwargs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">items</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> value </span><span class="token keyword" style="color:#00009f">is</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token builtin">hasattr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;state_dict&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token comment" style="color:#999988;font-style:italic"># å¦‚æœæ˜¯ DDP æˆ–ç¼–è¯‘åçš„å¯¹è±¡,åŒæ ·éœ€è¦è§£åŒ…</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    raw_value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">module</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token builtin">isinstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> DistributedDataParallel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    raw_value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">getattr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">raw_value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;_orig_mod&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> raw_value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    resume_data</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> raw_value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state_dict</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    resume_data</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># 8. åŸå­ä¿å­˜æ¢å¤æ–‡ä»¶</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        resume_tmp </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> resume_path </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;.tmp&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">save</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">resume_data</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> resume_tmp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">replace</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">resume_tmp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> resume_path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># 9. æ¸…ç†èµ„æº</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">del</span><span class="token plain"> state_dict</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> resume_data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cuda</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">empty_cache</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># é‡Šæ”¾æ˜¾å­˜</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># ==================== åŠ è½½æ¨¡å¼ ====================</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">path</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">exists</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">resume_path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># 1. åŠ è½½æ¢å¤æ–‡ä»¶åˆ° CPU</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ckp_data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">resume_path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> map_location</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;cpu&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># 2. å¤„ç† GPU æ•°é‡å˜åŒ–å¸¦æ¥çš„ Step å·®å¼‚</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># åœºæ™¯:ä¾‹å¦‚ 4 å¡å˜ 8 å¡,Global Batch Size ç¿»å€,æ€» Step æ•°åº”å‡åŠ</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            saved_ws </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ckp_data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;world_size&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            current_ws </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> dist</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_world_size</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> dist</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">is_initialized</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> saved_ws </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> current_ws</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                ckp_data</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;step&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ckp_data</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;step&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> saved_ws </span><span class="token operator" style="color:#393A34">//</span><span class="token plain"> current_ws</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token string-interpolation string" style="color:#e3116c">f&quot;GPUæ•°é‡å˜åŒ–(</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">saved_ws</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">â†’</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">current_ws</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">),stepå·²è‡ªåŠ¨è½¬æ¢ä¸º</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">ckp_data</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">[</span><span class="token string-interpolation interpolation string" style="color:#e3116c">&#x27;step&#x27;</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">]</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> ckp_data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><br></span></code></pre></div></div>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-éšå–»ç¿»è¯‘å°æ˜å­¦ä¹ çš„å­˜æ¡£ä¸è¯»æ¡£ç³»ç»Ÿ">ğŸ¯ éšå–»ç¿»è¯‘ï¼šå°æ˜å­¦ä¹ çš„&quot;å­˜æ¡£&quot;ä¸&quot;è¯»æ¡£&quot;ç³»ç»Ÿ<a href="#-éšå–»ç¿»è¯‘å°æ˜å­¦ä¹ çš„å­˜æ¡£ä¸è¯»æ¡£ç³»ç»Ÿ" class="hash-link" aria-label="Direct link to ğŸ¯ éšå–»ç¿»è¯‘ï¼šå°æ˜å­¦ä¹ çš„&quot;å­˜æ¡£&quot;ä¸&quot;è¯»æ¡£&quot;ç³»ç»Ÿ" title="Direct link to ğŸ¯ éšå–»ç¿»è¯‘ï¼šå°æ˜å­¦ä¹ çš„&quot;å­˜æ¡£&quot;ä¸&quot;è¯»æ¡£&quot;ç³»ç»Ÿ" translate="no">â€‹</a></h3>
<p>æƒ³è±¡å°æ˜åœ¨å­¦ä¹ å†™å°è¯´çš„è¿‡ç¨‹å°±åƒç©ä¸€æ¬¾ RPG æ¸¸æˆ,è€Œ <code>lm_checkpoint</code> å‡½æ•°å°±æ˜¯æ¸¸æˆçš„<strong>å­˜æ¡£/è¯»æ¡£ç³»ç»Ÿ</strong>ã€‚</p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-æ ¸å¿ƒæ¦‚å¿µä¸ºä»€ä¹ˆéœ€è¦æ£€æŸ¥ç‚¹">ğŸ® æ ¸å¿ƒæ¦‚å¿µï¼šä¸ºä»€ä¹ˆéœ€è¦æ£€æŸ¥ç‚¹?<a href="#-æ ¸å¿ƒæ¦‚å¿µä¸ºä»€ä¹ˆéœ€è¦æ£€æŸ¥ç‚¹" class="hash-link" aria-label="Direct link to ğŸ® æ ¸å¿ƒæ¦‚å¿µï¼šä¸ºä»€ä¹ˆéœ€è¦æ£€æŸ¥ç‚¹?" title="Direct link to ğŸ® æ ¸å¿ƒæ¦‚å¿µï¼šä¸ºä»€ä¹ˆéœ€è¦æ£€æŸ¥ç‚¹?" translate="no">â€‹</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="é—®é¢˜åœºæ™¯-1">é—®é¢˜åœºæ™¯<a href="#é—®é¢˜åœºæ™¯-1" class="hash-link" aria-label="Direct link to é—®é¢˜åœºæ™¯" title="Direct link to é—®é¢˜åœºæ™¯" translate="no">â€‹</a></h4>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">å°æ˜è®­ç»ƒäº† 7 å¤© (è®­ç»ƒæ¨¡å‹):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ç¬¬ 1 å¤©: å­¦ä¼šäº†åŸºç¡€è¯­æ³•</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ç¬¬ 2 å¤©: å­¦ä¼šäº†æå†™äººç‰©</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ç¬¬ 7 å¤©: æ­£åœ¨å­¦ä¹ å¤æ‚çš„æƒ…èŠ‚æ„å»º</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">çªç„¶åœç”µäº†! (è®­ç»ƒä¸­æ–­)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- å¦‚æœæ²¡æœ‰å­˜æ¡£: 7 å¤©çš„å­¦ä¹ æˆæœå…¨éƒ¨ä¸¢å¤±,å¿…é¡»ä»å¤´å¼€å§‹!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- å¦‚æœæœ‰å­˜æ¡£: å¯ä»¥ä»ç¬¬ 6 å¤©çš„çŠ¶æ€ç»§ç»­,åªæŸå¤± 1 å¤©çš„è¿›åº¦</span><br></span></code></pre></div></div>
<p><strong>ç°å®ä¸­çš„è®­ç»ƒä¸­æ–­åŸå› </strong>:</p>
<ul>
<li class="">ğŸ”Œ åœç”µ/æœåŠ¡å™¨é‡å¯</li>
<li class="">ğŸ’¥ ç¨‹åºå´©æºƒ(OOMã€CUDAé”™è¯¯)</li>
<li class="">â° é›†ç¾¤ä»»åŠ¡æ—¶é—´åˆ°æœŸ(å¾ˆå¤šå…¬å¸GPUèµ„æºæœ‰æ—¶é—´é™åˆ¶)</li>
<li class="">ğŸ”§ éœ€è¦è°ƒæ•´è¶…å‚æ•°</li>
<li class="">ğŸ“Š å®šæœŸä¿å­˜æœ€ä½³æ¨¡å‹</li>
</ul>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-ä¸¤ç§å­˜æ¡£æ–‡ä»¶è½»é‡æ¨ç†-vs-å®Œæ•´æ¢å¤">ğŸ“¦ ä¸¤ç§å­˜æ¡£æ–‡ä»¶ï¼šè½»é‡æ¨ç† vs å®Œæ•´æ¢å¤<a href="#-ä¸¤ç§å­˜æ¡£æ–‡ä»¶è½»é‡æ¨ç†-vs-å®Œæ•´æ¢å¤" class="hash-link" aria-label="Direct link to ğŸ“¦ ä¸¤ç§å­˜æ¡£æ–‡ä»¶ï¼šè½»é‡æ¨ç† vs å®Œæ•´æ¢å¤" title="Direct link to ğŸ“¦ ä¸¤ç§å­˜æ¡£æ–‡ä»¶ï¼šè½»é‡æ¨ç† vs å®Œæ•´æ¢å¤" translate="no">â€‹</a></h3>
<p>ä»£ç ä¸­ç”Ÿæˆäº†<strong>ä¸¤ä¸ªæ–‡ä»¶</strong>,å°±åƒæ¸¸æˆçš„&quot;å¿«é€Ÿå­˜æ¡£&quot;å’Œ&quot;å®Œæ•´å­˜æ¡£&quot;:</p>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># ç¬¬ 157-159 è¡Œ</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ckp_path </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&quot;</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">save_dir</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">/</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">weight</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">_</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">lm_config</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">hidden_size</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">moe_path</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">.pth&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># ä¾‹å¦‚: checkpoints/full_sft_512.pth</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resume_path </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&quot;</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">save_dir</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">/</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">weight</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">_</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">lm_config</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">hidden_size</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">moe_path</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">_resume.pth&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># ä¾‹å¦‚: checkpoints/full_sft_512_resume.pth</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="-æ–‡ä»¶-1-çº¯æƒé‡æ–‡ä»¶-ckp_path">ğŸ“„ æ–‡ä»¶ 1: çº¯æƒé‡æ–‡ä»¶ (ckp_path)<a href="#-æ–‡ä»¶-1-çº¯æƒé‡æ–‡ä»¶-ckp_path" class="hash-link" aria-label="Direct link to ğŸ“„ æ–‡ä»¶ 1: çº¯æƒé‡æ–‡ä»¶ (ckp_path)" title="Direct link to ğŸ“„ æ–‡ä»¶ 1: çº¯æƒé‡æ–‡ä»¶ (ckp_path)" translate="no">â€‹</a></h4>
<p><strong>ç±»æ¯”</strong>: å°æ˜çš„&quot;æŠ€èƒ½å¡ç‰‡&quot;</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">åªåŒ…å«:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">âœ“ å°æ˜çš„å†™ä½œèƒ½åŠ› (æ¨¡å‹å‚æ•°)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ä¸åŒ…å«:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">âœ— å°æ˜çš„å­¦ä¹ è¿›åº¦ (epoch/step)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">âœ— å°æ˜çš„&quot;å­¦ä¹ ç¬”è®°&quot; (optimizerçŠ¶æ€)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">âœ— è®­ç»ƒæ—¥å¿—çš„ID (wandb_id)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ç”¨é€”:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">â†’ ç”¨äºæ¨ç†/éƒ¨ç½² (åªéœ€è¦&quot;ä¼šå†™ä½œ&quot;,ä¸éœ€è¦&quot;ç»§ç»­å­¦ä¹ &quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">â†’ åˆ†äº«ç»™åˆ«äººä½¿ç”¨</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">â†’ æ–‡ä»¶è¾ƒå° (çº¦ 500MB)</span><br></span></code></pre></div></div>
<p><strong>ä»£ç å®ç°</strong> (ç¬¬ 173-180 è¡Œ):</p>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">state_dict </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> raw_model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state_dict</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># è·å–æ‰€æœ‰å‚æ•°</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">state_dict </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">k</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">half</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cpu</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> k</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> state_dict</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">items</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># â†‘ è½¬ä¸º FP16 (åŸæœ¬æ˜¯ FP32),å‡å° 50% ä½“ç§¯</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ckp_tmp </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ckp_path </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;.tmp&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">save</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">state_dict</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ckp_tmp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># å…ˆä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">replace</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ckp_tmp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ckp_path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># åŸå­æ›¿æ¢ (é˜²æ­¢ä¿å­˜åˆ°ä¸€åŠæ–­ç”µ)</span><br></span></code></pre></div></div>
<p><strong>ä¸ºä»€ä¹ˆç”¨ <code>.tmp</code> ä¸´æ—¶æ–‡ä»¶?</strong></p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">é”™è¯¯åšæ³•:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">torch.save(state_dict, &quot;model.pth&quot;)  # ç›´æ¥ä¿å­˜</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">â†’ å¦‚æœä¿å­˜åˆ°ä¸€åŠæ–­ç”µ,model.pth æ–‡ä»¶æŸå,æ— æ³•ä½¿ç”¨!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">æ­£ç¡®åšæ³•:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">torch.save(state_dict, &quot;model.pth.tmp&quot;)  # å…ˆå†™ä¸´æ—¶æ–‡ä»¶</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">os.replace(&quot;model.pth.tmp&quot;, &quot;model.pth&quot;)  # åŸå­æ“ä½œ (è¦ä¹ˆå…¨æˆåŠŸ,è¦ä¹ˆå…¨å¤±è´¥)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">â†’ å³ä½¿æ–­ç”µ,ä¹Ÿåªä¼šæŸå¤±ä¸´æ—¶æ–‡ä»¶,åŸæ–‡ä»¶ä¾ç„¶å®Œå¥½</span><br></span></code></pre></div></div>
<p><strong>ç±»æ¯”</strong>: å°±åƒç¼–è¾‘æ–‡æ¡£æ—¶,è½¯ä»¶ä¼šå…ˆä¿å­˜åˆ° <code>æ–‡æ¡£.docx.tmp</code>,ç¡®è®¤å†™å…¥æˆåŠŸåå†æ›¿æ¢åŸæ–‡ä»¶ã€‚</p>
<hr>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="-æ–‡ä»¶-2-å®Œæ•´æ¢å¤æ–‡ä»¶-resume_path">ğŸ“š æ–‡ä»¶ 2: å®Œæ•´æ¢å¤æ–‡ä»¶ (resume_path)<a href="#-æ–‡ä»¶-2-å®Œæ•´æ¢å¤æ–‡ä»¶-resume_path" class="hash-link" aria-label="Direct link to ğŸ“š æ–‡ä»¶ 2: å®Œæ•´æ¢å¤æ–‡ä»¶ (resume_path)" title="Direct link to ğŸ“š æ–‡ä»¶ 2: å®Œæ•´æ¢å¤æ–‡ä»¶ (resume_path)" translate="no">â€‹</a></h4>
<p><strong>ç±»æ¯”</strong>: å°æ˜çš„&quot;å®Œæ•´å­¦ä¹ æ¡£æ¡ˆ&quot;</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">åŒ…å«æ‰€æœ‰è®­ç»ƒçŠ¶æ€:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">âœ“ å°æ˜çš„å†™ä½œèƒ½åŠ› (model state_dict)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">âœ“ å°æ˜çš„å­¦ä¹ è¿›åº¦ (epoch: 7, step: 15000)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">âœ“ å°æ˜çš„&quot;å­¦ä¹ ç¬”è®°&quot; (optimizer state_dict)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  â†‘ è®°å½•äº†å“ªäº›çŸ¥è¯†ç‚¹éœ€è¦é‡ç‚¹å¤ä¹  (æ¢¯åº¦åŠ¨é‡ã€å­¦ä¹ ç‡ç­‰)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">âœ“ è®­ç»ƒæ—¥å¿—çš„ID (wandb_id)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">âœ“ å½“æ—¶ç”¨äº†å‡ ä¸ªGPU (world_size: 4)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">âœ“ å…¶ä»–è®­ç»ƒç»„ä»¶ (å¦‚å­¦ä¹ ç‡è°ƒåº¦å™¨ scheduler)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ç”¨é€”:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">â†’ æ–­ç‚¹ç»­è®­ (ä»ä¸­æ–­çš„åœ°æ–¹ç»§ç»­è®­ç»ƒ)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">â†’ æ–‡ä»¶è¾ƒå¤§ (çº¦ 1GB,å› ä¸ºåŒ…å« optimizer çŠ¶æ€)</span><br></span></code></pre></div></div>
<p><strong>ä»£ç å®ç°</strong> (ç¬¬ 192-221 è¡Œ):</p>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">resume_data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;model&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> state_dict</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">                    </span><span class="token comment" style="color:#999988;font-style:italic"># æ¨¡å‹æƒé‡</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;optimizer&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> optimizer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state_dict</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># ä¼˜åŒ–å™¨çŠ¶æ€</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;epoch&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> epoch</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">                         </span><span class="token comment" style="color:#999988;font-style:italic"># å½“å‰ç¬¬å‡ è½®</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;step&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> step</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">                           </span><span class="token comment" style="color:#999988;font-style:italic"># å½“å‰ç¬¬å‡ æ­¥</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;world_size&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> dist</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_world_size</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> dist</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">is_initialized</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;wandb_id&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> wandb_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">                   </span><span class="token comment" style="color:#999988;font-style:italic"># è®­ç»ƒæ›²çº¿çš„ID</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># å¤„ç†é¢å¤–çš„è®­ç»ƒç»„ä»¶ (å¦‚ LR Scheduler)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> value </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> kwargs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">items</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token builtin">hasattr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;state_dict&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        resume_data</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state_dict</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># ä¿å­˜è°ƒåº¦å™¨çŠ¶æ€</span><br></span></code></pre></div></div>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-å…³é”®æŠ€æœ¯ç»†èŠ‚">ğŸ” å…³é”®æŠ€æœ¯ç»†èŠ‚<a href="#-å…³é”®æŠ€æœ¯ç»†èŠ‚" class="hash-link" aria-label="Direct link to ğŸ” å…³é”®æŠ€æœ¯ç»†èŠ‚" title="Direct link to ğŸ” å…³é”®æŠ€æœ¯ç»†èŠ‚" translate="no">â€‹</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="1-æ¨¡å‹è§£åŒ…-ç¬¬-164-170-è¡Œ">1. æ¨¡å‹&quot;è§£åŒ…&quot; (ç¬¬ 164-170 è¡Œ)<a href="#1-æ¨¡å‹è§£åŒ…-ç¬¬-164-170-è¡Œ" class="hash-link" aria-label="Direct link to 1. æ¨¡å‹&quot;è§£åŒ…&quot; (ç¬¬ 164-170 è¡Œ)" title="Direct link to 1. æ¨¡å‹&quot;è§£åŒ…&quot; (ç¬¬ 164-170 è¡Œ)" translate="no">â€‹</a></h4>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># é—®é¢˜: è®­ç»ƒæ—¶çš„æ¨¡å‹å¯èƒ½è¢«&quot;åŒ…è£…&quot;äº†å¤šå±‚</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">raw_model </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">module </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token builtin">isinstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> DistributedDataParallel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> model</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">raw_model </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">getattr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">raw_model</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;_orig_mod&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> raw_model</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><strong>éšå–»è§£é‡Š</strong>:</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">è®­ç»ƒæ—¶çš„æ¨¡å‹å°±åƒ&quot;ä¿„ç½—æ–¯å¥—å¨ƒ&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">å¤–å±‚åŒ…è£… 1: DistributedDataParallel (å¤šGPUå¹¶è¡Œè®­ç»ƒ)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  â†“</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">å¤–å±‚åŒ…è£… 2: torch.compile (PyTorch 2.0 ç¼–è¯‘ä¼˜åŒ–)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  â†“</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">å†…æ ¸: çœŸæ­£çš„ MiniMindForCausalLM æ¨¡å‹</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ä¿å­˜æ—¶éœ€è¦&quot;è§£åŒ…&quot;åˆ°æœ€é‡Œå±‚,å¦åˆ™:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ä¿å­˜çš„æ–‡ä»¶åŒ…å«å¤šä½™çš„åŒ…è£…ä»£ç </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- åŠ è½½æ—¶å¯èƒ½å› ä¸ºç¯å¢ƒä¸åŒ (å¦‚å•GPU) è€Œå¤±è´¥</span><br></span></code></pre></div></div>
<p><strong>ä»£ç é€»è¾‘</strong>:</p>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># æ­¥éª¤ 1: æ£€æŸ¥æ˜¯å¦æ˜¯ DDP åŒ…è£…</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token builtin">isinstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> DistributedDataParallel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    raw_model </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">module  </span><span class="token comment" style="color:#999988;font-style:italic"># å–å‡ºå†…éƒ¨çš„åŸå§‹æ¨¡å‹</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    raw_model </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> model</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># æ­¥éª¤ 2: æ£€æŸ¥æ˜¯å¦æ˜¯ compile åŒ…è£…</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token builtin">hasattr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">raw_model</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;_orig_mod&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    raw_model </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> raw_model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_orig_mod  </span><span class="token comment" style="color:#999988;font-style:italic"># å–å‡ºç¼–è¯‘å‰çš„åŸå§‹æ¨¡å‹</span><br></span></code></pre></div></div>
<hr>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="2-fp16-å‹ç¼©-ç¬¬-175-è¡Œ">2. FP16 å‹ç¼© (ç¬¬ 175 è¡Œ)<a href="#2-fp16-å‹ç¼©-ç¬¬-175-è¡Œ" class="hash-link" aria-label="Direct link to 2. FP16 å‹ç¼© (ç¬¬ 175 è¡Œ)" title="Direct link to 2. FP16 å‹ç¼© (ç¬¬ 175 è¡Œ)" translate="no">â€‹</a></h4>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">state_dict </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">k</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">half</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cpu</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> k</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> state_dict</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">items</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<p><strong>éšå–»è§£é‡Š</strong>:</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">åŸå§‹æ¨¡å‹å‚æ•° (FP32):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">æ¯ä¸ªæ•°å­—ç”¨ 32 ä½å­˜å‚¨: 3.141592653589793</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">â†’ ç²¾åº¦æé«˜,ä½†æ–‡ä»¶å¾ˆå¤§</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">å‹ç¼©å (FP16):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">æ¯ä¸ªæ•°å­—ç”¨ 16 ä½å­˜å‚¨: 3.141</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">â†’ ç²¾åº¦ç•¥é™ (å°æ•°ç‚¹å 4 ä½),ä½†æ–‡ä»¶å‡å° 50%</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ç±»æ¯”:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FP32 = 4K è¶…æ¸…ç”µå½± (10GB)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FP16 = 1080p é«˜æ¸…ç”µå½± (5GB)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">â†’ å¯¹äº&quot;å­˜æ¡£&quot;æ¥è¯´,1080p è¶³å¤Ÿæ¸…æ™°äº†</span><br></span></code></pre></div></div>
<p><strong>ä¸ºä»€ä¹ˆæ¨ç†æ—¶ç”¨ FP16 æ²¡é—®é¢˜?</strong></p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">è®­ç»ƒæ—¶:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- éœ€è¦è®¡ç®—æ¢¯åº¦ (å¾®å°çš„æ•°å€¼å˜åŒ–éƒ½å¾ˆé‡è¦)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- éœ€è¦é«˜ç²¾åº¦ (FP32 æˆ– BF16)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">æ¨ç†æ—¶:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- åªåšå‰å‘ä¼ æ’­,ä¸è®¡ç®—æ¢¯åº¦</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- FP16 ç²¾åº¦å®Œå…¨å¤Ÿç”¨,ä¸”é€Ÿåº¦æ›´å¿«</span><br></span></code></pre></div></div>
<hr>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="3-åŸå­ä¿å­˜-ç¬¬-178-180-è¡Œ">3. åŸå­ä¿å­˜ (ç¬¬ 178-180 è¡Œ)<a href="#3-åŸå­ä¿å­˜-ç¬¬-178-180-è¡Œ" class="hash-link" aria-label="Direct link to 3. åŸå­ä¿å­˜ (ç¬¬ 178-180 è¡Œ)" title="Direct link to 3. åŸå­ä¿å­˜ (ç¬¬ 178-180 è¡Œ)" translate="no">â€‹</a></h4>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">ckp_tmp </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ckp_path </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;.tmp&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">save</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">state_dict</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ckp_tmp</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># å†™å…¥ä¸´æ—¶æ–‡ä»¶</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">replace</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ckp_tmp</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ckp_path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic"># åŸå­æ›¿æ¢</span><br></span></code></pre></div></div>
<p><strong>éšå–»è§£é‡Š</strong>:</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">åœºæ™¯: ä¿å­˜ä¸€ä¸ª 5GB çš„æ¨¡å‹æ–‡ä»¶</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">é”™è¯¯åšæ³•:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">torch.save(state, &quot;model.pth&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">â†’ ä¿å­˜è¿›åº¦: 10% ... 50% ... ğŸ’¥ æ–­ç”µ!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">â†’ ç»“æœ: model.pth æŸå (åªå†™äº†ä¸€åŠ,æ— æ³•åŠ è½½)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">æ­£ç¡®åšæ³•:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">torch.save(state, &quot;model.pth.tmp&quot;)  # å†™ä¸´æ—¶æ–‡ä»¶</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">â†’ ä¿å­˜è¿›åº¦: 10% ... 50% ... ğŸ’¥ æ–­ç”µ!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">â†’ ç»“æœ: model.pth.tmp æŸå,ä½†åŸæ¥çš„ model.pth å®Œå¥½æ— æŸ!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">å¦‚æœæˆåŠŸ:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">os.replace(&quot;model.pth.tmp&quot;, &quot;model.pth&quot;)  # ç¬é—´å®Œæˆ (åŸå­æ“ä½œ)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">â†’ è¦ä¹ˆæˆåŠŸæ›¿æ¢,è¦ä¹ˆä¿æŒåŸæ–‡ä»¶ä¸å˜</span><br></span></code></pre></div></div>
<p><strong><code>os.replace</code> çš„ç‰¹æ€§</strong>:</p>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># åŸå­æ“ä½œ (Atomic Operation):</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># - åœ¨æ“ä½œç³»ç»Ÿå±‚é¢ä¿è¯&quot;è¦ä¹ˆå…¨æˆåŠŸ,è¦ä¹ˆå…¨å¤±è´¥&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># - å³ä½¿æ“ä½œåˆ°ä¸€åŠæ–­ç”µ,ä¹Ÿä¸ä¼šäº§ç”Ÿ&quot;åŠæˆå“&quot;æ–‡ä»¶</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">replace</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">src</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dst</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># æ¨è!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># éåŸå­æ“ä½œ (æœ‰é£é™©):</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">remove</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dst</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># å…ˆåˆ é™¤æ—§æ–‡ä»¶</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">rename</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">src</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dst</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># å†é‡å‘½åæ–°æ–‡ä»¶</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># â†‘ å¦‚æœåœ¨ä¸¤æ­¥ä¹‹é—´æ–­ç”µ,dst æ–‡ä»¶å°±å½»åº•ä¸¢å¤±äº†!</span><br></span></code></pre></div></div>
<hr>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="4-wandb-id-ä¿å­˜-ç¬¬-183-189-è¡Œ">4. WandB ID ä¿å­˜ (ç¬¬ 183-189 è¡Œ)<a href="#4-wandb-id-ä¿å­˜-ç¬¬-183-189-è¡Œ" class="hash-link" aria-label="Direct link to 4. WandB ID ä¿å­˜ (ç¬¬ 183-189 è¡Œ)" title="Direct link to 4. WandB ID ä¿å­˜ (ç¬¬ 183-189 è¡Œ)" translate="no">â€‹</a></h4>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">wandb_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> wandb</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token builtin">hasattr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">wandb</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;get_run&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        run </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> wandb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        wandb_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">getattr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">run</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;id&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> run </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        wandb_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">getattr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">wandb</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;id&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><strong>éšå–»è§£é‡Š</strong>:</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">WandB (Weights &amp; Biases) = è®­ç»ƒè¿‡ç¨‹çš„&quot;è¡Œè½¦è®°å½•ä»ª&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ä½œç”¨:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- è®°å½•æ¯ä¸€æ­¥çš„ Lossã€Learning Rateã€Accuracy</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ç”Ÿæˆæ¼‚äº®çš„è®­ç»ƒæ›²çº¿å›¾</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- æ”¯æŒå¤šäººåä½œæŸ¥çœ‹</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">é—®é¢˜:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">å¦‚æœè®­ç»ƒä¸­æ–­åé‡æ–°å¼€å§‹,WandB ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ Run ID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">â†’ æ›²çº¿ä¼šæ–­å¼€,çœ‹èµ·æ¥åƒä¸¤æ¬¡ç‹¬ç«‹çš„è®­ç»ƒ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">è§£å†³æ–¹æ¡ˆ:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ä¿å­˜åŸæ¥çš„ wandb_id,æ¢å¤è®­ç»ƒæ—¶ç”¨åŒä¸€ä¸ª ID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">â†’ æ›²çº¿ä¼šæ— ç¼è¡”æ¥,çœ‹èµ·æ¥åƒä¸€æ¬¡å®Œæ•´çš„è®­ç»ƒ</span><br></span></code></pre></div></div>
<p><strong>ä½¿ç”¨ç¤ºä¾‹</strong>:</p>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># æ¢å¤è®­ç»ƒæ—¶</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ckp_data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> lm_checkpoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> model</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># åŠ è½½æ£€æŸ¥ç‚¹</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> ckp_data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    wandb_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ckp_data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;wandb_id&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    wandb</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">init</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">project</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;my_project&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">id</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">wandb_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> resume</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;allow&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># â†‘ ä½¿ç”¨ä¿å­˜çš„ ID,æ›²çº¿ä¼šæ¥ç€ä¹‹å‰çš„ç”»</span><br></span></code></pre></div></div>
<hr>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="5-å¤„ç†é¢å¤–çš„è®­ç»ƒç»„ä»¶-ç¬¬-203-216-è¡Œ">5. å¤„ç†é¢å¤–çš„è®­ç»ƒç»„ä»¶ (ç¬¬ 203-216 è¡Œ)<a href="#5-å¤„ç†é¢å¤–çš„è®­ç»ƒç»„ä»¶-ç¬¬-203-216-è¡Œ" class="hash-link" aria-label="Direct link to 5. å¤„ç†é¢å¤–çš„è®­ç»ƒç»„ä»¶ (ç¬¬ 203-216 è¡Œ)" title="Direct link to 5. å¤„ç†é¢å¤–çš„è®­ç»ƒç»„ä»¶ (ç¬¬ 203-216 è¡Œ)" translate="no">â€‹</a></h4>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> value </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> kwargs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">items</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> value </span><span class="token keyword" style="color:#00009f">is</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token builtin">hasattr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;state_dict&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            raw_value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">module </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token builtin">isinstance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> DistributedDataParallel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            raw_value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">getattr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">raw_value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;_orig_mod&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> raw_value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            resume_data</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> raw_value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state_dict</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            resume_data</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">key</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> value</span><br></span></code></pre></div></div>
<p><strong>éšå–»è§£é‡Š</strong>:</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">é™¤äº†æ¨¡å‹å’Œä¼˜åŒ–å™¨,è®­ç»ƒè¿˜å¯èƒ½ç”¨åˆ°:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1. LR Scheduler (å­¦ä¹ ç‡è°ƒåº¦å™¨):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - è®°å½•äº†&quot;å½“å‰å­¦ä¹ ç‡åº”è¯¥æ˜¯å¤šå°‘&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - å¦‚æœä¸ä¿å­˜,æ¢å¤åå­¦ä¹ ç‡ä¼šé‡ç½®,å½±å“æ”¶æ•›</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. Scaler (æ··åˆç²¾åº¦ç¼©æ”¾å™¨):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - è®°å½•äº† FP16 è®­ç»ƒçš„ç¼©æ”¾å› å­</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - å¦‚æœä¸ä¿å­˜,å¯èƒ½å¯¼è‡´æ¢¯åº¦æº¢å‡º</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. å…¶ä»–è‡ªå®šä¹‰ç»„ä»¶:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - å¦‚ EMA (æŒ‡æ•°ç§»åŠ¨å¹³å‡) çš„å½±å­æ¨¡å‹</span><br></span></code></pre></div></div>
<p><strong>ä½¿ç”¨ç¤ºä¾‹</strong>:</p>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># ä¿å­˜æ—¶</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">scheduler </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">optim</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lr_scheduler</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CosineAnnealingLR</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">optimizer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> T_max</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lm_checkpoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    config</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    model</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    optimizer</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">optimizer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    scheduler</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">scheduler</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># â† ä¼ å…¥ scheduler</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># æ¢å¤æ—¶</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ckp_data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> lm_checkpoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> model</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">optimizer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">load_state_dict</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ckp_data</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;optimizer&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">scheduler</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">load_state_dict</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ckp_data</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;scheduler&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># â† æ¢å¤ scheduler çŠ¶æ€</span><br></span></code></pre></div></div>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-åŠ è½½æ¨¡å¼ä»å­˜æ¡£ä¸­æ¢å¤">ğŸ”„ åŠ è½½æ¨¡å¼ï¼šä»å­˜æ¡£ä¸­æ¢å¤<a href="#-åŠ è½½æ¨¡å¼ä»å­˜æ¡£ä¸­æ¢å¤" class="hash-link" aria-label="Direct link to ğŸ”„ åŠ è½½æ¨¡å¼ï¼šä»å­˜æ¡£ä¸­æ¢å¤" title="Direct link to ğŸ”„ åŠ è½½æ¨¡å¼ï¼šä»å­˜æ¡£ä¸­æ¢å¤" translate="no">â€‹</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="ä»£ç é€»è¾‘-ç¬¬-227-246-è¡Œ">ä»£ç é€»è¾‘ (ç¬¬ 227-246 è¡Œ)<a href="#ä»£ç é€»è¾‘-ç¬¬-227-246-è¡Œ" class="hash-link" aria-label="Direct link to ä»£ç é€»è¾‘ (ç¬¬ 227-246 è¡Œ)" title="Direct link to ä»£ç é€»è¾‘ (ç¬¬ 227-246 è¡Œ)" translate="no">â€‹</a></h4>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># ==================== åŠ è½½æ¨¡å¼ ====================</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> os</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">path</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">exists</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">resume_path</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># 1. åŠ è½½æ¢å¤æ–‡ä»¶åˆ° CPU</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ckp_data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">resume_path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> map_location</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;cpu&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># 2. å¤„ç† GPU æ•°é‡å˜åŒ–å¸¦æ¥çš„ Step å·®å¼‚</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        saved_ws </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ckp_data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;world_size&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        current_ws </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> dist</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_world_size</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> dist</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">is_initialized</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> saved_ws </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> current_ws</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            ckp_data</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;step&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ckp_data</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;step&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> saved_ws </span><span class="token operator" style="color:#393A34">//</span><span class="token plain"> current_ws</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;GPUæ•°é‡å˜åŒ–(</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">saved_ws</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">â†’</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">current_ws</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">),stepå·²è‡ªåŠ¨è½¬æ¢ä¸º</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">ckp_data</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">[</span><span class="token string-interpolation interpolation string" style="color:#e3116c">&#x27;step&#x27;</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">]</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> ckp_data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><br></span></code></pre></div></div>
<hr>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="å…³é”®ç‚¹-1-map_locationcpu">å…³é”®ç‚¹ 1: <code>map_location=&quot;cpu&quot;</code><a href="#å…³é”®ç‚¹-1-map_locationcpu" class="hash-link" aria-label="Direct link to å…³é”®ç‚¹-1-map_locationcpu" title="Direct link to å…³é”®ç‚¹-1-map_locationcpu" translate="no">â€‹</a></h4>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">ckp_data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">resume_path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> map_location</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;cpu&quot;</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><strong>éšå–»è§£é‡Š</strong>:</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">é—®é¢˜åœºæ™¯:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ä¿å­˜æ—¶ç”¨çš„æ˜¯ 4 å— GPU,æ¯å— GPU çš„æ•°æ®åˆ†åˆ«åœ¨:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- cuda:0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- cuda:1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- cuda:2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- cuda:3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">åŠ è½½æ—¶å¯èƒ½:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- åªæœ‰ 1 å— GPU â†’ å¦‚æœç›´æ¥åŠ è½½åˆ° cuda:1,ä¼šæŠ¥é”™ (è®¾å¤‡ä¸å­˜åœ¨)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ç”¨çš„æ˜¯ CPU â†’ å¦‚æœç›´æ¥åŠ è½½åˆ° cuda:0,ä¼šæŠ¥é”™</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">è§£å†³æ–¹æ¡ˆ:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">å…ˆç»Ÿä¸€åŠ è½½åˆ° CPU,å†æ ¹æ®å®é™…æƒ…å†µåˆ†é…åˆ° GPU</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">â†’ ç±»ä¼¼äº&quot;å…ˆæŠŠè´§ç‰©å¸åˆ°ä»“åº“,å†æ ¹æ®éœ€è¦é…é€&quot;</span><br></span></code></pre></div></div>
<hr>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="å…³é”®ç‚¹-2-gpu-æ•°é‡å˜åŒ–çš„-step-è°ƒæ•´">å…³é”®ç‚¹ 2: GPU æ•°é‡å˜åŒ–çš„ Step è°ƒæ•´<a href="#å…³é”®ç‚¹-2-gpu-æ•°é‡å˜åŒ–çš„-step-è°ƒæ•´" class="hash-link" aria-label="Direct link to å…³é”®ç‚¹ 2: GPU æ•°é‡å˜åŒ–çš„ Step è°ƒæ•´" title="Direct link to å…³é”®ç‚¹ 2: GPU æ•°é‡å˜åŒ–çš„ Step è°ƒæ•´" translate="no">â€‹</a></h4>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">saved_ws </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ckp_data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;world_size&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># ä¿å­˜æ—¶ç”¨äº†å‡ å— GPU</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">current_ws </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> dist</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_world_size</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> dist</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">is_initialized</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># ç°åœ¨ç”¨å‡ å—</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> saved_ws </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> current_ws</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ckp_data</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;step&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ckp_data</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;step&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> saved_ws </span><span class="token operator" style="color:#393A34">//</span><span class="token plain"> current_ws</span><br></span></code></pre></div></div>
<p><strong>éšå–»è§£é‡Š</strong>:</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">è®­ç»ƒåœºæ™¯:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- åŸæ¥ç”¨ 4 å— GPU è®­ç»ƒåˆ°ç¬¬ 1000 æ­¥</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ç°åœ¨æ¢æˆ 8 å— GPU ç»§ç»­è®­ç»ƒ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">é—®é¢˜:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Global Batch Size = Per-GPU Batch Size Ã— GPU æ•°é‡</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- 4 GPU æ—¶: Batch=32 Ã— 4 = 128</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- 8 GPU æ—¶: Batch=32 Ã— 8 = 256 (ç¿»å€!)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">å½±å“:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">åŸæ¥ 1 æ­¥çœ‹ 128 ä¸ªæ ·æœ¬,ç°åœ¨ 1 æ­¥çœ‹ 256 ä¸ªæ ·æœ¬</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">â†’ å®é™…è¿›åº¦åº”è¯¥æ˜¯åŸæ¥çš„ 2 å€</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">è°ƒæ•´å…¬å¼:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">new_step = old_step Ã— old_gpu_count / new_gpu_count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">new_step = 1000 Ã— 4 / 8 = 500</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">è§£é‡Š:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">è™½ç„¶è·‘äº† 1000 æ­¥,ä½†å› ä¸º batch ç¿»å€,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">å®é™…ç›¸å½“äº 8 å¡ä¸‹çš„ 500 æ­¥</span><br></span></code></pre></div></div>
<p><strong>å®é™…ä¾‹å­</strong>:</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">åœºæ™¯ 1: ä» 4 å¡æ¢åˆ° 8 å¡</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">saved_ws = 4, current_ws = 8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">step = 1000 Ã— 4 / 8 = 500</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">â†’ é¿å…å­¦ä¹ ç‡è°ƒåº¦å™¨æå‰ç»“æŸ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">åœºæ™¯ 2: ä» 8 å¡æ¢åˆ° 4 å¡</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">saved_ws = 8, current_ws = 4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">step = 500 Ã— 8 / 4 = 1000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">â†’ é¿å…å­¦ä¹ ç‡è°ƒåº¦å™¨å»¶åç»“æŸ</span><br></span></code></pre></div></div>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-å®Œæ•´ä½¿ç”¨æµç¨‹">ğŸ’¡ å®Œæ•´ä½¿ç”¨æµç¨‹<a href="#-å®Œæ•´ä½¿ç”¨æµç¨‹" class="hash-link" aria-label="Direct link to ğŸ’¡ å®Œæ•´ä½¿ç”¨æµç¨‹" title="Direct link to ğŸ’¡ å®Œæ•´ä½¿ç”¨æµç¨‹" translate="no">â€‹</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="è®­ç»ƒè„šæœ¬ä¸­çš„å…¸å‹ç”¨æ³•">è®­ç»ƒè„šæœ¬ä¸­çš„å…¸å‹ç”¨æ³•<a href="#è®­ç»ƒè„šæœ¬ä¸­çš„å…¸å‹ç”¨æ³•" class="hash-link" aria-label="Direct link to è®­ç»ƒè„šæœ¬ä¸­çš„å…¸å‹ç”¨æ³•" title="Direct link to è®­ç»ƒè„šæœ¬ä¸­çš„å…¸å‹ç”¨æ³•" translate="no">â€‹</a></h4>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># ==================== åˆå§‹åŒ– ====================</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> MiniMindConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hidden_size</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">512</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> num_hidden_layers</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">model </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> MiniMindForCausalLM</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cuda</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">optimizer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">optim</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">AdamW</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">parameters</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> lr</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1e-4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">scheduler </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">optim</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">lr_scheduler</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">CosineAnnealingLR</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">optimizer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> T_max</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">10000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">start_epoch </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">start_step </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># ==================== å°è¯•åŠ è½½æ£€æŸ¥ç‚¹ ====================</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ckp_data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> lm_checkpoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> model</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> save_dir</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;./checkpoints&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> ckp_data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;å‘ç°æ£€æŸ¥ç‚¹,æ­£åœ¨æ¢å¤...&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">load_state_dict</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ckp_data</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;model&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    optimizer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">load_state_dict</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ckp_data</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;optimizer&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    scheduler</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">load_state_dict</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ckp_data</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;scheduler&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> scheduler</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state_dict</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    start_epoch </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ckp_data</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;epoch&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    start_step </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ckp_data</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;step&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;ä» Epoch </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">start_epoch</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">, Step </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">start_step</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"> ç»§ç»­è®­ç»ƒ&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;æœªå‘ç°æ£€æŸ¥ç‚¹,ä»å¤´å¼€å§‹è®­ç»ƒ&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># ==================== è®­ç»ƒå¾ªç¯ ====================</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> epoch </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">start_epoch</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> step</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> batch </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">enumerate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dataloader</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> epoch </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> start_epoch </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> step </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> start_step</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">continue</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># è·³è¿‡å·²ç»è®­ç»ƒè¿‡çš„æ­¥éª¤</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># ... è®­ç»ƒä»£ç  ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># æ¯ 1000 æ­¥ä¿å­˜ä¸€æ¬¡</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> step </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            lm_checkpoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                config</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                model</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                optimizer</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">optimizer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                epoch</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">epoch</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                step</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">step</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                scheduler</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">scheduler</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                save_dir</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;./checkpoints&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;æ£€æŸ¥ç‚¹å·²ä¿å­˜: Epoch </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">epoch</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">, Step </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">step</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="ï¸-å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ">âš ï¸ å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ<a href="#ï¸-å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ" class="hash-link" aria-label="Direct link to âš ï¸ å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ" title="Direct link to âš ï¸ å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ" translate="no">â€‹</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="é—®é¢˜-1-åŠ è½½æ£€æŸ¥ç‚¹æ—¶æŠ¥é”™-missing-keys-æˆ–-unexpected-keys">é—®é¢˜ 1: åŠ è½½æ£€æŸ¥ç‚¹æ—¶æŠ¥é”™ &quot;Missing keys&quot; æˆ– &quot;Unexpected keys&quot;<a href="#é—®é¢˜-1-åŠ è½½æ£€æŸ¥ç‚¹æ—¶æŠ¥é”™-missing-keys-æˆ–-unexpected-keys" class="hash-link" aria-label="Direct link to é—®é¢˜ 1: åŠ è½½æ£€æŸ¥ç‚¹æ—¶æŠ¥é”™ &quot;Missing keys&quot; æˆ– &quot;Unexpected keys&quot;" title="Direct link to é—®é¢˜ 1: åŠ è½½æ£€æŸ¥ç‚¹æ—¶æŠ¥é”™ &quot;Missing keys&quot; æˆ– &quot;Unexpected keys&quot;" translate="no">â€‹</a></h4>
<p><strong>åŸå› </strong>:</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">ä¿å­˜æ—¶çš„æ¨¡å‹ç»“æ„:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MiniMindForCausalLM(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    model: MiniMindModel(...),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lm_head: Linear(...)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">åŠ è½½æ—¶çš„æ¨¡å‹ç»“æ„:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">MiniMindModel(...)  # å°‘äº† lm_head!</span><br></span></code></pre></div></div>
<p><strong>è§£å†³æ–¹æ¡ˆ</strong>:</p>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># æ–¹æ³• 1: ä½¿ç”¨ strict=False (ä¸æ¨è,å¯èƒ½éšè—çœŸæ­£çš„é—®é¢˜)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">load_state_dict</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ckp_data</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;model&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> strict</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># æ–¹æ³• 2: æ‰‹åŠ¨è¿‡æ»¤ä¸åŒ¹é…çš„é”® (æ¨è)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">model_state </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ckp_data</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;model&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">model_keys </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">state_dict</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">keys</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ckp_keys </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">model_state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">keys</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">missing_keys </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> model_keys </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> ckp_keys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">unexpected_keys </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ckp_keys </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> model_keys</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> missing_keys</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;è­¦å‘Š: ç¼ºå°‘é”® </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">missing_keys</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> unexpected_keys</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;è­¦å‘Š: å¤šä½™é”® </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">unexpected_keys</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    model_state </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">k</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> v </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> k</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> model_state</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">items</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> k </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> model_keys</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">load_state_dict</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">model_state</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<hr>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="é—®é¢˜-2-æ˜¾å­˜ä¸è¶³æ— æ³•åŠ è½½æ£€æŸ¥ç‚¹">é—®é¢˜ 2: æ˜¾å­˜ä¸è¶³,æ— æ³•åŠ è½½æ£€æŸ¥ç‚¹<a href="#é—®é¢˜-2-æ˜¾å­˜ä¸è¶³æ— æ³•åŠ è½½æ£€æŸ¥ç‚¹" class="hash-link" aria-label="Direct link to é—®é¢˜ 2: æ˜¾å­˜ä¸è¶³,æ— æ³•åŠ è½½æ£€æŸ¥ç‚¹" title="Direct link to é—®é¢˜ 2: æ˜¾å­˜ä¸è¶³,æ— æ³•åŠ è½½æ£€æŸ¥ç‚¹" translate="no">â€‹</a></h4>
<p><strong>åŸå› </strong>:</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">åŠ è½½ checkpoint æ—¶:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1. å…ˆåŠ è½½åˆ° CPU (å ç”¨ 2GB å†…å­˜)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. å†å¤åˆ¶åˆ° GPU (å ç”¨ 2GB æ˜¾å­˜)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. æ¨¡å‹å·²ç»åœ¨ GPU ä¸Š (å ç”¨ 2GB æ˜¾å­˜)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">â†’ å³°å€¼æ˜¾å­˜: 4GB!</span><br></span></code></pre></div></div>
<p><strong>è§£å†³æ–¹æ¡ˆ</strong>:</p>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># æ–¹æ³• 1: å»¶è¿Ÿåˆå§‹åŒ–æ¨¡å‹</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ckp_data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> lm_checkpoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> model</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">model </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> MiniMindForCausalLM</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># å…ˆåˆ›å»ºç©ºæ¨¡å‹ (æ˜¾å­˜å ç”¨å°)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">load_state_dict</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ckp_data</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;model&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># å†åŠ è½½æƒé‡</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cuda</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># æœ€åç§»åŠ¨åˆ° GPU</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># æ–¹æ³• 2: ä½¿ç”¨ mmap æ¨¡å¼ (é€‚åˆè¶…å¤§æ¨¡å‹)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ckp_data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">load</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">resume_path</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> map_location</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;cpu&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mmap</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># â†‘ ä¸ä¼šä¸€æ¬¡æ€§åŠ è½½æ•´ä¸ªæ–‡ä»¶åˆ°å†…å­˜,è€Œæ˜¯æŒ‰éœ€è¯»å–</span><br></span></code></pre></div></div>
<hr>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="é—®é¢˜-3-å¤šæœºè®­ç»ƒæ—¶åªæœ‰-rank-0-ä¿å­˜æ£€æŸ¥ç‚¹">é—®é¢˜ 3: å¤šæœºè®­ç»ƒæ—¶,åªæœ‰ Rank 0 ä¿å­˜æ£€æŸ¥ç‚¹<a href="#é—®é¢˜-3-å¤šæœºè®­ç»ƒæ—¶åªæœ‰-rank-0-ä¿å­˜æ£€æŸ¥ç‚¹" class="hash-link" aria-label="Direct link to é—®é¢˜ 3: å¤šæœºè®­ç»ƒæ—¶,åªæœ‰ Rank 0 ä¿å­˜æ£€æŸ¥ç‚¹" title="Direct link to é—®é¢˜ 3: å¤šæœºè®­ç»ƒæ—¶,åªæœ‰ Rank 0 ä¿å­˜æ£€æŸ¥ç‚¹" translate="no">â€‹</a></h4>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># åœ¨åˆ†å¸ƒå¼è®­ç»ƒä¸­,åº”è¯¥åªè®©ä¸»è¿›ç¨‹ä¿å­˜</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> dist</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_rank</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># åªæœ‰ Rank 0 (ä¸»è¿›ç¨‹) æ‰§è¡Œä¿å­˜</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    lm_checkpoint</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        config</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        model</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        optimizer</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">optimizer</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># å…¶ä»–è¿›ç¨‹ç­‰å¾…ä¿å­˜å®Œæˆ</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> dist</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">is_initialized</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dist</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">barrier</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># åŒæ­¥,ç¡®ä¿ Rank 0 ä¿å­˜å®Œæˆåå†ç»§ç»­</span><br></span></code></pre></div></div>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-ä¸¤ç§æ–‡ä»¶çš„å¯¹æ¯”æ€»ç»“">ğŸ“Š ä¸¤ç§æ–‡ä»¶çš„å¯¹æ¯”æ€»ç»“<a href="#-ä¸¤ç§æ–‡ä»¶çš„å¯¹æ¯”æ€»ç»“" class="hash-link" aria-label="Direct link to ğŸ“Š ä¸¤ç§æ–‡ä»¶çš„å¯¹æ¯”æ€»ç»“" title="Direct link to ğŸ“Š ä¸¤ç§æ–‡ä»¶çš„å¯¹æ¯”æ€»ç»“" translate="no">â€‹</a></h3>
<table><thead><tr><th>ç‰¹æ€§</th><th>çº¯æƒé‡æ–‡ä»¶ (ckp_path)</th><th>å®Œæ•´æ¢å¤æ–‡ä»¶ (resume_path)</th></tr></thead><tbody><tr><td><strong>åŒ…å«å†…å®¹</strong></td><td>ä»…æ¨¡å‹å‚æ•°</td><td>æ¨¡å‹ + ä¼˜åŒ–å™¨ + è®­ç»ƒçŠ¶æ€</td></tr><tr><td><strong>æ–‡ä»¶å¤§å°</strong></td><td>~500MB</td><td>~1GB</td></tr><tr><td><strong>ç²¾åº¦</strong></td><td>FP16</td><td>FP16 (å¯æ”¹ä¸º FP32)</td></tr><tr><td><strong>ç”¨é€”</strong></td><td>æ¨ç†/éƒ¨ç½²</td><td>æ–­ç‚¹ç»­è®­</td></tr><tr><td><strong>æ˜¯å¦å¯è·¨GPUæ•°é‡</strong></td><td>âœ“ æ˜¯</td><td>âœ“ æ˜¯ (ä¼šè‡ªåŠ¨è°ƒæ•´ step)</td></tr><tr><td><strong>æ˜¯å¦å¯è·¨ä¼˜åŒ–å™¨</strong></td><td>âœ“ æ˜¯</td><td>âœ— å¦ (å¿…é¡»ç”¨ç›¸åŒçš„ä¼˜åŒ–å™¨)</td></tr><tr><td><strong>åŠ è½½é€Ÿåº¦</strong></td><td>å¿«</td><td>æ…¢ (æ–‡ä»¶æ›´å¤§)</td></tr></tbody></table>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-ç±»æ¯”æ€»ç»“-1">ğŸ“ ç±»æ¯”æ€»ç»“<a href="#-ç±»æ¯”æ€»ç»“-1" class="hash-link" aria-label="Direct link to ğŸ“ ç±»æ¯”æ€»ç»“" title="Direct link to ğŸ“ ç±»æ¯”æ€»ç»“" translate="no">â€‹</a></h3>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">lm_checkpoint å‡½æ•°å°±åƒ:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1. æ¸¸æˆçš„å­˜æ¡£ç³»ç»Ÿ:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - çº¯æƒé‡æ–‡ä»¶ = å¿«é€Ÿå­˜æ¡£ (åªä¿å­˜è§’è‰²å±æ€§,ç”¨äºå¿«é€Ÿè¯»å–)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - å®Œæ•´æ¢å¤æ–‡ä»¶ = å®Œæ•´å­˜æ¡£ (ä¿å­˜æ‰€æœ‰çŠ¶æ€,ç”¨äºå®Œç¾å¤åŸ)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. æ–‡æ¡£ç¼–è¾‘è½¯ä»¶:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - çº¯æƒé‡æ–‡ä»¶ = å¯¼å‡ºä¸º PDF (åªè¯»,ç”¨äºåˆ†äº«)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - å®Œæ•´æ¢å¤æ–‡ä»¶ = ä¿å­˜ä¸º .docx (å¯ç»§ç»­ç¼–è¾‘)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. è§†é¢‘å‰ªè¾‘è½¯ä»¶:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - çº¯æƒé‡æ–‡ä»¶ = å¯¼å‡ºä¸º MP4 (æˆå“,ç”¨äºæ’­æ”¾)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - å®Œæ•´æ¢å¤æ–‡ä»¶ = ä¿å­˜ä¸ºå·¥ç¨‹æ–‡ä»¶ (åŒ…å«æ‰€æœ‰ç´ æå’Œæ—¶é—´è½´,å¯ç»§ç»­å‰ªè¾‘)</span><br></span></code></pre></div></div>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-ä¸å…¶ä»–æ¨¡å—çš„å…³ç³»">ğŸ”— ä¸å…¶ä»–æ¨¡å—çš„å…³ç³»<a href="#-ä¸å…¶ä»–æ¨¡å—çš„å…³ç³»" class="hash-link" aria-label="Direct link to ğŸ”— ä¸å…¶ä»–æ¨¡å—çš„å…³ç³»" title="Direct link to ğŸ”— ä¸å…¶ä»–æ¨¡å—çš„å…³ç³»" translate="no">â€‹</a></h3>
<!-- -->
<hr>
<h2 class="anchor anchorTargetStickyNavbar_aDle" id="å››æ•™å°æ˜è¯†å­—åˆ†è¯å™¨-tokenizer-ä¸è¯åµŒå…¥-embedding">å››ã€æ•™å°æ˜è¯†å­—:åˆ†è¯å™¨ (Tokenizer) ä¸è¯åµŒå…¥ (Embedding)<a href="#å››æ•™å°æ˜è¯†å­—åˆ†è¯å™¨-tokenizer-ä¸è¯åµŒå…¥-embedding" class="hash-link" aria-label="Direct link to å››ã€æ•™å°æ˜è¯†å­—:åˆ†è¯å™¨ (Tokenizer) ä¸è¯åµŒå…¥ (Embedding)" title="Direct link to å››ã€æ•™å°æ˜è¯†å­—:åˆ†è¯å™¨ (Tokenizer) ä¸è¯åµŒå…¥ (Embedding)" translate="no">â€‹</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-æ ¸å¿ƒé—®é¢˜è®¡ç®—æœºå¦‚ä½•ç†è§£æ–‡å­—">ğŸ“ æ ¸å¿ƒé—®é¢˜:è®¡ç®—æœºå¦‚ä½•ç†è§£æ–‡å­—?<a href="#-æ ¸å¿ƒé—®é¢˜è®¡ç®—æœºå¦‚ä½•ç†è§£æ–‡å­—" class="hash-link" aria-label="Direct link to ğŸ“ æ ¸å¿ƒé—®é¢˜:è®¡ç®—æœºå¦‚ä½•ç†è§£æ–‡å­—?" title="Direct link to ğŸ“ æ ¸å¿ƒé—®é¢˜:è®¡ç®—æœºå¦‚ä½•ç†è§£æ–‡å­—?" translate="no">â€‹</a></h3>
<p><strong>é—®é¢˜åœºæ™¯</strong>:</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">å°æ˜çš„å¤§è„‘(ç¥ç»ç½‘ç»œ)åªèƒ½å¤„ç†æ•°å­—:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[0.5, -0.3, 0.8, ...]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ä½†æˆ‘ä»¬è¦æ•™ä»–å†™çš„æ˜¯æ–‡å­—:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;å°çº¢å¸½å»æ£®æ—&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">å¦‚ä½•æŠŠæ–‡å­—å˜æˆæ•°å­—?</span><br></span></code></pre></div></div>
<p><strong>è§£å†³æ–¹æ¡ˆ</strong>:ä¸¤æ­¥è½¬æ¢</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">æ–‡å­— â†’ [åˆ†è¯å™¨] â†’ Token ID â†’ [è¯åµŒå…¥] â†’ å‘é‡</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;å°çº¢å¸½&quot; â†’ 453 â†’ [0.2, -0.5, 0.3, ...]</span><br></span></code></pre></div></div>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-ç¬¬ä¸€æ­¥åˆ†è¯å™¨-tokenizer---å»ºç«‹è¯æ±‡è¡¨">ğŸ”¤ ç¬¬ä¸€æ­¥:åˆ†è¯å™¨ (Tokenizer) - å»ºç«‹&quot;è¯æ±‡è¡¨&quot;<a href="#-ç¬¬ä¸€æ­¥åˆ†è¯å™¨-tokenizer---å»ºç«‹è¯æ±‡è¡¨" class="hash-link" aria-label="Direct link to ğŸ”¤ ç¬¬ä¸€æ­¥:åˆ†è¯å™¨ (Tokenizer) - å»ºç«‹&quot;è¯æ±‡è¡¨&quot;" title="Direct link to ğŸ”¤ ç¬¬ä¸€æ­¥:åˆ†è¯å™¨ (Tokenizer) - å»ºç«‹&quot;è¯æ±‡è¡¨&quot;" translate="no">â€‹</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="ä»£ç ä½ç½®ä»å¤´å¼€å§‹è®­ç»ƒè‡ªå·±çš„å¤§æ¨¡å‹py1393">ä»£ç ä½ç½®:ä»å¤´å¼€å§‹è®­ç»ƒè‡ªå·±çš„å¤§æ¨¡å‹.py:1393<a href="#ä»£ç ä½ç½®ä»å¤´å¼€å§‹è®­ç»ƒè‡ªå·±çš„å¤§æ¨¡å‹py1393" class="hash-link" aria-label="Direct link to ä»£ç ä½ç½®:ä»å¤´å¼€å§‹è®­ç»ƒè‡ªå·±çš„å¤§æ¨¡å‹.py:1393" title="Direct link to ä»£ç ä½ç½®:ä»å¤´å¼€å§‹è®­ç»ƒè‡ªå·±çš„å¤§æ¨¡å‹.py:1393" translate="no">â€‹</a></h4>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># ç¬¬ 1393 è¡Œ</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tokenizer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> AutoTokenizer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_pretrained</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tokenizer_path</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="-éšå–»ç»™æ¯ä¸ªè¯åˆ†é…ä¸€ä¸ªèº«ä»½è¯å·">ğŸ¯ éšå–»:ç»™æ¯ä¸ªè¯åˆ†é…ä¸€ä¸ª&quot;èº«ä»½è¯å·&quot;<a href="#-éšå–»ç»™æ¯ä¸ªè¯åˆ†é…ä¸€ä¸ªèº«ä»½è¯å·" class="hash-link" aria-label="Direct link to ğŸ¯ éšå–»:ç»™æ¯ä¸ªè¯åˆ†é…ä¸€ä¸ª&quot;èº«ä»½è¯å·&quot;" title="Direct link to ğŸ¯ éšå–»:ç»™æ¯ä¸ªè¯åˆ†é…ä¸€ä¸ª&quot;èº«ä»½è¯å·&quot;" translate="no">â€‹</a></h4>
<p><strong>ç±»æ¯”åœºæ™¯</strong>:</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">å­¦æ ¡ç»™æ¯ä¸ªå­¦ç”Ÿåˆ†é…å­¦å·:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- å¼ ä¸‰ â†’ 001</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- æå›› â†’ 002</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ç‹äº” â†’ 003</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">åŒæ ·,åˆ†è¯å™¨ç»™æ¯ä¸ªè¯åˆ†é… ID:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- &quot;å°çº¢å¸½&quot; â†’ 453</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- &quot;å»&quot; â†’ 234</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- &quot;æ£®æ—&quot; â†’ 789</span><br></span></code></pre></div></div>
<hr>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="-åˆ†è¯å™¨çš„è¯å…¸ç»“æ„">ğŸ“– åˆ†è¯å™¨çš„&quot;è¯å…¸&quot;ç»“æ„<a href="#-åˆ†è¯å™¨çš„è¯å…¸ç»“æ„" class="hash-link" aria-label="Direct link to ğŸ“– åˆ†è¯å™¨çš„&quot;è¯å…¸&quot;ç»“æ„" title="Direct link to ğŸ“– åˆ†è¯å™¨çš„&quot;è¯å…¸&quot;ç»“æ„" translate="no">â€‹</a></h4>
<p><strong>è¯æ±‡è¡¨ç¤ºä¾‹</strong> (<code>vocab_size=6400</code>):</p>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">tokenizer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">vocab </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># ç‰¹æ®Šç¬¦å·</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;&lt;PAD&gt;&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># å¡«å……ç¬¦å· (ç”¨äºå¯¹é½åºåˆ—é•¿åº¦)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;&lt;BOS&gt;&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># å¥å­å¼€å§‹ (Beginning of Sequence)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;&lt;EOS&gt;&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># å¥å­ç»“æŸ (End of Sequence)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;&lt;UNK&gt;&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># æœªçŸ¥è¯ (Unknown)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># å¸¸ç”¨å­—è¯</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;æˆ‘&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;çš„&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;ä½ &quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;æ˜¯&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">7</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;åœ¨&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># å¸¸ç”¨è¯ç»„</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;å°çº¢å¸½&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">453</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;å»&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">234</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;æ£®æ—&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">789</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;å¤§ç°ç‹¼&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1024</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># ... (å…± 6400 ä¸ªè¯)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;é‡å­çº ç¼ &quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6399</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre></div></div>
<hr>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="-åˆ†è¯è¿‡ç¨‹æ–‡æœ¬--token-ids">ğŸ”§ åˆ†è¯è¿‡ç¨‹:æ–‡æœ¬ â†’ Token IDs<a href="#-åˆ†è¯è¿‡ç¨‹æ–‡æœ¬--token-ids" class="hash-link" aria-label="Direct link to ğŸ”§ åˆ†è¯è¿‡ç¨‹:æ–‡æœ¬ â†’ Token IDs" title="Direct link to ğŸ”§ åˆ†è¯è¿‡ç¨‹:æ–‡æœ¬ â†’ Token IDs" translate="no">â€‹</a></h4>
<p><strong>ç¤ºä¾‹ä»£ç </strong>:</p>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> transformers </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> AutoTokenizer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># åŠ è½½åˆ†è¯å™¨</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tokenizer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> AutoTokenizer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">from_pretrained</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;./tokenizer_config&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># è¾“å…¥æ–‡æœ¬</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">text </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;å°çº¢å¸½å»æ£®æ—&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># åˆ†è¯å¹¶ç¼–ç </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">token_ids </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> tokenizer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">encode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">text</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">token_ids</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># è¾“å‡º: [1, 453, 234, 789, 2]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#        â†‘   â†‘   â†‘   â†‘   â†‘</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#      BOS å°çº¢å¸½ å» æ£®æ— EOS</span><br></span></code></pre></div></div>
<p><strong>è¯¦ç»†æ­¥éª¤è§£æ</strong>:</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">Step 1: åˆ‡åˆ†è¯è¯­ (Tokenization)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">åŸæ–‡: &quot;å°çº¢å¸½å»æ£®æ—&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">â†“</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">åˆ‡åˆ†å: [&quot;å°çº¢å¸½&quot;, &quot;å»&quot;, &quot;æ£®æ—&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(ä¸­æ–‡åˆ†è¯å™¨å¯èƒ½æŒ‰å­—åˆ‡åˆ†æˆ–æŒ‰è¯åˆ‡åˆ†,å–å†³äºè®­ç»ƒæ–¹å¼)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Step 2: æŸ¥è¯å…¸ (Lookup)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;å°çº¢å¸½&quot; â†’ åœ¨è¯å…¸ä¸­æ‰¾åˆ° â†’ ID = 453</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;å»&quot;     â†’ åœ¨è¯å…¸ä¸­æ‰¾åˆ° â†’ ID = 234</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;æ£®æ—&quot;   â†’ åœ¨è¯å…¸ä¸­æ‰¾åˆ° â†’ ID = 789</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Step 3: æ·»åŠ ç‰¹æ®Šç¬¦å·</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">åŸå§‹ IDs: [453, 234, 789]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">â†“</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">æ·»åŠ  BOS å’Œ EOS:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[1, 453, 234, 789, 2]</span><br></span></code></pre></div></div>
<hr>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="-å¦‚æœé‡åˆ°ç”Ÿåƒ»è¯æ€ä¹ˆåŠ">ğŸ¤” å¦‚æœé‡åˆ°&quot;ç”Ÿåƒ»è¯&quot;æ€ä¹ˆåŠ?<a href="#-å¦‚æœé‡åˆ°ç”Ÿåƒ»è¯æ€ä¹ˆåŠ" class="hash-link" aria-label="Direct link to ğŸ¤” å¦‚æœé‡åˆ°&quot;ç”Ÿåƒ»è¯&quot;æ€ä¹ˆåŠ?" title="Direct link to ğŸ¤” å¦‚æœé‡åˆ°&quot;ç”Ÿåƒ»è¯&quot;æ€ä¹ˆåŠ?" translate="no">â€‹</a></h4>
<p><strong>åœºæ™¯</strong>:</p>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">text </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;å°çº¢å¸½å»é‡å­æ£®æ—&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#               â†‘â†‘</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#            è¯å…¸é‡Œæ²¡æœ‰è¿™ä¸ªè¯!</span><br></span></code></pre></div></div>
<p><strong>ä¸‰ç§å¤„ç†ç­–ç•¥</strong>:</p>
<h5 class="anchor anchorTargetStickyNavbar_aDle" id="ç­–ç•¥-1-æ ‡è®°ä¸º-unk-unknown">ç­–ç•¥ 1: æ ‡è®°ä¸º <code>&lt;UNK&gt;</code> (Unknown)<a href="#ç­–ç•¥-1-æ ‡è®°ä¸º-unk-unknown" class="hash-link" aria-label="Direct link to ç­–ç•¥-1-æ ‡è®°ä¸º-unk-unknown" title="Direct link to ç­–ç•¥-1-æ ‡è®°ä¸º-unk-unknown" translate="no">â€‹</a></h5>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># è€å¼æ–¹æ³• (BERT æ—¶ä»£)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;é‡å­æ£®æ—&quot;</span><span class="token plain"> â†’ è¯å…¸ä¸­ä¸å­˜åœ¨ â†’ ID </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">UNK</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ç¼ºç‚¹</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> ä¿¡æ¯å®Œå…¨ä¸¢å¤±!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;é‡å­æ£®æ—&quot;</span><span class="token plain"> å’Œ </span><span class="token string" style="color:#e3116c">&quot;æ ¸èšå˜&quot;</span><span class="token plain"> éƒ½å˜æˆ </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">æ— æ³•åŒºåˆ†</span><br></span></code></pre></div></div>
<h5 class="anchor anchorTargetStickyNavbar_aDle" id="ç­–ç•¥-2-æ‹†åˆ†ä¸ºå­è¯-subword-tokenization">ç­–ç•¥ 2: æ‹†åˆ†ä¸ºå­è¯ (Subword Tokenization)<a href="#ç­–ç•¥-2-æ‹†åˆ†ä¸ºå­è¯-subword-tokenization" class="hash-link" aria-label="Direct link to ç­–ç•¥ 2: æ‹†åˆ†ä¸ºå­è¯ (Subword Tokenization)" title="Direct link to ç­–ç•¥ 2: æ‹†åˆ†ä¸ºå­è¯ (Subword Tokenization)" translate="no">â€‹</a></h5>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># ç°ä»£æ–¹æ³• (GPT/Llama å¸¸ç”¨: BPE, WordPiece, SentencePiece)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;é‡å­æ£®æ—&quot;</span><span class="token plain"> â†’ æ‹†åˆ†ä¸ºæ›´å°çš„å•å…ƒ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ä¾‹å¦‚ </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">BPE ç®—æ³•</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;é‡å­æ£®æ—&quot;</span><span class="token plain"> â†’ </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;é‡&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;å­&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;æ£®æ—&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          â†’ </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">4521</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4522</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">789</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ä¼˜ç‚¹</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> ä»»ä½•è¯éƒ½èƒ½è¡¨ç¤º </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">æœ€åæƒ…å†µæ‹†æˆå•å­—</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> å¸¸ç”¨è¯ä¿æŒå®Œæ•´ </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">å¦‚</span><span class="token string" style="color:#e3116c">&quot;æ£®æ—&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> ç”Ÿåƒ»è¯æ‹†æˆå°å— </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">å¦‚</span><span class="token string" style="color:#e3116c">&quot;é‡å­&quot;</span><span class="token plain"> â†’ </span><span class="token string" style="color:#e3116c">&quot;é‡&quot;</span><span class="token operator" style="color:#393A34">+</span><span class="token string" style="color:#e3116c">&quot;å­&quot;</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h5 class="anchor anchorTargetStickyNavbar_aDle" id="ç­–ç•¥-3-å­—èŠ‚çº§ç¼–ç -byte-level-encoding">ç­–ç•¥ 3: å­—èŠ‚çº§ç¼–ç  (Byte-level Encoding)<a href="#ç­–ç•¥-3-å­—èŠ‚çº§ç¼–ç -byte-level-encoding" class="hash-link" aria-label="Direct link to ç­–ç•¥ 3: å­—èŠ‚çº§ç¼–ç  (Byte-level Encoding)" title="Direct link to ç­–ç•¥ 3: å­—èŠ‚çº§ç¼–ç  (Byte-level Encoding)" translate="no">â€‹</a></h5>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># æœ€ç°ä»£çš„æ–¹æ³• (GPT-4, Llama 2)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ä»»ä½• Unicode å­—ç¬¦éƒ½èƒ½è¡¨ç¤ºä¸º UTF</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> å­—èŠ‚åºåˆ—</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token string" style="color:#e3116c">&quot;é‡å­æ£®æ—&quot;</span><span class="token plain"> â†’ UTF</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> å­—èŠ‚ â†’ </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0xE9</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x87</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0x8F</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> â†’ Token IDs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ä¼˜ç‚¹</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> è¦†ç›–ç‡</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">æ²¡æœ‰ </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">UNK</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> æ”¯æŒæ‰€æœ‰è¯­è¨€</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">åŒ…æ‹¬è¡¨æƒ…ç¬¦å· ğŸ‰</span><br></span></code></pre></div></div>
<hr>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="-ä¸åŒåˆ†è¯æ–¹å¼çš„å¯¹æ¯”">ğŸ“Š ä¸åŒåˆ†è¯æ–¹å¼çš„å¯¹æ¯”<a href="#-ä¸åŒåˆ†è¯æ–¹å¼çš„å¯¹æ¯”" class="hash-link" aria-label="Direct link to ğŸ“Š ä¸åŒåˆ†è¯æ–¹å¼çš„å¯¹æ¯”" title="Direct link to ğŸ“Š ä¸åŒåˆ†è¯æ–¹å¼çš„å¯¹æ¯”" translate="no">â€‹</a></h4>
<table><thead><tr><th>åˆ†è¯æ–¹æ³•</th><th>ä»£è¡¨æ¨¡å‹</th><th>ä¼˜ç‚¹</th><th>ç¼ºç‚¹</th><th>è¯è¡¨å¤§å°</th></tr></thead><tbody><tr><td><strong>è¯çº§åˆ«</strong> (Word-level)</td><td>Word2Vec</td><td>ç›´è§‚æ˜“æ‡‚</td><td>è¯è¡¨å·¨å¤§,ç”Ÿåƒ»è¯å¤š</td><td>50,000+</td></tr><tr><td><strong>å­—ç¬¦çº§åˆ«</strong> (Char-level)</td><td>CharRNN</td><td>è¯è¡¨å°,æ—  OOV</td><td>åºåˆ—å¤ªé•¿,å­¦ä¹ å›°éš¾</td><td>256 (ASCII)</td></tr><tr><td><strong>å­è¯çº§åˆ«</strong> (Subword: BPE/WordPiece)</td><td>BERT, GPT-2</td><td>å¹³è¡¡è¯è¡¨å’Œåºåˆ—é•¿åº¦</td><td>åˆ‡åˆ†æ–¹å¼ä¸ç›´è§‚</td><td>30,000-50,000</td></tr><tr><td><strong>å­—èŠ‚çº§åˆ«</strong> (Byte-level BPE)</td><td>GPT-4, Llama 2</td><td>å®Œç¾è¦†ç›–æ‰€æœ‰å­—ç¬¦</td><td>ä¸­æ–‡ç­‰è¯­è¨€åºåˆ—å˜é•¿</td><td>50,257</td></tr></tbody></table>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-ç¬¬äºŒæ­¥è¯åµŒå…¥-embedding---æŠŠ-id-å˜æˆæœ‰æ„ä¹‰çš„å‘é‡">ğŸ§® ç¬¬äºŒæ­¥:è¯åµŒå…¥ (Embedding) - æŠŠ ID å˜æˆ&quot;æœ‰æ„ä¹‰çš„å‘é‡&quot;<a href="#-ç¬¬äºŒæ­¥è¯åµŒå…¥-embedding---æŠŠ-id-å˜æˆæœ‰æ„ä¹‰çš„å‘é‡" class="hash-link" aria-label="Direct link to ğŸ§® ç¬¬äºŒæ­¥:è¯åµŒå…¥ (Embedding) - æŠŠ ID å˜æˆ&quot;æœ‰æ„ä¹‰çš„å‘é‡&quot;" title="Direct link to ğŸ§® ç¬¬äºŒæ­¥:è¯åµŒå…¥ (Embedding) - æŠŠ ID å˜æˆ&quot;æœ‰æ„ä¹‰çš„å‘é‡&quot;" translate="no">â€‹</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="ä»£ç ä½ç½®ä»å¤´å¼€å§‹è®­ç»ƒè‡ªå·±çš„å¤§æ¨¡å‹py1096">ä»£ç ä½ç½®:ä»å¤´å¼€å§‹è®­ç»ƒè‡ªå·±çš„å¤§æ¨¡å‹.py:1096<a href="#ä»£ç ä½ç½®ä»å¤´å¼€å§‹è®­ç»ƒè‡ªå·±çš„å¤§æ¨¡å‹py1096" class="hash-link" aria-label="Direct link to ä»£ç ä½ç½®:ä»å¤´å¼€å§‹è®­ç»ƒè‡ªå·±çš„å¤§æ¨¡å‹.py:1096" title="Direct link to ä»£ç ä½ç½®:ä»å¤´å¼€å§‹è®­ç»ƒè‡ªå·±çš„å¤§æ¨¡å‹.py:1096" translate="no">â€‹</a></h4>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># ç¬¬ 1096 è¡Œ</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">embed_tokens </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Embedding</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">vocab_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hidden_size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># ä¾‹å¦‚: nn.Embedding(6400, 512)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#                   â†‘      â†‘</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#                è¯è¡¨å¤§å°  å‘é‡ç»´åº¦</span><br></span></code></pre></div></div>
<hr>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="-éšå–»ä»èº«ä»½è¯å·åˆ°ä¸ªäººæ¡£æ¡ˆ">ğŸ¯ éšå–»:ä»&quot;èº«ä»½è¯å·&quot;åˆ°&quot;ä¸ªäººæ¡£æ¡ˆ&quot;<a href="#-éšå–»ä»èº«ä»½è¯å·åˆ°ä¸ªäººæ¡£æ¡ˆ" class="hash-link" aria-label="Direct link to ğŸ¯ éšå–»:ä»&quot;èº«ä»½è¯å·&quot;åˆ°&quot;ä¸ªäººæ¡£æ¡ˆ&quot;" title="Direct link to ğŸ¯ éšå–»:ä»&quot;èº«ä»½è¯å·&quot;åˆ°&quot;ä¸ªäººæ¡£æ¡ˆ&quot;" translate="no">â€‹</a></h4>
<p><strong>é—®é¢˜</strong>:</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">Token ID åªæ˜¯ä¸€ä¸ªç¼–å·:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">453 (ä»£è¡¨&quot;å°çº¢å¸½&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ä½†è¿™ä¸ªæ•°å­—æœ¬èº«æ²¡æœ‰ä»»ä½•æ„ä¹‰!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- è®¡ç®—æœºä¸çŸ¥é“ 453 å’Œ 454 æœ‰ä»€ä¹ˆå…³ç³»</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ä¸çŸ¥é“ 453 (&quot;å°çº¢å¸½&quot;) å’Œ 1024 (&quot;å¤§ç°ç‹¼&quot;) åœ¨è¯­ä¹‰ä¸Šæœ‰å…³è”</span><br></span></code></pre></div></div>
<p><strong>è§£å†³æ–¹æ¡ˆ:è¯åµŒå…¥ (Embedding)</strong></p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">æŠŠæ¯ä¸ª Token ID æ˜ å°„åˆ°ä¸€ä¸ª&quot;ç‰¹å¾å‘é‡&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Token ID 453 (&quot;å°çº¢å¸½&quot;) â†’ å‘é‡ [0.2, -0.5, 0.3, 0.8, ...]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                  â†‘     â†‘     â†‘     â†‘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                               æ€§åˆ«ç‰¹å¾ å¹´é¾„ç‰¹å¾ ç«¥è¯ç‰¹å¾ ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">è¿™ä¸ªå‘é‡åŒ…å«äº†è¯çš„&quot;è¯­ä¹‰ä¿¡æ¯&quot;!</span><br></span></code></pre></div></div>
<hr>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="-embedding-å±‚çš„å·¥ä½œåŸç†">ğŸ“– Embedding å±‚çš„å·¥ä½œåŸç†<a href="#-embedding-å±‚çš„å·¥ä½œåŸç†" class="hash-link" aria-label="Direct link to ğŸ“– Embedding å±‚çš„å·¥ä½œåŸç†" title="Direct link to ğŸ“– Embedding å±‚çš„å·¥ä½œåŸç†" translate="no">â€‹</a></h4>
<p><strong>æœ¬è´¨:ä¸€ä¸ªæŸ¥æ‰¾è¡¨ (Lookup Table)</strong></p>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Embedding å±‚çš„å†…éƒ¨ç»“æ„</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Embedding</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Module</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__init__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> vocab_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> hidden_size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># åˆ›å»ºä¸€ä¸ªæŸ¥æ‰¾è¡¨ (æƒé‡çŸ©é˜µ)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># å½¢çŠ¶: [vocab_size, hidden_size]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># ä¾‹å¦‚: [6400, 512]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">weight </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Parameter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">randn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">vocab_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> hidden_size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">forward</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> input_ids</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># input_ids: [batch_size, seq_len]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># ä¾‹å¦‚: [[1, 453, 234, 789, 2]]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># ç´¢å¼•æŸ¥æ‰¾ (ç±»ä¼¼äºå­—å…¸æŸ¥è¯¢)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">weight</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">input_ids</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># è¾“å‡º: [batch_size, seq_len, hidden_size]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># ä¾‹å¦‚: [1, 5, 512]</span><br></span></code></pre></div></div>
<hr>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="-å…·ä½“ä¾‹å­ä»-id-åˆ°å‘é‡">ğŸ” å…·ä½“ä¾‹å­:ä» ID åˆ°å‘é‡<a href="#-å…·ä½“ä¾‹å­ä»-id-åˆ°å‘é‡" class="hash-link" aria-label="Direct link to ğŸ” å…·ä½“ä¾‹å­:ä» ID åˆ°å‘é‡" title="Direct link to ğŸ” å…·ä½“ä¾‹å­:ä» ID åˆ°å‘é‡" translate="no">â€‹</a></h4>
<p><strong>å‡è®¾</strong>:</p>
<ul>
<li class=""><code>vocab_size = 6400</code></li>
<li class=""><code>hidden_size = 512</code></li>
</ul>
<p><strong>Embedding æƒé‡è¡¨</strong>:</p>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># å½¢çŠ¶: [6400, 512]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># æ¯ä¸€è¡Œæ˜¯ä¸€ä¸ªè¯çš„å‘é‡</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">embedding_table </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># ID 0: &lt;PAD&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 512 ä¸ª 0 (å¡«å……ç¬¦å·æ²¡æœ‰æ„ä¹‰)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># ID 1: &lt;BOS&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0.1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">0.2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.3</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># ID 453: &quot;å°çº¢å¸½&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0.2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">0.5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">0.4</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 512 ç»´å‘é‡</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># ID 234: &quot;å»&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">[</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">0.1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">0.2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.7</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># ID 789: &quot;æ£®æ—&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0.4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">0.3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.6</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">0.1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># ... (å…± 6400 è¡Œ)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><br></span></code></pre></div></div>
<p><strong>æŸ¥æ‰¾è¿‡ç¨‹</strong>:</p>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># è¾“å…¥: Token IDs</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">input_ids </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">tensor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">453</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">234</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">789</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># shape: [1, 5]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Embedding æŸ¥æ‰¾</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">embeddings </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> embed_tokens</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">input_ids</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># shape: [1, 5, 512]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># ç­‰ä»·äº:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">embeddings </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">stack</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    embedding_table</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># &lt;BOS&gt; çš„å‘é‡</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    embedding_table</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">453</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># &quot;å°çº¢å¸½&quot; çš„å‘é‡</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    embedding_table</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">234</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># &quot;å»&quot; çš„å‘é‡</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    embedding_table</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">789</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># &quot;æ£®æ—&quot; çš„å‘é‡</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    embedding_table</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># &lt;EOS&gt; çš„å‘é‡</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dim</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><strong>ç»“æœ</strong>:</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">åŸå§‹è¾“å…¥ (ç¦»æ•£ç¬¦å·):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;å°çº¢å¸½å»æ£®æ—&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ç»è¿‡ Tokenizer:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[1, 453, 234, 789, 2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ç»è¿‡ Embedding:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [0.1, -0.2, 0.5, ..., 0.3],    # &lt;BOS&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [0.2, -0.5, 0.3, ..., -0.4],   # å°çº¢å¸½</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [-0.1, 0.3, -0.2, ..., 0.7],   # å»</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [0.4, -0.3, 0.6, ..., 0.2],    # æ£®æ—</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  [0.05, 0.1, -0.1, ..., 0.0]    # &lt;EOS&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">å½¢çŠ¶: [1, 5, 512]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      â†‘  â†‘  â†‘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    batch seq hidden</span><br></span></code></pre></div></div>
<hr>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="-è¿™äº›å‘é‡çš„æ„ä¹‰ä»å“ªæ¥">ğŸ¤” è¿™äº›å‘é‡çš„&quot;æ„ä¹‰&quot;ä»å“ªæ¥?<a href="#-è¿™äº›å‘é‡çš„æ„ä¹‰ä»å“ªæ¥" class="hash-link" aria-label="Direct link to ğŸ¤” è¿™äº›å‘é‡çš„&quot;æ„ä¹‰&quot;ä»å“ªæ¥?" title="Direct link to ğŸ¤” è¿™äº›å‘é‡çš„&quot;æ„ä¹‰&quot;ä»å“ªæ¥?" translate="no">â€‹</a></h4>
<p><strong>å…³é”®:è®­ç»ƒè¿‡ç¨‹ä¸­è‡ªåŠ¨å­¦ä¹ !</strong></p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">åˆå§‹çŠ¶æ€ (éšæœºåˆå§‹åŒ–):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;å°çº¢å¸½&quot; â†’ [0.01, -0.02, 0.03, ...]  (éšæœºå™ªå£°,æ²¡æœ‰æ„ä¹‰)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;å¤§ç°ç‹¼&quot; â†’ [0.05, 0.01, -0.04, ...]  (ä¹Ÿæ˜¯éšæœºçš„)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">è®­ç»ƒè¿‡ç¨‹:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">æ¨¡å‹çœ‹äº†å¤§é‡ç«¥è¯æ•…äº‹å,å‘ç°:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- &quot;å°çº¢å¸½&quot; å’Œ &quot;å¤§ç°ç‹¼&quot; ç»å¸¸ä¸€èµ·å‡ºç°</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- &quot;å°çº¢å¸½&quot; å’Œ &quot;æ£®æ—&quot; ç»å¸¸ä¸€èµ·å‡ºç°</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- &quot;å°çº¢å¸½&quot; å’Œ &quot;é‡å­åŠ›å­¦&quot; å‡ ä¹ä¸å‡ºç°</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">é€šè¿‡åå‘ä¼ æ’­,Embedding å‘é‡é€æ¸è°ƒæ•´:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">è®­ç»ƒåçš„çŠ¶æ€:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;å°çº¢å¸½&quot; â†’ [0.8, -0.2, 0.9, ...]  (ç«¥è¯ç‰¹å¾=0.8, ç°ä»£ç§‘æŠ€ç‰¹å¾=-0.2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;å¤§ç°ç‹¼&quot; â†’ [0.7, -0.3, 0.8, ...]  (ç«¥è¯ç‰¹å¾=0.7, ç›¸ä¼¼!)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;é‡å­åŠ›å­¦&quot; â†’ [-0.5, 0.9, -0.6, ...] (ç«¥è¯ç‰¹å¾=-0.5, å¾ˆä¸åŒ!)</span><br></span></code></pre></div></div>
<p><strong>ç±»æ¯”</strong>:</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">å°±åƒä½ é€šè¿‡è§‚å¯Ÿå­¦ä¹ è¯ä¹‰:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ä½ è§è¿‡å¾ˆå¤šå¥å­:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- &quot;å°çº¢å¸½åœ¨æ£®æ—é‡Œé‡åˆ°äº†å¤§ç°ç‹¼&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- &quot;å°çº¢å¸½å®³æ€•å¤§ç°ç‹¼&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- &quot;å¤§ç°ç‹¼è¿½é€å°çº¢å¸½&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">å¤§è„‘è‡ªåŠ¨æ€»ç»“:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">â†’ &quot;å°çº¢å¸½&quot; å’Œ &quot;å¤§ç°ç‹¼&quot; æœ‰å…³è”</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">â†’ å®ƒä»¬çš„&quot;å‘é‡&quot;åº”è¯¥æ¯”è¾ƒæ¥è¿‘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">æ¨¡å‹ä¹Ÿæ˜¯è¿™æ ·å­¦ä¹ çš„!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">é€šè¿‡å¤§é‡æ–‡æœ¬,è‡ªåŠ¨å­¦ä¼šè¯ä¸è¯ä¹‹é—´çš„å…³ç³»</span><br></span></code></pre></div></div>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-æ€»ç»“ä»æ–‡å­—åˆ°å‘é‡çš„å®Œæ•´æµç¨‹">ğŸ’¡ æ€»ç»“:ä»æ–‡å­—åˆ°å‘é‡çš„å®Œæ•´æµç¨‹<a href="#-æ€»ç»“ä»æ–‡å­—åˆ°å‘é‡çš„å®Œæ•´æµç¨‹" class="hash-link" aria-label="Direct link to ğŸ’¡ æ€»ç»“:ä»æ–‡å­—åˆ°å‘é‡çš„å®Œæ•´æµç¨‹" title="Direct link to ğŸ’¡ æ€»ç»“:ä»æ–‡å­—åˆ°å‘é‡çš„å®Œæ•´æµç¨‹" translate="no">â€‹</a></h3>
<!-- -->
<hr>
<h2 class="anchor anchorTargetStickyNavbar_aDle" id="äº”å°æ˜çš„è”æƒ³å‘æ•£èƒ½åŠ›feedforward-å‰é¦ˆç½‘ç»œ-swiglu">äº”ã€å°æ˜çš„&quot;è”æƒ³å‘æ•£&quot;èƒ½åŠ›ï¼šFeedForward å‰é¦ˆç½‘ç»œ (SwiGLU)<a href="#äº”å°æ˜çš„è”æƒ³å‘æ•£èƒ½åŠ›feedforward-å‰é¦ˆç½‘ç»œ-swiglu" class="hash-link" aria-label="Direct link to äº”ã€å°æ˜çš„&quot;è”æƒ³å‘æ•£&quot;èƒ½åŠ›ï¼šFeedForward å‰é¦ˆç½‘ç»œ (SwiGLU)" title="Direct link to äº”ã€å°æ˜çš„&quot;è”æƒ³å‘æ•£&quot;èƒ½åŠ›ï¼šFeedForward å‰é¦ˆç½‘ç»œ (SwiGLU)" translate="no">â€‹</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-ä»£ç ç‰‡æ®µ-ç¬¬-249-298-è¡Œ">ğŸ“ ä»£ç ç‰‡æ®µ (ç¬¬ 249-298 è¡Œ)<a href="#-ä»£ç ç‰‡æ®µ-ç¬¬-249-298-è¡Œ" class="hash-link" aria-label="Direct link to ğŸ“ ä»£ç ç‰‡æ®µ (ç¬¬ 249-298 è¡Œ)" title="Direct link to ğŸ“ ä»£ç ç‰‡æ®µ (ç¬¬ 249-298 è¡Œ)" translate="no">â€‹</a></h3>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">FeedForward</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Module</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    å‰é¦ˆç¥ç»ç½‘ç»œå±‚ (Feed-Forward Network, FFN)ã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    è¿™é‡Œé‡‡ç”¨çš„æ˜¯ Llama æ¶æ„ä¸­ç»å…¸çš„ SwiGLU (Swish-Gated Linear Unit) å˜ä½“ã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    ç›¸æ¯”ä¼ ç»Ÿçš„ ReLU FFN (up_proj -&gt; relu -&gt; down_proj)ï¼ŒSwiGLU å¢åŠ äº†é—¨æ§æœºåˆ¶ï¼Œæ€§èƒ½é€šå¸¸æ›´å¥½ã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__init__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> MiniMindConfig</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token builtin">super</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">__init__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">intermediate_size </span><span class="token keyword" style="color:#00009f">is</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            intermediate_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hidden_size </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">intermediate_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">64</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">intermediate_size </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">64</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">//</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gate_proj </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Linear</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hidden_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">intermediate_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> bias</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">down_proj </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Linear</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">intermediate_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hidden_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> bias</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">up_proj </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Linear</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hidden_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">intermediate_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> bias</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dropout </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Dropout</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dropout</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">act_fn </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ACT2FN</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hidden_act</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">forward</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dropout</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">down_proj</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">act_fn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gate_proj</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">up_proj</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-éšå–»ç¿»è¯‘å°æ˜çš„æ€ç»´å‘æ•£ä¸æ”¶æ•›èƒ½åŠ›">ğŸ¯ éšå–»ç¿»è¯‘ï¼šå°æ˜çš„&quot;æ€ç»´å‘æ•£ä¸æ”¶æ•›&quot;èƒ½åŠ›<a href="#-éšå–»ç¿»è¯‘å°æ˜çš„æ€ç»´å‘æ•£ä¸æ”¶æ•›èƒ½åŠ›" class="hash-link" aria-label="Direct link to ğŸ¯ éšå–»ç¿»è¯‘ï¼šå°æ˜çš„&quot;æ€ç»´å‘æ•£ä¸æ”¶æ•›&quot;èƒ½åŠ›" title="Direct link to ğŸ¯ éšå–»ç¿»è¯‘ï¼šå°æ˜çš„&quot;æ€ç»´å‘æ•£ä¸æ”¶æ•›&quot;èƒ½åŠ›" translate="no">â€‹</a></h3>
<p>åœ¨ Transformer æ¶æ„ä¸­ï¼Œæ¯ä¸€å±‚éƒ½æœ‰ä¸¤ä¸ªæ ¸å¿ƒç»„ä»¶ï¼š</p>
<ol>
<li class=""><strong>Attention (æ³¨æ„åŠ›æœºåˆ¶)</strong>ï¼šè®©å°æ˜&quot;çœ‹åˆ°&quot;å¥å­ä¸­æ‰€æœ‰è¯çš„å…³ç³»</li>
<li class=""><strong>FeedForward (å‰é¦ˆç½‘ç»œ)</strong>ï¼šè®©å°æ˜å¯¹çœ‹åˆ°çš„å†…å®¹è¿›è¡Œ&quot;æ·±åº¦æ€è€ƒ&quot;</li>
</ol>
<p>FeedForward å°±åƒå°æ˜çš„<strong>è”æƒ³æ€ç»´èƒ½åŠ›</strong>â€”â€”çœ‹åˆ°ä¸€ä¸ªè¯åï¼Œå¤§è„‘ä¼šè¿…é€Ÿè”æƒ³åˆ°å¾ˆå¤šç›¸å…³æ¦‚å¿µï¼Œç„¶åç­›é€‰å‡ºæœ€é‡è¦çš„å‡ ä¸ªã€‚</p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-æ ¸å¿ƒè®¾è®¡ä¸ºä»€ä¹ˆè¦å…ˆæ‰©å¼ å†å‹ç¼©">ğŸ§  æ ¸å¿ƒè®¾è®¡ï¼šä¸ºä»€ä¹ˆè¦&quot;å…ˆæ‰©å¼ ï¼Œå†å‹ç¼©&quot;ï¼Ÿ<a href="#-æ ¸å¿ƒè®¾è®¡ä¸ºä»€ä¹ˆè¦å…ˆæ‰©å¼ å†å‹ç¼©" class="hash-link" aria-label="Direct link to ğŸ§  æ ¸å¿ƒè®¾è®¡ï¼šä¸ºä»€ä¹ˆè¦&quot;å…ˆæ‰©å¼ ï¼Œå†å‹ç¼©&quot;ï¼Ÿ" title="Direct link to ğŸ§  æ ¸å¿ƒè®¾è®¡ï¼šä¸ºä»€ä¹ˆè¦&quot;å…ˆæ‰©å¼ ï¼Œå†å‹ç¼©&quot;ï¼Ÿ" translate="no">â€‹</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="ä¼ ç»Ÿ-ffn-ç»“æ„-relu-æ—¶ä»£">ä¼ ç»Ÿ FFN ç»“æ„ (ReLU æ—¶ä»£)<a href="#ä¼ ç»Ÿ-ffn-ç»“æ„-relu-æ—¶ä»£" class="hash-link" aria-label="Direct link to ä¼ ç»Ÿ FFN ç»“æ„ (ReLU æ—¶ä»£)" title="Direct link to ä¼ ç»Ÿ FFN ç»“æ„ (ReLU æ—¶ä»£)" translate="no">â€‹</a></h4>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">è¾“å…¥ (512 ç»´)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    â†“</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ã€æ‰©å¼ ã€‘Linear: 512 â†’ 2048</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    â†“</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ã€æ¿€æ´»ã€‘ReLU</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    â†“</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ã€å‹ç¼©ã€‘Linear: 2048 â†’ 512</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    â†“</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">è¾“å‡º (512 ç»´)</span><br></span></code></pre></div></div>
<p><strong>é—®é¢˜</strong>ï¼šReLU ä¼šæŠŠæ‰€æœ‰è´Ÿæ•°å˜æˆ 0ï¼Œä¿¡æ¯ä¸¢å¤±ä¸¥é‡</p>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="ç°ä»£-ffn-ç»“æ„-swiglullamagpt-4-ä½¿ç”¨">ç°ä»£ FFN ç»“æ„ (SwiGLUï¼ŒLlama/GPT-4 ä½¿ç”¨)<a href="#ç°ä»£-ffn-ç»“æ„-swiglullamagpt-4-ä½¿ç”¨" class="hash-link" aria-label="Direct link to ç°ä»£ FFN ç»“æ„ (SwiGLUï¼ŒLlama/GPT-4 ä½¿ç”¨)" title="Direct link to ç°ä»£ FFN ç»“æ„ (SwiGLUï¼ŒLlama/GPT-4 ä½¿ç”¨)" translate="no">â€‹</a></h4>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">è¾“å…¥ (512 ç»´)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    â†“</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">â”‚           â”‚           â”‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">â†“           â†“           â”‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gate_proj   up_proj     â”‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">512â†’1408    512â†’1408    â”‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    â†“           â†“       â”‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ã€æ¿€æ´»ã€‘SiLU     â”‚       â”‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    â†“           â”‚       â”‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    â”œâ”€â”€â”€â”€â”€ Ã— â”€â”€â”€â”¤       â”‚  â† é€å…ƒç´ ç›¸ä¹˜ (é—¨æ§æœºåˆ¶)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    â†“                   â”‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">down_proj               â”‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1408â†’512                â”‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    â†“                   â”‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">è¾“å‡º (512 ç»´)           â”‚</span><br></span></code></pre></div></div>
<p><strong>ä¼˜åŠ¿</strong>ï¼šé—¨æ§æœºåˆ¶è®©æ¨¡å‹è‡ªå·±å†³å®š&quot;å“ªäº›ä¿¡æ¯è¯¥é€šè¿‡ï¼Œå“ªäº›è¯¥æŠ‘åˆ¶&quot;</p>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-éšå–»è§£æä¸‰ä¸ªæŠ•å½±å±‚çš„ä½œç”¨">ğŸ”‘ éšå–»è§£æï¼šä¸‰ä¸ªæŠ•å½±å±‚çš„ä½œç”¨<a href="#-éšå–»è§£æä¸‰ä¸ªæŠ•å½±å±‚çš„ä½œç”¨" class="hash-link" aria-label="Direct link to ğŸ”‘ éšå–»è§£æï¼šä¸‰ä¸ªæŠ•å½±å±‚çš„ä½œç”¨" title="Direct link to ğŸ”‘ éšå–»è§£æï¼šä¸‰ä¸ªæŠ•å½±å±‚çš„ä½œç”¨" translate="no">â€‹</a></h3>
<p>æƒ³è±¡å°æ˜åœ¨å†™ä½œæ–‡ï¼Œçœ‹åˆ°é¢˜ç›®&quot;æ˜¥å¤©&quot;åçš„æ€è€ƒè¿‡ç¨‹ï¼š</p>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="1-gate_proj-é—¨æ§æŠ•å½±è¿™ä¸ªè”æƒ³é‡è¦å—">1. <code>gate_proj</code> (é—¨æ§æŠ•å½±)ï¼š&quot;è¿™ä¸ªè”æƒ³é‡è¦å—ï¼Ÿ&quot;<a href="#1-gate_proj-é—¨æ§æŠ•å½±è¿™ä¸ªè”æƒ³é‡è¦å—" class="hash-link" aria-label="Direct link to 1-gate_proj-é—¨æ§æŠ•å½±è¿™ä¸ªè”æƒ³é‡è¦å—" title="Direct link to 1-gate_proj-é—¨æ§æŠ•å½±è¿™ä¸ªè”æƒ³é‡è¦å—" translate="no">â€‹</a></h4>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gate_proj </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Linear</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hidden_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">intermediate_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> bias</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 512 â†’ 1408</span><br></span></code></pre></div></div>
<p><strong>ä½œç”¨</strong>ï¼šè®¡ç®—æ¯ä¸ªè”æƒ³çš„&quot;é‡è¦æ€§åˆ†æ•°&quot;</p>
<p><strong>éšå–»</strong>ï¼š</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">å°æ˜çœ‹åˆ°&quot;æ˜¥å¤©&quot;åï¼Œå¤§è„‘å¼€å§‹è¯„ä¼°å„ç§è”æƒ³çš„é‡è¦æ€§ï¼š</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- è”æƒ³&quot;èŠ±æœµ&quot; â†’ é‡è¦æ€§åˆ†æ•° 0.9 (éå¸¸ç›¸å…³ï¼)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- è”æƒ³&quot;è´è¶&quot; â†’ é‡è¦æ€§åˆ†æ•° 0.7 (æ¯”è¾ƒç›¸å…³)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- è”æƒ³&quot;å†¬å¤©&quot; â†’ é‡è¦æ€§åˆ†æ•° 0.2 (ä¸å¤ªç›¸å…³)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- è”æƒ³&quot;é‡å­åŠ›å­¦&quot; â†’ é‡è¦æ€§åˆ†æ•° -0.8 (å®Œå…¨ä¸ç›¸å…³ï¼)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ç»è¿‡ SiLU æ¿€æ´»åï¼š</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- æ­£åˆ†æ•°è¢«æ”¾å¤§ (ç›¸å…³è”æƒ³æ›´çªå‡º)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- è´Ÿåˆ†æ•°è¢«æŠ‘åˆ¶ä½†ä¸å®Œå…¨å½’é›¶ (ä¿ç•™ä¸€ç‚¹ç‚¹ä¿¡æ¯)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="2-up_proj-ä¸Šè¡ŒæŠ•å½±æ‰€æœ‰å¯èƒ½çš„è”æƒ³æ˜¯ä»€ä¹ˆ">2. <code>up_proj</code> (ä¸Šè¡ŒæŠ•å½±)ï¼š&quot;æ‰€æœ‰å¯èƒ½çš„è”æƒ³æ˜¯ä»€ä¹ˆï¼Ÿ&quot;<a href="#2-up_proj-ä¸Šè¡ŒæŠ•å½±æ‰€æœ‰å¯èƒ½çš„è”æƒ³æ˜¯ä»€ä¹ˆ" class="hash-link" aria-label="Direct link to 2-up_proj-ä¸Šè¡ŒæŠ•å½±æ‰€æœ‰å¯èƒ½çš„è”æƒ³æ˜¯ä»€ä¹ˆ" title="Direct link to 2-up_proj-ä¸Šè¡ŒæŠ•å½±æ‰€æœ‰å¯èƒ½çš„è”æƒ³æ˜¯ä»€ä¹ˆ" translate="no">â€‹</a></h4>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">up_proj </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Linear</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hidden_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">intermediate_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> bias</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 512 â†’ 1408</span><br></span></code></pre></div></div>
<p><strong>ä½œç”¨</strong>ï¼šç”Ÿæˆæ‰€æœ‰å¯èƒ½çš„è”æƒ³ç‰¹å¾</p>
<p><strong>éšå–»</strong>ï¼š</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">å°æ˜çœ‹åˆ°&quot;æ˜¥å¤©&quot;åï¼Œå¤§è„‘äº§ç”Ÿçš„æ‰€æœ‰åŸå§‹è”æƒ³ï¼š</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ç‰¹å¾1: å…³äºé¢œè‰²çš„è”æƒ³ â†’ 0.5 (ç»¿è‰²ã€ç²‰è‰²...)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ç‰¹å¾2: å…³äºæ¸©åº¦çš„è”æƒ³ â†’ 0.8 (æ¸©æš–ã€èˆ’é€‚...)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ç‰¹å¾3: å…³äºæƒ…æ„Ÿçš„è”æƒ³ â†’ 0.3 (å¸Œæœ›ã€æ–°ç”Ÿ...)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ç‰¹å¾4: å…³äºå£°éŸ³çš„è”æƒ³ â†’ 0.4 (é¸Ÿé¸£ã€æµæ°´...)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ç‰¹å¾1408: å…³äºæŸç§æŠ½è±¡æ¦‚å¿µ â†’ 0.1</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="3-é—¨æ§ä¹˜æ³•-gate--upç­›é€‰æœ‰ä»·å€¼çš„è”æƒ³">3. é—¨æ§ä¹˜æ³• (Gate Ã— Up)ï¼š&quot;ç­›é€‰æœ‰ä»·å€¼çš„è”æƒ³&quot;<a href="#3-é—¨æ§ä¹˜æ³•-gate--upç­›é€‰æœ‰ä»·å€¼çš„è”æƒ³" class="hash-link" aria-label="Direct link to 3. é—¨æ§ä¹˜æ³• (Gate Ã— Up)ï¼š&quot;ç­›é€‰æœ‰ä»·å€¼çš„è”æƒ³&quot;" title="Direct link to 3. é—¨æ§ä¹˜æ³• (Gate Ã— Up)ï¼š&quot;ç­›é€‰æœ‰ä»·å€¼çš„è”æƒ³&quot;" translate="no">â€‹</a></h4>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">act_fn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gate_proj</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">up_proj</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># SiLU(gate) Ã— up</span><br></span></code></pre></div></div>
<p><strong>ä½œç”¨</strong>ï¼šç”¨&quot;é‡è¦æ€§åˆ†æ•°&quot;è¿‡æ»¤&quot;åŸå§‹è”æƒ³&quot;</p>
<p><strong>éšå–»</strong>ï¼š</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">é—¨æ§æœºåˆ¶ = ç­›é€‰å™¨</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">åŸå§‹è”æƒ³ (up_proj):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[0.5, 0.8, 0.3, 0.4, ..., 0.1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">é‡è¦æ€§åˆ†æ•° (gate_proj ç»è¿‡ SiLU):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[0.9, 0.7, 0.8, 0.2, ..., 0.01]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">é€å…ƒç´ ç›¸ä¹˜å:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[0.45, 0.56, 0.24, 0.08, ..., 0.001]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   â†‘     â†‘     â†‘     â†‘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ç›¸å…³è”æƒ³è¢«ä¿ç•™  ä¸ç›¸å…³çš„å‡ ä¹ä¸º0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ç»“æœï¼š</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- &quot;èŠ±æœµ&quot;çš„è”æƒ³: 0.5 Ã— 0.9 = 0.45 (ä¿ç•™å¤§éƒ¨åˆ†)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- &quot;é‡å­åŠ›å­¦&quot;çš„è”æƒ³: 0.1 Ã— 0.01 = 0.001 (å‡ ä¹æ¶ˆå¤±)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="4-down_proj-ä¸‹è¡ŒæŠ•å½±æ€»ç»“å¹¶è¾“å‡º">4. <code>down_proj</code> (ä¸‹è¡ŒæŠ•å½±)ï¼š&quot;æ€»ç»“å¹¶è¾“å‡º&quot;<a href="#4-down_proj-ä¸‹è¡ŒæŠ•å½±æ€»ç»“å¹¶è¾“å‡º" class="hash-link" aria-label="Direct link to 4-down_proj-ä¸‹è¡ŒæŠ•å½±æ€»ç»“å¹¶è¾“å‡º" title="Direct link to 4-down_proj-ä¸‹è¡ŒæŠ•å½±æ€»ç»“å¹¶è¾“å‡º" translate="no">â€‹</a></h4>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">down_proj </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Linear</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">intermediate_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hidden_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> bias</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 1408 â†’ 512</span><br></span></code></pre></div></div>
<p><strong>ä½œç”¨</strong>ï¼šå°†ç­›é€‰åçš„è”æƒ³å‹ç¼©å›åŸå§‹ç»´åº¦</p>
<p><strong>éšå–»</strong>ï¼š</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">ç»è¿‡å‘æ•£æ€è€ƒåï¼Œå°æ˜è„‘ä¸­æœ‰ 1408 ä¸ªè”æƒ³ç¢ç‰‡</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">éœ€è¦æ•´ç†æˆ 512 ç»´çš„&quot;æ€è€ƒç»“è®º&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ç±»ä¼¼äºï¼š</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">å¤´è„‘é£æš´é˜¶æ®µï¼šå†™æ»¡ä¸€æ•´å¼ ç™½æ¿çš„æƒ³æ³• (1408 ä¸ª)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    â†“</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">æ€»ç»“é˜¶æ®µï¼šæç‚¼æˆä¸€æ®µè¯ (512 ç»´)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">down_proj çš„ä½œç”¨å°±æ˜¯&quot;å»ç²—å–ç²¾ï¼Œæç‚¼ç²¾å&quot;</span><br></span></code></pre></div></div>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-ç»´åº¦è®¡ç®—ä¸ºä»€ä¹ˆæ˜¯-83-å€">ğŸ“ ç»´åº¦è®¡ç®—ï¼šä¸ºä»€ä¹ˆæ˜¯ <code>8/3</code> å€ï¼Ÿ<a href="#-ç»´åº¦è®¡ç®—ä¸ºä»€ä¹ˆæ˜¯-83-å€" class="hash-link" aria-label="Direct link to -ç»´åº¦è®¡ç®—ä¸ºä»€ä¹ˆæ˜¯-83-å€" title="Direct link to -ç»´åº¦è®¡ç®—ä¸ºä»€ä¹ˆæ˜¯-83-å€" translate="no">â€‹</a></h3>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">intermediate_size </span><span class="token keyword" style="color:#00009f">is</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    intermediate_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hidden_size </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 512 Ã— 8/3 â‰ˆ 1365</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">intermediate_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">64</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">intermediate_size </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">64</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">//</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># å¯¹é½åˆ° 64</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># æœ€ç»ˆ: 1408</span><br></span></code></pre></div></div>
<p><strong>å†å²èƒŒæ™¯</strong>ï¼š</p>
<table><thead><tr><th>æ¶æ„</th><th>æ‰©å¼ å€æ•°</th><th>intermediate_size (hidden=512)</th></tr></thead><tbody><tr><td>GPT-2/BERT (ReLU FFN)</td><td>4Ã—</td><td>2048</td></tr><tr><td>Llama/GPT-4 (SwiGLU)</td><td>8/3Ã—</td><td>1408</td></tr></tbody></table>
<p><strong>ä¸ºä»€ä¹ˆ SwiGLU ç”¨æ›´å°çš„å€æ•°ï¼Ÿ</strong></p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">ä¼ ç»Ÿ ReLU FFN:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- åªæœ‰ 1 ä¸ªæŠ•å½± (up_proj)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ä¸­é—´ç»´åº¦: 4 Ã— hidden = 2048</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- å‚æ•°é‡: 2 Ã— (512 Ã— 2048) = 2.1M</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SwiGLU FFN:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- æœ‰ 3 ä¸ªæŠ•å½± (gate_proj, up_proj, down_proj æœ‰ä¸¤ä¸ª up æ–¹å‘)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ä¸­é—´ç»´åº¦: 8/3 Ã— hidden = 1408</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- å‚æ•°é‡: 3 Ã— (512 Ã— 1408) = 2.16M</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ç»“è®ºï¼š</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- å‚æ•°é‡å·®ä¸å¤š</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ä½† SwiGLU æœ‰æ›´å¼ºçš„è¡¨è¾¾èƒ½åŠ› (é—¨æ§æœºåˆ¶)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- 8/3 æ˜¯ Llama å›¢é˜Ÿå®éªŒå‡ºçš„æœ€ä½³æ¯”ä¾‹</span><br></span></code></pre></div></div>
<p><strong>ä¸ºä»€ä¹ˆå¯¹é½åˆ° 64ï¼Ÿ</strong></p>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">intermediate_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">64</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">intermediate_size </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">64</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">//</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">64</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><strong>åŸå› </strong>ï¼šGPU çš„ Tensor Core é€šå¸¸ä»¥ 64 æˆ– 128 ä¸ºå•ä½å¤„ç†æ•°æ®</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">ä¸å¯¹é½: intermediate_size = 1365</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    â†’ GPU éœ€è¦è¡¥é›¶åˆ° 1408ï¼Œæµªè´¹è®¡ç®—èµ„æº</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    â†’ çŸ©é˜µä¹˜æ³•æ•ˆç‡ä½ä¸‹</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">å¯¹é½å: intermediate_size = 1408 (64 çš„æ•´æ•°å€)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    â†’ GPU å¯ä»¥é«˜æ•ˆåˆ©ç”¨æ‰€æœ‰è®¡ç®—å•å…ƒ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    â†’ é€Ÿåº¦æå‡ 10%-20%</span><br></span></code></pre></div></div>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-æ¿€æ´»å‡½æ•°ä¸ºä»€ä¹ˆç”¨-silu-swish-è€Œä¸æ˜¯-relu">ğŸ”¥ æ¿€æ´»å‡½æ•°ï¼šä¸ºä»€ä¹ˆç”¨ SiLU (Swish) è€Œä¸æ˜¯ ReLUï¼Ÿ<a href="#-æ¿€æ´»å‡½æ•°ä¸ºä»€ä¹ˆç”¨-silu-swish-è€Œä¸æ˜¯-relu" class="hash-link" aria-label="Direct link to ğŸ”¥ æ¿€æ´»å‡½æ•°ï¼šä¸ºä»€ä¹ˆç”¨ SiLU (Swish) è€Œä¸æ˜¯ ReLUï¼Ÿ" title="Direct link to ğŸ”¥ æ¿€æ´»å‡½æ•°ï¼šä¸ºä»€ä¹ˆç”¨ SiLU (Swish) è€Œä¸æ˜¯ ReLUï¼Ÿ" translate="no">â€‹</a></h3>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">act_fn </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ACT2FN</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hidden_act</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># é€šå¸¸æ˜¯ &#x27;silu&#x27;</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="relu-çš„é—®é¢˜ä¸€åˆ€åˆ‡">ReLU çš„é—®é¢˜ï¼š&quot;ä¸€åˆ€åˆ‡&quot;<a href="#relu-çš„é—®é¢˜ä¸€åˆ€åˆ‡" class="hash-link" aria-label="Direct link to ReLU çš„é—®é¢˜ï¼š&quot;ä¸€åˆ€åˆ‡&quot;" title="Direct link to ReLU çš„é—®é¢˜ï¼š&quot;ä¸€åˆ€åˆ‡&quot;" translate="no">â€‹</a></h4>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">relu</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token builtin">max</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">è¾“å…¥</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">è¾“å‡º</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        â†‘  â†‘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ä¿¡æ¯å®Œå…¨ä¸¢å¤±!</span><br></span></code></pre></div></div>
<p><strong>éšå–»</strong>ï¼š</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">ReLU è€å¸ˆæ‰¹æ”¹ä½œæ–‡ï¼š</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- åˆ†æ•° &gt; 0ï¼š&quot;åŠæ ¼ï¼ä¿ç•™ä½ çš„åˆ†æ•°&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- åˆ†æ•° â‰¤ 0ï¼š&quot;é›¶åˆ†ï¼æ»šå»é‡å†™&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">é—®é¢˜ï¼š</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- å¾ˆå¤šæœ‰ä»·å€¼çš„&quot;æ¥è¿‘åŠæ ¼&quot;çš„æƒ³æ³•è¢«ç›´æ¥æŠ¹æ€</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- &quot;ç¥ç»å…ƒæ­»äº¡&quot;é—®é¢˜ï¼šå¦‚æœæŸä¸ªç¥ç»å…ƒæ€»æ˜¯è¾“å‡ºè´Ÿæ•°ï¼Œå®ƒå°±æ°¸è¿œä¸ä¼šè¢«æ¿€æ´»</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="silu-çš„ä¼˜åŠ¿æŸ”æ€§ç­›é€‰">SiLU çš„ä¼˜åŠ¿ï¼š&quot;æŸ”æ€§ç­›é€‰&quot;<a href="#silu-çš„ä¼˜åŠ¿æŸ”æ€§ç­›é€‰" class="hash-link" aria-label="Direct link to SiLU çš„ä¼˜åŠ¿ï¼š&quot;æŸ”æ€§ç­›é€‰&quot;" title="Direct link to SiLU çš„ä¼˜åŠ¿ï¼š&quot;æŸ”æ€§ç­›é€‰&quot;" translate="no">â€‹</a></h4>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">silu</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> x </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> sigmoid</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">è¾“å…¥</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">   </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">   </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">    </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">è¾“å‡º</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">0.24</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">0.27</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.73</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.76</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        â†‘      â†‘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     ä¿ç•™äº†ä¸€ç‚¹è´Ÿæ•°ä¿¡æ¯ï¼</span><br></span></code></pre></div></div>
<p><strong>éšå–»</strong>ï¼š</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">SiLU è€å¸ˆæ‰¹æ”¹ä½œæ–‡ï¼š</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- é«˜åˆ† (x &gt;&gt; 0)ï¼šç»™äºˆé«˜åº¦è‚¯å®šï¼Œåˆ†æ•°å‡ ä¹ä¸å˜</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ä¸­ç­‰åˆ† (x â‰ˆ 0)ï¼šè°¨æ…è¯„ä¼°ï¼Œé€‚å½“ç¼©å‡</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ä½åˆ† (x &lt; 0)ï¼šç»™äºˆæ”¹è¿›å»ºè®®ï¼Œä¿ç•™ä¸€ç‚¹ç‚¹åé¦ˆä¿¡æ¯</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ä¼˜åŠ¿ï¼š</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- å¹³æ»‘å¯å¯¼ï¼Œæ¢¯åº¦æµåŠ¨æ›´å¥½</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- è´Ÿæ•°åŒºåŸŸä»æœ‰å¾®å°æ¢¯åº¦ï¼Œé¿å…&quot;ç¥ç»å…ƒæ­»äº¡&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- å®éªŒè¯æ˜ï¼ŒSiLU æ¯” ReLU æå‡ 1-2% å‡†ç¡®ç‡</span><br></span></code></pre></div></div>
<p><strong>æ•°å­¦å…¬å¼å¯¹æ¯”</strong>ï¼š</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">ReLU:  f(x) = max(0, x)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       å¯¼æ•°: x &gt; 0 â†’ 1; x â‰¤ 0 â†’ 0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SiLU:  f(x) = x Ã— sigmoid(x) = x Ã— (1 / (1 + e^(-x)))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       å¯¼æ•°: å¤„å¤„å¯å¯¼ï¼Œè´Ÿæ•°åŒºåŸŸä¹Ÿæœ‰å¾®å°æ¢¯åº¦</span><br></span></code></pre></div></div>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-å®Œæ•´å‰å‘ä¼ æ’­è¿‡ç¨‹">ğŸ’¡ å®Œæ•´å‰å‘ä¼ æ’­è¿‡ç¨‹<a href="#-å®Œæ•´å‰å‘ä¼ æ’­è¿‡ç¨‹" class="hash-link" aria-label="Direct link to ğŸ’¡ å®Œæ•´å‰å‘ä¼ æ’­è¿‡ç¨‹" title="Direct link to ğŸ’¡ å®Œæ•´å‰å‘ä¼ æ’­è¿‡ç¨‹" translate="no">â€‹</a></h3>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">forward</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dropout</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">down_proj</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">act_fn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">gate_proj</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">up_proj</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><strong>æ­¥éª¤åˆ†è§£</strong>ï¼š</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">Step 1: è¾“å…¥</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">x.shape = [batch_size, seq_len, hidden_size]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">x.shape = [32, 128, 512]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Step 2: é—¨æ§æŠ•å½±</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gate = self.gate_proj(x)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gate.shape = [32, 128, 1408]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Step 3: SiLU æ¿€æ´»</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gate = self.act_fn(gate)  # SiLU</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gate.shape = [32, 128, 1408]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Step 4: ä¸Šè¡ŒæŠ•å½±</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">up = self.up_proj(x)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">up.shape = [32, 128, 1408]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Step 5: é—¨æ§ä¹˜æ³• (æ ¸å¿ƒï¼)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hidden = gate * up  # é€å…ƒç´ ç›¸ä¹˜</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">hidden.shape = [32, 128, 1408]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Step 6: ä¸‹è¡ŒæŠ•å½± (å‹ç¼©)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output = self.down_proj(hidden)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output.shape = [32, 128, 512]  # æ¢å¤åŸå§‹ç»´åº¦</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Step 7: Dropout (è®­ç»ƒæ—¶)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output = self.dropout(output)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output.shape = [32, 128, 512]</span><br></span></code></pre></div></div>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-ä¸-attention-çš„åˆ†å·¥">ğŸ“Š ä¸ Attention çš„åˆ†å·¥<a href="#-ä¸-attention-çš„åˆ†å·¥" class="hash-link" aria-label="Direct link to ğŸ“Š ä¸ Attention çš„åˆ†å·¥" title="Direct link to ğŸ“Š ä¸ Attention çš„åˆ†å·¥" translate="no">â€‹</a></h3>
<!-- -->
<p><strong>ç±»æ¯”</strong>ï¼š</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">Attention = ç¤¾äº¤èƒ½åŠ›</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- çœ‹çœ‹å‘¨å›´çš„äººåœ¨åšä»€ä¹ˆ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ç†è§£ä¸Šä¸‹æ–‡å…³ç³»</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- &quot;å°çº¢å¸½&quot;çœ‹åˆ°&quot;å¤§ç°ç‹¼&quot;ï¼ŒçŸ¥é“æœ‰å±é™©</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FeedForward = ç‹¬ç«‹æ€è€ƒèƒ½åŠ›</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- å¯¹çœ‹åˆ°çš„ä¿¡æ¯è¿›è¡Œæ·±åº¦åŠ å·¥</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- èåˆèƒŒæ™¯çŸ¥è¯†</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- &quot;å±é™©&quot;è¿™ä¸ªæ¦‚å¿µ â†’ è”æƒ³åˆ°&quot;é€ƒè·‘&quot;ã€&quot;å¤–å©†å®¶&quot;ã€&quot;çŒäºº&quot;...</span><br></span></code></pre></div></div>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-åœ¨-transformer-block-ä¸­çš„ä½ç½®">ğŸ”— åœ¨ Transformer Block ä¸­çš„ä½ç½®<a href="#-åœ¨-transformer-block-ä¸­çš„ä½ç½®" class="hash-link" aria-label="Direct link to ğŸ”— åœ¨ Transformer Block ä¸­çš„ä½ç½®" title="Direct link to ğŸ”— åœ¨ Transformer Block ä¸­çš„ä½ç½®" translate="no">â€‹</a></h3>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># MiniMindBlock ä¸­çš„ä»£ç  (ç¬¬ 1019 è¡Œ)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mlp </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> FeedForward</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">use_moe </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> MOEFeedForward</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><strong>å®Œæ•´æµç¨‹</strong>ï¼š</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">è¾“å…¥</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  â†“</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RMSNorm (å½’ä¸€åŒ–)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  â†“</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Attention (æ•æ‰å…³ç³»)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  â†“</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Residual Add (æ®‹å·®è¿æ¥)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  â†“</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RMSNorm (å½’ä¸€åŒ–)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  â†“</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FeedForward (æ·±åº¦æ€è€ƒ)  â† æˆ‘ä»¬åˆšå­¦çš„è¿™ä¸ªï¼</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  â†“</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Residual Add (æ®‹å·®è¿æ¥)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  â†“</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">è¾“å‡ºåˆ°ä¸‹ä¸€å±‚</span><br></span></code></pre></div></div>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-å‚æ•°é‡è®¡ç®—">âš¡ å‚æ•°é‡è®¡ç®—<a href="#-å‚æ•°é‡è®¡ç®—" class="hash-link" aria-label="Direct link to âš¡ å‚æ•°é‡è®¡ç®—" title="Direct link to âš¡ å‚æ•°é‡è®¡ç®—" translate="no">â€‹</a></h3>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># å‡è®¾ hidden_size=512, intermediate_size=1408</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># gate_proj: 512 Ã— 1408 = 720,896 å‚æ•°</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># up_proj:   512 Ã— 1408 = 720,896 å‚æ•°</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># down_proj: 1408 Ã— 512 = 720,896 å‚æ•°</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># æ€»è®¡: 2,162,688 å‚æ•° (çº¦ 2.16M)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># å¯¹æ¯”ä¼ ç»Ÿ ReLU FFN (intermediate_size=2048):</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># up_proj:   512 Ã— 2048 = 1,048,576 å‚æ•°</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># down_proj: 2048 Ã— 512 = 1,048,576 å‚æ•°</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># æ€»è®¡: 2,097,152 å‚æ•° (çº¦ 2.1M)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># ç»“è®ºï¼šSwiGLU å‚æ•°é‡ç•¥å¤š (~3%)ï¼Œä½†æ€§èƒ½æå‡æ˜æ˜¾</span><br></span></code></pre></div></div>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-å®é™…åº”ç”¨å»ºè®®">ğŸ’¼ å®é™…åº”ç”¨å»ºè®®<a href="#-å®é™…åº”ç”¨å»ºè®®" class="hash-link" aria-label="Direct link to ğŸ’¼ å®é™…åº”ç”¨å»ºè®®" title="Direct link to ğŸ’¼ å®é™…åº”ç”¨å»ºè®®" translate="no">â€‹</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="åœºæ™¯-1-å°æ¨¡å‹-hidden_size--1024">åœºæ™¯ 1: å°æ¨¡å‹ (hidden_size &lt; 1024)<a href="#åœºæ™¯-1-å°æ¨¡å‹-hidden_size--1024" class="hash-link" aria-label="Direct link to åœºæ™¯ 1: å°æ¨¡å‹ (hidden_size &lt; 1024)" title="Direct link to åœºæ™¯ 1: å°æ¨¡å‹ (hidden_size &lt; 1024)" translate="no">â€‹</a></h4>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> MiniMindConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hidden_size</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">512</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    intermediate_size</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># è‡ªåŠ¨è®¡ç®—ä¸º 1408</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hidden_act</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;silu&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">       </span><span class="token comment" style="color:#999988;font-style:italic"># ä½¿ç”¨ SiLU</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    dropout</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">             </span><span class="token comment" style="color:#999988;font-style:italic"># å¤§è§„æ¨¡æ•°æ®ä¸éœ€è¦ dropout</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="åœºæ™¯-2-è°ƒä¼˜ä¸­é—´å±‚å¤§å°">åœºæ™¯ 2: è°ƒä¼˜ä¸­é—´å±‚å¤§å°<a href="#åœºæ™¯-2-è°ƒä¼˜ä¸­é—´å±‚å¤§å°" class="hash-link" aria-label="Direct link to åœºæ™¯ 2: è°ƒä¼˜ä¸­é—´å±‚å¤§å°" title="Direct link to åœºæ™¯ 2: è°ƒä¼˜ä¸­é—´å±‚å¤§å°" translate="no">â€‹</a></h4>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># å¦‚æœæ˜¾å­˜ç´§å¼ ï¼Œå¯ä»¥æ‰‹åŠ¨å‡å° intermediate_size</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> MiniMindConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hidden_size</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">512</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    intermediate_size</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1024</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 2Ã— è€Œä¸æ˜¯ 2.67Ã—</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># å‚æ•°é‡å‡å°‘çº¦ 30%ï¼Œä½†æ€§èƒ½å¯èƒ½ç•¥é™</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="åœºæ™¯-3-ä½¿ç”¨ä¸åŒæ¿€æ´»å‡½æ•°">åœºæ™¯ 3: ä½¿ç”¨ä¸åŒæ¿€æ´»å‡½æ•°<a href="#åœºæ™¯-3-ä½¿ç”¨ä¸åŒæ¿€æ´»å‡½æ•°" class="hash-link" aria-label="Direct link to åœºæ™¯ 3: ä½¿ç”¨ä¸åŒæ¿€æ´»å‡½æ•°" title="Direct link to åœºæ™¯ 3: ä½¿ç”¨ä¸åŒæ¿€æ´»å‡½æ•°" translate="no">â€‹</a></h4>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># å°è¯•å…¶ä»–æ¿€æ´»å‡½æ•°</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> MiniMindConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hidden_act</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;gelu&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic"># BERT ä½¿ç”¨çš„æ¿€æ´»å‡½æ•°</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># æˆ– &quot;relu&quot; (ä¼ ç»Ÿæ–¹æ³•)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># æˆ– &quot;silu&quot; (Llama é»˜è®¤ï¼Œæ¨è)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-ç±»æ¯”æ€»ç»“-2">ğŸ“ ç±»æ¯”æ€»ç»“<a href="#-ç±»æ¯”æ€»ç»“-2" class="hash-link" aria-label="Direct link to ğŸ“ ç±»æ¯”æ€»ç»“" title="Direct link to ğŸ“ ç±»æ¯”æ€»ç»“" translate="no">â€‹</a></h3>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">FeedForward å±‚å°±åƒå°æ˜çš„&quot;è”æƒ³æ€è€ƒ&quot;è¿‡ç¨‹ï¼š</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1. å‘æ•£é˜¶æ®µ (gate_proj + up_proj):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - çœ‹åˆ°&quot;æ˜¥å¤©&quot;ï¼Œè„‘æµ·ä¸­æµ®ç° 1408 ç§è”æƒ³</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - åŒæ—¶è¯„ä¼°æ¯ç§è”æƒ³çš„é‡è¦æ€§</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. ç­›é€‰é˜¶æ®µ (é—¨æ§ä¹˜æ³•):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - ç”¨&quot;é‡è¦æ€§åˆ†æ•°&quot;è¿‡æ»¤è”æƒ³</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - ç›¸å…³çš„ä¿ç•™ï¼Œä¸ç›¸å…³çš„æŠ‘åˆ¶</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. æ”¶æ•›é˜¶æ®µ (down_proj):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - æŠŠ 1408 ä¸ªè”æƒ³ç¢ç‰‡</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - æ€»ç»“æˆ 512 ç»´çš„&quot;æ€è€ƒç»“è®º&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå«&quot;å‰é¦ˆ&quot;â€”â€”</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ä¿¡æ¯åªæœä¸€ä¸ªæ–¹å‘æµåŠ¨ï¼Œæ²¡æœ‰å¾ªç¯ï¼Œ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">åƒæµæ°´çº¿ä¸€æ ·é«˜æ•ˆå¤„ç†æ¯ä¸ªè¯çš„ç‰¹å¾ã€‚</span><br></span></code></pre></div></div>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_aDle" id="å…­å°æ˜çš„éŸ³é‡å¹³è¡¡å™¨rmsnorm-å‡æ–¹æ ¹å½’ä¸€åŒ–">å…­ã€å°æ˜çš„&quot;éŸ³é‡å¹³è¡¡å™¨&quot;ï¼šRMSNorm å‡æ–¹æ ¹å½’ä¸€åŒ–<a href="#å…­å°æ˜çš„éŸ³é‡å¹³è¡¡å™¨rmsnorm-å‡æ–¹æ ¹å½’ä¸€åŒ–" class="hash-link" aria-label="Direct link to å…­ã€å°æ˜çš„&quot;éŸ³é‡å¹³è¡¡å™¨&quot;ï¼šRMSNorm å‡æ–¹æ ¹å½’ä¸€åŒ–" title="Direct link to å…­ã€å°æ˜çš„&quot;éŸ³é‡å¹³è¡¡å™¨&quot;ï¼šRMSNorm å‡æ–¹æ ¹å½’ä¸€åŒ–" translate="no">â€‹</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-ä»£ç ç‰‡æ®µ-ç¬¬-552-605-è¡Œ">ğŸ“ ä»£ç ç‰‡æ®µ (ç¬¬ 552-605 è¡Œ)<a href="#-ä»£ç ç‰‡æ®µ-ç¬¬-552-605-è¡Œ" class="hash-link" aria-label="Direct link to ğŸ“ ä»£ç ç‰‡æ®µ (ç¬¬ 552-605 è¡Œ)" title="Direct link to ğŸ“ ä»£ç ç‰‡æ®µ (ç¬¬ 552-605 è¡Œ)" translate="no">â€‹</a></h3>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">RMSNorm</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">nn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Module</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    å‡æ–¹æ ¹å±‚å½’ä¸€åŒ– (Root Mean Square Layer Normalization, RMSNorm)ã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__init__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dim</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> eps</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">float</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1e-5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token builtin">super</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">__init__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">eps </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> eps</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># å¯å­¦ä¹ çš„ç¼©æ”¾å‚æ•°ï¼Œå½¢çŠ¶ä¸º [dim]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">weight </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Parameter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ones</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dim</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_norm</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># RMS(x) = sqrt(mean(x^2) + eps)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># è¿”å› x / RMS(x)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> x </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">rsqrt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">pow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mean</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> keepdim</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">eps</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">forward</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># åœ¨ FP32 ç²¾åº¦ä¸‹è®¡ç®—ï¼Œç„¶åè½¬å›åŸç²¾åº¦</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">weight </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_norm</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">float</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">type_as</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-éšå–»ç¿»è¯‘æ•™å®¤é‡Œçš„éŸ³é‡å¹³è¡¡å™¨">ğŸ¯ éšå–»ç¿»è¯‘ï¼šæ•™å®¤é‡Œçš„&quot;éŸ³é‡å¹³è¡¡å™¨&quot;<a href="#-éšå–»ç¿»è¯‘æ•™å®¤é‡Œçš„éŸ³é‡å¹³è¡¡å™¨" class="hash-link" aria-label="Direct link to ğŸ¯ éšå–»ç¿»è¯‘ï¼šæ•™å®¤é‡Œçš„&quot;éŸ³é‡å¹³è¡¡å™¨&quot;" title="Direct link to ğŸ¯ éšå–»ç¿»è¯‘ï¼šæ•™å®¤é‡Œçš„&quot;éŸ³é‡å¹³è¡¡å™¨&quot;" translate="no">â€‹</a></h3>
<p>æƒ³è±¡å°æ˜æ­£åœ¨ä¸€ä¸ªæ•™å®¤é‡Œå¬è¯¾ï¼Œæ•™å®¤é‡Œæœ‰å¾ˆå¤šå­¦ç”Ÿï¼Œæ¯ä¸ªå­¦ç”Ÿéƒ½åœ¨å‘è¨€ï¼Œä½†é—®é¢˜æ˜¯ï¼š</p>
<p><strong>é—®é¢˜åœºæ™¯</strong>ï¼š</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">æ•™å®¤é‡Œ 512 ä¸ªå­¦ç”ŸåŒæ—¶è¯´è¯ (å¯¹åº” hidden_size=512):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">å­¦ç”ŸA (ç‰¹å¾1): å£°éŸ³å¾ˆå¤§ï¼Œå–Šå«çº§åˆ« â†’ æ•°å€¼ = 100.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">å­¦ç”ŸB (ç‰¹å¾2): æ­£å¸¸è¯´è¯ â†’ æ•°å€¼ = 1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">å­¦ç”ŸC (ç‰¹å¾3): è½»å£°ç»†è¯­ â†’ æ•°å€¼ = 0.001</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">å­¦ç”ŸD (ç‰¹å¾4): å‡ ä¹å¬ä¸è§ â†’ æ•°å€¼ = 0.00001</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">é—®é¢˜:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1. å¤§å£°å–Šå«çš„å­¦ç”Ÿä¼š&quot;æ·¹æ²¡&quot;å…¶ä»–äººçš„å£°éŸ³</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. ç¥ç»ç½‘ç»œçš„æ¢¯åº¦ä¼šè¢«å¤§æ•°å€¼ä¸»å¯¼</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. æ¨¡å‹éš¾ä»¥å­¦ä¹ åˆ°ç»†å¾®çš„ç‰¹å¾å·®å¼‚</span><br></span></code></pre></div></div>
<p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š<strong>å½’ä¸€åŒ– = å®‰è£…ä¸€ä¸ª&quot;æ™ºèƒ½éŸ³é‡å¹³è¡¡å™¨&quot;</strong></p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">å½’ä¸€åŒ–å:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">å­¦ç”ŸA: åŸæ¥ 100.0 â†’ ç°åœ¨ 0.8 (è¢«å‹ä½)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">å­¦ç”ŸB: åŸæ¥ 1.0 â†’ ç°åœ¨ 0.3 (é€‚å½“è°ƒæ•´)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">å­¦ç”ŸC: åŸæ¥ 0.001 â†’ ç°åœ¨ 0.2 (è¢«æ”¾å¤§)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">å­¦ç”ŸD: åŸæ¥ 0.00001 â†’ ç°åœ¨ 0.1 (è¢«å¤§å¹…æ”¾å¤§)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ç»“æœ: æ¯ä¸ªå­¦ç”Ÿçš„&quot;ç›¸å¯¹éŸ³é‡&quot;è¢«ä¿ç•™ï¼Œä½†ç»å¯¹æ•°å€¼èŒƒå›´å˜å¾—å¯æ§</span><br></span></code></pre></div></div>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-æ•°å­¦åŸç†rmsnorm-vs-layernorm">ğŸ§® æ•°å­¦åŸç†ï¼šRMSNorm vs LayerNorm<a href="#-æ•°å­¦åŸç†rmsnorm-vs-layernorm" class="hash-link" aria-label="Direct link to ğŸ§® æ•°å­¦åŸç†ï¼šRMSNorm vs LayerNorm" title="Direct link to ğŸ§® æ•°å­¦åŸç†ï¼šRMSNorm vs LayerNorm" translate="no">â€‹</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="ä¼ ç»Ÿ-layernorm-bertgpt-2-ä½¿ç”¨">ä¼ ç»Ÿ LayerNorm (BERT/GPT-2 ä½¿ç”¨)<a href="#ä¼ ç»Ÿ-layernorm-bertgpt-2-ä½¿ç”¨" class="hash-link" aria-label="Direct link to ä¼ ç»Ÿ LayerNorm (BERT/GPT-2 ä½¿ç”¨)" title="Direct link to ä¼ ç»Ÿ LayerNorm (BERT/GPT-2 ä½¿ç”¨)" translate="no">â€‹</a></h4>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># LayerNorm çš„è®¡ç®—å…¬å¼</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">layer_norm</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    mean </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mean</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> keepdim</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># æ­¥éª¤1: è®¡ç®—å‡å€¼</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    var </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">var</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> keepdim</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">         </span><span class="token comment" style="color:#999988;font-style:italic"># æ­¥éª¤2: è®¡ç®—æ–¹å·®</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    x_norm </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> mean</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> sqrt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">var </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> eps</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># æ­¥éª¤3: å‡å‡å€¼ï¼Œé™¤æ ‡å‡†å·®</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> gamma </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> x_norm </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> beta          </span><span class="token comment" style="color:#999988;font-style:italic"># æ­¥éª¤4: ç¼©æ”¾å’Œåç§»</span><br></span></code></pre></div></div>
<p><strong>ç±»æ¯”</strong>ï¼š</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">LayerNorm å°±åƒ&quot;å…¨é¢çš„æˆç»©è°ƒæ•´&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1. å…ˆè®¡ç®—ç­çº§å¹³å‡åˆ† (mean)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. å†è®¡ç®—åˆ†æ•°æ³¢åŠ¨å¹…åº¦ (variance)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. æ¯ä¸ªäººçš„åˆ†æ•°å‡å»å¹³å‡åˆ†ï¼Œå†é™¤ä»¥æ³¢åŠ¨å¹…åº¦</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4. æœ€åä¹˜ä»¥æƒé‡ã€åŠ ä¸Šåç½®</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">é—®é¢˜: è®¡ç®— mean å’Œ var ä¸¤ä¸ªç»Ÿè®¡é‡ï¼Œè®¡ç®—é‡è¾ƒå¤§</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="ç°ä»£-rmsnorm-llamagpt-4-ä½¿ç”¨">ç°ä»£ RMSNorm (Llama/GPT-4 ä½¿ç”¨)<a href="#ç°ä»£-rmsnorm-llamagpt-4-ä½¿ç”¨" class="hash-link" aria-label="Direct link to ç°ä»£ RMSNorm (Llama/GPT-4 ä½¿ç”¨)" title="Direct link to ç°ä»£ RMSNorm (Llama/GPT-4 ä½¿ç”¨)" translate="no">â€‹</a></h4>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># RMSNorm çš„è®¡ç®—å…¬å¼</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">rms_norm</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    rms </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sqrt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mean</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token operator" style="color:#393A34">^</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> eps</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># åªè®¡ç®—å‡æ–¹æ ¹</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    x_norm </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> x </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> rms              </span><span class="token comment" style="color:#999988;font-style:italic"># ç›´æ¥é™¤ä»¥ RMS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> gamma </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> x_norm         </span><span class="token comment" style="color:#999988;font-style:italic"># åªæœ‰ç¼©æ”¾ï¼Œæ²¡æœ‰åç½®</span><br></span></code></pre></div></div>
<p><strong>ç±»æ¯”</strong>ï¼š</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">RMSNorm å°±åƒ&quot;ç®€åŒ–çš„éŸ³é‡è°ƒèŠ‚&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1. è®¡ç®—æ‰€æœ‰å£°éŸ³çš„&quot;èƒ½é‡&quot;å¹³å‡å€¼ (mean of squares)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. å¼€æ–¹å¾—åˆ°&quot;å‡æ–¹æ ¹éŸ³é‡&quot; (RMS)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. æŠŠæ¯ä¸ªäººçš„å£°éŸ³é™¤ä»¥è¿™ä¸ªå‡æ–¹æ ¹</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ä¼˜åŠ¿:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- çœç•¥äº†&quot;å‡å»å‡å€¼&quot;è¿™ä¸€æ­¥ â†’ è®¡ç®—é‡å‡å°‘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- çœç•¥äº†åç½®é¡¹ (beta) â†’ å‚æ•°æ›´å°‘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- å®éªŒè¡¨æ˜ï¼Œåœ¨å¤§æ¨¡å‹ä¸­æ•ˆæœç›¸å½“ç”šè‡³æ›´å¥½ï¼</span><br></span></code></pre></div></div>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-ä»£ç é€è¡Œè§£æ">ğŸ”¢ ä»£ç é€è¡Œè§£æ<a href="#-ä»£ç é€è¡Œè§£æ" class="hash-link" aria-label="Direct link to ğŸ”¢ ä»£ç é€è¡Œè§£æ" title="Direct link to ğŸ”¢ ä»£ç é€è¡Œè§£æ" translate="no">â€‹</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="1-åˆå§‹åŒ–-__init__">1. åˆå§‹åŒ– (<code>__init__</code>)<a href="#1-åˆå§‹åŒ–-__init__" class="hash-link" aria-label="Direct link to 1-åˆå§‹åŒ–-__init__" title="Direct link to 1-åˆå§‹åŒ–-__init__" translate="no">â€‹</a></h4>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__init__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dim</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> eps</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">float</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1e-5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token builtin">super</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">__init__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">eps </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> eps  </span><span class="token comment" style="color:#999988;font-style:italic"># é˜²æ­¢é™¤é›¶çš„å°æ•°</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">weight </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Parameter</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ones</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dim</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># å¯å­¦ä¹ çš„ç¼©æ”¾å‚æ•°</span><br></span></code></pre></div></div>
<p><strong>å‚æ•°è§£é‡Š</strong>ï¼š</p>
<table><thead><tr><th>å‚æ•°</th><th>å€¼</th><th>ä½œç”¨</th><th>éšå–»</th></tr></thead><tbody><tr><td><code>dim</code></td><td>512</td><td>è¾“å…¥ç‰¹å¾ç»´åº¦</td><td>æ•™å®¤é‡Œæœ‰ 512 ä¸ªå­¦ç”Ÿ</td></tr><tr><td><code>eps</code></td><td>1e-5</td><td>é˜²æ­¢é™¤é›¶</td><td>éŸ³é‡è°ƒèŠ‚å™¨çš„&quot;æœ€å°éŸ³é‡é˜ˆå€¼&quot;</td></tr><tr><td><code>weight</code></td><td>[1,1,...,1] (512ä¸ª)</td><td>å¯å­¦ä¹ çš„ç¼©æ”¾å› å­</td><td>æ¯ä¸ªå­¦ç”Ÿçš„&quot;éº¦å…‹é£å¢ç›Š&quot;</td></tr></tbody></table>
<p><strong>ä¸ºä»€ä¹ˆ <code>weight</code> åˆå§‹åŒ–ä¸ºå…¨ 1ï¼Ÿ</strong></p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">åˆå§‹çŠ¶æ€:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">weight = [1, 1, 1, ..., 1]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ä½œç”¨:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- å½’ä¸€åŒ–åï¼Œè¾“å‡º = è¾“å…¥ Ã— 1 = è¾“å…¥ (ä¸æ”¹å˜)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œweight ä¼šå­¦ä¹ è°ƒæ•´</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- æœ€ç»ˆï¼Œé‡è¦ç‰¹å¾çš„ weight ä¼šå˜å¤§ï¼Œä¸é‡è¦çš„ä¼šå˜å°</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ç±»æ¯”:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ä¸€å¼€å§‹æ‰€æœ‰å­¦ç”Ÿçš„éº¦å…‹é£éƒ½æ˜¯é»˜è®¤éŸ³é‡</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">è®­ç»ƒåï¼Œ&quot;é‡è¦å‘è¨€&quot;çš„å­¦ç”Ÿéº¦å…‹é£ä¼šè¢«è°ƒå¤§</span><br></span></code></pre></div></div>
<hr>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="2-æ ¸å¿ƒå½’ä¸€åŒ–å‡½æ•°-_norm">2. æ ¸å¿ƒå½’ä¸€åŒ–å‡½æ•° (<code>_norm</code>)<a href="#2-æ ¸å¿ƒå½’ä¸€åŒ–å‡½æ•°-_norm" class="hash-link" aria-label="Direct link to 2-æ ¸å¿ƒå½’ä¸€åŒ–å‡½æ•°-_norm" title="Direct link to 2-æ ¸å¿ƒå½’ä¸€åŒ–å‡½æ•°-_norm" translate="no">â€‹</a></h4>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_norm</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> x </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">rsqrt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">pow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mean</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> keepdim</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">eps</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><strong>åˆ†æ­¥è§£æ</strong>ï¼š</p>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># å‡è®¾è¾“å…¥ x.shape = [batch_size, seq_len, hidden_size]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># ä¾‹å¦‚ x.shape = [32, 128, 512]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Step 1: å¹³æ–¹</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">x_squared </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">pow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># x_squared.shape = [32, 128, 512]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># æ¯ä¸ªå…ƒç´ éƒ½è¢«å¹³æ–¹</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Step 2: æ²¿æœ€åä¸€ç»´æ±‚å‡å€¼ (Mean Square)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mean_square </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> x_squared</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mean</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> keepdim</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># mean_square.shape = [32, 128, 1]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 512 ä¸ªç‰¹å¾çš„å¹³æ–¹å€¼è¢«å¹³å‡æˆ 1 ä¸ªæ•°</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Step 3: åŠ ä¸Š epsilon é˜²æ­¢é™¤é›¶</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">safe_ms </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> mean_square </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">eps</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># safe_ms.shape = [32, 128, 1]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Step 4: è®¡ç®—å¹³æ–¹æ ¹çš„å€’æ•° (rsqrt = 1/sqrt)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">scale </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">rsqrt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">safe_ms</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># scale.shape = [32, 128, 1]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># è¿™å°±æ˜¯ 1 / RMS(x)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Step 5: ä¹˜ä»¥åŸè¾“å…¥</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">x_norm </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> x </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> scale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># x_norm.shape = [32, 128, 512]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># å¹¿æ’­æœºåˆ¶ï¼š[32,128,512] * [32,128,1] â†’ [32,128,512]</span><br></span></code></pre></div></div>
<p><strong>éšå–»</strong>ï¼š</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">Step 1: æµ‹é‡æ¯ä¸ªå­¦ç”Ÿè¯´è¯çš„&quot;èƒ½é‡&quot; (å¹³æ–¹)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ä¸ç®¡æ˜¯æ­£æ•°è¿˜æ˜¯è´Ÿæ•°ï¼Œèƒ½é‡éƒ½æ˜¯æ­£çš„</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- å–Šå« (100) â†’ èƒ½é‡ 10000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- è½»è¯­ (0.01) â†’ èƒ½é‡ 0.0001</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Step 2: è®¡ç®—å…¨ç­çš„&quot;å¹³å‡èƒ½é‡&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- æŠŠ 512 ä¸ªå­¦ç”Ÿçš„èƒ½é‡åŠ èµ·æ¥ï¼Œé™¤ä»¥ 512</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Step 3-4: è®¡ç®—&quot;éŸ³é‡è°ƒèŠ‚ç³»æ•°&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- 1 / sqrt(å¹³å‡èƒ½é‡)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- å¹³å‡èƒ½é‡è¶Šå¤§ï¼Œè°ƒèŠ‚ç³»æ•°è¶Šå° (å‹ä½æ•´ä½“éŸ³é‡)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Step 5: åº”ç”¨è°ƒèŠ‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- æ¯ä¸ªå­¦ç”Ÿçš„å£°éŸ³ Ã— è°ƒèŠ‚ç³»æ•°</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- æ•´ä½“éŸ³é‡è¢«&quot;æ‹‰å¹³&quot;åˆ°å¯æ§èŒƒå›´</span><br></span></code></pre></div></div>
<hr>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="3-å‰å‘ä¼ æ’­-forward">3. å‰å‘ä¼ æ’­ (<code>forward</code>)<a href="#3-å‰å‘ä¼ æ’­-forward" class="hash-link" aria-label="Direct link to 3-å‰å‘ä¼ æ’­-forward" title="Direct link to 3-å‰å‘ä¼ æ’­-forward" translate="no">â€‹</a></h4>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">forward</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">weight </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_norm</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">float</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">type_as</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><strong>åˆ†æ­¥è§£æ</strong>ï¼š</p>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Step 1: è½¬æ¢ä¸º FP32 ç²¾åº¦</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">x_fp32 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">float</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># åŸå› ï¼šå½’ä¸€åŒ–è®¡ç®—æ¶‰åŠæ±‚å’Œã€é™¤æ³•ï¼ŒFP16 å®¹æ˜“æº¢å‡º</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Step 2: æ‰§è¡Œå½’ä¸€åŒ–</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">x_norm </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_norm</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x_fp32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Step 3: è½¬å›åŸå§‹ç²¾åº¦</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">x_norm </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> x_norm</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">type_as</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># å¦‚æœè¾“å…¥æ˜¯ FP16/BF16ï¼Œè¾“å‡ºä¹Ÿæ˜¯ FP16/BF16</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Step 4: ä¹˜ä»¥å¯å­¦ä¹ æƒé‡</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">output </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">weight </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> x_norm</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># self.weight.shape = [512]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># x_norm.shape = [32, 128, 512]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># å¹¿æ’­åï¼šoutput.shape = [32, 128, 512]</span><br></span></code></pre></div></div>
<p><strong>ä¸ºä»€ä¹ˆè¦ç”¨ FP32 è®¡ç®—ï¼Ÿ</strong></p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">é—®é¢˜åœºæ™¯:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">å‡è®¾è¾“å…¥æœ‰ 512 ä¸ªæ•°ï¼Œå¹³å‡å€¼çº¦ 1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">åœ¨ FP16 ä¸­:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- æ±‚å’Œ: 1.0 + 1.0 + ... (512æ¬¡) = 512.0 âœ“</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- å¹³æ–¹åæ±‚å’Œ: 1.0Â² + 1.0Â² + ... = 512.0 âœ“</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ä½†å¦‚æœæ•°å€¼èŒƒå›´å¤§:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- å¤§æ•°: 1000.0Â² = 1,000,000 (FP16 æœ€å¤§çº¦ 65504ï¼Œæº¢å‡ºï¼)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- å°æ•°: 0.0001Â² = 0.00000001 (FP16 ç²¾åº¦ä¸å¤Ÿï¼Œå˜æˆ 0)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">è§£å†³æ–¹æ¡ˆ:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">åœ¨ FP32 ä¸­è®¡ç®— (èŒƒå›´çº¦ 10^38)ï¼Œè®¡ç®—å®Œå†è½¬å› FP16</span><br></span></code></pre></div></div>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-rmsnorm-vs-layernorm-å¯¹æ¯”">ğŸ“Š RMSNorm vs LayerNorm å¯¹æ¯”<a href="#-rmsnorm-vs-layernorm-å¯¹æ¯”" class="hash-link" aria-label="Direct link to ğŸ“Š RMSNorm vs LayerNorm å¯¹æ¯”" title="Direct link to ğŸ“Š RMSNorm vs LayerNorm å¯¹æ¯”" translate="no">â€‹</a></h3>
<table><thead><tr><th>ç‰¹æ€§</th><th>LayerNorm</th><th>RMSNorm</th></tr></thead><tbody><tr><td><strong>è®¡ç®—å…¬å¼</strong></td><td><code>(x - mean) / std * Î³ + Î²</code></td><td><code>x / RMS(x) * Î³</code></td></tr><tr><td><strong>ç»Ÿè®¡é‡</strong></td><td>å‡å€¼ + æ–¹å·® (2ä¸ª)</td><td>ä»…å‡æ–¹æ ¹ (1ä¸ª)</td></tr><tr><td><strong>å¯å­¦ä¹ å‚æ•°</strong></td><td>Î³ (scale) + Î² (bias)</td><td>ä»… Î³ (scale)</td></tr><tr><td><strong>è®¡ç®—é€Ÿåº¦</strong></td><td>è¾ƒæ…¢</td><td>å¿« ~7-15%</td></tr><tr><td><strong>å‚æ•°é‡</strong></td><td>2 Ã— dim</td><td>1 Ã— dim</td></tr><tr><td><strong>ä½¿ç”¨æ¨¡å‹</strong></td><td>BERT, GPT-2</td><td>Llama, GPT-4, Mistral</td></tr></tbody></table>
<p><strong>ä¸ºä»€ä¹ˆå¤§æ¨¡å‹æ›´å–œæ¬¢ RMSNormï¼Ÿ</strong></p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">1. è®¡ç®—æ•ˆç‡:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - LayerNorm éœ€è¦ä¸¤æ¬¡ reduce (mean + var)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - RMSNorm åªéœ€è¦ä¸€æ¬¡ reduce (mean of squares)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - åœ¨ 512 ç»´åº¦ä¸Šï¼ŒèŠ‚çœçº¦ 15% è®¡ç®—æ—¶é—´</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. å‚æ•°é‡:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - LayerNorm: 2 Ã— hidden_size = 1024 å‚æ•°/å±‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - RMSNorm: 1 Ã— hidden_size = 512 å‚æ•°/å±‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - åœ¨ 32 å±‚æ¨¡å‹ä¸­ï¼Œå‡å°‘çº¦ 16K å‚æ•°</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. æ€§èƒ½:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - å¤šç¯‡è®ºæ–‡å®éªŒè¡¨æ˜ï¼Œåœ¨å¤§æ¨¡å‹ä¸­ä¸¤è€…æ€§èƒ½ç›¸å½“</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - æœ‰æ—¶ RMSNorm ç”šè‡³æ›´å¥½ (å¯èƒ½å› ä¸ºæ›´ç®€å•çš„å½’çº³åç½®)</span><br></span></code></pre></div></div>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-åœ¨-transformer-ä¸­çš„ä½ç½®">ğŸ“ åœ¨ Transformer ä¸­çš„ä½ç½®<a href="#-åœ¨-transformer-ä¸­çš„ä½ç½®" class="hash-link" aria-label="Direct link to ğŸ“ åœ¨ Transformer ä¸­çš„ä½ç½®" title="Direct link to ğŸ“ åœ¨ Transformer ä¸­çš„ä½ç½®" translate="no">â€‹</a></h3>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># MiniMindBlock ä¸­çš„ä½¿ç”¨ (ç¬¬ 1010-1014 è¡Œ)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">input_layernorm </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> RMSNorm</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hidden_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> eps</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">rms_norm_eps</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">post_attention_layernorm </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> RMSNorm</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hidden_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> eps</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">rms_norm_eps</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><strong>å®Œæ•´æµç¨‹</strong>ï¼š</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">è¾“å…¥</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   â†“</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">â”Œâ”€ RMSNorm (input_layernorm) â† è¿™é‡Œï¼</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">â”‚     â†“</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">â”‚  Attention</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">â”‚     â†“</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">â””â”€ Residual Add (x + Attention(x))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       â†“</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">â”Œâ”€ RMSNorm (post_attention_layernorm) â† è¿˜æœ‰è¿™é‡Œï¼</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">â”‚     â†“</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">â”‚  FeedForward</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">â”‚     â†“</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">â””â”€ Residual Add (x + FFN(x))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       â†“</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   è¾“å‡º</span><br></span></code></pre></div></div>
<p><strong>ä¸ºä»€ä¹ˆæ¯ä¸ªå­å±‚å‰éƒ½è¦å½’ä¸€åŒ–ï¼Ÿ</strong></p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">ç±»æ¯”: æ¥åŠ›èµ›è·‘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">å¦‚æœæ²¡æœ‰å½’ä¸€åŒ–:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ç¬¬ 1 æ£’é€‰æ‰‹å†²åˆºåˆ°ç»ˆç‚¹ï¼Œé€Ÿåº¦ 10m/s</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- æŠŠæ£’ä¼ ç»™ç¬¬ 2 æ£’ï¼Œç¬¬ 2 æ£’ç”¨ 10m/s çš„åˆé€Ÿåº¦ç»§ç»­åŠ é€Ÿ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ç¬¬ 3 æ£’æ¥åˆ°æ£’æ—¶ï¼Œé€Ÿåº¦å·²ç» 100m/s (çˆ†è¡¨ï¼)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ç¬¬ 32 æ£’æ—¶...é€Ÿåº¦å·²ç»æ˜¯å…‰é€Ÿçš„ 1000 å€ (æ•°å€¼çˆ†ç‚¸ï¼)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">æœ‰äº†å½’ä¸€åŒ–:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- æ¯ä¸€æ£’ç»“æŸåï¼Œå…ˆ&quot;ä¼‘æ¯ä¸€ä¸‹&quot;ï¼ŒæŠŠçŠ¶æ€è°ƒæ•´åˆ°æ­£å¸¸èŒƒå›´</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ç¬¬ 1 æ£’: 10m/s â†’ å½’ä¸€åŒ– â†’ 1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ç¬¬ 2 æ£’: ä» 1.0 å¼€å§‹ï¼Œå†å†²åˆºåˆ° 10m/s â†’ å½’ä¸€åŒ– â†’ 1.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- æ‰€æœ‰æ£’æ¬¡éƒ½åœ¨å¯æ§èŒƒå›´å†…</span><br></span></code></pre></div></div>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-epsilon-eps-çš„ä½œç”¨">ğŸ’¡ epsilon (eps) çš„ä½œç”¨<a href="#-epsilon-eps-çš„ä½œç”¨" class="hash-link" aria-label="Direct link to ğŸ’¡ epsilon (eps) çš„ä½œç”¨" title="Direct link to ğŸ’¡ epsilon (eps) çš„ä½œç”¨" translate="no">â€‹</a></h3>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">eps </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> eps  </span><span class="token comment" style="color:#999988;font-style:italic"># é»˜è®¤ 1e-5 = 0.00001</span><br></span></code></pre></div></div>
<p><strong>é—®é¢˜åœºæ™¯</strong>ï¼š</p>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># å¦‚æœè¾“å…¥å…¨æ˜¯ 0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">x </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">tensor</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># è®¡ç®— RMS</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mean_square </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token plain">Â² </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">Â² </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">Â² </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">Â²</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rms </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sqrt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">scale </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> âˆ  </span><span class="token comment" style="color:#999988;font-style:italic"># é™¤é›¶é”™è¯¯ï¼</span><br></span></code></pre></div></div>
<p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š</p>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># åŠ ä¸Šä¸€ä¸ªæå°çš„æ•°</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rms </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sqrt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.00001</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.00316</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">scale </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.00316</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">316.2</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># å®‰å…¨ï¼</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># è¾“å‡º</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">x_norm </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">316.2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># ä»ç„¶æ˜¯ 0ï¼Œç¬¦åˆé¢„æœŸ</span><br></span></code></pre></div></div>
<p><strong>eps çš„é€‰æ‹©</strong>ï¼š</p>
<table><thead><tr><th>eps å€¼</th><th>é€‚ç”¨åœºæ™¯</th><th>é£é™©</th></tr></thead><tbody><tr><td>1e-5</td><td>é»˜è®¤å€¼ï¼Œé€‚åˆå¤§å¤šæ•°æƒ…å†µ</td><td>æ— </td></tr><tr><td>1e-6</td><td>æ›´é«˜ç²¾åº¦éœ€æ±‚</td><td>FP16 ä¸‹å¯èƒ½å˜æˆ 0</td></tr><tr><td>1e-4</td><td>æç«¯æ•°å€¼èŒƒå›´</td><td>å¯èƒ½è½»å¾®å½±å“ç²¾åº¦</td></tr></tbody></table>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-æ•°å€¼ç¨³å®šæ€§ä¸ºä»€ä¹ˆ-fp32-å¾ˆé‡è¦">ğŸ”¬ æ•°å€¼ç¨³å®šæ€§ï¼šä¸ºä»€ä¹ˆ FP32 å¾ˆé‡è¦ï¼Ÿ<a href="#-æ•°å€¼ç¨³å®šæ€§ä¸ºä»€ä¹ˆ-fp32-å¾ˆé‡è¦" class="hash-link" aria-label="Direct link to ğŸ”¬ æ•°å€¼ç¨³å®šæ€§ï¼šä¸ºä»€ä¹ˆ FP32 å¾ˆé‡è¦ï¼Ÿ" title="Direct link to ğŸ”¬ æ•°å€¼ç¨³å®šæ€§ï¼šä¸ºä»€ä¹ˆ FP32 å¾ˆé‡è¦ï¼Ÿ" translate="no">â€‹</a></h3>
<p><strong>å®éªŒå¯¹æ¯”</strong>ï¼š</p>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> torch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># æ¨¡æ‹Ÿ hidden_size=512 çš„ç‰¹å¾å‘é‡</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">x </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">randn</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">512</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># æ•°å€¼èŒƒå›´è¾ƒå¤§</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># FP16 è®¡ç®—</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">x_fp16 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">half</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mean_sq_fp16 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> x_fp16</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">pow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mean</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># å¯èƒ½æº¢å‡ºï¼</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;FP16 mean_square: </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">mean_sq_fp16</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># å¯èƒ½æ˜¯ inf æˆ– nan</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># FP32 è®¡ç®—</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">x_fp32 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">float</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mean_sq_fp32 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> x_fp32</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">pow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mean</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;FP32 mean_square: </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">mean_sq_fp32</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># æ­£å¸¸æ•°å€¼</span><br></span></code></pre></div></div>
<p><strong>è¾“å‡ºç¤ºä¾‹</strong>ï¼š</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">FP16 mean_square: inf  # çˆ†äº†ï¼</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FP32 mean_square: 998234.5  # æ­£å¸¸</span><br></span></code></pre></div></div>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-å‚æ•°é‡è®¡ç®—-1">ğŸ“ å‚æ•°é‡è®¡ç®—<a href="#-å‚æ•°é‡è®¡ç®—-1" class="hash-link" aria-label="Direct link to ğŸ“ å‚æ•°é‡è®¡ç®—" title="Direct link to ğŸ“ å‚æ•°é‡è®¡ç®—" translate="no">â€‹</a></h3>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># å‡è®¾ hidden_size=512, num_layers=8</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># æ¯å±‚æœ‰ 2 ä¸ª RMSNorm</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#   - input_layernorm: 512 å‚æ•°</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#   - post_attention_layernorm: 512 å‚æ•°</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># åŠ ä¸Šæœ€åä¸€å±‚çš„ norm</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">#   - model.norm: 512 å‚æ•°</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">total_rmsnorm_params </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">512</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">512</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">512</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8704</span><span class="token plain"> å‚æ•°</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># å¯¹æ¯” LayerNorm:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">total_layernorm_params </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">512</span><span class="token operator" style="color:#393A34">*</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">512</span><span class="token operator" style="color:#393A34">*</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">512</span><span class="token operator" style="color:#393A34">*</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">17408</span><span class="token plain"> å‚æ•°</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># èŠ‚çœäº† 50% çš„å½’ä¸€åŒ–å±‚å‚æ•°ï¼</span><br></span></code></pre></div></div>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-ç±»æ¯”æ€»ç»“-3">ğŸ¯ ç±»æ¯”æ€»ç»“<a href="#-ç±»æ¯”æ€»ç»“-3" class="hash-link" aria-label="Direct link to ğŸ¯ ç±»æ¯”æ€»ç»“" title="Direct link to ğŸ¯ ç±»æ¯”æ€»ç»“" translate="no">â€‹</a></h3>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">RMSNorm å°±åƒæ•™å®¤é‡Œçš„&quot;æ™ºèƒ½éŸ³é‡å¹³è¡¡å™¨&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1. é—®é¢˜:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   512 ä¸ªå­¦ç”ŸåŒæ—¶è¯´è¯ï¼Œå£°éŸ³å¤§å°å·®å¼‚æ‚¬æ®Š</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - æœ‰äººåœ¨å–Šå« (æ•°å€¼ 1000)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - æœ‰äººåœ¨ä½è¯­ (æ•°å€¼ 0.001)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. è§£å†³æ–¹æ¡ˆ:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   æµ‹é‡å…¨ç­çš„&quot;å¹³å‡èƒ½é‡&quot; â†’ è®¡ç®—ä¸€ä¸ª&quot;è°ƒèŠ‚ç³»æ•°&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   æ¯ä¸ªäººçš„å£°éŸ³éƒ½é™¤ä»¥è¿™ä¸ªç³»æ•°</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. æ•ˆæœ:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - åŸæœ¬çš„&quot;ç›¸å¯¹å¤§å°&quot;è¢«ä¿ç•™</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - æ•´ä½“æ•°å€¼èŒƒå›´å˜å¾—å¯æ§</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - é˜²æ­¢æŸäº›&quot;å¤§å—“é—¨&quot;ä¸»å¯¼æ•´ä¸ªè¯¾å ‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4. å¯å­¦ä¹ æƒé‡ (weight):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - ä¸€å¼€å§‹æ‰€æœ‰å­¦ç”Ÿçš„éº¦å…‹é£å¢ç›Šæ˜¯ 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œæ¨¡å‹ä¼šå­¦ä¹ è°ƒæ•´</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - é‡è¦çš„&quot;å‘è¨€&quot;ä¼šè¢«æ”¾å¤§ï¼Œä¸é‡è¦çš„ä¼šè¢«å‹ä½</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5. ä¸ LayerNorm çš„åŒºåˆ«:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - LayerNorm: å…ˆå‡å»å¹³å‡åˆ†ï¼Œå†é™¤ä»¥æ³¢åŠ¨å¹…åº¦ï¼Œå†ç¼©æ”¾+åç§»</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - RMSNorm: ç›´æ¥é™¤ä»¥&quot;èƒ½é‡å‡æ–¹æ ¹&quot;ï¼Œå†ç¼©æ”¾</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - RMSNorm æ›´ç®€å•ã€æ›´å¿«ã€å‚æ•°æ›´å°‘</span><br></span></code></pre></div></div>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-ç›¸å…³ä»£ç ä½ç½®">ğŸ”— ç›¸å…³ä»£ç ä½ç½®<a href="#-ç›¸å…³ä»£ç ä½ç½®" class="hash-link" aria-label="Direct link to ğŸ”— ç›¸å…³ä»£ç ä½ç½®" title="Direct link to ğŸ”— ç›¸å…³ä»£ç ä½ç½®" translate="no">â€‹</a></h3>
<table><thead><tr><th>ç”¨é€”</th><th>ä»£ç ä½ç½®</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>RMSNorm å®šä¹‰</td><td>552-605 è¡Œ</td><td>ç±»å®šä¹‰å’Œå®ç°</td></tr><tr><td>Attention å‰ä½¿ç”¨</td><td>1047 è¡Œ</td><td><code>self.input_layernorm(hidden_states)</code></td></tr><tr><td>FFN å‰ä½¿ç”¨</td><td>1068 è¡Œ</td><td><code>self.post_attention_layernorm(hidden_states)</code></td></tr><tr><td>æœ€ç»ˆè¾“å‡ºå‰ä½¿ç”¨</td><td>1185 è¡Œ</td><td><code>self.norm(hidden_states)</code></td></tr></tbody></table>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_aDle" id="ä¸ƒå°æ˜çš„ç¤¾äº¤èƒ½åŠ›æ³¨æ„åŠ›æœºåˆ¶-attention">ä¸ƒã€å°æ˜çš„&quot;ç¤¾äº¤èƒ½åŠ›&quot;ï¼šæ³¨æ„åŠ›æœºåˆ¶ (Attention)<a href="#ä¸ƒå°æ˜çš„ç¤¾äº¤èƒ½åŠ›æ³¨æ„åŠ›æœºåˆ¶-attention" class="hash-link" aria-label="Direct link to ä¸ƒã€å°æ˜çš„&quot;ç¤¾äº¤èƒ½åŠ›&quot;ï¼šæ³¨æ„åŠ›æœºåˆ¶ (Attention)" title="Direct link to ä¸ƒã€å°æ˜çš„&quot;ç¤¾äº¤èƒ½åŠ›&quot;ï¼šæ³¨æ„åŠ›æœºåˆ¶ (Attention)" translate="no">â€‹</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-ä»£ç ç‰‡æ®µ-ç¬¬-392-549-è¡Œ">ğŸ“ ä»£ç ç‰‡æ®µ (ç¬¬ 392-549 è¡Œ)<a href="#-ä»£ç ç‰‡æ®µ-ç¬¬-392-549-è¡Œ" class="hash-link" aria-label="Direct link to ğŸ“ ä»£ç ç‰‡æ®µ (ç¬¬ 392-549 è¡Œ)" title="Direct link to ğŸ“ ä»£ç ç‰‡æ®µ (ç¬¬ 392-549 è¡Œ)" translate="no">â€‹</a></h3>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">Attention</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">nn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Module</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    æ³¨æ„åŠ›æœºåˆ¶æ¨¡å— (Attention Mechanism)ã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    æœ¬å®ç°æ”¯æŒåˆ†ç»„æŸ¥è¯¢æ³¨æ„åŠ› (Grouped Query Attention, GQA) ä»¥åŠ Flash Attention åŠ é€Ÿã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    åŒæ—¶é›†æˆäº†æ—‹è½¬ä½ç½®ç¼–ç  (RoPE) å’Œ KV Cache æœºåˆ¶ã€‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__init__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> MiniMindConfig</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token builtin">super</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">__init__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">num_key_value_heads </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            args</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">num_attention_heads</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">num_key_value_heads </span><span class="token keyword" style="color:#00009f">is</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">num_key_value_heads</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">assert</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">num_attention_heads </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">num_key_value_heads </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">n_local_heads </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">num_attention_heads  </span><span class="token comment" style="color:#999988;font-style:italic"># Query å¤´æ•°</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">n_local_kv_heads </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">num_key_value_heads  </span><span class="token comment" style="color:#999988;font-style:italic"># Key/Value å¤´æ•°</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">n_rep </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">n_local_heads </span><span class="token operator" style="color:#393A34">//</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">n_local_kv_heads</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">head_dim </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hidden_size </span><span class="token operator" style="color:#393A34">//</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">num_attention_heads</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># çº¿æ€§æŠ•å½±å±‚</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">q_proj </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Linear</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">args</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hidden_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">num_attention_heads </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">head_dim</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> bias</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">k_proj </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Linear</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">args</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hidden_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">num_key_value_heads </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">head_dim</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> bias</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">v_proj </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Linear</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">args</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hidden_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">num_key_value_heads </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">head_dim</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> bias</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">o_proj </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Linear</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">args</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">num_attention_heads </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">head_dim</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hidden_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> bias</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">attn_dropout </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Dropout</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">args</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dropout</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">resid_dropout </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Dropout</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">args</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dropout</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dropout </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dropout</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flash </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">hasattr</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">nn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">functional</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;scaled_dot_product_attention&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flash_attn</span><br></span></code></pre></div></div>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-éšå–»ç¿»è¯‘å°æ˜å‚åŠ åœ†æ¡Œè®¨è®ºä¼š">ğŸ¯ éšå–»ç¿»è¯‘ï¼šå°æ˜å‚åŠ &quot;åœ†æ¡Œè®¨è®ºä¼š&quot;<a href="#-éšå–»ç¿»è¯‘å°æ˜å‚åŠ åœ†æ¡Œè®¨è®ºä¼š" class="hash-link" aria-label="Direct link to ğŸ¯ éšå–»ç¿»è¯‘ï¼šå°æ˜å‚åŠ &quot;åœ†æ¡Œè®¨è®ºä¼š&quot;" title="Direct link to ğŸ¯ éšå–»ç¿»è¯‘ï¼šå°æ˜å‚åŠ &quot;åœ†æ¡Œè®¨è®ºä¼š&quot;" translate="no">â€‹</a></h3>
<p>æƒ³è±¡å°æ˜åœ¨å†™å°è¯´æ—¶ï¼Œéœ€è¦ç†è§£å¥å­ä¸­æ¯ä¸ªè¯ä¸å…¶ä»–è¯çš„å…³ç³»ã€‚<strong>æ³¨æ„åŠ›æœºåˆ¶</strong>å°±åƒä¸€åœº&quot;åœ†æ¡Œè®¨è®ºä¼š&quot;ï¼š</p>
<p><strong>åœºæ™¯è®¾å®š</strong>ï¼š</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">å¥å­: &quot;å°çº¢å¸½ èµ°è¿› æ£®æ— é‡åˆ° äº† å¤§ç°ç‹¼&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">å°æ˜çš„å¤§è„‘åŒæ—¶å¤„ç† 6 ä¸ªè¯:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ä½ç½®0: å°çº¢å¸½ (ä¸»è§’)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ä½ç½®1: èµ°è¿›   (åŠ¨ä½œ)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ä½ç½®2: æ£®æ—   (åœ°ç‚¹)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ä½ç½®3: é‡åˆ°   (è½¬æŠ˜åŠ¨ä½œ)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ä½ç½®4: äº†     (è¯­æ°”è¯)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ä½ç½®5: å¤§ç°ç‹¼ (å¦ä¸€ä¸ªè§’è‰²)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">é—®é¢˜: å½“å°æ˜æƒ³ç†è§£&quot;é‡åˆ°&quot;è¿™ä¸ªè¯æ—¶ï¼Œåº”è¯¥é‡ç‚¹å…³æ³¨å“ªäº›è¯ï¼Ÿ</span><br></span></code></pre></div></div>
<p><strong>æ³¨æ„åŠ›æœºåˆ¶çš„å›ç­”</strong>ï¼š</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">&quot;é‡åˆ°&quot;éœ€è¦å…³æ³¨:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- &quot;å°çº¢å¸½&quot; (è°é‡åˆ°çš„ï¼Ÿ) â†’ æ³¨æ„åŠ›æƒé‡ 0.35</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- &quot;å¤§ç°ç‹¼&quot; (é‡åˆ°äº†è°ï¼Ÿ) â†’ æ³¨æ„åŠ›æƒé‡ 0.45</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- &quot;æ£®æ—&quot;   (åœ¨å“ªé‡Œé‡åˆ°çš„ï¼Ÿ) â†’ æ³¨æ„åŠ›æƒé‡ 0.15</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- &quot;èµ°è¿›&quot;   (ä¹‹å‰å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ) â†’ æ³¨æ„åŠ›æƒé‡ 0.05</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- &quot;äº†&quot;     (è¯­æ³•è¾…åŠ©) â†’ æ³¨æ„åŠ›æƒé‡ 0.00</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ç»“æœ: &quot;é‡åˆ°&quot;çš„è¯­ä¹‰ = 35%çš„å°çº¢å¸½ä¿¡æ¯ + 45%çš„å¤§ç°ç‹¼ä¿¡æ¯ + 15%çš„æ£®æ—ä¿¡æ¯ + ...</span><br></span></code></pre></div></div>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-æ ¸å¿ƒæ¦‚å¿µquerykeyvalue-qkv">ğŸ”‘ æ ¸å¿ƒæ¦‚å¿µï¼šQueryã€Keyã€Value (QKV)<a href="#-æ ¸å¿ƒæ¦‚å¿µquerykeyvalue-qkv" class="hash-link" aria-label="Direct link to ğŸ”‘ æ ¸å¿ƒæ¦‚å¿µï¼šQueryã€Keyã€Value (QKV)" title="Direct link to ğŸ”‘ æ ¸å¿ƒæ¦‚å¿µï¼šQueryã€Keyã€Value (QKV)" translate="no">â€‹</a></h3>
<p>è¿™æ˜¯æ³¨æ„åŠ›æœºåˆ¶çš„ä¸‰ä¸ªæ ¸å¿ƒè§’è‰²ï¼Œç”¨&quot;å›¾ä¹¦é¦†æŸ¥è¯¢&quot;æ¥ç±»æ¯”æœ€ç›´è§‚ï¼š</p>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="åœºæ™¯å»å›¾ä¹¦é¦†æ‰¾ä¹¦">åœºæ™¯ï¼šå»å›¾ä¹¦é¦†æ‰¾ä¹¦<a href="#åœºæ™¯å»å›¾ä¹¦é¦†æ‰¾ä¹¦" class="hash-link" aria-label="Direct link to åœºæ™¯ï¼šå»å›¾ä¹¦é¦†æ‰¾ä¹¦" title="Direct link to åœºæ™¯ï¼šå»å›¾ä¹¦é¦†æ‰¾ä¹¦" translate="no">â€‹</a></h4>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">ä½ æƒ³æ‰¾ä¸€æœ¬å…³äº&quot;ç«¥è¯æ•…äº‹&quot;çš„ä¹¦:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1. Query (æŸ¥è¯¢/é—®é¢˜): ä½ è„‘æµ·ä¸­çš„éœ€æ±‚</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &quot;æˆ‘æƒ³æ‰¾ç«¥è¯æ•…äº‹ç›¸å…³çš„ä¹¦&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. Key (ç´¢å¼•/ç›®å½•å¡): ä¹¦æ¶ä¸Šæ¯æœ¬ä¹¦çš„æ ‡ç­¾</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &quot;æ ¼æ—ç«¥è¯&quot;ã€&quot;å®‰å¾’ç”Ÿç«¥è¯&quot;ã€&quot;å“ˆåˆ©æ³¢ç‰¹&quot;ã€&quot;é«˜ç­‰æ•°å­¦&quot;...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. Value (å†…å®¹/ä¹¦æœ¬èº«): æ¯æœ¬ä¹¦çš„å®é™…å†…å®¹</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ã€Šæ ¼æ—ç«¥è¯ã€‹çš„æ•…äº‹å†…å®¹ã€ã€Šé«˜ç­‰æ•°å­¦ã€‹çš„å…¬å¼å†…å®¹...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">æŸ¥è¯¢è¿‡ç¨‹:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">a) ç”¨ä½ çš„ Query å’Œæ¯ä¸ª Key è¿›è¡ŒåŒ¹é… (è®¡ç®—ç›¸ä¼¼åº¦)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - &quot;ç«¥è¯æ•…äº‹&quot; vs &quot;æ ¼æ—ç«¥è¯&quot; â†’ åŒ¹é…åº¦ 0.9 (å¾ˆé«˜!)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - &quot;ç«¥è¯æ•…äº‹&quot; vs &quot;é«˜ç­‰æ•°å­¦&quot; â†’ åŒ¹é…åº¦ 0.0 (å®Œå…¨ä¸ç›¸å…³)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">b) æ ¹æ®åŒ¹é…åº¦ï¼ŒåŠ æƒè·å– Value (ä¹¦çš„å†…å®¹)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - 90% æ³¨æ„åŠ›åœ¨ã€Šæ ¼æ—ç«¥è¯ã€‹çš„å†…å®¹</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - 0% æ³¨æ„åŠ›åœ¨ã€Šé«˜ç­‰æ•°å­¦ã€‹çš„å†…å®¹</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">c) è¾“å‡º: ç»¼åˆäº†ç›¸å…³ä¹¦ç±å†…å®¹çš„&quot;ç­”æ¡ˆ&quot;</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="ä»£ç ä¸­çš„-qkv-æŠ•å½±">ä»£ç ä¸­çš„ QKV æŠ•å½±<a href="#ä»£ç ä¸­çš„-qkv-æŠ•å½±" class="hash-link" aria-label="Direct link to ä»£ç ä¸­çš„ QKV æŠ•å½±" title="Direct link to ä»£ç ä¸­çš„ QKV æŠ•å½±" translate="no">â€‹</a></h4>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># ç¬¬ 420-430 è¡Œ</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">q_proj </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Linear</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">args</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hidden_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">num_attention_heads </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">head_dim</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> bias</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">k_proj </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Linear</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">args</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hidden_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">num_key_value_heads </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">head_dim</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> bias</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">v_proj </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> nn</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Linear</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">args</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">hidden_size</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">num_key_value_heads </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">head_dim</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> bias</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><strong>éšå–»è§£é‡Š</strong>ï¼š</p>
<table><thead><tr><th>æŠ•å½±å±‚</th><th>ä½œç”¨</th><th>ç±»æ¯”</th></tr></thead><tbody><tr><td><code>q_proj</code></td><td>æŠŠè¾“å…¥å˜æˆ&quot;é—®é¢˜&quot;</td><td>æŠŠä½ çš„éœ€æ±‚ç¿»è¯‘æˆå›¾ä¹¦é¦†èƒ½ç†è§£çš„æŸ¥è¯¢è¯­è¨€</td></tr><tr><td><code>k_proj</code></td><td>æŠŠè¾“å…¥å˜æˆ&quot;ç´¢å¼•&quot;</td><td>ç»™æ¯ä¸ªè¯è´´ä¸Šæ ‡ç­¾ï¼Œæ–¹ä¾¿è¢«æŸ¥æ‰¾</td></tr><tr><td><code>v_proj</code></td><td>æŠŠè¾“å…¥å˜æˆ&quot;å†…å®¹&quot;</td><td>æå–æ¯ä¸ªè¯çš„æ ¸å¿ƒä¿¡æ¯ï¼Œå‡†å¤‡è¢«è¯»å–</td></tr></tbody></table>
<p><strong>ç»´åº¦è¯´æ˜</strong>ï¼š</p>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># å‡è®¾ hidden_size=512, num_attention_heads=8, num_key_value_heads=2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># head_dim = 512 / 8 = 64</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q_proj</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">512</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> â†’ </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">8</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">64</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">512</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 8 ä¸ª Query å¤´ï¼Œæ¯ä¸ª 64 ç»´</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k_proj</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">512</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> â†’ </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">64</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">128</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 2 ä¸ª Key å¤´ï¼Œæ¯ä¸ª 64 ç»´ (GQA)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">v_proj</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">512</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> â†’ </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">64</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">128</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 2 ä¸ª Value å¤´ï¼Œæ¯ä¸ª 64 ç»´ (GQA)</span><br></span></code></pre></div></div>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-å¤šå¤´æ³¨æ„åŠ›-multi-head-attention">ğŸ§  å¤šå¤´æ³¨æ„åŠ› (Multi-Head Attention)<a href="#-å¤šå¤´æ³¨æ„åŠ›-multi-head-attention" class="hash-link" aria-label="Direct link to ğŸ§  å¤šå¤´æ³¨æ„åŠ› (Multi-Head Attention)" title="Direct link to ğŸ§  å¤šå¤´æ³¨æ„åŠ› (Multi-Head Attention)" translate="no">â€‹</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="ä¸ºä»€ä¹ˆéœ€è¦å¤šä¸ªå¤´">ä¸ºä»€ä¹ˆéœ€è¦&quot;å¤šä¸ªå¤´&quot;ï¼Ÿ<a href="#ä¸ºä»€ä¹ˆéœ€è¦å¤šä¸ªå¤´" class="hash-link" aria-label="Direct link to ä¸ºä»€ä¹ˆéœ€è¦&quot;å¤šä¸ªå¤´&quot;ï¼Ÿ" title="Direct link to ä¸ºä»€ä¹ˆéœ€è¦&quot;å¤šä¸ªå¤´&quot;ï¼Ÿ" translate="no">â€‹</a></h4>
<p><strong>é—®é¢˜åœºæ™¯</strong>ï¼š</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">å¥å­: &quot;å°çº¢å¸½çš„å¤–å©†ä½åœ¨æ£®æ—æ·±å¤„çš„å°æœ¨å±‹é‡Œ&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">å•å¤´æ³¨æ„åŠ›çš„å±€é™:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- åªèƒ½å…³æ³¨ä¸€ç§å…³ç³»æ¨¡å¼</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- å¯èƒ½åªå…³æ³¨åˆ°&quot;å°çº¢å¸½&quot;å’Œ&quot;å¤–å©†&quot;çš„äº²å±å…³ç³»</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- å¿½ç•¥äº†&quot;å¤–å©†&quot;å’Œ&quot;å°æœ¨å±‹&quot;çš„å±…ä½å…³ç³»</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- å¿½ç•¥äº†&quot;æ£®æ—&quot;å’Œ&quot;å°æœ¨å±‹&quot;çš„åœ°ç†å…³ç³»</span><br></span></code></pre></div></div>
<p><strong>è§£å†³æ–¹æ¡ˆï¼šå¤šå¤´æ³¨æ„åŠ›</strong></p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">8 ä¸ªæ³¨æ„åŠ›å¤´ï¼Œå„å¸å…¶èŒ:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">å¤´1 (è¯­æ³•å¤´): å…³æ³¨ä¸»è°“å®¾ç»“æ„</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &quot;å¤–å©†&quot; â†’ &quot;ä½åœ¨&quot; â†’ &quot;å°æœ¨å±‹&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">å¤´2 (è¯­ä¹‰å¤´): å…³æ³¨è¯­ä¹‰ç›¸ä¼¼è¯</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &quot;å°çº¢å¸½&quot; â†” &quot;å¤–å©†&quot; (éƒ½æ˜¯äºº)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &quot;æ£®æ—&quot; â†” &quot;å°æœ¨å±‹&quot; (éƒ½æ˜¯åœ°ç‚¹)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">å¤´3 (è·ç¦»å¤´): å…³æ³¨ç›¸é‚»è¯</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &quot;æ£®æ—æ·±å¤„&quot; â†’ &quot;çš„&quot; â†’ &quot;å°æœ¨å±‹&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">å¤´4 (å®ä½“å¤´): å…³æ³¨ä¸“æœ‰åè¯</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   &quot;å°çº¢å¸½&quot; â†” &quot;å¤–å©†&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">å¤´5-8: å…¶ä»–æ¨¡å¼ (æƒ…æ„Ÿã€å› æœã€æ—¶é—´ç­‰)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">æœ€ç»ˆ: ç»¼åˆ 8 ä¸ªå¤´çš„å‘ç°ï¼Œå½¢æˆå…¨é¢ç†è§£</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="ä»£ç ä¸­çš„å¤šå¤´å®ç°">ä»£ç ä¸­çš„å¤šå¤´å®ç°<a href="#ä»£ç ä¸­çš„å¤šå¤´å®ç°" class="hash-link" aria-label="Direct link to ä»£ç ä¸­çš„å¤šå¤´å®ç°" title="Direct link to ä»£ç ä¸­çš„å¤šå¤´å®ç°" translate="no">â€‹</a></h4>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># ç¬¬ 467-472 è¡Œ</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># é‡å¡‘å½¢çŠ¶ï¼Œå°† hidden_size åˆ‡åˆ†ä¸º n_heads * head_dim</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">xq </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> xq</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">view</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bsz</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> seq_len</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">n_local_heads</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">head_dim</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">xk </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> xk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">view</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bsz</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> seq_len</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">n_local_kv_heads</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">head_dim</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">xv </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> xv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">view</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bsz</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> seq_len</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">n_local_kv_heads</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">head_dim</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><strong>å½¢çŠ¶å˜åŒ–</strong>ï¼š</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">è¾“å…¥ x: [batch=32, seq_len=128, hidden=512]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    â†“ q_proj</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">xq: [32, 128, 512]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    â†“ view (åˆ‡åˆ†ä¸ºå¤šä¸ªå¤´)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">xq: [32, 128, 8, 64]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    â†‘     â†‘   â†‘   â†‘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  batch  seq heads head_dim</span><br></span></code></pre></div></div>
<p><strong>éšå–»</strong>ï¼š</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">åŸæœ¬: 512 ä¸ªç¥ç»å…ƒä¸€èµ·å¤„ç†</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">åˆ‡åˆ†å: åˆ†æˆ 8 ç»„ï¼Œæ¯ç»„ 64 ä¸ªç¥ç»å…ƒ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">å°±åƒ:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">åŸæœ¬: 1 ä¸ªå¤§ä¾¦æ¢è´Ÿè´£å…¨éƒ¨çº¿ç´¢</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">åˆ‡åˆ†å: 8 ä¸ªå°ä¾¦æ¢ï¼Œæ¯äººè´Ÿè´£ä¸€éƒ¨åˆ†çº¿ç´¢</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ç„¶åæ±‡æ€»å„è‡ªçš„å‘ç°</span><br></span></code></pre></div></div>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-æ—‹è½¬ä½ç½®ç¼–ç -rope">ğŸ”„ æ—‹è½¬ä½ç½®ç¼–ç  (RoPE)<a href="#-æ—‹è½¬ä½ç½®ç¼–ç -rope" class="hash-link" aria-label="Direct link to ğŸ”„ æ—‹è½¬ä½ç½®ç¼–ç  (RoPE)" title="Direct link to ğŸ”„ æ—‹è½¬ä½ç½®ç¼–ç  (RoPE)" translate="no">â€‹</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="ä¸ºä»€ä¹ˆéœ€è¦ä½ç½®ä¿¡æ¯">ä¸ºä»€ä¹ˆéœ€è¦ä½ç½®ä¿¡æ¯ï¼Ÿ<a href="#ä¸ºä»€ä¹ˆéœ€è¦ä½ç½®ä¿¡æ¯" class="hash-link" aria-label="Direct link to ä¸ºä»€ä¹ˆéœ€è¦ä½ç½®ä¿¡æ¯ï¼Ÿ" title="Direct link to ä¸ºä»€ä¹ˆéœ€è¦ä½ç½®ä¿¡æ¯ï¼Ÿ" translate="no">â€‹</a></h4>
<p><strong>é—®é¢˜</strong>ï¼š</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">å¥å­1: &quot;ç‹—å’¬äºº&quot; (ç‹—æ˜¯ä¸»è¯­ï¼Œäººæ˜¯å®¾è¯­)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">å¥å­2: &quot;äººå’¬ç‹—&quot; (äººæ˜¯ä¸»è¯­ï¼Œç‹—æ˜¯å®¾è¯­)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">å¦‚æœæ²¡æœ‰ä½ç½®ä¿¡æ¯:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ä¸¤ä¸ªå¥å­çš„è¯å‘é‡å®Œå…¨ç›¸åŒ: {ç‹—, å’¬, äºº}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- æ¨¡å‹æ— æ³•åŒºåˆ†è°æ˜¯ä¸»è¯­ã€è°æ˜¯å®¾è¯­!</span><br></span></code></pre></div></div>
<p><strong>è§£å†³æ–¹æ¡ˆï¼šRoPE æ—‹è½¬ä½ç½®ç¼–ç </strong></p>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># ç¬¬ 474-477 è¡Œ</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cos</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sin </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> position_embeddings</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">xq</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> xk </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> apply_rotary_pos_emb</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">xq</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> xk</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> cos</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sin</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="rope-çš„éšå–»ç»™åº§ä½ç¼–å·">RoPE çš„éšå–»ï¼šç»™åº§ä½ç¼–å·<a href="#rope-çš„éšå–»ç»™åº§ä½ç¼–å·" class="hash-link" aria-label="Direct link to RoPE çš„éšå–»ï¼šç»™åº§ä½ç¼–å·" title="Direct link to RoPE çš„éšå–»ï¼šç»™åº§ä½ç¼–å·" translate="no">â€‹</a></h4>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">æƒ³è±¡ç”µå½±é™¢çš„åº§ä½:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">æ²¡æœ‰ä½ç½®ç¼–ç :</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- è§‚ä¼— A å’Œ B éƒ½åœ¨çœ‹ç”µå½±</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ä½†ä¸çŸ¥é“è°ååœ¨å‰æ’ã€è°åœ¨åæ’</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- æ— æ³•åˆ¤æ–­&quot;å‰æ’çš„è§‚ä¼—æŒ¡ä½äº†åæ’&quot;è¿™ç§å…³ç³»</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">æœ‰äº† RoPE:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- è§‚ä¼— A åœ¨ 3 æ’ (ä½ç½® 3)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- è§‚ä¼— B åœ¨ 7 æ’ (ä½ç½® 7)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ä»–ä»¬ä¹‹é—´çš„&quot;ç›¸å¯¹è·ç¦»&quot;æ˜¯ 4 æ’</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RoPE çš„ç‰¹æ®Šä¹‹å¤„:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- æŠŠä½ç½®ä¿¡æ¯&quot;èå…¥&quot;åˆ°å‘é‡ä¸­</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- é€šè¿‡&quot;æ—‹è½¬&quot;æ“ä½œï¼Œè®©ç›¸å¯¹ä½ç½®è‡ªç„¶ä½“ç°åœ¨ç‚¹ç§¯ä¸­</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ä½ç½® 3 å’Œä½ç½® 7 çš„ Query/Key æ—‹è½¬åï¼Œç‚¹ç§¯ç»“æœè‡ªåŠ¨åæ˜ äº†&quot;è·ç¦» 4&quot;</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="rope-çš„æ•°å­¦ç›´è§‰">RoPE çš„æ•°å­¦ç›´è§‰<a href="#rope-çš„æ•°å­¦ç›´è§‰" class="hash-link" aria-label="Direct link to RoPE çš„æ•°å­¦ç›´è§‰" title="Direct link to RoPE çš„æ•°å­¦ç›´è§‰" translate="no">â€‹</a></h4>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># ç¬¬ 301-352 è¡Œ apply_rotary_pos_emb å‡½æ•°</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">rotate_half</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    x1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">shape</span><span class="token punctuation" style="color:#393A34">[</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">//</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    x2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">shape</span><span class="token punctuation" style="color:#393A34">[</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">//</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cat</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">-</span><span class="token plain">x2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> x1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dim</span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q_embed </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">q </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> cos</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rotate_half</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">q</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> sin</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">k_embed </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> cos</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rotate_half</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> sin</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><strong>æ—‹è½¬çš„å‡ ä½•æ„ä¹‰</strong>ï¼š</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">æŠŠå‘é‡æƒ³è±¡æˆå¤æ•°å¹³é¢ä¸Šçš„ç‚¹:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">åŸå§‹å‘é‡ q = [q1, q2] </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         â†’ å¤æ•°è¡¨ç¤º: q1 + i*q2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">æ—‹è½¬ Î¸ è§’åº¦:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(q1 + i*q2) Ã— e^(iÎ¸) = (q1 + i*q2) Ã— (cos Î¸ + i*sin Î¸)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">å±•å¼€:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">å®éƒ¨: q1*cos - q2*sin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">è™šéƒ¨: q1*sin + q2*cos</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ä»£ç å®ç°:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">q * cos = [q1*cos, q2*cos]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">rotate_half(q) * sin = [-q2*sin, q1*sin]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ç›¸åŠ : [q1*cos - q2*sin, q2*cos + q1*sin]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">è¿™å°±æ˜¯äºŒç»´æ—‹è½¬çŸ©é˜µçš„ç»“æœ!</span><br></span></code></pre></div></div>
<p><strong>ä¸ºä»€ä¹ˆæ—‹è½¬èƒ½è¡¨ç¤ºä½ç½®ï¼Ÿ</strong></p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">ä½ç½® 0 çš„å‘é‡: ä¸æ—‹è½¬</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ä½ç½® 1 çš„å‘é‡: æ—‹è½¬ Î¸ åº¦</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ä½ç½® 2 çš„å‘é‡: æ—‹è½¬ 2Î¸ åº¦</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ä½ç½® n çš„å‘é‡: æ—‹è½¬ nÎ¸ åº¦</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">å½“è®¡ç®— Q å’Œ K çš„ç‚¹ç§¯æ—¶:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Q åœ¨ä½ç½® mï¼Œæ—‹è½¬äº† mÎ¸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- K åœ¨ä½ç½® nï¼Œæ—‹è½¬äº† nÎ¸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ç‚¹ç§¯ç»“æœåªå–å†³äº (m-n)Î¸ï¼Œå³ç›¸å¯¹ä½ç½®!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">è¿™å°±æ˜¯ RoPE çš„ç²¾å¦™ä¹‹å¤„:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ç»å¯¹ä½ç½®ç¼–ç  â†’ ç›¸å¯¹ä½ç½®ä¿¡æ¯</span><br></span></code></pre></div></div>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-kv-cacheæ¨ç†åŠ é€Ÿçš„ç§˜å¯†æ­¦å™¨">ğŸ“¦ KV Cacheï¼šæ¨ç†åŠ é€Ÿçš„ç§˜å¯†æ­¦å™¨<a href="#-kv-cacheæ¨ç†åŠ é€Ÿçš„ç§˜å¯†æ­¦å™¨" class="hash-link" aria-label="Direct link to ğŸ“¦ KV Cacheï¼šæ¨ç†åŠ é€Ÿçš„ç§˜å¯†æ­¦å™¨" title="Direct link to ğŸ“¦ KV Cacheï¼šæ¨ç†åŠ é€Ÿçš„ç§˜å¯†æ­¦å™¨" translate="no">â€‹</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="é—®é¢˜åœºæ™¯-2">é—®é¢˜åœºæ™¯<a href="#é—®é¢˜åœºæ™¯-2" class="hash-link" aria-label="Direct link to é—®é¢˜åœºæ™¯" title="Direct link to é—®é¢˜åœºæ™¯" translate="no">â€‹</a></h4>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">ç”Ÿæˆæ–‡æœ¬: &quot;ä»Šå¤©å¤©æ°”...&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Step 1: è¾“å…¥ &quot;ä»Šå¤©å¤©æ°”&quot;ï¼Œç”Ÿæˆ &quot;å¾ˆ&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        è®¡ç®— Q, K, V for [&quot;ä»Šå¤©&quot;, &quot;å¤©æ°”&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        è¾“å‡º: &quot;å¾ˆ&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Step 2: è¾“å…¥ &quot;ä»Šå¤©å¤©æ°”å¾ˆ&quot;ï¼Œç”Ÿæˆ &quot;å¥½&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        é‡æ–°è®¡ç®— Q, K, V for [&quot;ä»Šå¤©&quot;, &quot;å¤©æ°”&quot;, &quot;å¾ˆ&quot;]  â† æµªè´¹ï¼</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        å…¶å® &quot;ä»Šå¤©&quot;, &quot;å¤©æ°”&quot; çš„ K, V å·²ç»åœ¨ Step 1 ç®—è¿‡äº†</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">é—®é¢˜: æ¯ä¸€æ­¥éƒ½é‡å¤è®¡ç®—å†å² token çš„ K, V</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     åºåˆ—è¶Šé•¿ï¼Œæµªè´¹è¶Šä¸¥é‡</span><br></span></code></pre></div></div>
<p><strong>è§£å†³æ–¹æ¡ˆï¼šKV Cache</strong></p>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># ç¬¬ 479-486 è¡Œ</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># å¦‚æœæä¾›äº†è¿‡å»çš„ KVï¼Œå°†å…¶ä¸å½“å‰çš„ KV æ‹¼æ¥</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> past_key_value </span><span class="token keyword" style="color:#00009f">is</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    xk </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cat</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">past_key_value</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> xk</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dim</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    xv </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cat</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">past_key_value</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> xv</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dim</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># å¦‚æœå¯ç”¨ç¼“å­˜ï¼Œä¿å­˜å½“å‰çš„å®Œæ•´ KV çŠ¶æ€</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">past_kv </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">xk</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> xv</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> use_cache </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><br></span></code></pre></div></div>
<p><strong>éšå–»è§£é‡Š</strong>ï¼š</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">KV Cache = åšç¬”è®°</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">æ²¡æœ‰ Cache:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">è€å¸ˆ: &quot;è¯·å›å¿†ä»Šå¤©ä¸Šåˆå­¦çš„å†…å®¹&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">å­¦ç”Ÿ: ä»å¤´å¼€å§‹å›å¿†å…¨éƒ¨è¯¾ç¨‹... (æ…¢!)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">æœ‰äº† Cache:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">è€å¸ˆ: &quot;è¯·å›å¿†ä»Šå¤©ä¸Šåˆå­¦çš„å†…å®¹&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">å­¦ç”Ÿ: ç¿»å¼€ç¬”è®°æœ¬ï¼Œç›´æ¥çœ‹è®°å½• (å¿«!)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ä»£ç æµç¨‹:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Step 1: è®¡ç®— K, V for [&quot;ä»Šå¤©&quot;, &quot;å¤©æ°”&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ä¿å­˜åˆ° Cache: past_kv = (K, V)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Step 2: è¾“å…¥æ–°è¯ &quot;å¾ˆ&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        åªè®¡ç®—æ–°è¯çš„ k, v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ä» Cache ä¸­å–å‡ºå†å²çš„ K, V</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        æ‹¼æ¥: K_new = [K_å†å², k_å½“å‰]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">èŠ‚çœ: ä» O(nÂ²) é™åˆ° O(n)</span><br></span></code></pre></div></div>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-åˆ†ç»„æŸ¥è¯¢æ³¨æ„åŠ›-gqa">ğŸ­ åˆ†ç»„æŸ¥è¯¢æ³¨æ„åŠ› (GQA)<a href="#-åˆ†ç»„æŸ¥è¯¢æ³¨æ„åŠ›-gqa" class="hash-link" aria-label="Direct link to ğŸ­ åˆ†ç»„æŸ¥è¯¢æ³¨æ„åŠ› (GQA)" title="Direct link to ğŸ­ åˆ†ç»„æŸ¥è¯¢æ³¨æ„åŠ› (GQA)" translate="no">â€‹</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="é—®é¢˜åœºæ™¯-3">é—®é¢˜åœºæ™¯<a href="#é—®é¢˜åœºæ™¯-3" class="hash-link" aria-label="Direct link to é—®é¢˜åœºæ™¯" title="Direct link to é—®é¢˜åœºæ™¯" translate="no">â€‹</a></h4>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">æ ‡å‡† Multi-Head Attention (MHA):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- 8 ä¸ª Query å¤´</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- 8 ä¸ª Key å¤´</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- 8 ä¸ª Value å¤´</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">KV Cache å¤§å° = 8 Ã— seq_len Ã— head_dim Ã— 2 (Kå’ŒV)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">             = 8 Ã— 2048 Ã— 64 Ã— 2 = 2 MB / layer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">32 å±‚æ¨¡å‹: 64 MB æ˜¾å­˜ç”¨äº KV Cache</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">100K ä¸Šä¸‹æ–‡: 3.2 GB æ˜¾å­˜ç”¨äº KV Cache!</span><br></span></code></pre></div></div>
<p><strong>è§£å†³æ–¹æ¡ˆï¼šGQA (Grouped Query Attention)</strong></p>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># ç¬¬ 404-415 è¡Œ</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">n_local_heads </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> args</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">num_attention_heads  </span><span class="token comment" style="color:#999988;font-style:italic"># Query å¤´æ•°: 8</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">n_local_kv_heads </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">num_key_value_heads  </span><span class="token comment" style="color:#999988;font-style:italic"># KV å¤´æ•°: 2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">n_rep </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">n_local_heads </span><span class="token operator" style="color:#393A34">//</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">n_local_kv_heads  </span><span class="token comment" style="color:#999988;font-style:italic"># é‡å¤å€æ•°: 4</span><br></span></code></pre></div></div>
<p><strong>éšå–»è§£é‡Š</strong>ï¼š</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">åŸæ¥ (MHA):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">8 ä¸ªå­¦ç”Ÿ (Query) å„å¸¦ 1 æœ¬ä¸“å±è¯å…¸ (Key+Value)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">æ€»å…±éœ€è¦ 8 æœ¬è¯å…¸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ç°åœ¨ (GQA):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">8 ä¸ªå­¦ç”Ÿ (Query) å…±ç”¨ 2 æœ¬å…¬å…±è¯å…¸ (Key+Value)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">æ¯ 4 ä¸ªå­¦ç”Ÿå…±ç”¨ 1 æœ¬è¯å…¸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">æ€»å…±åªéœ€è¦ 2 æœ¬è¯å…¸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">èŠ‚çœ: æ˜¾å­˜å‡å°‘ 75% (8â†’2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ä»£ä»·: æ€§èƒ½å‡ ä¹ä¸é™ (Meta è®ºæ–‡éªŒè¯)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="repeat_kv-å‡½æ•°å¦‚ä½•å…±äº«è¯å…¸">repeat_kv å‡½æ•°ï¼šå¦‚ä½•&quot;å…±äº«&quot;è¯å…¸<a href="#repeat_kv-å‡½æ•°å¦‚ä½•å…±äº«è¯å…¸" class="hash-link" aria-label="Direct link to repeat_kv å‡½æ•°ï¼šå¦‚ä½•&quot;å…±äº«&quot;è¯å…¸" title="Direct link to repeat_kv å‡½æ•°ï¼šå¦‚ä½•&quot;å…±äº«&quot;è¯å…¸" translate="no">â€‹</a></h4>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># ç¬¬ 355-389 è¡Œ</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">repeat_kv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Tensor</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> n_rep</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Tensor</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    bs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> slen</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> num_key_value_heads</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> head_dim </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">shape</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> n_rep </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> x</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        x</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">expand</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> slen</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> num_key_value_heads</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> n_rep</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> head_dim</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reshape</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> slen</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> num_key_value_heads </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> n_rep</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> head_dim</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><strong>å½¢çŠ¶å˜åŒ–å›¾è§£</strong>ï¼š</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">è¾“å…¥ K: [batch, seq, 2, 64]  (2 ä¸ª KV å¤´)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         â†“</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">æ’å…¥ç»´åº¦: [batch, seq, 2, 1, 64]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         â†“</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">å¹¿æ’­å¤åˆ¶: [batch, seq, 2, 4, 64]  (æ¯ä¸ªå¤´å¤åˆ¶ 4 æ¬¡)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         â†“</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">åˆå¹¶ç»´åº¦: [batch, seq, 8, 64]  (å˜æˆ 8 ä¸ªå¤´)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ç»“æœ: 2 ä¸ª KV å¤´è¢«&quot;å¹¿æ’­&quot;æˆ 8 ä¸ªï¼Œä¾› 8 ä¸ª Query å¤´ä½¿ç”¨</span><br></span></code></pre></div></div>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-flash-attentioné—ªç”µèˆ¬çš„è®¡ç®—é€Ÿåº¦">âš¡ Flash Attentionï¼šé—ªç”µèˆ¬çš„è®¡ç®—é€Ÿåº¦<a href="#-flash-attentioné—ªç”µèˆ¬çš„è®¡ç®—é€Ÿåº¦" class="hash-link" aria-label="Direct link to âš¡ Flash Attentionï¼šé—ªç”µèˆ¬çš„è®¡ç®—é€Ÿåº¦" title="Direct link to âš¡ Flash Attentionï¼šé—ªç”µèˆ¬çš„è®¡ç®—é€Ÿåº¦" translate="no">â€‹</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="ä¼ ç»Ÿæ³¨æ„åŠ›çš„é—®é¢˜">ä¼ ç»Ÿæ³¨æ„åŠ›çš„é—®é¢˜<a href="#ä¼ ç»Ÿæ³¨æ„åŠ›çš„é—®é¢˜" class="hash-link" aria-label="Direct link to ä¼ ç»Ÿæ³¨æ„åŠ›çš„é—®é¢˜" title="Direct link to ä¼ ç»Ÿæ³¨æ„åŠ›çš„é—®é¢˜" translate="no">â€‹</a></h4>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># ä¼ ç»Ÿå®ç° (ç¬¬ 517-543 è¡Œçš„ else åˆ†æ”¯)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">scores </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">xq @ xk</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">transpose</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> math</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sqrt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">head_dim</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># scores å½¢çŠ¶: [batch, heads, seq_len, seq_len]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># å¦‚æœ seq_len=32768ï¼Œé‚£ä¹ˆ scores å ç”¨:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># 32768 Ã— 32768 Ã— 4 bytes = 4 GB æ˜¾å­˜!</span><br></span></code></pre></div></div>
<p><strong>é—®é¢˜</strong>ï¼š</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">è¦å­˜å‚¨å®Œæ•´çš„æ³¨æ„åŠ›çŸ©é˜µ:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- å½¢çŠ¶: [seq_len Ã— seq_len]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- 32K åºåˆ—: 1 billion ä¸ªå…ƒç´ </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- æ˜¾å­˜çˆ†ç‚¸!</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="flash-attention-çš„è§£å†³æ–¹æ¡ˆ">Flash Attention çš„è§£å†³æ–¹æ¡ˆ<a href="#flash-attention-çš„è§£å†³æ–¹æ¡ˆ" class="hash-link" aria-label="Direct link to Flash Attention çš„è§£å†³æ–¹æ¡ˆ" title="Direct link to Flash Attention çš„è§£å†³æ–¹æ¡ˆ" translate="no">â€‹</a></h4>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># ç¬¬ 499-513 è¡Œ</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flash </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">seq_len </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">and</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    output </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> F</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">scaled_dot_product_attention</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        xq</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> xk</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> xv</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dropout_p</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dropout </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">training </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        is_causal</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><strong>æ ¸å¿ƒæ€æƒ³ï¼šåˆ†å—è®¡ç®— (Tiling)</strong></p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">ä¼ ç»Ÿæ–¹æ³•:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1. è®¡ç®—å®Œæ•´çš„ [32K Ã— 32K] æ³¨æ„åŠ›çŸ©é˜µ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. å­˜å‚¨åˆ°æ˜¾å­˜</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. åº”ç”¨ Softmax</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4. ä¹˜ä»¥ V</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Flash Attention:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1. æŠŠçŸ©é˜µåˆ†æˆå°å— (å¦‚ 64Ã—64)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. æ¯æ¬¡åªè®¡ç®—ä¸€ä¸ªå°å—</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. è®¡ç®—å®Œç«‹å³ä¸¢å¼ƒï¼ŒèŠ‚çœæ˜¾å­˜</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4. ç»“æœå®Œå…¨ä¸€è‡´ï¼Œä½†æ˜¾å­˜å ç”¨ä» O(nÂ²) é™åˆ° O(n)</span><br></span></code></pre></div></div>
<p><strong>æ€§èƒ½å¯¹æ¯”</strong>ï¼š</p>
<table><thead><tr><th>æŒ‡æ ‡</th><th>ä¼ ç»Ÿæ³¨æ„åŠ›</th><th>Flash Attention</th></tr></thead><tbody><tr><td><strong>æ˜¾å­˜</strong></td><td>O(nÂ²)</td><td>O(n)</td></tr><tr><td><strong>é€Ÿåº¦</strong></td><td>100%</td><td>200-400%</td></tr><tr><td><strong>ç²¾åº¦</strong></td><td>å®Œå…¨ä¸€è‡´</td><td>å®Œå…¨ä¸€è‡´</td></tr></tbody></table>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-å› æœæ©ç -causal-mask">ğŸ­ å› æœæ©ç  (Causal Mask)<a href="#-å› æœæ©ç -causal-mask" class="hash-link" aria-label="Direct link to ğŸ­ å› æœæ©ç  (Causal Mask)" title="Direct link to ğŸ­ å› æœæ©ç  (Causal Mask)" translate="no">â€‹</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="ä¸ºä»€ä¹ˆéœ€è¦å› æœæ©ç ">ä¸ºä»€ä¹ˆéœ€è¦å› æœæ©ç ï¼Ÿ<a href="#ä¸ºä»€ä¹ˆéœ€è¦å› æœæ©ç " class="hash-link" aria-label="Direct link to ä¸ºä»€ä¹ˆéœ€è¦å› æœæ©ç ï¼Ÿ" title="Direct link to ä¸ºä»€ä¹ˆéœ€è¦å› æœæ©ç ï¼Ÿ" translate="no">â€‹</a></h4>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">ç”Ÿæˆæ–‡æœ¬æ—¶çš„è§„åˆ™:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- åªèƒ½çœ‹åˆ°&quot;å·²ç»ç”Ÿæˆçš„è¯&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ä¸èƒ½&quot;å·çœ‹æœªæ¥&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ä¾‹å¦‚ç”Ÿæˆ &quot;ä»Šå¤©å¤©æ°”å¾ˆå¥½&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ä½ç½®0 &quot;ä»Šå¤©&quot; åªèƒ½çœ‹åˆ°: [ä»Šå¤©]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ä½ç½®1 &quot;å¤©æ°”&quot; åªèƒ½çœ‹åˆ°: [ä»Šå¤©, å¤©æ°”]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ä½ç½®2 &quot;å¾ˆ&quot;   åªèƒ½çœ‹åˆ°: [ä»Šå¤©, å¤©æ°”, å¾ˆ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ä½ç½®3 &quot;å¥½&quot;   åªèƒ½çœ‹åˆ°: [ä»Šå¤©, å¤©æ°”, å¾ˆ, å¥½]</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="ä»£ç å®ç°">ä»£ç å®ç°<a href="#ä»£ç å®ç°" class="hash-link" aria-label="Direct link to ä»£ç å®ç°" title="Direct link to ä»£ç å®ç°" translate="no">â€‹</a></h4>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># ç¬¬ 521-527 è¡Œ</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># åº”ç”¨å› æœæ©ç </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">scores</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain">seq_len</span><span class="token punctuation" style="color:#393A34">:</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">triu</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">full</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">seq_len</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> seq_len</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">float</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;-inf&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> device</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">scores</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">device</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    diagonal</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<p><strong>æ©ç çŸ©é˜µå¯è§†åŒ–</strong>ï¼š</p>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">                Key ä½ç½®</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              0    1    2    3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Query    0   [0   -âˆ   -âˆ   -âˆ]   â† ä½ç½®0åªèƒ½çœ‹ä½ç½®0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ä½ç½®     1   [0    0   -âˆ   -âˆ]   â† ä½ç½®1èƒ½çœ‹0,1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         2   [0    0    0   -âˆ]   â† ä½ç½®2èƒ½çœ‹0,1,2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         3   [0    0    0    0]   â† ä½ç½®3èƒ½çœ‹å…¨éƒ¨</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Softmax å:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         0   [1.0  0    0    0 ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         1   [0.5  0.5  0    0 ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         2   [0.3  0.3  0.3  0 ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         3   [0.25 0.25 0.25 0.25]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-âˆ ç»è¿‡ Softmax å˜æˆ 0ï¼Œè¾¾åˆ°&quot;çœ‹ä¸è§&quot;çš„æ•ˆæœ</span><br></span></code></pre></div></div>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-å®Œæ•´çš„-attention-æµç¨‹å›¾">ğŸ“Š å®Œæ•´çš„ Attention æµç¨‹å›¾<a href="#-å®Œæ•´çš„-attention-æµç¨‹å›¾" class="hash-link" aria-label="Direct link to ğŸ“Š å®Œæ•´çš„ Attention æµç¨‹å›¾" title="Direct link to ğŸ“Š å®Œæ•´çš„ Attention æµç¨‹å›¾" translate="no">â€‹</a></h3>
<!-- -->
<hr>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-å‚æ•°é‡è®¡ç®—-2">âš¡ å‚æ•°é‡è®¡ç®—<a href="#-å‚æ•°é‡è®¡ç®—-2" class="hash-link" aria-label="Direct link to âš¡ å‚æ•°é‡è®¡ç®—" title="Direct link to âš¡ å‚æ•°é‡è®¡ç®—" translate="no">â€‹</a></h3>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># å‡è®¾ hidden_size=512, num_heads=8, num_kv_heads=2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># q_proj: 512 Ã— 512 = 262,144 å‚æ•°</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># k_proj: 512 Ã— 128 = 65,536 å‚æ•°  (GQA èŠ‚çœ!)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># v_proj: 512 Ã— 128 = 65,536 å‚æ•°  (GQA èŠ‚çœ!)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># o_proj: 512 Ã— 512 = 262,144 å‚æ•°</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># æ€»è®¡: 655,360 å‚æ•° (0.66M)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># å¯¹æ¯”æ ‡å‡† MHA (num_kv_heads=8):</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># k_proj: 512 Ã— 512 = 262,144</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># v_proj: 512 Ã— 512 = 262,144</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># æ€»è®¡: 1,048,576 å‚æ•° (1.05M)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># GQA èŠ‚çœ: 37.5% çš„ Attention å±‚å‚æ•°!</span><br></span></code></pre></div></div>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-å®é™…åº”ç”¨åœºæ™¯">ğŸ’¼ å®é™…åº”ç”¨åœºæ™¯<a href="#-å®é™…åº”ç”¨åœºæ™¯" class="hash-link" aria-label="Direct link to ğŸ’¼ å®é™…åº”ç”¨åœºæ™¯" title="Direct link to ğŸ’¼ å®é™…åº”ç”¨åœºæ™¯" translate="no">â€‹</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="åœºæ™¯-1-çŸ­æ–‡æœ¬ç”Ÿæˆ-èŠå¤©æœºå™¨äºº">åœºæ™¯ 1: çŸ­æ–‡æœ¬ç”Ÿæˆ (èŠå¤©æœºå™¨äºº)<a href="#åœºæ™¯-1-çŸ­æ–‡æœ¬ç”Ÿæˆ-èŠå¤©æœºå™¨äºº" class="hash-link" aria-label="Direct link to åœºæ™¯ 1: çŸ­æ–‡æœ¬ç”Ÿæˆ (èŠå¤©æœºå™¨äºº)" title="Direct link to åœºæ™¯ 1: çŸ­æ–‡æœ¬ç”Ÿæˆ (èŠå¤©æœºå™¨äºº)" translate="no">â€‹</a></h4>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># seq_len &lt; 512ï¼Œä¸éœ€è¦ç‰¹åˆ«ä¼˜åŒ–</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> MiniMindConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hidden_size</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">512</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    num_attention_heads</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    num_key_value_heads</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># ä½¿ç”¨æ ‡å‡† MHA</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    flash_attn</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="åœºæ™¯-2-é•¿æ–‡æœ¬å¤„ç†-æ–‡æ¡£åˆ†æ">åœºæ™¯ 2: é•¿æ–‡æœ¬å¤„ç† (æ–‡æ¡£åˆ†æ)<a href="#åœºæ™¯-2-é•¿æ–‡æœ¬å¤„ç†-æ–‡æ¡£åˆ†æ" class="hash-link" aria-label="Direct link to åœºæ™¯ 2: é•¿æ–‡æœ¬å¤„ç† (æ–‡æ¡£åˆ†æ)" title="Direct link to åœºæ™¯ 2: é•¿æ–‡æœ¬å¤„ç† (æ–‡æ¡£åˆ†æ)" translate="no">â€‹</a></h4>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># seq_len &gt; 4096ï¼Œæ˜¾å­˜æ˜¯ç“¶é¢ˆ</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> MiniMindConfig</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    hidden_size</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1024</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    num_attention_heads</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    num_key_value_heads</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># ä½¿ç”¨ GQA èŠ‚çœ KV Cache</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    flash_attn</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># å¿…é¡»å¼€å¯!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    max_position_embeddings</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">32768</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_aDle" id="åœºæ™¯-3-æµå¼æ¨ç†-å®æ—¶ç”Ÿæˆ">åœºæ™¯ 3: æµå¼æ¨ç† (å®æ—¶ç”Ÿæˆ)<a href="#åœºæ™¯-3-æµå¼æ¨ç†-å®æ—¶ç”Ÿæˆ" class="hash-link" aria-label="Direct link to åœºæ™¯ 3: æµå¼æ¨ç† (å®æ—¶ç”Ÿæˆ)" title="Direct link to åœºæ™¯ 3: æµå¼æ¨ç† (å®æ—¶ç”Ÿæˆ)" translate="no">â€‹</a></h4>
<div class="language-python codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-python codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># ä½¿ç”¨ KV Cache åŠ é€Ÿè‡ªå›å½’ç”Ÿæˆ</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">past_key_values </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">None</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> _ </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">max_new_tokens</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    outputs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> model</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        input_ids</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">new_token</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        past_key_values</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">past_key_values</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        use_cache</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">True</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># å¯ç”¨ KV Cache</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    past_key_values </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> outputs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">past_key_values</span><br></span></code></pre></div></div>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-ç±»æ¯”æ€»ç»“-4">ğŸ“ ç±»æ¯”æ€»ç»“<a href="#-ç±»æ¯”æ€»ç»“-4" class="hash-link" aria-label="Direct link to ğŸ“ ç±»æ¯”æ€»ç»“" title="Direct link to ğŸ“ ç±»æ¯”æ€»ç»“" translate="no">â€‹</a></h3>
<div class="language-text codeBlockContainer_FVab theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_oMSL"><pre tabindex="0" class="prism-code language-text codeBlock_MTmK thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_KEkQ"><span class="token-line" style="color:#393A34"><span class="token plain">æ³¨æ„åŠ›æœºåˆ¶å°±åƒå°æ˜å‚åŠ &quot;åœ†æ¡Œè®¨è®ºä¼š&quot;:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1. åœºæ™¯è®¾å®š:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - å¥å­ä¸­çš„æ¯ä¸ªè¯æ˜¯ä¸€ä¸ª&quot;ä¸ä¼šè€…&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - æ¯ä¸ªä¸ä¼šè€…éƒ½æœ‰é—®é¢˜ (Query) å’ŒçŸ¥è¯† (Key+Value)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. è®¨è®ºè¿‡ç¨‹:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - å°æ˜ (å½“å‰è¯) æå‡ºé—®é¢˜ (Query)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - å‘æ‰€æœ‰äººè¯¢é—® (å’Œæ¯ä¸ªäººçš„ Key è®¡ç®—ç›¸ä¼¼åº¦)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - æ ¹æ®ç›¸å…³åº¦ï¼Œè·å–å¤§å®¶çš„çŸ¥è¯† (åŠ æƒæ±‚å’Œ Value)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. å¤šå¤´æ³¨æ„åŠ›:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - 8 ä¸ªå°æ˜åˆ†èº«ï¼Œå„è‡ªå…³æ³¨ä¸åŒè§’åº¦</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - è¯­æ³•ã€è¯­ä¹‰ã€æƒ…æ„Ÿã€è·ç¦»...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - æœ€åæ±‡æ€»æ‰€æœ‰å‘ç°</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4. ä½ç½®ç¼–ç  (RoPE):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - ç»™æ¯ä¸ªåº§ä½ç¼–å·</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - è®©å°æ˜çŸ¥é“&quot;è°ååœ¨å‰é¢ã€è°ååœ¨åé¢&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5. KV Cache:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - æŠŠè®¨è®ºç»“æœè®°åœ¨ç¬”è®°æœ¬ä¸Š</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - ä¸‹æ¬¡è®¨è®ºç›´æ¥ç¿»ç¬”è®°ï¼Œä¸ç”¨é‡æ–°é—®</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">6. GQA:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - 4 ä¸ªå­¦ç”Ÿå…±ç”¨ 1 æœ¬è¯å…¸</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - èŠ‚çœèµ„æºï¼Œæ•ˆæœç›¸å½“</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">7. Flash Attention:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - åˆ†æ‰¹è®¨è®ºï¼Œè¾¹è®¨è®ºè¾¹æ€»ç»“</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - ä¸ç”¨åŒæ—¶è®°ä½æ‰€æœ‰äººè¯´çš„è¯</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - çœå†…å­˜ã€é€Ÿåº¦å¿«</span><br></span></code></pre></div></div>
<hr>
<h3 class="anchor anchorTargetStickyNavbar_aDle" id="-ç›¸å…³ä»£ç ä½ç½®æ±‡æ€»">ğŸ”— ç›¸å…³ä»£ç ä½ç½®æ±‡æ€»<a href="#-ç›¸å…³ä»£ç ä½ç½®æ±‡æ€»" class="hash-link" aria-label="Direct link to ğŸ”— ç›¸å…³ä»£ç ä½ç½®æ±‡æ€»" title="Direct link to ğŸ”— ç›¸å…³ä»£ç ä½ç½®æ±‡æ€»" translate="no">â€‹</a></h3>
<table><thead><tr><th>ç»„ä»¶</th><th>ä»£ç ä½ç½®</th><th>åŠŸèƒ½</th></tr></thead><tbody><tr><td><code>apply_rotary_pos_emb</code></td><td>301-352 è¡Œ</td><td>åº”ç”¨ RoPE æ—‹è½¬ä½ç½®ç¼–ç </td></tr><tr><td><code>repeat_kv</code></td><td>355-389 è¡Œ</td><td>GQA çš„ KV å¤´å¤åˆ¶æ‰©å±•</td></tr><tr><td><code>Attention.__init__</code></td><td>399-443 è¡Œ</td><td>åˆå§‹åŒ–æŠ•å½±å±‚å’Œé…ç½®</td></tr><tr><td><code>Attention.forward</code></td><td>446-549 è¡Œ</td><td>å®Œæ•´çš„æ³¨æ„åŠ›è®¡ç®—æµç¨‹</td></tr><tr><td>Flash Attention è·¯å¾„</td><td>499-513 è¡Œ</td><td>PyTorch å†…ç½®é«˜æ•ˆå®ç°</td></tr><tr><td>æ‰‹åŠ¨ Attention è·¯å¾„</td><td>515-543 è¡Œ</td><td>å…¼å®¹æ—§ç‰ˆæœ¬çš„å®ç°</td></tr></tbody></table>
<hr></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_iDCr"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/AI/Pytorch/ä»å¤´å¼€å§‹è®­ç»ƒè‡ªå·±çš„å¤§æ¨¡å‹.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_c0mv" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_mxtt"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/notes3/docs/AI/Pytorch/outer"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">outer</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/notes3/docs/AI/Pytorch/ä¼˜åŒ–/ç®€ä»‹"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">ç®€ä»‹</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_r83r thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-æ•´ä½“è®­ç»ƒæµç¨‹" class="table-of-contents__link toc-highlight">1. æ•´ä½“è®­ç»ƒæµç¨‹</a></li><li><a href="#2-è®­ç»ƒå¾ªç¯è¯¦æƒ…-train_epoch" class="table-of-contents__link toc-highlight">2. è®­ç»ƒå¾ªç¯è¯¦æƒ… (train_epoch)</a></li><li><a href="#3-æ¨¡å‹ç»„ä»¶æ¶æ„-class-diagram" class="table-of-contents__link toc-highlight">3. æ¨¡å‹ç»„ä»¶æ¶æ„ (Class Diagram)</a></li><li><a href="#4-å…³é”®ç»„ä»¶è¯´æ˜" class="table-of-contents__link toc-highlight">4. å…³é”®ç»„ä»¶è¯´æ˜</a></li><li><a href="#ä¸€å¼€åœºå‡†å¤‡è®¾ç½®éšæœºç§å­-setup_seed" class="table-of-contents__link toc-highlight">ä¸€ã€å¼€åœºå‡†å¤‡ï¼šè®¾ç½®éšæœºç§å­ (<code>setup_seed</code>)</a><ul><li><a href="#-ä»£ç ç‰‡æ®µ-ç¬¬-114-121-è¡Œ" class="table-of-contents__link toc-highlight">ğŸ“ ä»£ç ç‰‡æ®µ (ç¬¬ 114-121 è¡Œ)</a></li><li><a href="#-éšå–»ç¿»è¯‘å›ºå®šè€ƒè¯•é¢˜åº“çš„é¡ºåº" class="table-of-contents__link toc-highlight">ğŸ¯ éšå–»ç¿»è¯‘ï¼šå›ºå®šè€ƒè¯•é¢˜åº“çš„é¡ºåº</a></li><li><a href="#-ç±»æ¯”æ€»ç»“" class="table-of-contents__link toc-highlight">ğŸ’¡ ç±»æ¯”æ€»ç»“</a></li><li><a href="#ï¸-æ³¨æ„äº‹é¡¹" class="table-of-contents__link toc-highlight">âš ï¸ æ³¨æ„äº‹é¡¹</a></li></ul></li><li><a href="#äºŒè®¾è®¡å¤§è„‘è“å›¾minimindconfig-é…ç½®ç±»" class="table-of-contents__link toc-highlight">äºŒã€è®¾è®¡å¤§è„‘è“å›¾ï¼šMiniMindConfig é…ç½®ç±»</a><ul><li><a href="#-ä»£ç ç‰‡æ®µ-ç¬¬-27-102-è¡Œ" class="table-of-contents__link toc-highlight">ğŸ“ ä»£ç ç‰‡æ®µ (ç¬¬ 27-102 è¡Œ)</a></li><li><a href="#-éšå–»ç¿»è¯‘è®¾è®¡å°æ˜çš„å¤§è„‘è“å›¾" class="table-of-contents__link toc-highlight">ğŸ¯ éšå–»ç¿»è¯‘ï¼šè®¾è®¡å°æ˜çš„å¤§è„‘è“å›¾</a></li><li><a href="#-æ ¸å¿ƒç»“æ„å‚æ•°" class="table-of-contents__link toc-highlight">ğŸ§  æ ¸å¿ƒç»“æ„å‚æ•°</a></li><li><a href="#ï¸-ä¼˜åŒ–ä¸æŠ€å·§å‚æ•°" class="table-of-contents__link toc-highlight">âš™ï¸ ä¼˜åŒ–ä¸æŠ€å·§å‚æ•°</a></li><li><a href="#-ç‰¹æ®Štokenå‚æ•°" class="table-of-contents__link toc-highlight">ğŸ”§ ç‰¹æ®ŠTokenå‚æ•°</a></li><li><a href="#-é«˜çº§å‚æ•°" class="table-of-contents__link toc-highlight">ğŸ”¬ é«˜çº§å‚æ•°</a></li><li><a href="#-æ··åˆä¸“å®¶moeå‚æ•°" class="table-of-contents__link toc-highlight">ğŸ“ æ··åˆä¸“å®¶(MoE)å‚æ•°</a></li><li><a href="#-é…ç½®æ€»ç»“è¡¨" class="table-of-contents__link toc-highlight">ğŸ“Š é…ç½®æ€»ç»“è¡¨</a></li><li><a href="#-é…ç½®å®æˆ˜å»ºè®®" class="table-of-contents__link toc-highlight">ğŸ’¡ é…ç½®å®æˆ˜å»ºè®®</a></li></ul></li><li><a href="#ä¸‰å­¦ä¹ è¿›åº¦çš„å­˜æ¡£ä¸è¯»æ¡£æ¨¡å‹æ£€æŸ¥ç‚¹-lm_checkpoint" class="table-of-contents__link toc-highlight">ä¸‰ã€å­¦ä¹ è¿›åº¦çš„å­˜æ¡£ä¸è¯»æ¡£ï¼šæ¨¡å‹æ£€æŸ¥ç‚¹ (lm_checkpoint)</a><ul><li><a href="#-ä»£ç ç‰‡æ®µ-ç¬¬-124-246-è¡Œ" class="table-of-contents__link toc-highlight">ğŸ“ ä»£ç ç‰‡æ®µ (ç¬¬ 124-246 è¡Œ)</a></li><li><a href="#-éšå–»ç¿»è¯‘å°æ˜å­¦ä¹ çš„å­˜æ¡£ä¸è¯»æ¡£ç³»ç»Ÿ" class="table-of-contents__link toc-highlight">ğŸ¯ éšå–»ç¿»è¯‘ï¼šå°æ˜å­¦ä¹ çš„&quot;å­˜æ¡£&quot;ä¸&quot;è¯»æ¡£&quot;ç³»ç»Ÿ</a></li><li><a href="#-æ ¸å¿ƒæ¦‚å¿µä¸ºä»€ä¹ˆéœ€è¦æ£€æŸ¥ç‚¹" class="table-of-contents__link toc-highlight">ğŸ® æ ¸å¿ƒæ¦‚å¿µï¼šä¸ºä»€ä¹ˆéœ€è¦æ£€æŸ¥ç‚¹?</a></li><li><a href="#-ä¸¤ç§å­˜æ¡£æ–‡ä»¶è½»é‡æ¨ç†-vs-å®Œæ•´æ¢å¤" class="table-of-contents__link toc-highlight">ğŸ“¦ ä¸¤ç§å­˜æ¡£æ–‡ä»¶ï¼šè½»é‡æ¨ç† vs å®Œæ•´æ¢å¤</a></li><li><a href="#-å…³é”®æŠ€æœ¯ç»†èŠ‚" class="table-of-contents__link toc-highlight">ğŸ” å…³é”®æŠ€æœ¯ç»†èŠ‚</a></li><li><a href="#-åŠ è½½æ¨¡å¼ä»å­˜æ¡£ä¸­æ¢å¤" class="table-of-contents__link toc-highlight">ğŸ”„ åŠ è½½æ¨¡å¼ï¼šä»å­˜æ¡£ä¸­æ¢å¤</a></li><li><a href="#-å®Œæ•´ä½¿ç”¨æµç¨‹" class="table-of-contents__link toc-highlight">ğŸ’¡ å®Œæ•´ä½¿ç”¨æµç¨‹</a></li><li><a href="#ï¸-å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ" class="table-of-contents__link toc-highlight">âš ï¸ å¸¸è§é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ</a></li><li><a href="#-ä¸¤ç§æ–‡ä»¶çš„å¯¹æ¯”æ€»ç»“" class="table-of-contents__link toc-highlight">ğŸ“Š ä¸¤ç§æ–‡ä»¶çš„å¯¹æ¯”æ€»ç»“</a></li><li><a href="#-ç±»æ¯”æ€»ç»“-1" class="table-of-contents__link toc-highlight">ğŸ“ ç±»æ¯”æ€»ç»“</a></li><li><a href="#-ä¸å…¶ä»–æ¨¡å—çš„å…³ç³»" class="table-of-contents__link toc-highlight">ğŸ”— ä¸å…¶ä»–æ¨¡å—çš„å…³ç³»</a></li></ul></li><li><a href="#å››æ•™å°æ˜è¯†å­—åˆ†è¯å™¨-tokenizer-ä¸è¯åµŒå…¥-embedding" class="table-of-contents__link toc-highlight">å››ã€æ•™å°æ˜è¯†å­—:åˆ†è¯å™¨ (Tokenizer) ä¸è¯åµŒå…¥ (Embedding)</a><ul><li><a href="#-æ ¸å¿ƒé—®é¢˜è®¡ç®—æœºå¦‚ä½•ç†è§£æ–‡å­—" class="table-of-contents__link toc-highlight">ğŸ“ æ ¸å¿ƒé—®é¢˜:è®¡ç®—æœºå¦‚ä½•ç†è§£æ–‡å­—?</a></li><li><a href="#-ç¬¬ä¸€æ­¥åˆ†è¯å™¨-tokenizer---å»ºç«‹è¯æ±‡è¡¨" class="table-of-contents__link toc-highlight">ğŸ”¤ ç¬¬ä¸€æ­¥:åˆ†è¯å™¨ (Tokenizer) - å»ºç«‹&quot;è¯æ±‡è¡¨&quot;</a></li><li><a href="#-ç¬¬äºŒæ­¥è¯åµŒå…¥-embedding---æŠŠ-id-å˜æˆæœ‰æ„ä¹‰çš„å‘é‡" class="table-of-contents__link toc-highlight">ğŸ§® ç¬¬äºŒæ­¥:è¯åµŒå…¥ (Embedding) - æŠŠ ID å˜æˆ&quot;æœ‰æ„ä¹‰çš„å‘é‡&quot;</a></li><li><a href="#-æ€»ç»“ä»æ–‡å­—åˆ°å‘é‡çš„å®Œæ•´æµç¨‹" class="table-of-contents__link toc-highlight">ğŸ’¡ æ€»ç»“:ä»æ–‡å­—åˆ°å‘é‡çš„å®Œæ•´æµç¨‹</a></li></ul></li><li><a href="#äº”å°æ˜çš„è”æƒ³å‘æ•£èƒ½åŠ›feedforward-å‰é¦ˆç½‘ç»œ-swiglu" class="table-of-contents__link toc-highlight">äº”ã€å°æ˜çš„&quot;è”æƒ³å‘æ•£&quot;èƒ½åŠ›ï¼šFeedForward å‰é¦ˆç½‘ç»œ (SwiGLU)</a><ul><li><a href="#-ä»£ç ç‰‡æ®µ-ç¬¬-249-298-è¡Œ" class="table-of-contents__link toc-highlight">ğŸ“ ä»£ç ç‰‡æ®µ (ç¬¬ 249-298 è¡Œ)</a></li><li><a href="#-éšå–»ç¿»è¯‘å°æ˜çš„æ€ç»´å‘æ•£ä¸æ”¶æ•›èƒ½åŠ›" class="table-of-contents__link toc-highlight">ğŸ¯ éšå–»ç¿»è¯‘ï¼šå°æ˜çš„&quot;æ€ç»´å‘æ•£ä¸æ”¶æ•›&quot;èƒ½åŠ›</a></li><li><a href="#-æ ¸å¿ƒè®¾è®¡ä¸ºä»€ä¹ˆè¦å…ˆæ‰©å¼ å†å‹ç¼©" class="table-of-contents__link toc-highlight">ğŸ§  æ ¸å¿ƒè®¾è®¡ï¼šä¸ºä»€ä¹ˆè¦&quot;å…ˆæ‰©å¼ ï¼Œå†å‹ç¼©&quot;ï¼Ÿ</a></li><li><a href="#-éšå–»è§£æä¸‰ä¸ªæŠ•å½±å±‚çš„ä½œç”¨" class="table-of-contents__link toc-highlight">ğŸ”‘ éšå–»è§£æï¼šä¸‰ä¸ªæŠ•å½±å±‚çš„ä½œç”¨</a></li><li><a href="#-ç»´åº¦è®¡ç®—ä¸ºä»€ä¹ˆæ˜¯-83-å€" class="table-of-contents__link toc-highlight">ğŸ“ ç»´åº¦è®¡ç®—ï¼šä¸ºä»€ä¹ˆæ˜¯ <code>8/3</code> å€ï¼Ÿ</a></li><li><a href="#-æ¿€æ´»å‡½æ•°ä¸ºä»€ä¹ˆç”¨-silu-swish-è€Œä¸æ˜¯-relu" class="table-of-contents__link toc-highlight">ğŸ”¥ æ¿€æ´»å‡½æ•°ï¼šä¸ºä»€ä¹ˆç”¨ SiLU (Swish) è€Œä¸æ˜¯ ReLUï¼Ÿ</a></li><li><a href="#-å®Œæ•´å‰å‘ä¼ æ’­è¿‡ç¨‹" class="table-of-contents__link toc-highlight">ğŸ’¡ å®Œæ•´å‰å‘ä¼ æ’­è¿‡ç¨‹</a></li><li><a href="#-ä¸-attention-çš„åˆ†å·¥" class="table-of-contents__link toc-highlight">ğŸ“Š ä¸ Attention çš„åˆ†å·¥</a></li><li><a href="#-åœ¨-transformer-block-ä¸­çš„ä½ç½®" class="table-of-contents__link toc-highlight">ğŸ”— åœ¨ Transformer Block ä¸­çš„ä½ç½®</a></li><li><a href="#-å‚æ•°é‡è®¡ç®—" class="table-of-contents__link toc-highlight">âš¡ å‚æ•°é‡è®¡ç®—</a></li><li><a href="#-å®é™…åº”ç”¨å»ºè®®" class="table-of-contents__link toc-highlight">ğŸ’¼ å®é™…åº”ç”¨å»ºè®®</a></li><li><a href="#-ç±»æ¯”æ€»ç»“-2" class="table-of-contents__link toc-highlight">ğŸ“ ç±»æ¯”æ€»ç»“</a></li></ul></li><li><a href="#å…­å°æ˜çš„éŸ³é‡å¹³è¡¡å™¨rmsnorm-å‡æ–¹æ ¹å½’ä¸€åŒ–" class="table-of-contents__link toc-highlight">å…­ã€å°æ˜çš„&quot;éŸ³é‡å¹³è¡¡å™¨&quot;ï¼šRMSNorm å‡æ–¹æ ¹å½’ä¸€åŒ–</a><ul><li><a href="#-ä»£ç ç‰‡æ®µ-ç¬¬-552-605-è¡Œ" class="table-of-contents__link toc-highlight">ğŸ“ ä»£ç ç‰‡æ®µ (ç¬¬ 552-605 è¡Œ)</a></li><li><a href="#-éšå–»ç¿»è¯‘æ•™å®¤é‡Œçš„éŸ³é‡å¹³è¡¡å™¨" class="table-of-contents__link toc-highlight">ğŸ¯ éšå–»ç¿»è¯‘ï¼šæ•™å®¤é‡Œçš„&quot;éŸ³é‡å¹³è¡¡å™¨&quot;</a></li><li><a href="#-æ•°å­¦åŸç†rmsnorm-vs-layernorm" class="table-of-contents__link toc-highlight">ğŸ§® æ•°å­¦åŸç†ï¼šRMSNorm vs LayerNorm</a></li><li><a href="#-ä»£ç é€è¡Œè§£æ" class="table-of-contents__link toc-highlight">ğŸ”¢ ä»£ç é€è¡Œè§£æ</a></li><li><a href="#-rmsnorm-vs-layernorm-å¯¹æ¯”" class="table-of-contents__link toc-highlight">ğŸ“Š RMSNorm vs LayerNorm å¯¹æ¯”</a></li><li><a href="#-åœ¨-transformer-ä¸­çš„ä½ç½®" class="table-of-contents__link toc-highlight">ğŸ“ åœ¨ Transformer ä¸­çš„ä½ç½®</a></li><li><a href="#-epsilon-eps-çš„ä½œç”¨" class="table-of-contents__link toc-highlight">ğŸ’¡ epsilon (eps) çš„ä½œç”¨</a></li><li><a href="#-æ•°å€¼ç¨³å®šæ€§ä¸ºä»€ä¹ˆ-fp32-å¾ˆé‡è¦" class="table-of-contents__link toc-highlight">ğŸ”¬ æ•°å€¼ç¨³å®šæ€§ï¼šä¸ºä»€ä¹ˆ FP32 å¾ˆé‡è¦ï¼Ÿ</a></li><li><a href="#-å‚æ•°é‡è®¡ç®—-1" class="table-of-contents__link toc-highlight">ğŸ“ å‚æ•°é‡è®¡ç®—</a></li><li><a href="#-ç±»æ¯”æ€»ç»“-3" class="table-of-contents__link toc-highlight">ğŸ¯ ç±»æ¯”æ€»ç»“</a></li><li><a href="#-ç›¸å…³ä»£ç ä½ç½®" class="table-of-contents__link toc-highlight">ğŸ”— ç›¸å…³ä»£ç ä½ç½®</a></li></ul></li><li><a href="#ä¸ƒå°æ˜çš„ç¤¾äº¤èƒ½åŠ›æ³¨æ„åŠ›æœºåˆ¶-attention" class="table-of-contents__link toc-highlight">ä¸ƒã€å°æ˜çš„&quot;ç¤¾äº¤èƒ½åŠ›&quot;ï¼šæ³¨æ„åŠ›æœºåˆ¶ (Attention)</a><ul><li><a href="#-ä»£ç ç‰‡æ®µ-ç¬¬-392-549-è¡Œ" class="table-of-contents__link toc-highlight">ğŸ“ ä»£ç ç‰‡æ®µ (ç¬¬ 392-549 è¡Œ)</a></li><li><a href="#-éšå–»ç¿»è¯‘å°æ˜å‚åŠ åœ†æ¡Œè®¨è®ºä¼š" class="table-of-contents__link toc-highlight">ğŸ¯ éšå–»ç¿»è¯‘ï¼šå°æ˜å‚åŠ &quot;åœ†æ¡Œè®¨è®ºä¼š&quot;</a></li><li><a href="#-æ ¸å¿ƒæ¦‚å¿µquerykeyvalue-qkv" class="table-of-contents__link toc-highlight">ğŸ”‘ æ ¸å¿ƒæ¦‚å¿µï¼šQueryã€Keyã€Value (QKV)</a></li><li><a href="#-å¤šå¤´æ³¨æ„åŠ›-multi-head-attention" class="table-of-contents__link toc-highlight">ğŸ§  å¤šå¤´æ³¨æ„åŠ› (Multi-Head Attention)</a></li><li><a href="#-æ—‹è½¬ä½ç½®ç¼–ç -rope" class="table-of-contents__link toc-highlight">ğŸ”„ æ—‹è½¬ä½ç½®ç¼–ç  (RoPE)</a></li><li><a href="#-kv-cacheæ¨ç†åŠ é€Ÿçš„ç§˜å¯†æ­¦å™¨" class="table-of-contents__link toc-highlight">ğŸ“¦ KV Cacheï¼šæ¨ç†åŠ é€Ÿçš„ç§˜å¯†æ­¦å™¨</a></li><li><a href="#-åˆ†ç»„æŸ¥è¯¢æ³¨æ„åŠ›-gqa" class="table-of-contents__link toc-highlight">ğŸ­ åˆ†ç»„æŸ¥è¯¢æ³¨æ„åŠ› (GQA)</a></li><li><a href="#-flash-attentioné—ªç”µèˆ¬çš„è®¡ç®—é€Ÿåº¦" class="table-of-contents__link toc-highlight">âš¡ Flash Attentionï¼šé—ªç”µèˆ¬çš„è®¡ç®—é€Ÿåº¦</a></li><li><a href="#-å› æœæ©ç -causal-mask" class="table-of-contents__link toc-highlight">ğŸ­ å› æœæ©ç  (Causal Mask)</a></li><li><a href="#-å®Œæ•´çš„-attention-æµç¨‹å›¾" class="table-of-contents__link toc-highlight">ğŸ“Š å®Œæ•´çš„ Attention æµç¨‹å›¾</a></li><li><a href="#-å‚æ•°é‡è®¡ç®—-2" class="table-of-contents__link toc-highlight">âš¡ å‚æ•°é‡è®¡ç®—</a></li><li><a href="#-å®é™…åº”ç”¨åœºæ™¯" class="table-of-contents__link toc-highlight">ğŸ’¼ å®é™…åº”ç”¨åœºæ™¯</a></li><li><a href="#-ç±»æ¯”æ€»ç»“-4" class="table-of-contents__link toc-highlight">ğŸ“ ç±»æ¯”æ€»ç»“</a></li><li><a href="#-ç›¸å…³ä»£ç ä½ç½®æ±‡æ€»" class="table-of-contents__link toc-highlight">ğŸ”— ç›¸å…³ä»£ç ä½ç½®æ±‡æ€»</a></li></ul></li></ul></div></div></div></div></main></div></div></div></div>
</body>
</html>