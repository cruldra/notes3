<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-AI/vllm/PagedAttention技术详解" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">PagedAttention 技术详解 | Cruldra</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://your-docusaurus-site.example.com/notes3/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://your-docusaurus-site.example.com/notes3/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://your-docusaurus-site.example.com/notes3/docs/AI/vllm/PagedAttention技术详解"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="PagedAttention 技术详解 | Cruldra"><meta data-rh="true" name="description" content="概述"><meta data-rh="true" property="og:description" content="概述"><link data-rh="true" rel="icon" href="/notes3/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://your-docusaurus-site.example.com/notes3/docs/AI/vllm/PagedAttention技术详解"><link data-rh="true" rel="alternate" href="https://your-docusaurus-site.example.com/notes3/docs/AI/vllm/PagedAttention技术详解" hreflang="en"><link data-rh="true" rel="alternate" href="https://your-docusaurus-site.example.com/notes3/docs/AI/vllm/PagedAttention技术详解" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"vLLM 学习资料","item":"https://your-docusaurus-site.example.com/notes3/docs/AI/vllm/"},{"@type":"ListItem","position":2,"name":"PagedAttention 技术详解","item":"https://your-docusaurus-site.example.com/notes3/docs/AI/vllm/PagedAttention技术详解"}]}</script><link rel="alternate" type="application/rss+xml" href="/notes3/blog/rss.xml" title="Cruldra RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/notes3/blog/atom.xml" title="Cruldra Atom Feed"><link rel="stylesheet" href="/notes3/assets/css/styles.f3dc2d00.css">
<script src="/notes3/assets/js/runtime~main.ca6d8e20.js" defer="defer"></script>
<script src="/notes3/assets/js/main.93d55afe.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>document.documentElement.setAttribute("data-theme",window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),document.documentElement.setAttribute("data-theme-choice","system"),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/notes3/img/logo.svg"><style data-mantine-styles="classes">@media (max-width: 35.99375em) {.mantine-visible-from-xs {display: none !important;}}@media (min-width: 36em) {.mantine-hidden-from-xs {display: none !important;}}@media (max-width: 47.99375em) {.mantine-visible-from-sm {display: none !important;}}@media (min-width: 48em) {.mantine-hidden-from-sm {display: none !important;}}@media (max-width: 61.99375em) {.mantine-visible-from-md {display: none !important;}}@media (min-width: 62em) {.mantine-hidden-from-md {display: none !important;}}@media (max-width: 74.99375em) {.mantine-visible-from-lg {display: none !important;}}@media (min-width: 75em) {.mantine-hidden-from-lg {display: none !important;}}@media (max-width: 87.99375em) {.mantine-visible-from-xl {display: none !important;}}@media (min-width: 88em) {.mantine-hidden-from-xl {display: none !important;}}</style><div role="region" aria-label="Skip to main content"><a class="skipToContent_kJiJ" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/notes3/"><div class="navbar__logo"><img src="/notes3/img/logo.svg" alt="My Site Logo" class="themedComponent_NrnZ themedComponent--light_kIco"><img src="/notes3/img/logo.svg" alt="My Site Logo" class="themedComponent_NrnZ themedComponent--dark_HCTy"></div><b class="navbar__title text--truncate">Cruldra</b></a><a class="navbar__item navbar__link" href="/notes3/docs/category/设计模式">JVM</a><a class="navbar__item navbar__link" href="/notes3/docs/category/css">前端</a><a class="navbar__item navbar__link" href="/notes3/docs/category/astrbot">工具</a><a class="navbar__item navbar__link" href="/notes3/docs/category/ai电竞酒店">个人</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/notes3/docs/AI/Agno/介绍">AI</a><a class="navbar__item navbar__link" href="/notes3/docs/category/内置模块">Python</a><a class="navbar__item navbar__link" href="/notes3/docs/category/actix-web">Rust</a><a class="navbar__item navbar__link" href="/notes3/docs/category/数据库系统">软件工程</a><a class="navbar__item navbar__link" href="/notes3/docs/category/上古卷轴5">游戏</a><a class="navbar__item navbar__link" href="/notes3/docs/Go/Go-Python-Java三语言全方位对比">Go</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><div class="navbarSearchContainer_V3q0"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_YMCn"><div class="docsWrapper_UDzO"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_OA9t" type="button"></button><div class="docRoot_zblS"><aside class="theme-doc-sidebar-container docSidebarContainer_utvl"><div class="sidebarViewport_uicj"><div class="sidebar_wSJP"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_xz03"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_OIbK menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/notes3/docs/AI/Agno/介绍"><span title="Agno" class="categoryLinkLabel_5XjO">Agno</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_OIbK menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/notes3/docs/AI/CrewAI/CLI"><span title="CrewAI" class="categoryLinkLabel_5XjO">CrewAI</span></a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/notes3/docs/AI/DALLE成本计算"><span title="DALL-E 画图成本计算" class="linkLabel_VeW_">DALL-E 画图成本计算</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_OIbK menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/notes3/docs/AI/MCP/MCP-Python-SDK"><span title="MCP" class="categoryLinkLabel_5XjO">MCP</span></a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/notes3/docs/AI/Transformer"><span title="Transformer" class="linkLabel_VeW_">Transformer</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_OIbK menu__link menu__link--sublist menu__link--active" href="/notes3/docs/AI/vllm/"><span title="vLLM 学习资料" class="categoryLinkLabel_5XjO">vLLM 学习资料</span></a><button aria-label="Collapse sidebar category &#x27;vLLM 学习资料&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/notes3/docs/AI/vllm/PagedAttention技术详解"><span title="PagedAttention 技术详解" class="linkLabel_VeW_">PagedAttention 技术详解</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes3/docs/AI/vllm/vLLM完整指南"><span title="vLLM 完整指南" class="linkLabel_VeW_">vLLM 完整指南</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes3/docs/AI/vllm/vLLM实战部署指南"><span title="vLLM 实战部署指南" class="linkLabel_VeW_">vLLM 实战部署指南</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes3/docs/AI/vllm/vLLM性能调优指南"><span title="vLLM 性能调优指南" class="linkLabel_VeW_">vLLM 性能调优指南</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes3/docs/AI/vllm/vllm-fast-inference-and-cuda-graph"><span title="vLLM 快速推理与 CUDA Graph 详解" class="linkLabel_VeW_">vLLM 快速推理与 CUDA Graph 详解</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/notes3/docs/AI/vllm/安装常见错误及解决方案"><span title="安装常见错误及解决方案" class="linkLabel_VeW_">安装常见错误及解决方案</span></a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/notes3/docs/AI/一些概念1"><span title="一些概念1" class="linkLabel_VeW_">一些概念1</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/notes3/docs/AI/一些概念2"><span title="一些概念2" class="linkLabel_VeW_">一些概念2</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/notes3/docs/AI/一些概念3"><span title="一些概念3" class="linkLabel_VeW_">一些概念3</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/notes3/docs/AI/一些概念4"><span title="一些概念4" class="linkLabel_VeW_">一些概念4</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/notes3/docs/AI/一些概念5"><span title="一些概念5" class="linkLabel_VeW_">一些概念5</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/notes3/docs/AI/候选模型"><span title="候选模型" class="linkLabel_VeW_">候选模型</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/notes3/docs/AI/变分自编码器详解"><span title="变分自编码器（VAE）详解" class="linkLabel_VeW_">变分自编码器（VAE）详解</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/notes3/docs/AI/大模型核心概念通俗解释"><span title="大模型核心概念通俗解释" class="linkLabel_VeW_">大模型核心概念通俗解释</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/notes3/docs/AI/大模型训练中的随机种子：为什么需要它？"><span title="大模型训练中的随机种子：为什么需要它？" class="linkLabel_VeW_">大模型训练中的随机种子：为什么需要它？</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_OIbK menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/notes3/docs/AI/嵌入和向量/Chroma与PGVector对比"><span title="嵌入和向量" class="categoryLinkLabel_5XjO">嵌入和向量</span></a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/notes3/docs/AI/感知机"><span title="感知机" class="linkLabel_VeW_">感知机</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/notes3/docs/AI/智能体"><span title="智能体(Agent)" class="linkLabel_VeW_">智能体(Agent)</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_OIbK menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/notes3/docs/AI/深度学习/入门"><span title="深度学习" class="categoryLinkLabel_5XjO">深度学习</span></a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/notes3/docs/AI/理解大模型：从函数视角看AI的本质"><span title="理解大模型：从函数视角看AI的本质" class="linkLabel_VeW_">理解大模型：从函数视角看AI的本质</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/notes3/docs/AI/知识蒸馏"><span title="知识蒸馏" class="linkLabel_VeW_">知识蒸馏</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/notes3/docs/AI/联邦学习概念"><span title="联邦学习概念" class="linkLabel_VeW_">联邦学习概念</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_OIbK menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/notes3/docs/AI/通义千问/阿里云百炼"><span title="通义千问" class="categoryLinkLabel_5XjO">通义千问</span></a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/notes3/docs/AI/金丝雀发布和AB测试"><span title="金丝雀发布和AB测试" class="linkLabel_VeW_">金丝雀发布和AB测试</span></a></li></ul></nav></div></div></aside><main class="docMainContainer_e2u6"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_y0g3"><div class="docItemContainer_PZbB"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_I1XV" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/notes3/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_ZIEp"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><a class="breadcrumbs__link" href="/notes3/docs/AI/vllm/"><span>vLLM 学习资料</span></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">PagedAttention 技术详解</span></li></ul></nav><div class="tocCollapsible_UUJj theme-doc-toc-mobile tocMobile_b9MH"><button type="button" class="clean-btn tocCollapsibleButton_zQap">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>PagedAttention 技术详解</h1></header>
<h2 class="anchor anchorTargetStickyNavbar_FzkC" id="概述">概述<a href="#概述" class="hash-link" aria-label="Direct link to 概述" title="Direct link to 概述" translate="no">​</a></h2>
<p>PagedAttention 是 vLLM 的核心技术创新，它借鉴了操作系统虚拟内存分页管理的思想，解决了大语言模型推理过程中 KV Cache 的内存管理难题。</p>
<h2 class="anchor anchorTargetStickyNavbar_FzkC" id="背景kv-cache-的挑战">背景：KV Cache 的挑战<a href="#背景kv-cache-的挑战" class="hash-link" aria-label="Direct link to 背景：KV Cache 的挑战" title="Direct link to 背景：KV Cache 的挑战" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_FzkC" id="什么是-kv-cache">什么是 KV Cache？<a href="#什么是-kv-cache" class="hash-link" aria-label="Direct link to 什么是 KV Cache？" title="Direct link to 什么是 KV Cache？" translate="no">​</a></h3>
<p>在 Transformer 模型的自注意力机制中，每个 token 都需要与之前所有 token 进行注意力计算。为了避免重复计算，模型会缓存每个 token 的 Key 和 Value 向量，这就是 KV Cache。</p>
<h3 class="anchor anchorTargetStickyNavbar_FzkC" id="传统-kv-cache-的三大问题">传统 KV Cache 的三大问题<a href="#传统-kv-cache-的三大问题" class="hash-link" aria-label="Direct link to 传统 KV Cache 的三大问题" title="Direct link to 传统 KV Cache 的三大问题" translate="no">​</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_FzkC" id="1-显存占用增长快">1. 显存占用增长快<a href="#1-显存占用增长快" class="hash-link" aria-label="Direct link to 1. 显存占用增长快" title="Direct link to 1. 显存占用增长快" translate="no">​</a></h4>
<ul>
<li class=""><strong>问题描述</strong>：随着生成序列长度增加，KV Cache 占用的显存呈线性增长</li>
<li class=""><strong>影响</strong>：对于长文本生成任务，KV Cache 可能占用模型参数数倍的显存</li>
<li class=""><strong>示例</strong>：一个 13B 参数的模型，生成 2048 个 token 时，KV Cache 可能占用 20GB+ 显存</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_FzkC" id="2-内存碎片严重">2. 内存碎片严重<a href="#2-内存碎片严重" class="hash-link" aria-label="Direct link to 2. 内存碎片严重" title="Direct link to 2. 内存碎片严重" translate="no">​</a></h4>
<ul>
<li class=""><strong>问题描述</strong>：不同请求的序列长度不同，导致内存分配不均，产生大量碎片</li>
<li class=""><strong>影响</strong>：即使总显存充足，也可能因为碎片化而无法分配新的内存块</li>
<li class=""><strong>示例</strong>：100 个请求，长度从 100 到 2000 不等，传统方法需要为每个请求预分配最大长度的内存</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_FzkC" id="3-缓存难以复用">3. 缓存难以复用<a href="#3-缓存难以复用" class="hash-link" aria-label="Direct link to 3. 缓存难以复用" title="Direct link to 3. 缓存难以复用" translate="no">​</a></h4>
<ul>
<li class=""><strong>问题描述</strong>：不同请求即使有相同的前缀（如系统提示词），也无法共享 KV Cache</li>
<li class=""><strong>影响</strong>：浪费大量显存存储重复的计算结果</li>
<li class=""><strong>示例</strong>：1000 个请求都使用相同的 500 token 系统提示词，传统方法需要存储 1000 份相同的 KV Cache</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_FzkC" id="pagedattention-的解决方案">PagedAttention 的解决方案<a href="#pagedattention-的解决方案" class="hash-link" aria-label="Direct link to PagedAttention 的解决方案" title="Direct link to PagedAttention 的解决方案" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_FzkC" id="核心思想">核心思想<a href="#核心思想" class="hash-link" aria-label="Direct link to 核心思想" title="Direct link to 核心思想" translate="no">​</a></h3>
<p>PagedAttention 将 KV Cache 分割成固定大小的&quot;页&quot;（pages），类似操作系统的虚拟内存分页：</p>
<div class="language-text codeBlockContainer_iV14 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_jh8H"><pre tabindex="0" class="prism-code language-text codeBlock_E9uv thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Kv4h"><span class="token-line" style="color:#393A34"><span class="token plain">传统方法：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Request 1: [████████████████████████] (连续内存，2000 tokens)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Request 2: [████████] (连续内存，800 tokens)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Request 3: [████████████] (连续内存，1200 tokens)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">问题：需要预分配最大长度，产生碎片</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PagedAttention：</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Request 1: [Page1][Page2][Page3][Page4]... (按需分配)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Request 2: [Page1][Page2]... (按需分配)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Request 3: [Page1][Page2][Page3]... (按需分配)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">优势：按需分配，减少碎片，可共享页</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_FzkC" id="关键机制">关键机制<a href="#关键机制" class="hash-link" aria-label="Direct link to 关键机制" title="Direct link to 关键机制" translate="no">​</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_FzkC" id="1-分页管理">1. 分页管理<a href="#1-分页管理" class="hash-link" aria-label="Direct link to 1. 分页管理" title="Direct link to 1. 分页管理" translate="no">​</a></h4>
<ul>
<li class=""><strong>页大小</strong>：固定大小（如 16 或 32 个 token）</li>
<li class=""><strong>页表</strong>：维护逻辑地址到物理地址的映射</li>
<li class=""><strong>按需分配</strong>：只在需要时分配新页，避免预先分配大块连续内存</li>
</ul>
<div class="language-python codeBlockContainer_iV14 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_jh8H"><pre tabindex="0" class="prism-code language-python codeBlock_E9uv thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Kv4h"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># 伪代码示例</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">PagedKVCache</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__init__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> page_size</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">page_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> page_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">physical_pages </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 物理页池</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">page_tables </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic"># 每个请求的页表</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">allocate_page</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> request_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;为请求分配新页&quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">free_pages</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">physical_pages</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">create_new_page</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        page </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">free_pages</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">page_tables</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">request_id</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">page</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> page</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_FzkC" id="2-内存共享">2. 内存共享<a href="#2-内存共享" class="hash-link" aria-label="Direct link to 2. 内存共享" title="Direct link to 2. 内存共享" translate="no">​</a></h4>
<p>不同请求可以共享相同的 KV Cache 页，特别适合以下场景：</p>
<ul>
<li class=""><strong>系统提示词共享</strong>：多个请求使用相同的系统提示词</li>
<li class=""><strong>前缀共享</strong>：多个请求有相同的前缀</li>
<li class=""><strong>并行采样</strong>：同一个请求生成多个候选序列</li>
</ul>
<div class="language-text codeBlockContainer_iV14 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_jh8H"><pre tabindex="0" class="prism-code language-text codeBlock_E9uv thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Kv4h"><span class="token-line" style="color:#393A34"><span class="token plain">示例：3 个请求共享系统提示词</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Request 1: [Shared Page 1][Shared Page 2][Private Page 1][Private Page 2]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Request 2: [Shared Page 1][Shared Page 2][Private Page 3]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Request 3: [Shared Page 1][Shared Page 2][Private Page 4][Private Page 5]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">共享页只存储一次，节省显存</span><br></span></code></pre></div></div>
<h4 class="anchor anchorTargetStickyNavbar_FzkC" id="3-写时复制copy-on-write">3. 写时复制（Copy-on-Write）<a href="#3-写时复制copy-on-write" class="hash-link" aria-label="Direct link to 3. 写时复制（Copy-on-Write）" title="Direct link to 3. 写时复制（Copy-on-Write）" translate="no">​</a></h4>
<p>当需要修改共享页时，采用写时复制机制：</p>
<ol>
<li class="">检测到写操作</li>
<li class="">复制共享页到新的物理页</li>
<li class="">更新页表指向新页</li>
<li class="">在新页上执行写操作</li>
</ol>
<div class="language-python codeBlockContainer_iV14 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_jh8H"><pre tabindex="0" class="prism-code language-python codeBlock_E9uv thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Kv4h"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">write_to_page</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">request_id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> page_index</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;写入页，如果是共享页则先复制&quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    page </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">page_tables</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">request_id</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">page_index</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> page</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">is_shared</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># 写时复制</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new_page </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> page</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">copy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">page_tables</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">request_id</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">page_index</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> new_page</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        page </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> new_page</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    page</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">write</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_FzkC" id="技术优势">技术优势<a href="#技术优势" class="hash-link" aria-label="Direct link to 技术优势" title="Direct link to 技术优势" translate="no">​</a></h3>
<h4 class="anchor anchorTargetStickyNavbar_FzkC" id="1-显存利用率提升">1. 显存利用率提升<a href="#1-显存利用率提升" class="hash-link" aria-label="Direct link to 1. 显存利用率提升" title="Direct link to 1. 显存利用率提升" translate="no">​</a></h4>
<ul>
<li class=""><strong>按需分配</strong>：只分配实际需要的内存，避免预分配浪费</li>
<li class=""><strong>减少碎片</strong>：固定大小的页减少内存碎片</li>
<li class=""><strong>提升利用率</strong>：显存利用率从 20-40% 提升到 80-90%</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_FzkC" id="2-吞吐量提升">2. 吞吐量提升<a href="#2-吞吐量提升" class="hash-link" aria-label="Direct link to 2. 吞吐量提升" title="Direct link to 2. 吞吐量提升" translate="no">​</a></h4>
<ul>
<li class=""><strong>更多并发</strong>：相同显存下可以处理更多并发请求</li>
<li class=""><strong>批处理优化</strong>：更高效的批处理，提升吞吐量</li>
<li class=""><strong>性能提升</strong>：相比传统方法，吞吐量提升 2-24 倍</li>
</ul>
<h4 class="anchor anchorTargetStickyNavbar_FzkC" id="3-灵活性增强">3. 灵活性增强<a href="#3-灵活性增强" class="hash-link" aria-label="Direct link to 3. 灵活性增强" title="Direct link to 3. 灵活性增强" translate="no">​</a></h4>
<ul>
<li class=""><strong>动态长度</strong>：支持动态序列长度，无需预先指定最大长度</li>
<li class=""><strong>内存共享</strong>：自动检测和共享相同的前缀</li>
<li class=""><strong>资源调度</strong>：更灵活的资源调度和负载均衡</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_FzkC" id="实现细节">实现细节<a href="#实现细节" class="hash-link" aria-label="Direct link to 实现细节" title="Direct link to 实现细节" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_FzkC" id="页表结构">页表结构<a href="#页表结构" class="hash-link" aria-label="Direct link to 页表结构" title="Direct link to 页表结构" translate="no">​</a></h3>
<div class="language-python codeBlockContainer_iV14 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_jh8H"><pre tabindex="0" class="prism-code language-python codeBlock_E9uv thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Kv4h"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">PageTable</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;页表：逻辑地址到物理地址的映射&quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__init__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">logical_to_physical </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 逻辑页号 -&gt; 物理页号</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">get_physical_page</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> logical_page_num</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;获取物理页号&quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">logical_to_physical</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">logical_page_num</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">add_page</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> physical_page_num</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;添加新页&quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">logical_to_physical</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">physical_page_num</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_FzkC" id="物理页池">物理页池<a href="#物理页池" class="hash-link" aria-label="Direct link to 物理页池" title="Direct link to 物理页池" translate="no">​</a></h3>
<div class="language-python codeBlockContainer_iV14 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_jh8H"><pre tabindex="0" class="prism-code language-python codeBlock_E9uv thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Kv4h"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">PhysicalPagePool</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;物理页池：管理所有物理页&quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">__init__</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> num_pages</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> page_size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">num_pages </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> num_pages</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">page_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> page_size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pages </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Page</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">page_size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> _ </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">num_pages</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">free_pages </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token builtin">set</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">num_pages</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">allocate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;分配一个空闲页&quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">free_pages</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">raise</span><span class="token plain"> OutOfMemoryError</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;No free pages available&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        page_num </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">free_pages</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pop</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> page_num</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">free</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> page_num</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;释放一个页&quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">free_pages</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">page_num</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_FzkC" id="注意力计算">注意力计算<a href="#注意力计算" class="hash-link" aria-label="Direct link to 注意力计算" title="Direct link to 注意力计算" translate="no">​</a></h3>
<p>PagedAttention 需要修改注意力计算，以支持分页的 KV Cache：</p>
<div class="language-python codeBlockContainer_iV14 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_jh8H"><pre tabindex="0" class="prism-code language-python codeBlock_E9uv thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_Kv4h"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">paged_attention</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">query</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> page_table</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> physical_pages</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    分页注意力计算</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Args:</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        query: 查询向量 [batch_size, num_heads, head_dim]</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        page_table: 页表，映射逻辑页到物理页</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        physical_pages: 物理页池</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    Returns:</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        attention_output: 注意力输出</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    attention_scores </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 遍历所有逻辑页</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> logical_page_num </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> </span><span class="token builtin">range</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">len</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">page_table</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># 获取物理页</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        physical_page_num </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> page_table</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_physical_page</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">logical_page_num</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        page </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> physical_pages</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">physical_page_num</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># 获取该页的 K, V</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        keys </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> page</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_keys</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        values </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> page</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get_values</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># 计算注意力分数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        scores </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">matmul</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">query</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> keys</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">transpose</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        attention_scores</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">scores</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 合并所有页的注意力分数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    all_scores </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cat</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">attention_scores</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dim</span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    attention_weights </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">softmax</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">all_scores</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dim</span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 计算加权和</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># ... (省略详细实现)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> attention_output</span><br></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_FzkC" id="性能对比">性能对比<a href="#性能对比" class="hash-link" aria-label="Direct link to 性能对比" title="Direct link to 性能对比" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_FzkC" id="吞吐量对比">吞吐量对比<a href="#吞吐量对比" class="hash-link" aria-label="Direct link to 吞吐量对比" title="Direct link to 吞吐量对比" translate="no">​</a></h3>
<table><thead><tr><th>框架</th><th>吞吐量 (requests/s)</th><th>相对提升</th></tr></thead><tbody><tr><td>HuggingFace Transformers</td><td>1.0x</td><td>基准</td></tr><tr><td>vLLM (PagedAttention)</td><td>2-24x</td><td>2-24 倍</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_FzkC" id="显存利用率对比">显存利用率对比<a href="#显存利用率对比" class="hash-link" aria-label="Direct link to 显存利用率对比" title="Direct link to 显存利用率对比" translate="no">​</a></h3>
<table><thead><tr><th>框架</th><th>显存利用率</th><th>可支持并发数</th></tr></thead><tbody><tr><td>传统方法</td><td>20-40%</td><td>10-20</td></tr><tr><td>PagedAttention</td><td>80-90%</td><td>50-100</td></tr></tbody></table>
<h3 class="anchor anchorTargetStickyNavbar_FzkC" id="延迟对比">延迟对比<a href="#延迟对比" class="hash-link" aria-label="Direct link to 延迟对比" title="Direct link to 延迟对比" translate="no">​</a></h3>
<table><thead><tr><th>场景</th><th>传统方法</th><th>PagedAttention</th><th>改善</th></tr></thead><tbody><tr><td>短文本 (100 tokens)</td><td>50ms</td><td>45ms</td><td>10%</td></tr><tr><td>中文本 (500 tokens)</td><td>200ms</td><td>150ms</td><td>25%</td></tr><tr><td>长文本 (2000 tokens)</td><td>800ms</td><td>500ms</td><td>37.5%</td></tr></tbody></table>
<h2 class="anchor anchorTargetStickyNavbar_FzkC" id="适用场景">适用场景<a href="#适用场景" class="hash-link" aria-label="Direct link to 适用场景" title="Direct link to 适用场景" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_FzkC" id="最适合的场景">最适合的场景<a href="#最适合的场景" class="hash-link" aria-label="Direct link to 最适合的场景" title="Direct link to 最适合的场景" translate="no">​</a></h3>
<ol>
<li class=""><strong>高并发服务</strong>：需要同时处理大量请求</li>
<li class=""><strong>长文本生成</strong>：生成长度不确定或较长的文本</li>
<li class=""><strong>批量推理</strong>：批量处理多个请求</li>
<li class=""><strong>共享前缀</strong>：多个请求有相同的系统提示词或前缀</li>
<li class=""><strong>并行采样</strong>：需要为同一个请求生成多个候选序列</li>
</ol>
<h3 class="anchor anchorTargetStickyNavbar_FzkC" id="不太适合的场景">不太适合的场景<a href="#不太适合的场景" class="hash-link" aria-label="Direct link to 不太适合的场景" title="Direct link to 不太适合的场景" translate="no">​</a></h3>
<ol>
<li class=""><strong>单请求低延迟</strong>：单个请求的绝对延迟可能略高于优化的单请求推理</li>
<li class=""><strong>极短文本</strong>：对于极短文本（少于50 tokens），分页开销可能不划算</li>
<li class=""><strong>显存充足</strong>：如果显存非常充足，传统方法也能工作良好</li>
</ol>
<h2 class="anchor anchorTargetStickyNavbar_FzkC" id="与操作系统分页的类比">与操作系统分页的类比<a href="#与操作系统分页的类比" class="hash-link" aria-label="Direct link to 与操作系统分页的类比" title="Direct link to 与操作系统分页的类比" translate="no">​</a></h2>
<table><thead><tr><th>操作系统分页</th><th>PagedAttention</th><th>说明</th></tr></thead><tbody><tr><td>虚拟地址空间</td><td>逻辑 KV Cache 地址</td><td>程序/请求看到的地址</td></tr><tr><td>物理内存</td><td>GPU 显存</td><td>实际存储位置</td></tr><tr><td>页表</td><td>KV Cache 页表</td><td>地址映射关系</td></tr><tr><td>页</td><td>KV Cache 页</td><td>固定大小的内存块</td></tr><tr><td>按需分页</td><td>按需分配 KV Cache</td><td>只在需要时分配</td></tr><tr><td>页面共享</td><td>KV Cache 共享</td><td>多个进程/请求共享相同页</td></tr><tr><td>写时复制</td><td>写时复制</td><td>修改共享页时先复制</td></tr></tbody></table>
<h2 class="anchor anchorTargetStickyNavbar_FzkC" id="总结">总结<a href="#总结" class="hash-link" aria-label="Direct link to 总结" title="Direct link to 总结" translate="no">​</a></h2>
<p>PagedAttention 是 vLLM 的核心创新，通过借鉴操作系统的虚拟内存分页思想，解决了大语言模型推理中的内存管理难题：</p>
<ul>
<li class="">✅ <strong>显著提升显存利用率</strong>：从 20-40% 提升到 80-90%</li>
<li class="">✅ <strong>大幅提升吞吐量</strong>：相比传统方法提升 2-24 倍</li>
<li class="">✅ <strong>支持更多并发</strong>：相同硬件下可处理更多请求</li>
<li class="">✅ <strong>减少内存碎片</strong>：固定大小的页减少碎片化</li>
<li class="">✅ <strong>实现内存共享</strong>：自动共享相同的前缀，节省显存</li>
</ul>
<p>PagedAttention 使得 vLLM 成为大语言模型推理的高性能引擎，特别适合企业级服务和高并发场景。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_RM2i"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/AI/vllm/PagedAttention技术详解.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_NBA7" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_Ng_4"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/notes3/docs/AI/vllm/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">vLLM 学习资料</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/notes3/docs/AI/vllm/vLLM完整指南"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">vLLM 完整指南</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_qSfz thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#概述" class="table-of-contents__link toc-highlight">概述</a></li><li><a href="#背景kv-cache-的挑战" class="table-of-contents__link toc-highlight">背景：KV Cache 的挑战</a><ul><li><a href="#什么是-kv-cache" class="table-of-contents__link toc-highlight">什么是 KV Cache？</a></li><li><a href="#传统-kv-cache-的三大问题" class="table-of-contents__link toc-highlight">传统 KV Cache 的三大问题</a></li></ul></li><li><a href="#pagedattention-的解决方案" class="table-of-contents__link toc-highlight">PagedAttention 的解决方案</a><ul><li><a href="#核心思想" class="table-of-contents__link toc-highlight">核心思想</a></li><li><a href="#关键机制" class="table-of-contents__link toc-highlight">关键机制</a></li><li><a href="#技术优势" class="table-of-contents__link toc-highlight">技术优势</a></li></ul></li><li><a href="#实现细节" class="table-of-contents__link toc-highlight">实现细节</a><ul><li><a href="#页表结构" class="table-of-contents__link toc-highlight">页表结构</a></li><li><a href="#物理页池" class="table-of-contents__link toc-highlight">物理页池</a></li><li><a href="#注意力计算" class="table-of-contents__link toc-highlight">注意力计算</a></li></ul></li><li><a href="#性能对比" class="table-of-contents__link toc-highlight">性能对比</a><ul><li><a href="#吞吐量对比" class="table-of-contents__link toc-highlight">吞吐量对比</a></li><li><a href="#显存利用率对比" class="table-of-contents__link toc-highlight">显存利用率对比</a></li><li><a href="#延迟对比" class="table-of-contents__link toc-highlight">延迟对比</a></li></ul></li><li><a href="#适用场景" class="table-of-contents__link toc-highlight">适用场景</a><ul><li><a href="#最适合的场景" class="table-of-contents__link toc-highlight">最适合的场景</a></li><li><a href="#不太适合的场景" class="table-of-contents__link toc-highlight">不太适合的场景</a></li></ul></li><li><a href="#与操作系统分页的类比" class="table-of-contents__link toc-highlight">与操作系统分页的类比</a></li><li><a href="#总结" class="table-of-contents__link toc-highlight">总结</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_EO6u"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_EO6u"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://x.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">X<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_EO6u"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/notes3/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_EO6u"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2026 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>