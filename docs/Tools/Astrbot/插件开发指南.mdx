---
sidebar_position: 3
---

AstrBot çš„æ’ä»¶ç³»ç»Ÿ(Starç³»ç»Ÿ)æ˜¯å…¶æ ¸å¿ƒç‰¹æ€§ä¹‹ä¸€ï¼Œå…è®¸å¼€å‘è€…è½»æ¾æ‰©å±•æœºå™¨äººåŠŸèƒ½ã€‚æ’ä»¶ç³»ç»Ÿå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

- **æç®€API**: åªéœ€å‡ è¡Œä»£ç å³å¯åˆ›å»ºåŠŸèƒ½æ’ä»¶
- **äº‹ä»¶é©±åŠ¨**: åŸºäºæ¶ˆæ¯äº‹ä»¶çš„å¤„ç†æœºåˆ¶
- **å¼‚æ­¥æ”¯æŒ**: åŸç”Ÿæ”¯æŒå¼‚æ­¥ç¼–ç¨‹
- **çƒ­åŠ è½½**: æ”¯æŒæ’ä»¶çš„åŠ¨æ€åŠ è½½å’Œå¸è½½
- **ä¸°å¯Œä¸Šä¸‹æ–‡**: æä¾›å®Œæ•´çš„æ¶ˆæ¯å’Œå¹³å°ä¿¡æ¯

## åŸºç¡€æ¦‚å¿µ

### Star(æ’ä»¶)
Staræ˜¯AstrBotä¸­æ’ä»¶çš„åŸºæœ¬å•ä½ï¼Œæ¯ä¸ªæ’ä»¶éƒ½ç»§æ‰¿è‡ª`Star`åŸºç±»ã€‚

### AstrMessageEvent
æ¶ˆæ¯äº‹ä»¶å¯¹è±¡ï¼ŒåŒ…å«äº†æ¶ˆæ¯çš„æ‰€æœ‰ä¿¡æ¯å’Œä¸Šä¸‹æ–‡ã€‚

### Context
ä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œæä¾›äº†ä¸AstrBotæ ¸å¿ƒåŠŸèƒ½äº¤äº’çš„æ¥å£ã€‚

## å¿«é€Ÿå¼€å§‹

### åˆ›å»ºç¬¬ä¸€ä¸ªæ’ä»¶

```python
# plugins/hello_world.py
from astrbot.api import Star, AstrMessageEvent

class HelloWorldStar(Star):
    def __init__(self):
        super().__init__()
        self.name = "Hello World"
        self.description = "ä¸€ä¸ªç®€å•çš„é—®å€™æ’ä»¶"
        self.author = "Your Name"
        self.version = "1.0.0"
    
    async def handle(self, event: AstrMessageEvent):
        """å¤„ç†æ¶ˆæ¯äº‹ä»¶"""
        if event.message.content == "hello":
            await event.reply("Hello, World! ğŸŒŸ")
            return True  # è¿”å›Trueè¡¨ç¤ºæ¶ˆæ¯å·²å¤„ç†
        return False  # è¿”å›Falseè¡¨ç¤ºæ¶ˆæ¯æœªå¤„ç†
```

### æ’ä»¶å…ƒæ•°æ®

```python
class MyPluginStar(Star):
    def __init__(self):
        super().__init__()
        # åŸºç¡€ä¿¡æ¯
        self.name = "æˆ‘çš„æ’ä»¶"
        self.description = "æ’ä»¶åŠŸèƒ½æè¿°"
        self.author = "ä½œè€…åç§°"
        self.version = "1.0.0"
        
        # å¯é€‰é…ç½®
        self.enabled = True  # æ˜¯å¦å¯ç”¨
        self.priority = 100  # ä¼˜å…ˆçº§(æ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜)
        self.commands = ["cmd1", "cmd2"]  # æ”¯æŒçš„å‘½ä»¤
        self.platforms = ["qq", "wechat"]  # æ”¯æŒçš„å¹³å°
```

## æ¶ˆæ¯å¤„ç†

### åŸºç¡€æ¶ˆæ¯å¤„ç†

```python
async def handle(self, event: AstrMessageEvent):
    """åŸºç¡€æ¶ˆæ¯å¤„ç†"""
    message = event.message.content
    
    # æ–‡æœ¬åŒ¹é…
    if message == "ping":
        await event.reply("pong!")
        return True
    
    # å‰ç¼€åŒ¹é…
    if message.startswith("/weather"):
        city = message[8:].strip()
        weather_info = await self.get_weather(city)
        await event.reply(f"{city}çš„å¤©æ°”: {weather_info}")
        return True
    
    # æ­£åˆ™åŒ¹é…
    import re
    pattern = r"^è®¡ç®—\s+(.+)$"
    match = re.match(pattern, message)
    if match:
        expression = match.group(1)
        result = eval(expression)  # æ³¨æ„ï¼šå®é™…ä½¿ç”¨ä¸­è¦åšå®‰å…¨æ£€æŸ¥
        await event.reply(f"è®¡ç®—ç»“æœ: {result}")
        return True
    
    return False
```

### æ¶ˆæ¯ç±»å‹å¤„ç†

```python
from astrbot.api import MessageType

async def handle(self, event: AstrMessageEvent):
    """å¤„ç†ä¸åŒç±»å‹çš„æ¶ˆæ¯"""
    
    # æ–‡æœ¬æ¶ˆæ¯
    if event.message.type == MessageType.TEXT:
        await self.handle_text(event)
    
    # å›¾ç‰‡æ¶ˆæ¯
    elif event.message.type == MessageType.IMAGE:
        await self.handle_image(event)
    
    # è¯­éŸ³æ¶ˆæ¯
    elif event.message.type == MessageType.VOICE:
        await self.handle_voice(event)
    
    # æ–‡ä»¶æ¶ˆæ¯
    elif event.message.type == MessageType.FILE:
        await self.handle_file(event)

async def handle_image(self, event: AstrMessageEvent):
    """å¤„ç†å›¾ç‰‡æ¶ˆæ¯"""
    image_url = event.message.content  # å›¾ç‰‡URL
    # ä¸‹è½½å¹¶å¤„ç†å›¾ç‰‡
    await event.reply("æ”¶åˆ°å›¾ç‰‡ï¼Œæ­£åœ¨å¤„ç†...")
```

### ç¾¤èŠå’Œç§èŠå¤„ç†

```python
async def handle(self, event: AstrMessageEvent):
    """åŒºåˆ†ç¾¤èŠå’Œç§èŠ"""
    
    # æ£€æŸ¥æ˜¯å¦ä¸ºç¾¤èŠ
    if event.is_group():
        await self.handle_group_message(event)
    else:
        await self.handle_private_message(event)

async def handle_group_message(self, event: AstrMessageEvent):
    """å¤„ç†ç¾¤èŠæ¶ˆæ¯"""
    group_id = event.group_id
    user_id = event.user_id
    
    # æ£€æŸ¥æ˜¯å¦@æœºå™¨äºº
    if event.is_at_bot():
        await event.reply("ä½ @äº†æˆ‘ï¼")
    
    # ç¾¤ç®¡ç†åŠŸèƒ½
    if event.message.content == "/ç¾¤ä¿¡æ¯":
        group_info = await self.get_group_info(group_id)
        await event.reply(f"ç¾¤åç§°: {group_info['name']}")

async def handle_private_message(self, event: AstrMessageEvent):
    """å¤„ç†ç§èŠæ¶ˆæ¯"""
    user_id = event.user_id
    await event.reply("è¿™æ˜¯ç§èŠæ¶ˆæ¯")
```

## é«˜çº§åŠŸèƒ½

### çŠ¶æ€ç®¡ç†

```python
class StatefulStar(Star):
    def __init__(self):
        super().__init__()
        self.name = "çŠ¶æ€ç®¡ç†æ’ä»¶"
        self.user_states = {}  # ç”¨æˆ·çŠ¶æ€å­˜å‚¨
    
    async def handle(self, event: AstrMessageEvent):
        user_id = event.user_id
        
        # è·å–ç”¨æˆ·çŠ¶æ€
        state = self.user_states.get(user_id, "idle")
        
        if state == "idle":
            if event.message.content == "/start_game":
                self.user_states[user_id] = "gaming"
                await event.reply("æ¸¸æˆå¼€å§‹ï¼è¯·è¾“å…¥ä½ çš„é€‰æ‹©ï¼š")
                return True
        
        elif state == "gaming":
            choice = event.message.content
            result = self.process_game_choice(choice)
            await event.reply(result)
            self.user_states[user_id] = "idle"
            return True
        
        return False
```

### å®šæ—¶ä»»åŠ¡

```python
import asyncio
from datetime import datetime, timedelta

class ScheduledStar(Star):
    def __init__(self):
        super().__init__()
        self.name = "å®šæ—¶ä»»åŠ¡æ’ä»¶"
        self.scheduled_tasks = []
    
    async def on_startup(self):
        """æ’ä»¶å¯åŠ¨æ—¶æ‰§è¡Œ"""
        # å¯åŠ¨å®šæ—¶ä»»åŠ¡
        asyncio.create_task(self.daily_reminder())
    
    async def daily_reminder(self):
        """æ¯æ—¥æé†’ä»»åŠ¡"""
        while True:
            now = datetime.now()
            # è®¡ç®—åˆ°æ˜å¤©æ—©ä¸Š8ç‚¹çš„æ—¶é—´
            tomorrow_8am = (now + timedelta(days=1)).replace(
                hour=8, minute=0, second=0, microsecond=0
            )
            sleep_seconds = (tomorrow_8am - now).total_seconds()
            
            await asyncio.sleep(sleep_seconds)
            
            # å‘é€æé†’æ¶ˆæ¯åˆ°æŒ‡å®šç¾¤ç»„
            await self.send_reminder()
    
    async def send_reminder(self):
        """å‘é€æé†’æ¶ˆæ¯"""
        # é€šè¿‡contextå‘é€æ¶ˆæ¯åˆ°æŒ‡å®šå¹³å°
        message = "æ—©ä¸Šå¥½ï¼æ–°çš„ä¸€å¤©å¼€å§‹äº†ï¼"
        await self.context.send_message(
            platform="qq",
            target="123456789",  # ç¾¤å·æˆ–ç”¨æˆ·ID
            message=message
        )
```

### æ•°æ®æŒä¹…åŒ–

```python
import json
import os

class DataPersistenceStar(Star):
    def __init__(self):
        super().__init__()
        self.name = "æ•°æ®æŒä¹…åŒ–æ’ä»¶"
        self.data_file = "data/plugins/my_plugin_data.json"
        self.data = self.load_data()
    
    def load_data(self):
        """åŠ è½½æ•°æ®"""
        if os.path.exists(self.data_file):
            with open(self.data_file, 'r', encoding='utf-8') as f:
                return json.load(f)
        return {}
    
    def save_data(self):
        """ä¿å­˜æ•°æ®"""
        os.makedirs(os.path.dirname(self.data_file), exist_ok=True)
        with open(self.data_file, 'w', encoding='utf-8') as f:
            json.dump(self.data, f, ensure_ascii=False, indent=2)
    
    async def handle(self, event: AstrMessageEvent):
        user_id = str(event.user_id)
        
        if event.message.content.startswith("/save "):
            # ä¿å­˜ç”¨æˆ·æ•°æ®
            data = event.message.content[6:]
            self.data[user_id] = data
            self.save_data()
            await event.reply("æ•°æ®å·²ä¿å­˜ï¼")
            return True
        
        elif event.message.content == "/load":
            # åŠ è½½ç”¨æˆ·æ•°æ®
            data = self.data.get(user_id, "æ²¡æœ‰ä¿å­˜çš„æ•°æ®")
            await event.reply(f"ä½ çš„æ•°æ®: {data}")
            return True
        
        return False
```

### HTTPè¯·æ±‚

```python
import aiohttp

class HttpRequestStar(Star):
    def __init__(self):
        super().__init__()
        self.name = "HTTPè¯·æ±‚æ’ä»¶"
    
    async def handle(self, event: AstrMessageEvent):
        if event.message.content.startswith("/weather "):
            city = event.message.content[9:]
            weather = await self.get_weather(city)
            await event.reply(weather)
            return True
        return False
    
    async def get_weather(self, city):
        """è·å–å¤©æ°”ä¿¡æ¯"""
        try:
            async with aiohttp.ClientSession() as session:
                url = f"http://api.weather.com/v1/current?city={city}"
                async with session.get(url) as response:
                    if response.status == 200:
                        data = await response.json()
                        return f"{city}çš„å¤©æ°”: {data['weather']}, æ¸©åº¦: {data['temperature']}Â°C"
                    else:
                        return "è·å–å¤©æ°”ä¿¡æ¯å¤±è´¥"
        except Exception as e:
            return f"è¯·æ±‚å‡ºé”™: {str(e)}"
```

## æ’ä»¶é…ç½®

### é…ç½®æ–‡ä»¶

```python
import yaml

class ConfigurableStar(Star):
    def __init__(self):
        super().__init__()
        self.name = "å¯é…ç½®æ’ä»¶"
        self.config = self.load_config()
    
    def load_config(self):
        """åŠ è½½é…ç½®æ–‡ä»¶"""
        config_file = "data/plugins/my_plugin_config.yaml"
        if os.path.exists(config_file):
            with open(config_file, 'r', encoding='utf-8') as f:
                return yaml.safe_load(f)
        
        # é»˜è®¤é…ç½®
        default_config = {
            "api_key": "",
            "max_requests": 100,
            "timeout": 30,
            "enabled_features": ["feature1", "feature2"]
        }
        
        # ä¿å­˜é»˜è®¤é…ç½®
        os.makedirs(os.path.dirname(config_file), exist_ok=True)
        with open(config_file, 'w', encoding='utf-8') as f:
            yaml.dump(default_config, f, default_flow_style=False)
        
        return default_config
    
    async def handle(self, event: AstrMessageEvent):
        if not self.config.get("api_key"):
            await event.reply("è¯·å…ˆé…ç½®APIå¯†é’¥")
            return True
        
        # ä½¿ç”¨é…ç½®è¿›è¡Œå¤„ç†
        max_requests = self.config.get("max_requests", 100)
        # ...
```

## é”™è¯¯å¤„ç†

```python
import logging

class RobustStar(Star):
    def __init__(self):
        super().__init__()
        self.name = "å¥å£®æ’ä»¶"
        self.logger = logging.getLogger(self.name)
    
    async def handle(self, event: AstrMessageEvent):
        try:
            # ä¸»è¦é€»è¾‘
            await self.main_logic(event)
        except Exception as e:
            # è®°å½•é”™è¯¯
            self.logger.error(f"å¤„ç†æ¶ˆæ¯æ—¶å‡ºé”™: {e}", exc_info=True)
            
            # å‘ç”¨æˆ·æŠ¥å‘Šé”™è¯¯
            await event.reply("æŠ±æ­‰ï¼Œå¤„ç†è¯·æ±‚æ—¶å‡ºç°äº†é”™è¯¯")
        
        return True
    
    async def main_logic(self, event: AstrMessageEvent):
        """ä¸»è¦ä¸šåŠ¡é€»è¾‘"""
        # å¯èƒ½å‡ºé”™çš„ä»£ç 
        pass
```

## æ’ä»¶æµ‹è¯•

### å•å…ƒæµ‹è¯•

```python
import unittest
from unittest.mock import AsyncMock, MagicMock

class TestMyPlugin(unittest.IsolatedAsyncioTestCase):
    def setUp(self):
        self.plugin = MyPluginStar()
    
    async def test_hello_response(self):
        """æµ‹è¯•helloå‘½ä»¤"""
        # åˆ›å»ºæ¨¡æ‹Ÿäº‹ä»¶
        event = MagicMock()
        event.message.content = "hello"
        event.reply = AsyncMock()
        
        # æ‰§è¡Œå¤„ç†
        result = await self.plugin.handle(event)
        
        # éªŒè¯ç»“æœ
        self.assertTrue(result)
        event.reply.assert_called_once_with("Hello, World! ğŸŒŸ")
    
    async def test_unknown_command(self):
        """æµ‹è¯•æœªçŸ¥å‘½ä»¤"""
        event = MagicMock()
        event.message.content = "unknown"
        
        result = await self.plugin.handle(event)
        
        self.assertFalse(result)

if __name__ == "__main__":
    unittest.main()
```

## æ’ä»¶å‘å¸ƒ

### ç›®å½•ç»“æ„

```
my_plugin/
â”œâ”€â”€ __init__.py
â”œâ”€â”€ main.py          # ä¸»æ’ä»¶æ–‡ä»¶
â”œâ”€â”€ config.yaml      # é…ç½®æ–‡ä»¶æ¨¡æ¿
â”œâ”€â”€ requirements.txt # ä¾èµ–åˆ—è¡¨
â”œâ”€â”€ README.md        # è¯´æ˜æ–‡æ¡£
â””â”€â”€ tests/           # æµ‹è¯•æ–‡ä»¶
    â””â”€â”€ test_main.py
```

### æ’ä»¶ä¿¡æ¯æ–‡ä»¶

```python
# __init__.py
from .main import MyPluginStar

__plugin_name__ = "æˆ‘çš„æ’ä»¶"
__plugin_version__ = "1.0.0"
__plugin_author__ = "ä½œè€…åç§°"
__plugin_description__ = "æ’ä»¶åŠŸèƒ½æè¿°"
__plugin_star__ = MyPluginStar
```

## æœ€ä½³å®è·µ

### 1. æ€§èƒ½ä¼˜åŒ–
- ä½¿ç”¨å¼‚æ­¥æ“ä½œé¿å…é˜»å¡
- åˆç†ä½¿ç”¨ç¼“å­˜å‡å°‘é‡å¤è®¡ç®—
- é¿å…åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œè€—æ—¶æ“ä½œ

### 2. å®‰å…¨è€ƒè™‘
- éªŒè¯ç”¨æˆ·è¾“å…¥
- é¿å…æ‰§è¡Œå±é™©ä»£ç 
- ä¿æŠ¤æ•æ„Ÿä¿¡æ¯

### 3. ç”¨æˆ·ä½“éªŒ
- æä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯
- æ”¯æŒå¸®åŠ©å‘½ä»¤
- å“åº”æ—¶é—´æ§åˆ¶

### 4. ä»£ç è´¨é‡
- éµå¾ªPEP 8ç¼–ç è§„èŒƒ
- æ·»åŠ é€‚å½“çš„æ³¨é‡Šå’Œæ–‡æ¡£
- ç¼–å†™å•å…ƒæµ‹è¯•

---

*æ›´å¤šæ’ä»¶å¼€å‘ç¤ºä¾‹å’ŒAPIæ–‡æ¡£ï¼Œè¯·å‚è€ƒå®˜æ–¹æ–‡æ¡£å’Œç¤¾åŒºæ’ä»¶ä»“åº“ã€‚*
