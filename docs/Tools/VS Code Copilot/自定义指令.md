自定义指令允许您定义通用的准则和规则，自动影响 AI 生成代码和处理其他开发任务的方式。您无需在每次聊天提示中手动包含上下文，而是在 Markdown 文件中指定自定义指令，以确 AI 的回复始终符合您的编码实践和项目要求。

您可以配置自定义指令，使其自动应用于所有聊天请求，或仅应用于特定文件。或者，您也可以手动将自定义指令附加到特定的聊天提示中。

> **注意**：在编辑器中输入时，**行内建议**不会考虑自定义指令。

## [指令文件的类型]

VS Code 支持多种基于 Markdown 的指令文件类型。如果在您的项目中有多种类型的指令文件，VS Code 会将它们合并并添加到聊天上下文中，不保证特定的顺序。

*   **单个 `.github/copilot-instructions.md` 文件**
    *   自动应用于工作区中的所有聊天请求
    *   存储在工作区内
*   **一个或多个 `.instructions.md` 文件**
    *   通过使用 glob 模式，根据文件类型或位置有条件地应用指令
    *   存储在工作区或用户配置文件中
*   **一个或多个 `AGENTS.md` 文件**
    *   如果您在工作区中使用多个 AI 代理，这非常有用
    *   自动应用于工作区中的所有聊天请求，或特定子文件夹（实验性）
    *   存储在工作区根目录或子文件夹中（实验性）

指令之间的空格会被忽略，因此为了可读性，指令可以写成一个段落，每行一条，或者用空行分隔。

要在指令中引用特定的上下文（如文件或 URL），可以使用 Markdown 链接。

## [自定义指令示例]

以下示例演示了如何使用自定义指令。更多社区贡献的示例，请参阅 [Awesome Copilot 仓库](https://github.com/github/awesome-copilot/tree/main)。

### 示例：通用编码准则

```markdown
---
applyTo: "**"
---
# 项目通用编码标准

## 命名约定
- 组件名称、接口和类型别名使用 PascalCase
- 变量、函数和方法使用 camelCase
- 私有类成员加下划线前缀 (_)
- 常量使用 ALL_CAPS

## 错误处理
- 异步操作使用 try/catch 块
- 在 React 组件中实现适当的错误边界
- 始终记录带有上下文信息的错误
```

### 示例：特定语言的编码准则

请注意这些指令是如何引用通用编码准则文件的。您可以将指令分成多个文件，以保持组织性并专注于特定主题。

```markdown
---
applyTo: "**/*.ts,**/*.tsx"
---
# TypeScript 和 React 的项目编码标准

将 [通用编码准则](./general-coding.instructions.md) 应用于所有代码。

## TypeScript 准则
- 所有新代码使用 TypeScript
- 尽可能遵循函数式编程原则
- 使用接口进行数据结构和类型定义
- 优先使用不可变数据 (const, readonly)
- 使用可选链 (?.) 和空值合并 (??) 运算符

## React 准则
- 使用带 Hook 的函数组件
- 遵循 React Hook 规则（无条件 Hook）
- 对于带有子组件的组件使用 React.FC 类型
- 保持组件小而专注
- 使用 CSS 模块进行组件样式设计
```

### 示例：文档编写准则

您可以为不同类型的任务创建指令文件，包括非开发活动，如编写文档。

```markdown
---
applyTo: "docs/**/*.md"
---
# 项目文档编写准则

## 通用准则
- 编写清晰简洁的文档。
- 使用一致的术语和风格。
- 在适用的地方包含代码示例。

## 语法
- 使用现在时动词 (is, open) 而不是过去时 (was, opened)。
- 编写陈述句和直接命令。避免使用 "could" 或 "would" 等假设性词语。
- 使用主动语态，主语执行动作。
- 使用第二人称 (you) 直接与读者对话。

## Markdown 准则
- 使用标题组织内容。
- 列表使用项目符号。
- 包含相关资源的链接。
- 代码片段使用代码块。
```

## [使用 `.github/copilot-instructions.md` 文件]

在工作区根目录下的单个 `.github/copilot-instructions.md` Markdown 文件中定义您的自定义指令。VS Code 会自动将此文件中的指令应用于该工作区内的所有聊天请求。

要使用 `.github/copilot-instructions.md` 文件：

1.  启用 `github.copilot.chat.codeGeneration.useInstructionFiles` 设置。
2.  在工作区根目录下创建一个 `.github/copilot-instructions.md` 文件。如果需要，先创建一个 `.github` 目录。
3.  使用自然语言和 Markdown 格式描述您的指令。

> **注意**：Visual Studio 和 GitHub.com 中的 GitHub Copilot 也会检测 `.github/copilot-instructions.md` 文件。如果您有一个在 VS Code 和 Visual Studio 中都使用的工作区，可以使用同一个文件为两个编辑器定义自定义指令。

## [使用 `.instructions.md` 文件]

除了使用应用于所有聊天请求的单个指令文件外，您还可以创建多个应用于特定文件类型或任务的 `.instructions.md` 文件。例如，您可以为不同的编程语言、框架或项目类型创建指令文件。

通过在指令文件头中使用 `applyTo` frontmatter 属性，您可以指定 glob 模式来定义指令应自动应用于哪些文件。指令文件在创建或修改文件时使用，通常不用于读取操作。

或者，您可以通过在聊天视图中使用 **Add Context** > **Instructions** 选项，手动将指令文件附加到特定的聊天提示中。

*   **工作区指令文件**：仅在工作区内可用，存储在工作区的 `.github/instructions` 文件夹中。
*   **用户指令文件**：可在多个工作区中使用，存储在当前的 [VS Code 配置文件](https://code.visualstudio.com/docs/configure/profiles)中。

### [指令文件格式]

指令文件是 Markdown 文件，使用 `.instructions.md` 扩展名，并具有以下结构：

#### [头部 (可选)]

头部格式为 YAML frontmatter，包含以下字段：

| 字段 | 描述 |
| --- | --- |
| `description` | 指令文件的简短描述。 |
| `name` | 指令文件的名称，在 UI 中使用。如果未指定，则使用文件名。 |
| `applyTo` | 可选的 glob 模式，定义指令应自动应用于哪些文件（相对于工作区根目录）。使用 `**` 应用于所有文件。如果未指定值，指令不会自动应用 - 您仍然可以手动将其添加到聊天请求中。 |

#### [正文]

指令文件正文包含在应用指令时发送给 LLM 的自定义指令。提供您希望 AI 遵循的具体准则、规则或任何其他相关信息。

要在正文中引用代理工具，请使用 `#tool:<tool-name>` 语法。例如，要引用 `githubRepo` 工具，请使用 `#tool:githubRepo`。

示例：

```markdown
---
applyTo: "**/*.py"
---
# Python 项目编码标准
- 遵循 Python 的 PEP 8 风格指南。
- 始终优先考虑可读性和清晰度。
- 为每个函数编写清晰简洁的注释。
- 确保函数具有描述性名称并包含类型提示。
- 保持适当的缩进（每一级缩进使用 4 个空格）。
```

### [创建指令文件]

创建指令文件时，请选择是将其存储在工作区还是用户配置文件中。工作区指令文件仅应用于该工作区，而用户指令文件可在多个工作区中使用。

要创建指令文件：

1.  在聊天视图中，选择 **Configure Chat** (齿轮图标) > **Chat Instructions**，然后选择 **New instruction file**。
    或者，从命令面板 (⇧⌘P (Windows, Linux Ctrl+Shift+P)) 使用 **Chat: New Instructions File** 命令。
2.  选择创建指令文件的位置。
    *   **工作区**：在工作区的 `.github/instructions` 文件夹中创建指令文件，仅在该工作区内使用。通过 `chat.instructionsFilesLocations` 设置为您的工作区添加更多指令文件夹。
    *   **用户配置文件**：在当前配置文件文件夹中创建指令文件，以便在所有工作区中使用。
3.  输入指令文件的文件名。这是 UI 中使用的默认名称。
4.  使用 Markdown 格式编写自定义指令。
    *   在文件顶部填写 YAML frontmatter，以配置指令的描述、名称和应用时间。
    *   在文件正文中添加指令。

要修改现有的指令文件，在聊天视图中，选择 **Configure Chat** (齿轮图标) > **Chat Instructions**，然后从列表中选择一个指令文件。或者，从命令面板使用 **Chat: Configure Instructions** 命令，并从快速选择中选择指令文件。

## [使用 `AGENTS.md` 文件]

如果您在工作区中使用多个 AI 代理，可以在工作区根目录下的 `AGENTS.md` Markdown 文件中为所有代理定义自定义指令。VS Code 会自动将此文件中的指令应用于该工作区内的所有聊天请求。

要启用或禁用对 `AGENTS.md` 文件的支持，请配置 `chat.useAgentsMdFile` 设置。

### [使用多个 `AGENTS.md` 文件 (实验性)]

如果希望将不同的指令应用于项目的不同部分，在子文件夹中使用多个 `AGENTS.md` 文件非常有用。例如，您可以为前端代码使用一个 `AGENTS.md` 文件，为后端代码使用另一个。

使用实验性的 `chat.useNestedAgentsMdFiles` 设置来启用或禁用对工作区中嵌套 `AGENTS.md` 文件的支持。

启用后，VS Code 会递归搜索工作区所有子文件夹中的 `AGENTS.md` 文件，并将其相对路径添加到聊天上下文中。代理可以根据正在编辑的文件决定使用哪些指令。

> **提示**：对于特定于文件夹的指令，您也可以使用多个具有不同 `applyTo` 模式（匹配文件夹结构）的 `.instructions.md` 文件。

## [在设置中指定自定义指令]

您可以使用 VS Code 用户或工作区设置，为特定场景配置自定义指令。

| 指令类型 | 设置名称 |
| --- | --- |
| 代码审查 | `github.copilot.chat.reviewSelection.instructions` |
| 提交信息生成 | `github.copilot.chat.commitMessageGeneration.instructions` |
| Pull Request 标题和描述生成 | `github.copilot.chat.pullRequestDescriptionGeneration.instructions` |
| 代码生成 (已弃用)* | `github.copilot.chat.codeGeneration.instructions` |
| 测试生成 (已弃用)* | `github.copilot.chat.testGeneration.instructions` |

*\* `codeGeneration` 和 `testGeneration` 设置在 VS Code 1.102 中已弃用。建议改用指令文件 (`.github/copilot-instructions.md` 或 `*.instructions.md`)。*

您可以在设置值中将自定义指令定义为文本（`text` 属性），或引用工作区中的外部文件（`file` 属性）。

以下代码片段展示了如何在 `settings.json` 文件中定义一组指令。

```json
{
  "github.copilot.chat.pullRequestDescriptionGeneration.instructions": [
    { "text": "Always include a list of key changes." }
  ],
  "github.copilot.chat.reviewSelection.instructions": [
    { "file": "guidance/backend-review-guidelines.md" },
    { "file": "guidance/frontend-review-guidelines.md" }
  ]
}
```

## [为工作区生成指令文件]

VS Code 可以分析您的工作区，并生成一个匹配的 `.github/copilot-instructions.md` 文件，其中包含符合您编码实践和项目结构的自定义指令。

要为工作区生成指令文件：

1.  在聊天视图中，选择 **Configure Chat** (齿轮图标) > **Generate Chat Instructions**。
2.  查看生成的指令文件并进行必要的编辑。

## [跨设备同步用户指令文件]

VS Code 可以使用设置同步跨多个设备同步您的用户指令文件。

要同步用户指令文件，请为提示和指令文件启用设置同步：

1.  确保已启用设置同步。
2.  从命令面板运行 **Settings Sync: Configure**。
3.  从要同步的设置列表中选择 **Prompts and Instructions**。

## [定义自定义指令的技巧]

*   保持指令简短且独立。每条指令应是一个简单的陈述。如果需要提供多条信息，请使用多条指令。
*   对于任务或特定语言的指令，每个主题使用多个 `*.instructions.md` 文件，并使用 `applyTo` 属性选择性地应用它们。
*   将特定于项目的指令存储在工作区中，以便与其他团队成员共享并将其包含在版本控制中。
*   在提示文件和自定义代理中重用和引用指令文件，以保持它们的整洁和专注，并避免重复指令。

## [常见问题]

### [为什么我的指令文件没有被应用？]

如果您的指令文件没有被应用，请检查以下内容：

1.  验证指令文件的位置是否正确：
    *   对于 `.github/copilot-instructions.md` 文件，必须位于工作区根目录的 `.github` 文件夹中，并且必须启用 `github.copilot.chat.codeGeneration.useInstructionFiles` 设置。
    *   对于 `*.instructions.md` 文件，必须位于 `chat.instructionsFilesLocations` 设置指定的文件夹之一（默认文件夹：`.github/instructions`）或用户配置文件中。
    *   对于 `AGENTS.md` 文件，确保启用了 `chat.useAgentsMdFile` 设置，并且文件位于工作区根目录；如果启用了 `chat.useNestedAgentsMdFiles`，则位于工作区的子文件夹中。
    *   对于 `SKILLS.md` 文件，确保启用了 `chat.useAgentSkills` 设置，并且技能文件位于 `~/.claude/skills/*/` 或工作区根目录的 `.claude/skills/` 文件夹中。
2.  对于 `*.instructions.md` 文件，检查 `applyTo` glob 模式是否与您正在处理的文件匹配。如果未指定 `applyTo` 属性，指令文件不会自动应用。检查聊天回复中的 `References` 部分，查看您的请求使用了哪些指令文件。
3.  验证聊天日志，查看哪些指令文件包含在聊天请求中或被代理加载：
    *   使用 Chat Debug 视图检查语言模型请求。
    *   调试 `applyTo` 匹配逻辑。

如果您的指令未包含在聊天请求中，请在 vscode 仓库中创建 issue，并分享请求日志和您的指令文件以便我们复现。

如果 LLM 没有请求您的按需指令，请尝试完善指令。您也可以尝试通过告诉 LLM 不要忘记使用特定指令来引导它。旧模型可能在利用按需指令方面更困难，需要更多指导。

### [我如何知道自定义指令文件来自哪里？]

自定义指令文件可以来自不同的来源：内置、在配置文件中定义的用户自定义、当前工作区中定义的工作区指令，或扩展贡献的指令。

要识别自定义指令文件的来源：

1.  从命令面板选择 **Chat: Configure Instructions**。
2.  将鼠标悬停在列表中的指令文件上。源位置显示在工具提示中。
