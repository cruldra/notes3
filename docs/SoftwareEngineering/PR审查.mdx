*原文发布于 [https://jimbobbennett.dev/blogs/how-to-review-a-pr/](https://jimbobbennett.dev/blogs/how-to-review-a-pr/)*

我常说，开发是一项团队运动。我们不是孤立地编写代码，而是作为团队的一员，为用户和客户交付价值，这些价值往往由软件组成。为了让团队交付最好的代码，代码需要被团队共同拥有。这意味着每一次代码变更都需要有多位开发者参与，以确保其正确性、适当性，并让团队成员都能了解这些变更。虽然有很多实现方式（如结对编程、集体编程），但最常见的方式就是 Pull Request（PR）。

## 什么是 Pull Request？

Pull Request（简称 PR）是 git 的一个功能，允许你请求代码所有者合并你的更改。你在分支或 fork 上做出代码更改，然后发起 PR，请求将你的代码合并到主仓库（origin/upstream）。本质上，这就是让你的代码准备好发布到团队、部署到生产环境的方式。

PR 的目的是让别人帮你检查代码。在 PR 合并前，代码会被审查。审查者会检查代码的正确性、风格，以及是否真正实现了预期的功能等。这是让第二双眼睛发现错误、促进知识共享（让团队中不止一人了解新代码）、以及让高级开发者指导和提升初级开发者的机会。

但 PR 审查常常做得很糟糕。最著名的就是那句 LGTM 👍（看起来没问题）。尤其是当 PR 很大、需要花很多时间时更是如此。

![一条推文：10 行代码 = 10 个问题，500 行代码 = 看起来没问题。](https://user-images.githubusercontent.com/217029/181068444-9a21be12-9ed3-42cb-95d3-594e75d6192c.png)

## 为什么我们 PR 审查做得这么差？

原因很简单——时间。审查 5 行代码很快，审查者可以快速检查并提出修改意见。但如果是 100 个文件，审查往往只是走个过场，因为没有足够的时间做全面审查。毕竟，审查代码并不能直接交付新功能！

我见过很多糟糕的 PR 审查，也见过因此上线的糟糕代码，所以我想写下自己关于如何做好 PR 审查的一些建议。欢迎在评论区补充！

## 如何更好地审查 PR

### 1. 分配时间

这通常不是审查者能决定的，但你应该为此发声，让管理层理解。PR 审查需要时间。如果你要求工程师 100% 投入功能开发，不仅会导致他们精疲力竭，还会让他们根本没有时间审查 PR。结果就是所有代码无论好坏都 LGTM 👍，合并后埋下隐患。

对工程师来说，这很合理——没时间在 PR 阶段抓 bug，但总能在迭代里分配时间修 bug。你的流程本身就会导致糟糕的工程实践。

理想情况下，工程师应该 60% 时间做功能开发，20% 处理日常事务，20% 留作备用（休假、病假、系统故障等）。那 20% 的日常事务应该足够用来审查 PR，如果不够——就要分配更多时间（或者采用结对编程，但说服管理层更难）。

有了时间，下一步就是审查需求单（ticket）！

### 2. 审查需求单（ticket）

所有好的 PR 都有一个需求单。通常是 Jira 里的任务，详细描述了要做的工作。但这不是代码，为什么要关心？因为需求单说明了变更的意图。修了什么 bug，新增了什么功能。没有详细的需求单，怎么验证代码是否正确？

那什么是好的需求单？这本身可以写一篇文章，但这里有几点：

*   有需求单。仅仅有个 ticket 就是好的开始。没有需求单就不该有变更。没有 ticket 的 PR 应该被拒绝，否则无法保证变更正确。
*   说明了变更的原因。知道“为什么”后，你可以从用户角度思考实现方式，有助于设计测试用例。
*   详细描述了变更内容。比如移动按钮？具体移动到哪里，移动多少。新增 API？什么 endpoint，请求和响应体是什么？
*   定义了测试用例。理想情况下应该覆盖全面，至少要给出验证变更的方法。比如新增计算 X 的功能，给出一些输入输出样例。
*   说明了对系统其他部分的影响。是否需要下游变更？文档是否需要更新？

只有对需求单满意，才能继续审查代码。不满意就退回给开发或产品经理完善。有时光是这样就能发现开发遗漏的问题，在看代码前就能修复 bug 或补全功能。

### 3. 代码能用吗？

代码应该能用。需求单定义了变更，代码要实现它。审查代码前，我喜欢先实际运行一下，看看它在整个系统里是否真的实现了预期功能。是的，这通常意味着要手动测试，但这样能很快发现问题。虽然不总是容易，但通常有方法或测试工具可以验证大系统中的某个功能。好的需求单也会帮你——它会告诉你需要测试什么、输入输出是什么、哪些是边界情况。

那单元测试呢？我后面会讲，但有单元测试并不代表代码一定能用。我遇到过 PR 里所有测试都通过，但实际系统里功能并没实现的情况。多次我指出问题后，开发加了单元测试，说测试都过了，但功能还是不对。

比如你有个加法函数，写了这些测试：2+2=4，3+1=4，0+4=4。这些测试能说明代码没问题吗？还是只是说明你写了个总是返回 4 的函数？

如果代码不能用，审查就没有意义。

### 4. 代码有自动化测试吗？

接下来就是自动化测试。代码有没有单元测试、集成测试、UI 测试等？没有的话——是不是应该有（大概率应该有）。有的话，能否运行、能否通过、真的覆盖了代码吗？

我发现先看测试代码很有用。如果明显有遗漏的测试用例、没考虑的边界情况、或者测试写得很差，那应该先让开发补全测试再看主代码。

你能在 PR 里看到测试都跑过了吗？如上——代码不能用就没必要审查。PR 应该尽可能多地跑单元测试，并且要有机制保证测试不过就不能合并。

### 5. 你能看懂代码吗？

现在可以看代码了。首先要问：你能看懂吗？如果你看不懂代码在干什么，就无法审查。对于了解系统和变更背景的人来说，代码应该是容易理解的。还要易读。变量、函数、类名是否合理？有没有注释说明“为什么”这么写？

> 任何说代码不需要注释的人都是错的。是的，好的命名能说明代码做了什么，但注释要说明“为什么”这么做。getter 不需要注释“获取值”，但你要说明为什么要获取这个值、为什么要这样处理。

代码的可读性很重要。我知道有些开发喜欢“高尔夫式”写法，越短越好，但牺牲可读性是很糟糕的。代码是写给人看的，不要耍聪明，要清晰、简洁、易懂。审查时要问：读者能看懂代码在做什么、为什么这么做吗？你的代码应该让团队里最初级的开发者都能明白——记住，代码属于团队，不是写代码的那个人，所以要让每个人都能理解。

### 6. 代码“好”吗？

最后，代码“好”吗？这里的“好”指的是是否遵循了团队规范。这包括编码规范（可以用工具辅助），也包括是否遵循了约定、实现方式是否和代码库其他部分一致。

比如——如果你的代码要给用户显示消息，这个消息是不是和其他消息一样放在常量文件里，方便国际化？是否符合无障碍（a11y）标准？命名是否一致？

这往往是主观的，所以团队要有明确的编码规范。

如果都没问题——就批准 PR 吧！有问题就写审查意见。

## PR 评论与变更请求

你审查完代码，该写评论了。虽然本文主要讲审查，这里也说说写评论的建议：

*   要友善。不要刻薄，不要做 Linus Torvalds。收到评论的人是你的同事和队友。所有评论都要友善、建设性。
*   评论要详细。如果需要改动，要说明原因（比如“按团队规范，这个要放到常量文件”）。
*   理解每个人的编码风格不同，个人偏好不能强加。如果实现方式没问题，就不要因为你喜欢另一种写法而要求改。问 20 个开发怎么做会有 30 种答案，不全是错的。
*   对初级开发者来说，这是学习和成长的机会。给出有助成长的建议。
*   对于小问题（如拼写错误），可以用建议功能，方便快速修改。

## 去审查 PR 吧！

这是一篇快速随笔，记录一些想法。欢迎在评论区交流你的看法！
