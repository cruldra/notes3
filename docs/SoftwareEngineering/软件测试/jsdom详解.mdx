**jsdom** æ˜¯ä¸€ä¸ªç”¨çº¯ JavaScript å®ç°çš„ DOM å’Œ HTML æ ‡å‡†åº“ï¼Œå®ƒåœ¨ Node.js ç¯å¢ƒä¸­æ¨¡æ‹Ÿæµè§ˆå™¨çš„ DOM APIã€‚ç®€å•æ¥è¯´ï¼Œjsdom è®©ä½ å¯ä»¥åœ¨æ²¡æœ‰æµè§ˆå™¨çš„æœåŠ¡å™¨ç¯å¢ƒä¸­æ“ä½œ DOM å…ƒç´ ã€‚

```javascript
// æ²¡æœ‰ jsdom çš„ Node.js ç¯å¢ƒ
console.log(typeof window)     // âŒ undefined
console.log(typeof document)   // âŒ undefined
console.log(typeof Element)    // âŒ undefined

// ä½¿ç”¨ jsdom å
import { JSDOM } from 'jsdom'
const dom = new JSDOM('<!DOCTYPE html><div>Hello World</div>')
global.window = dom.window
global.document = dom.window.document

console.log(typeof window)     // âœ… object
console.log(typeof document)   // âœ… object
console.log(typeof Element)    // âœ… function
```

## ä¸ºä»€ä¹ˆéœ€è¦ jsdomï¼Ÿ

### ğŸŒ ç¯å¢ƒå·®å¼‚é—®é¢˜

**æµè§ˆå™¨ç¯å¢ƒ vs Node.js ç¯å¢ƒ**

```javascript
// æµè§ˆå™¨ç¯å¢ƒ - å¤©ç„¶æ”¯æŒ
const button = document.createElement('button')
button.textContent = 'Click me'
document.body.appendChild(button)

// Node.js ç¯å¢ƒ - ä¸æ”¯æŒ
// ReferenceError: document is not defined
// ReferenceError: window is not defined
```

### ğŸ§ª æµ‹è¯•éœ€æ±‚

ç°ä»£å‰ç«¯æµ‹è¯•éœ€è¦ DOM ç¯å¢ƒï¼š

```typescript
// React ç»„ä»¶æµ‹è¯•
import { render, screen } from '@testing-library/react'

function Button({ onClick, children }: ButtonProps) {
  return <button onClick={onClick}>{children}</button>
}

// è¿™ä¸ªæµ‹è¯•éœ€è¦ DOM API
test('button renders correctly', () => {
  // render() å†…éƒ¨éœ€è¦è°ƒç”¨ï¼š
  // - document.createElement()
  // - element.appendChild()  
  // - element.querySelector()
  // - addEventListener()
  
  render(<Button>Click me</Button>)
  expect(screen.getByRole('button')).toHaveTextContent('Click me')
})
```

## jsdom çš„æ ¸å¿ƒåŠŸèƒ½

### ğŸ—ï¸ DOM æ“ä½œ

```javascript
import { JSDOM } from 'jsdom'

const dom = new JSDOM(`
  <!DOCTYPE html>
  <html>
    <body>
      <div id="app"></div>
    </body>
  </html>
`)

const { window } = dom
const { document } = window

// åˆ›å»ºå…ƒç´ 
const button = document.createElement('button')
button.textContent = 'Hello jsdom'
button.id = 'my-button'

// DOM æ“ä½œ
const app = document.getElementById('app')
app.appendChild(button)

// æŸ¥è¯¢å…ƒç´ 
const foundButton = document.querySelector('#my-button')
console.log(foundButton.textContent) // "Hello jsdom"

// ä¿®æ”¹æ ·å¼
foundButton.style.backgroundColor = 'blue'
```

### ğŸ¯ äº‹ä»¶å¤„ç†

```javascript
// åˆ›å»ºå’Œåˆ†å‘äº‹ä»¶
const button = document.createElement('button')
let clicked = false

button.addEventListener('click', () => {
  clicked = true
})

// åˆ›å»ºç‚¹å‡»äº‹ä»¶
const clickEvent = new window.Event('click')
button.dispatchEvent(clickEvent)

console.log(clicked) // true
```

### ğŸ”§ æµè§ˆå™¨ API æ¨¡æ‹Ÿ

```javascript
const { window } = new JSDOM('', {
  url: 'https://example.com/',
  referrer: 'https://google.com/',
  contentType: 'text/html',
  storageQuota: 10000000
})

// Location API
console.log(window.location.href)     // "https://example.com/"
console.log(window.location.hostname) // "example.com"

// Storage API
window.localStorage.setItem('key', 'value')
console.log(window.localStorage.getItem('key')) // "value"

// Timer API
window.setTimeout(() => {
  console.log('Timer executed')
}, 100)

// Console API
window.console.log('Hello from jsdom')
```

## åœ¨æµ‹è¯•æ¡†æ¶ä¸­çš„åº”ç”¨

### ğŸš€ Vitest é…ç½®

```typescript
// vitest.config.ts
import { defineConfig } from 'vitest/config'

export default defineConfig({
  test: {
    // ä½¿ç”¨ jsdom ä½œä¸ºæµ‹è¯•ç¯å¢ƒ
    environment: 'jsdom',
    
    // å…¨å±€é…ç½®
    globals: true,
    
    // è®¾ç½®æ–‡ä»¶
    setupFiles: ['./src/test/setup.ts']
  }
})
```

```typescript
// src/test/setup.ts
import { beforeAll, afterEach } from 'vitest'
import { cleanup } from '@testing-library/react'

// æ¯ä¸ªæµ‹è¯•åæ¸…ç† DOM
afterEach(() => {
  cleanup()
})

// å…¨å±€ DOM æ‰©å±•
beforeAll(() => {
  // æ·»åŠ è‡ªå®šä¹‰ matchers
  expect.extend({
    toBeInTheDocument(received) {
      const pass = received !== null && document.body.contains(received)
      return {
        message: () => `expected element to be in the document`,
        pass
      }
    }
  })
})
```

### ğŸ­ Jest é…ç½®

```javascript
// jest.config.js
module.exports = {
  testEnvironment: 'jsdom',
  setupFilesAfterEnv: ['<rootDir>/src/test/setup.js']
}
```

### ğŸ“¦ ç›´æ¥ä½¿ç”¨

```javascript
// ä¸ä¾èµ–æµ‹è¯•æ¡†æ¶çš„ç›´æ¥ä½¿ç”¨
import { JSDOM } from 'jsdom'

describe('DOM Tests', () => {
  let dom, window, document
  
  beforeEach(() => {
    dom = new JSDOM('<!DOCTYPE html><div id="root"></div>')
    window = dom.window
    document = window.document
    
    // è®¾ç½®å…¨å±€å˜é‡
    global.window = window
    global.document = document
  })
  
  afterEach(() => {
    dom.window.close()
  })
  
  test('DOM manipulation', () => {
    const root = document.getElementById('root')
    const p = document.createElement('p')
    p.textContent = 'Hello World'
    root.appendChild(p)
    
    expect(document.querySelector('p').textContent).toBe('Hello World')
  })
})
```

## React æµ‹è¯•å®è·µ

### ğŸ¯ ç»„ä»¶æµ‹è¯•

```typescript
// Button.tsx
interface ButtonProps {
  variant?: 'primary' | 'secondary'
  disabled?: boolean
  onClick?: () => void
  children: React.ReactNode
}

export function Button({ 
  variant = 'primary', 
  disabled = false, 
  onClick, 
  children 
}: ButtonProps) {
  return (
    <button
      className={`btn btn-${variant}`}
      disabled={disabled}
      onClick={onClick}
      data-testid="button"
    >
      {children}
    </button>
  )
}
```

```typescript
// Button.test.tsx
import { render, screen, fireEvent } from '@testing-library/react'
import { Button } from './Button'

describe('Button Component', () => {
  test('renders with correct text', () => {
    render(<Button>Click me</Button>)
    
    // jsdom æä¾›çš„ DOM API
    const button = screen.getByRole('button')
    expect(button).toBeInTheDocument()
    expect(button).toHaveTextContent('Click me')
  })
  
  test('applies correct CSS classes', () => {
    render(<Button variant="secondary">Secondary</Button>)
    
    const button = screen.getByTestId('button')
    expect(button).toHaveClass('btn', 'btn-secondary')
  })
  
  test('handles click events', () => {
    const handleClick = vi.fn()
    render(<Button onClick={handleClick}>Click me</Button>)
    
    const button = screen.getByRole('button')
    fireEvent.click(button) // jsdom å¤„ç†äº‹ä»¶
    
    expect(handleClick).toHaveBeenCalledTimes(1)
  })
  
  test('disables when disabled prop is true', () => {
    render(<Button disabled>Disabled</Button>)
    
    const button = screen.getByRole('button')
    expect(button).toBeDisabled()
  })
})
```

### ğŸ”„ äº¤äº’æµ‹è¯•

```typescript
// SearchBox.tsx
export function SearchBox({ onSearch }: { onSearch: (query: string) => void }) {
  const [query, setQuery] = useState('')
  
  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault()
    onSearch(query)
  }
  
  return (
    <form onSubmit={handleSubmit} data-testid="search-form">
      <input
        type="text"
        value={query}
        onChange={(e) => setQuery(e.target.value)}
        placeholder="æœç´¢è¯¾ç¨‹..."
        data-testid="search-input"
      />
      <button type="submit">æœç´¢</button>
    </form>
  )
}
```

```typescript
// SearchBox.test.tsx
import { render, screen, fireEvent } from '@testing-library/react'
import userEvent from '@testing-library/user-event'

describe('SearchBox', () => {
  test('submits search query', async () => {
    const user = userEvent.setup()
    const mockOnSearch = vi.fn()
    
    render(<SearchBox onSearch={mockOnSearch} />)
    
    const input = screen.getByTestId('search-input')
    const form = screen.getByTestId('search-form')
    
    // ç”¨æˆ·è¾“å…¥
    await user.type(input, 'React è¯¾ç¨‹')
    
    // è¡¨å•æäº¤
    fireEvent.submit(form)
    
    expect(mockOnSearch).toHaveBeenCalledWith('React è¯¾ç¨‹')
  })
  
  test('updates input value', async () => {
    const user = userEvent.setup()
    render(<SearchBox onSearch={vi.fn()} />)
    
    const input = screen.getByTestId('search-input')
    
    await user.type(input, 'TypeScript')
    
    expect(input).toHaveValue('TypeScript')
  })
})
```

## jsdom vs å…¶ä»–æµ‹è¯•ç¯å¢ƒ

### ğŸš€ jsdom vs happy-dom

```typescript
// jsdom - åŠŸèƒ½å®Œæ•´ä½†è¾ƒé‡
export default defineConfig({
  test: {
    environment: 'jsdom',
    // ä¼˜ç‚¹ï¼šå®Œæ•´çš„ DOM API æ”¯æŒ
    // ç¼ºç‚¹ï¼šå¯åŠ¨è¾ƒæ…¢ï¼Œå†…å­˜å ç”¨å¤§
  }
})

// happy-dom - è½»é‡ä½†åŠŸèƒ½å°‘
export default defineConfig({
  test: {
    environment: 'happy-dom',
    // ä¼˜ç‚¹ï¼šå¯åŠ¨å¿«ï¼Œå†…å­˜å ç”¨å°
    // ç¼ºç‚¹ï¼šAPI è¦†ç›–ä¸å¦‚ jsdom å®Œæ•´
  }
})
```

### ğŸŒ ç¯å¢ƒé€‰æ‹©ç­–ç•¥

```typescript
// æŒ‰æ–‡ä»¶ç±»å‹é€‰æ‹©ç¯å¢ƒ
export default defineConfig({
  test: {
    // é»˜è®¤ä½¿ç”¨ nodeï¼ˆæœ€å¿«ï¼‰
    environment: 'node',
    
    // é’ˆå¯¹ä¸åŒæ–‡ä»¶ä½¿ç”¨ä¸åŒç¯å¢ƒ
    environmentMatchGlobs: [
      // React ç»„ä»¶æµ‹è¯•ç”¨ jsdom
      ['**/*.component.test.{ts,tsx}', 'jsdom'],
      ['**/*.integration.test.{ts,tsx}', 'jsdom'],
      
      // çº¯é€»è¾‘æµ‹è¯•ç”¨ node
      ['**/*.utils.test.{ts,tsx}', 'node'],
      ['**/*.service.test.{ts,tsx}', 'node'],
    ]
  }
})
```

## é«˜çº§é…ç½®å’Œä¼˜åŒ–

### âš™ï¸ jsdom è¯¦ç»†é…ç½®

```javascript
const dom = new JSDOM(html, {
  // é¡µé¢ URL
  url: 'https://localhost:3000/',
  
  // å¼•ç”¨é¡µé¢
  referrer: 'https://google.com/',
  
  // å†…å®¹ç±»å‹
  contentType: 'text/html',
  
  // åŒ…å«çš„åŠŸèƒ½
  resources: 'usable', // æˆ– 'disable'
  
  // è¿è¡Œè„šæœ¬
  runScripts: 'dangerously', // æˆ– 'outside-only'
  
  // å­˜å‚¨é…é¢
  storageQuota: 10000000,
  
  // é¢„å®šä¹‰å…¨å±€å˜é‡
  beforeParse(window) {
    window.APP_CONFIG = {
      apiUrl: 'http://localhost:3001'
    }
  }
})
```

### ğŸ­ Mock æµè§ˆå™¨ API

```typescript
// æµ‹è¯•è®¾ç½®æ–‡ä»¶
beforeAll(() => {
  // Mock window.matchMedia
  Object.defineProperty(window, 'matchMedia', {
    writable: true,
    value: vi.fn().mockImplementation(query => ({
      matches: false,
      media: query,
      onchange: null,
      addListener: vi.fn(),
      removeListener: vi.fn(),
      addEventListener: vi.fn(),
      removeEventListener: vi.fn(),
      dispatchEvent: vi.fn(),
    }))
  })
  
  // Mock ResizeObserver
  global.ResizeObserver = vi.fn().mockImplementation(() => ({
    observe: vi.fn(),
    unobserve: vi.fn(),
    disconnect: vi.fn(),
  }))
  
  // Mock IntersectionObserver
  global.IntersectionObserver = vi.fn().mockImplementation(() => ({
    observe: vi.fn(),
    unobserve: vi.fn(),
    disconnect: vi.fn(),
  }))
})
```

### ğŸ“Š æ€§èƒ½ä¼˜åŒ–

```typescript
// æ€§èƒ½ä¼˜åŒ–é…ç½®
export default defineConfig({
  test: {
    environment: 'jsdom',
    
    // ç¯å¢ƒé€‰é¡¹
    environmentOptions: {
      jsdom: {
        resources: 'usable',
        runScripts: 'dangerously',
        
        // ç¦ç”¨ä¸éœ€è¦çš„åŠŸèƒ½
        features: {
          FetchExternalResources: false,
          ProcessExternalResources: false,
          SkipExternalResources: true
        }
      }
    },
    
    // æµ‹è¯•éš”ç¦»
    isolate: true,
    
    // å¹¶è¡Œæµ‹è¯•
    pool: 'threads'
  }
})
```

## å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### â“ å¸¸è§é”™è¯¯

```typescript
// 1. TypeError: Cannot read property 'getComputedStyle' of null
// è§£å†³ï¼šç¡®ä¿è®¾ç½®äº† jsdom ç¯å¢ƒ
test.skip('problematic test', () => {
  // ä¸´æ—¶è·³è¿‡æœ‰é—®é¢˜çš„æµ‹è¯•
})

// 2. ReferenceError: fetch is not defined
// è§£å†³ï¼šæ‰‹åŠ¨æ·»åŠ  fetch polyfill
import { vi } from 'vitest'

beforeAll(() => {
  global.fetch = vi.fn()
})

// 3. æ ·å¼ç›¸å…³æµ‹è¯•å¤±è´¥
// è§£å†³ï¼šjsdom ä¸æ¸²æŸ“ CSSï¼Œéœ€è¦ mock æˆ–ä½¿ç”¨å¿«ç…§æµ‹è¯•
expect(element).toMatchSnapshot()
```

### ğŸ”§ è°ƒè¯•æŠ€å·§

```typescript
// è°ƒè¯• DOM çŠ¶æ€
test('debug DOM', () => {
  render(<ComplexComponent />)
  
  // æ‰“å°æ•´ä¸ª DOM æ ‘
  screen.debug()
  
  // æ‰“å°ç‰¹å®šå…ƒç´ 
  const element = screen.getByRole('button')
  screen.debug(element)
  
  // æŸ¥çœ‹ DOM HTML
  console.log(document.body.innerHTML)
})
```

## æ€»ç»“

### ğŸ¯ æ ¸å¿ƒä»·å€¼
1. **ç¯å¢ƒä¸€è‡´æ€§** - åœ¨ Node.js ä¸­æ¨¡æ‹Ÿæµè§ˆå™¨ DOM
2. **æµ‹è¯•å¯è¡Œæ€§** - è®©å‰ç«¯ç»„ä»¶æµ‹è¯•æˆä¸ºå¯èƒ½
3. **API å®Œæ•´æ€§** - æä¾›æ¥è¿‘çœŸå®æµè§ˆå™¨çš„ API
4. **å¼€å‘æ•ˆç‡** - æ— éœ€çœŸå®æµè§ˆå™¨å³å¯æµ‹è¯•

### ğŸ“‹ ä½¿ç”¨å»ºè®®
- âœ… **React/Vue ç»„ä»¶æµ‹è¯•** - å¿…é¡»ä½¿ç”¨
- âœ… **DOM æ“ä½œæµ‹è¯•** - ç†æƒ³é€‰æ‹©
- âš ï¸ **çº¯é€»è¾‘æµ‹è¯•** - è€ƒè™‘ä½¿ç”¨ node ç¯å¢ƒ
- âŒ **çœŸå®æµè§ˆå™¨äº¤äº’** - ä½¿ç”¨ E2E æµ‹è¯•

### ğŸ’¡ æœ€ä½³å®è·µ
1. **æŒ‰éœ€é€‰æ‹©ç¯å¢ƒ** - ä¸æ˜¯æ‰€æœ‰æµ‹è¯•éƒ½éœ€è¦ DOM
2. **åˆç†é…ç½®** - ç¦ç”¨ä¸éœ€è¦çš„åŠŸèƒ½æå‡æ€§èƒ½
3. **é€‚å½“ Mock** - è¡¥å…… jsdom ä¸æ”¯æŒçš„ API
4. **æ¸…ç†èµ„æº** - æµ‹è¯•åæ¸…ç† DOM çŠ¶æ€

jsdom æ˜¯ç°ä»£å‰ç«¯æµ‹è¯•ä¸å¯æˆ–ç¼ºçš„å·¥å…·ï¼Œå®ƒè®©æˆ‘ä»¬èƒ½å¤Ÿåœ¨å¿«é€Ÿçš„ Node.js ç¯å¢ƒä¸­æµ‹è¯•å¤æ‚çš„ DOM äº¤äº’ï¼Œæ˜¯å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•çš„é‡è¦åŸºç¡€è®¾æ–½ã€‚
