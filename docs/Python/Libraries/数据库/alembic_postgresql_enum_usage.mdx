使用 `alembic-postgresql-enum` 库来解决 Alembic 不跟踪 PostgreSQL 枚举变化的问题。这个库可以自动处理以下操作：

- 创建新的枚举类型
- 添加/删除/修改枚举值
- 重新排序枚举值
- 删除未使用的枚举类型

## 配置

配置已经在 `api/app/db/migrations/env.py` 文件中完成，包括：

```python
# 导入 alembic_postgresql_enum 以支持 PostgreSQL 枚举类型的变更
import alembic_postgresql_enum

# 配置 alembic_postgresql_enum
alembic_postgresql_enum.set_configuration(
    alembic_postgresql_enum.Config(
        # 启用类型忽略注释，解决类型检查器的警告
        add_type_ignore=True,
        # 启用未使用枚举的清理
        drop_unused_enums=True,
        # 启用枚举值变更检测
        detect_enum_values_changes=True,
    )
)
```

## 使用方法

### 创建新的枚举类型

当你在模型中定义新的枚举类型时，Alembic 会自动创建相应的 PostgreSQL 枚举类型：

```python
class MyEnum(str, Enum):
    ONE = "one"
    TWO = "two"
    THREE = "three"

class MyModel(SQLModel, table=True):
    id: Optional[int] = Field(default=None, primary_key=True)
    status: MyEnum = Field(
        sa_column=Column(
            SQLAlchemyEnum(MyEnum, name="my_enum"),
            comment="状态",
        ),
        description="状态",
    )
```

### 添加新的枚举值

当你在枚举类中添加新的值时，Alembic 会自动生成迁移脚本来更新 PostgreSQL 枚举类型：

```python
class MyEnum(str, Enum):
    ONE = "one"
    TWO = "two"
    THREE = "three"
    FOUR = "four"  # 新增的枚举值
```

生成的迁移脚本会包含类似以下内容：

```python
def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.sync_enum_values(
        enum_schema='public', 
        enum_name='my_enum', 
        new_values=['one', 'two', 'three', 'four'], 
        affected_columns=[TableReference(table_schema='public', table_name='my_model', column_name='status')],
        enum_values_to_rename=[],
    )
    # ### end Alembic commands ###
```

### 删除枚举值

当你从枚举类中删除值时，Alembic 也会自动生成迁移脚本：

```python
class MyEnum(str, Enum):
    ONE = "one"
    TWO = "two"
    # THREE = "three"  # 已删除的枚举值
    FOUR = "four"
```

### 重命名枚举值

当你需要重命名枚举值时，Alembic 会生成迁移脚本，但你需要手动编辑它来指定重命名关系：

原始生成的脚本：
```python
def upgrade():
    op.sync_enum_values(
        enum_schema='public', 
        enum_name='my_enum', 
        new_values=['one', 'two', 'four', 'five'], 
        affected_columns=[TableReference(table_schema='public', table_name='my_model', column_name='status')],
        enum_values_to_rename=[],
    )
```

手动编辑后的脚本：
```python
def upgrade():
    op.sync_enum_values(
        enum_schema='public', 
        enum_name='my_enum', 
        new_values=['one', 'two', 'four', 'five'], 
        affected_columns=[TableReference(table_schema='public', table_name='my_model', column_name='status')],
        enum_values_to_rename=[('three', 'five')],  # 指定重命名关系：从 'three' 重命名为 'five'
    )
```

## 注意事项

1. 确保在修改枚举类型时，考虑到现有数据的兼容性
2. 重命名枚举值时，必须手动编辑迁移脚本，指定重命名关系
3. 删除枚举值时，确保没有数据引用这些值，否则迁移会失败

## 更多信息

更多详细信息，请参考 [alembic-postgresql-enum 官方文档](https://github.com/Pogchamp-company/alembic-postgresql-enum)。
