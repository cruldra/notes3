# Rust 模块系统详解

## 📚 什么是模块？

**模块**（Module）是 Rust 中组织代码的基本单位，类似于其他语言中的命名空间或包。

### 模块的作用

- ✅ **组织代码** - 将相关功能分组
- ✅ **控制可见性** - 决定哪些代码是公开的
- ✅ **避免命名冲突** - 不同模块可以有同名函数
- ✅ **代码复用** - 模块可以被其他模块引用

---

## 🎯 模块的三种组织方式

### 1️⃣ 内联模块（同一文件）

**适用场景**: 小型项目、快速原型

```rust
// main.rs
mod math {
    pub fn add(a: i32, b: i32) -> i32 {
        a + b
    }
    
    pub mod advanced {
        pub fn multiply(a: i32, b: i32) -> i32 {
            a * b
        }
    }
}

fn main() {
    let sum = math::add(1, 2);
    let product = math::advanced::multiply(3, 4);
    
    println!("Sum: {}, Product: {}", sum, product);
}
```

**特点**:
- ✅ 简单直接
- ✅ 适合小项目
- ❌ 文件会变得很大
- ❌ 难以维护

---

### 2️⃣ 分离到单独文件（现代风格）⭐

**适用场景**: 中大型项目（推荐）

#### 基本结构

```
src/
├── main.rs
└── math.rs
```

```rust
// main.rs
mod math;  // 声明模块，Rust 会自动找 math.rs

fn main() {
    let sum = math::add(1, 2);
    println!("Sum: {}", sum);
}
```

```rust
// math.rs
pub fn add(a: i32, b: i32) -> i32 {
    a + b
}

pub fn subtract(a: i32, b: i32) -> i32 {
    a - b
}
```

#### 带子模块的结构

```
src/
├── main.rs
├── math.rs
└── math/
    ├── basic.rs
    └── advanced.rs
```

```rust
// main.rs
mod math;

fn main() {
    math::basic::add(1, 2);
    math::advanced::multiply(3, 4);
}
```

```rust
// math.rs
pub mod basic;     // 声明子模块，对应 math/basic.rs
pub mod advanced;  // 声明子模块，对应 math/advanced.rs

pub fn init() {
    println!("Math module initialized");
}
```

```rust
// math/basic.rs
pub fn add(a: i32, b: i32) -> i32 {
    a + b
}

pub fn subtract(a: i32, b: i32) -> i32 {
    a - b
}
```

```rust
// math/advanced.rs
pub fn multiply(a: i32, b: i32) -> i32 {
    a * b
}

pub fn divide(a: i32, b: i32) -> i32 {
    a / b
}
```

---

### 3️⃣ 使用 mod.rs（旧风格）

**适用场景**: 维护旧项目

```
src/
├── main.rs
└── math/
    ├── mod.rs      ← 父模块
    ├── basic.rs    ← 子模块
    └── advanced.rs ← 子模块
```

```rust
// main.rs
mod math;

fn main() {
    math::basic::add(1, 2);
}
```

```rust
// math/mod.rs
pub mod basic;
pub mod advanced;

pub fn init() {
    println!("Math module initialized");
}
```

```rust
// math/basic.rs
pub fn add(a: i32, b: i32) -> i32 {
    a + b
}
```

**缺点**:
- ❌ 多个 `mod.rs` 文件名相同，IDE 难区分
- ❌ 父模块没有独立的文件名

---

## 📊 两种风格对比

| 特性 | 现代风格 | 旧风格 |
|------|---------|--------|
| **父模块文件** | `parent.rs` | `parent/mod.rs` |
| **子模块文件** | `parent/child.rs` | `parent/child.rs` |
| **清晰度** | ✅ 高 | ⚠️ 中 |
| **IDE 支持** | ✅ 好 | ⚠️ 一般 |
| **推荐度** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ |

---

## 🎨 完整示例：Web 应用

### 项目结构

```
my_web_app/
├── Cargo.toml
└── src/
    ├── main.rs
    ├── config.rs
    ├── routes.rs
    ├── routes/
    │   ├── user.rs
    │   ├── post.rs
    │   └── auth.rs
    ├── models.rs
    ├── models/
    │   ├── user.rs
    │   └── post.rs
    ├── database.rs
    └── database/
        ├── mysql.rs
        └── postgres.rs
```

### 代码实现

```rust
// main.rs
mod config;
mod routes;
mod models;
mod database;

fn main() {
    config::load();
    database::init();
    
    routes::user::list();
    routes::post::create();
    
    let user = models::user::find_by_id(1);
}
```

```rust
// config.rs
pub struct Config {
    pub port: u16,
    pub host: String,
}

pub fn load() -> Config {
    Config {
        port: 8080,
        host: "localhost".to_string(),
    }
}
```

```rust
// routes.rs
pub mod user;
pub mod post;
pub mod auth;

pub fn init() {
    println!("Routes initialized");
}
```

```rust
// routes/user.rs
pub fn list() {
    println!("Listing users...");
}

pub fn create() {
    println!("Creating user...");
}

pub fn update(id: i32) {
    println!("Updating user {}...", id);
}

pub fn delete(id: i32) {
    println!("Deleting user {}...", id);
}
```

```rust
// routes/post.rs
pub fn list() {
    println!("Listing posts...");
}

pub fn create() {
    println!("Creating post...");
}
```

```rust
// routes/auth.rs
pub fn login(username: &str, password: &str) -> bool {
    println!("Logging in user: {}", username);
    true
}

pub fn logout() {
    println!("Logging out...");
}
```

```rust
// models.rs
pub mod user;
pub mod post;
```

```rust
// models/user.rs
pub struct User {
    pub id: i32,
    pub name: String,
    pub email: String,
}

pub fn find_by_id(id: i32) -> Option<User> {
    println!("Finding user with id: {}", id);
    Some(User {
        id,
        name: "Alice".to_string(),
        email: "alice@example.com".to_string(),
    })
}

pub fn find_all() -> Vec<User> {
    println!("Finding all users...");
    vec![]
}
```

```rust
// models/post.rs
pub struct Post {
    pub id: i32,
    pub title: String,
    pub content: String,
    pub author_id: i32,
}

pub fn find_by_id(id: i32) -> Option<Post> {
    println!("Finding post with id: {}", id);
    None
}
```

```rust
// database.rs
pub mod mysql;
pub mod postgres;

pub fn init() {
    println!("Database module initialized");
}
```

```rust
// database/mysql.rs
pub fn connect() {
    println!("Connecting to MySQL...");
}

pub fn query(sql: &str) {
    println!("Executing MySQL query: {}", sql);
}
```

```rust
// database/postgres.rs
pub fn connect() {
    println!("Connecting to PostgreSQL...");
}

pub fn query(sql: &str) {
    println!("Executing PostgreSQL query: {}", sql);
}
```

---

## 🔑 模块查找规则

### 规则表

| 声明位置 | 查找文件 |
|---------|---------|
| `main.rs` 中 `mod foo;` | `foo.rs` 或 `foo/mod.rs` |
| `lib.rs` 中 `mod foo;` | `foo.rs` 或 `foo/mod.rs` |
| `foo.rs` 中 `mod bar;` | `foo/bar.rs` |
| `foo/mod.rs` 中 `mod bar;` | `foo/bar.rs` |

### 示例

```rust
// main.rs
mod database;  // 查找 database.rs 或 database/mod.rs
```

```rust
// database.rs
pub mod mysql;  // 查找 database/mysql.rs
```

```rust
// database/mysql.rs
pub mod connection;  // 查找 database/mysql/connection.rs
```

---

## 🔒 可见性控制

### pub 关键字

```rust
// math.rs
pub fn public_function() {
    println!("This is public");
}

fn private_function() {
    println!("This is private");
}

pub mod advanced {
    pub fn multiply(a: i32, b: i32) -> i32 {
        a * b
    }
}

mod internal {
    pub fn helper() {
        println!("Internal helper");
    }
}
```

```rust
// main.rs
mod math;

fn main() {
    math::public_function();  // ✅ 可以访问
    // math::private_function();  // ❌ 错误：私有函数
    
    math::advanced::multiply(2, 3);  // ✅ 可以访问
    // math::internal::helper();  // ❌ 错误：私有模块
}
```

### pub(crate) - 仅在当前 crate 可见

```rust
// lib.rs
pub(crate) fn internal_api() {
    println!("Only visible within this crate");
}
```

### pub(super) - 仅在父模块可见

```rust
// parent.rs
mod child {
    pub(super) fn helper() {
        println!("Only visible to parent");
    }
}

fn parent_function() {
    child::helper();  // ✅ 可以访问
}
```

---

## 📦 use 关键字

### 基本用法

```rust
// 不使用 use
fn main() {
    std::collections::HashMap::new();
    std::io::stdin();
}

// 使用 use
use std::collections::HashMap;
use std::io::stdin;

fn main() {
    HashMap::new();
    stdin();
}
```

### 导入多个项

```rust
use std::collections::{HashMap, HashSet, BTreeMap};
use std::io::{self, Read, Write};  // self 表示 std::io 本身
```

### 重命名

```rust
use std::collections::HashMap as Map;
use std::io::Result as IoResult;

fn main() {
    let map = Map::new();
}
```

### 导入所有公开项（不推荐）

```rust
use std::collections::*;  // 导入所有公开项
```

### 重新导出

```rust
// lib.rs
mod internal {
    pub fn helper() {}
}

pub use internal::helper;  // 重新导出，外部可以直接使用
```

---

## 🎯 最佳实践

### ✅ 推荐做法

1. **使用现代风格**
   ```
   src/
   ├── main.rs
   ├── parent.rs
   └── parent/
       └── child.rs
   ```

2. **一个文件一个模块**
   - 保持文件小而专注（< 300 行）
   - 每个文件只负责一个功能

3. **按功能组织，不是按类型**
   ```
   ✅ 好：
   src/
   ├── user/
   │   ├── model.rs
   │   ├── service.rs
   │   └── controller.rs
   
   ❌ 差：
   src/
   ├── models/
   │   └── user.rs
   ├── services/
   │   └── user.rs
   └── controllers/
       └── user.rs
   ```

4. **使用 pub use 简化路径**
   ```rust
   // lib.rs
   pub use models::user::User;
   pub use models::post::Post;
   
   // 外部使用
   use my_crate::{User, Post};  // 而不是 my_crate::models::user::User
   ```

5. **避免过度嵌套**
   - 最多 3-4 层
   - 超过 4 层考虑重构

### ❌ 避免做法

1. ❌ 所有代码放在一个文件
2. ❌ 混用新旧风格
3. ❌ 循环依赖
4. ❌ 过度使用 `pub`（暴露太多内部实现）
5. ❌ 使用 `use *`（污染命名空间）

---

## 🐛 常见错误

### 错误 1: 忘记声明模块

```rust
// main.rs
// ❌ 错误：忘记声明 math 模块
fn main() {
    math::add(1, 2);  // 错误：找不到 math
}
```

```rust
// ✅ 正确
mod math;  // 声明模块

fn main() {
    math::add(1, 2);
}
```

### 错误 2: 私有模块

```rust
// lib.rs
mod internal {  // ❌ 私有模块
    pub fn helper() {}
}
```

```rust
// main.rs
use my_crate::internal::helper;  // ❌ 错误：internal 是私有的
```

```rust
// ✅ 正确
pub mod internal {  // 公开模块
    pub fn helper() {}
}
```

### 错误 3: 循环依赖

```rust
// a.rs
use crate::b;

pub fn func_a() {
    b::func_b();
}
```

```rust
// b.rs
use crate::a;  // ❌ 循环依赖

pub fn func_b() {
    a::func_a();
}
```

**解决方案**: 提取公共逻辑到第三个模块

---

## 📚 总结

### 核心要点

1. **模块声明**: `mod foo;` 声明模块
2. **文件查找**: `foo.rs` 或 `foo/mod.rs`
3. **子模块**: 在 `foo.rs` 中声明 `mod bar;`，查找 `foo/bar.rs`
4. **可见性**: 使用 `pub` 控制
5. **导入**: 使用 `use` 简化路径

### 模块组织模式

| 场景 | 推荐方式 |
|------|---------|
| 小项目 | 内联模块 |
| 中大型项目 | 现代风格（`parent.rs` + `parent/`） |
| 维护旧项目 | 旧风格（`parent/mod.rs`） |

### 记忆口诀

- **mod** = 声明模块
- **pub** = 公开访问
- **use** = 导入简化
- **现代风格** = 文件名清晰
- **旧风格** = mod.rs 混乱

掌握模块系统是组织大型 Rust 项目的关键！🦀✨

