"use strict";(self.webpackChunknotes_3=self.webpackChunknotes_3||[]).push([[1356],{54213:(e,n,d)=>{d.d(n,{R:()=>r,x:()=>t});var l=d(36672);const s={},i=l.createContext(s);function r(e){const n=l.useContext(i);return l.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),l.createElement(i.Provider,{value:n},e.children)}},73045:(e,n,d)=>{d.r(n),d.d(n,{assets:()=>o,contentTitle:()=>t,default:()=>h,frontMatter:()=>r,metadata:()=>l,toc:()=>c});const l=JSON.parse('{"id":"Tools/Comfyui/UNETLoader\u8282\u70b9\u8be6\u7ec6\u5206\u6790","title":"UNETLoader \u8282\u70b9\u8be6\u7ec6\u5206\u6790","description":"\u6982\u8ff0","source":"@site/docs/Tools/Comfyui/UNETLoader\u8282\u70b9\u8be6\u7ec6\u5206\u6790.md","sourceDirName":"Tools/Comfyui","slug":"/Tools/Comfyui/UNETLoader\u8282\u70b9\u8be6\u7ec6\u5206\u6790","permalink":"/notes3/docs/Tools/Comfyui/UNETLoader\u8282\u70b9\u8be6\u7ec6\u5206\u6790","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Tools/Comfyui/UNETLoader\u8282\u70b9\u8be6\u7ec6\u5206\u6790.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tools","previous":{"title":"MMDiT (Multimodal Diffusion Transformer) \u6a21\u578b\u8be6\u89e3","permalink":"/notes3/docs/Tools/Comfyui/MMDiT\u6a21\u578b\u8be6\u89e3"},"next":{"title":"VAEDecode \u8282\u70b9\u8be6\u7ec6\u5206\u6790","permalink":"/notes3/docs/Tools/Comfyui/VAEDecode\u8282\u70b9\u8be6\u7ec6\u5206\u6790"}}');var s=d(23420),i=d(54213);const r={},t="UNETLoader \u8282\u70b9\u8be6\u7ec6\u5206\u6790",o={},c=[{value:"\u6982\u8ff0",id:"\u6982\u8ff0",level:2},{value:"\u8282\u70b9\u57fa\u672c\u4fe1\u606f",id:"\u8282\u70b9\u57fa\u672c\u4fe1\u606f",level:2},{value:"\u7c7b\u5b9a\u4e49",id:"\u7c7b\u5b9a\u4e49",level:3},{value:"\u663e\u793a\u540d\u79f0",id:"\u663e\u793a\u540d\u79f0",level:3},{value:"\u8f93\u5165\u8f93\u51fa\u89c4\u683c",id:"\u8f93\u5165\u8f93\u51fa\u89c4\u683c",level:2},{value:"\u8f93\u5165\u53c2\u6570\u8be6\u89e3",id:"\u8f93\u5165\u53c2\u6570\u8be6\u89e3",level:3},{value:"\u53c2\u6570\u8be6\u7ec6\u8bf4\u660e",id:"\u53c2\u6570\u8be6\u7ec6\u8bf4\u660e",level:4},{value:"\u8f93\u51fa\u7c7b\u578b",id:"\u8f93\u51fa\u7c7b\u578b",level:3},{value:"\u6838\u5fc3\u5b9e\u73b0\u5206\u6790",id:"\u6838\u5fc3\u5b9e\u73b0\u5206\u6790",level:2},{value:"\u4e3b\u8981\u6267\u884c\u51fd\u6570",id:"\u4e3b\u8981\u6267\u884c\u51fd\u6570",level:3},{value:"\u6267\u884c\u6d41\u7a0b\u56fe",id:"\u6267\u884c\u6d41\u7a0b\u56fe",level:3},{value:"\u6570\u636e\u7c7b\u578b\u8be6\u89e3",id:"\u6570\u636e\u7c7b\u578b\u8be6\u89e3",level:2},{value:"FP8\u6570\u636e\u7c7b\u578b\u5bf9\u6bd4",id:"fp8\u6570\u636e\u7c7b\u578b\u5bf9\u6bd4",level:3},{value:"\u6570\u636e\u7c7b\u578b\u9009\u62e9\u7b56\u7565",id:"\u6570\u636e\u7c7b\u578b\u9009\u62e9\u7b56\u7565",level:3},{value:"\u6df1\u5ea6\u6280\u672f\u5206\u6790",id:"\u6df1\u5ea6\u6280\u672f\u5206\u6790",level:2},{value:"1. \u6a21\u578b\u52a0\u8f7d\u673a\u5236",id:"1-\u6a21\u578b\u52a0\u8f7d\u673a\u5236",level:3},{value:"2. \u6a21\u578b\u7c7b\u578b\u68c0\u6d4b",id:"2-\u6a21\u578b\u7c7b\u578b\u68c0\u6d4b",level:3},{value:"3. \u8bbe\u5907\u548c\u5185\u5b58\u7ba1\u7406",id:"3-\u8bbe\u5907\u548c\u5185\u5b58\u7ba1\u7406",level:3},{value:"\u4e0eCheckpointLoaderSimple\u7684\u5bf9\u6bd4",id:"\u4e0echeckpointloadersimple\u7684\u5bf9\u6bd4",level:2},{value:"\u529f\u80fd\u5bf9\u6bd4",id:"\u529f\u80fd\u5bf9\u6bd4",level:3},{value:"\u4f7f\u7528\u573a\u666f\u5bf9\u6bd4",id:"\u4f7f\u7528\u573a\u666f\u5bf9\u6bd4",level:3},{value:"UNETLoader\u9002\u7528\u573a\u666f",id:"unetloader\u9002\u7528\u573a\u666f",level:4},{value:"CheckpointLoaderSimple\u9002\u7528\u573a\u666f",id:"checkpointloadersimple\u9002\u7528\u573a\u666f",level:4},{value:"\u6027\u80fd\u4f18\u5316\u7b56\u7565",id:"\u6027\u80fd\u4f18\u5316\u7b56\u7565",level:2},{value:"1. \u5185\u5b58\u4f18\u5316",id:"1-\u5185\u5b58\u4f18\u5316",level:3},{value:"FP8\u91cf\u5316\u6548\u679c",id:"fp8\u91cf\u5316\u6548\u679c",level:4},{value:"\u6279\u5904\u7406\u4f18\u5316",id:"\u6279\u5904\u7406\u4f18\u5316",level:4},{value:"2. \u901f\u5ea6\u4f18\u5316",id:"2-\u901f\u5ea6\u4f18\u5316",level:3},{value:"FP8\u4f18\u5316\u9009\u9879",id:"fp8\u4f18\u5316\u9009\u9879",level:4},{value:"\u9884\u7f16\u8bd1\u4f18\u5316",id:"\u9884\u7f16\u8bd1\u4f18\u5316",level:4},{value:"\u4f7f\u7528\u793a\u4f8b\u548c\u6700\u4f73\u5b9e\u8df5",id:"\u4f7f\u7528\u793a\u4f8b\u548c\u6700\u4f73\u5b9e\u8df5",level:2},{value:"\u57fa\u672c\u7528\u6cd5",id:"\u57fa\u672c\u7528\u6cd5",level:3},{value:"\u9ad8\u7ea7\u7ec4\u5408\u5de5\u4f5c\u6d41",id:"\u9ad8\u7ea7\u7ec4\u5408\u5de5\u4f5c\u6d41",level:3},{value:"\u5185\u5b58\u53d7\u9650\u73af\u5883",id:"\u5185\u5b58\u53d7\u9650\u73af\u5883",level:3},{value:"\u5e38\u89c1\u95ee\u9898\u548c\u89e3\u51b3\u65b9\u6848",id:"\u5e38\u89c1\u95ee\u9898\u548c\u89e3\u51b3\u65b9\u6848",level:2},{value:"1. \u6a21\u578b\u52a0\u8f7d\u5931\u8d25",id:"1-\u6a21\u578b\u52a0\u8f7d\u5931\u8d25",level:3},{value:"2. FP8\u4e0d\u652f\u6301\u9519\u8bef",id:"2-fp8\u4e0d\u652f\u6301\u9519\u8bef",level:3},{value:"3. \u5185\u5b58\u4e0d\u8db3",id:"3-\u5185\u5b58\u4e0d\u8db3",level:3},{value:"4. \u6027\u80fd\u95ee\u9898",id:"4-\u6027\u80fd\u95ee\u9898",level:3},{value:"\u6587\u4ef6\u7ec4\u7ec7\u6700\u4f73\u5b9e\u8df5",id:"\u6587\u4ef6\u7ec4\u7ec7\u6700\u4f73\u5b9e\u8df5",level:2},{value:"\u76ee\u5f55\u7ed3\u6784",id:"\u76ee\u5f55\u7ed3\u6784",level:3},{value:"\u547d\u540d\u89c4\u8303",id:"\u547d\u540d\u89c4\u8303",level:3},{value:"\u9ad8\u7ea7\u5e94\u7528\u573a\u666f",id:"\u9ad8\u7ea7\u5e94\u7528\u573a\u666f",level:2},{value:"1. \u6a21\u578b\u5fae\u8c03\u548c\u5b9e\u9a8c",id:"1-\u6a21\u578b\u5fae\u8c03\u548c\u5b9e\u9a8c",level:3},{value:"A/B\u6d4b\u8bd5\u4e0d\u540cUNET",id:"ab\u6d4b\u8bd5\u4e0d\u540cunet",level:4},{value:"\u81ea\u5b9a\u4e49\u6a21\u578b\u7ec4\u5408",id:"\u81ea\u5b9a\u4e49\u6a21\u578b\u7ec4\u5408",level:4},{value:"2. \u751f\u4ea7\u73af\u5883\u4f18\u5316",id:"2-\u751f\u4ea7\u73af\u5883\u4f18\u5316",level:3},{value:"\u670d\u52a1\u5668\u90e8\u7f72\u914d\u7f6e",id:"\u670d\u52a1\u5668\u90e8\u7f72\u914d\u7f6e",level:4},{value:"\u6279\u91cf\u5904\u7406\u4f18\u5316",id:"\u6279\u91cf\u5904\u7406\u4f18\u5316",level:4},{value:"3. \u7814\u7a76\u548c\u5f00\u53d1",id:"3-\u7814\u7a76\u548c\u5f00\u53d1",level:3},{value:"\u6a21\u578b\u6027\u80fd\u57fa\u51c6\u6d4b\u8bd5",id:"\u6a21\u578b\u6027\u80fd\u57fa\u51c6\u6d4b\u8bd5",level:4},{value:"\u6545\u969c\u6392\u9664\u548c\u8c03\u8bd5",id:"\u6545\u969c\u6392\u9664\u548c\u8c03\u8bd5",level:2},{value:"\u8bca\u65ad\u5de5\u5177",id:"\u8bca\u65ad\u5de5\u5177",level:3},{value:"\u6a21\u578b\u517c\u5bb9\u6027\u68c0\u67e5",id:"\u6a21\u578b\u517c\u5bb9\u6027\u68c0\u67e5",level:4},{value:"FP8\u652f\u6301\u68c0\u6d4b",id:"fp8\u652f\u6301\u68c0\u6d4b",level:4},{value:"\u5e38\u89c1\u9519\u8bef\u89e3\u51b3\u65b9\u6848",id:"\u5e38\u89c1\u9519\u8bef\u89e3\u51b3\u65b9\u6848",level:3},{value:"\u9519\u8bef\u4ee3\u7801\u5bf9\u7167\u8868",id:"\u9519\u8bef\u4ee3\u7801\u5bf9\u7167\u8868",level:4},{value:"\u81ea\u52a8\u6545\u969c\u6062\u590d",id:"\u81ea\u52a8\u6545\u969c\u6062\u590d",level:4},{value:"\u6027\u80fd\u76d1\u63a7\u548c\u4f18\u5316",id:"\u6027\u80fd\u76d1\u63a7\u548c\u4f18\u5316",level:2},{value:"\u5b9e\u65f6\u76d1\u63a7\u6307\u6807",id:"\u5b9e\u65f6\u76d1\u63a7\u6307\u6807",level:3},{value:"\u4f18\u5316\u5efa\u8bae\u751f\u6210\u5668",id:"\u4f18\u5316\u5efa\u8bae\u751f\u6210\u5668",level:3},{value:"\u603b\u7ed3",id:"\u603b\u7ed3",level:2},{value:"\u76f8\u5173\u8d44\u6e90",id:"\u76f8\u5173\u8d44\u6e90",level:2}];function a(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"unetloader-\u8282\u70b9\u8be6\u7ec6\u5206\u6790",children:"UNETLoader \u8282\u70b9\u8be6\u7ec6\u5206\u6790"})}),"\n",(0,s.jsx)(n.h2,{id:"\u6982\u8ff0",children:"\u6982\u8ff0"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"UNETLoader"})," \u662fComfyUI\u4e2d\u7684\u9ad8\u7ea7\u6a21\u578b\u52a0\u8f7d\u8282\u70b9\uff0c\u4e13\u95e8\u7528\u4e8e\u72ec\u7acb\u52a0\u8f7d\u6269\u6563\u6a21\u578b\uff08UNET\uff09\u800c\u4e0d\u5305\u542bCLIP\u548cVAE\u7ec4\u4ef6\u3002\u5b83\u63d0\u4f9b\u4e86\u7cbe\u7ec6\u7684\u6570\u636e\u7c7b\u578b\u63a7\u5236\uff0c\u7279\u522b\u9002\u7528\u4e8e\u9700\u8981\u81ea\u5b9a\u4e49\u6a21\u578b\u7ec4\u5408\u6216\u9ad8\u7ea7\u6027\u80fd\u4f18\u5316\u7684\u573a\u666f\u3002"]}),"\n",(0,s.jsx)(n.h2,{id:"\u8282\u70b9\u57fa\u672c\u4fe1\u606f",children:"\u8282\u70b9\u57fa\u672c\u4fe1\u606f"}),"\n",(0,s.jsx)(n.h3,{id:"\u7c7b\u5b9a\u4e49",children:"\u7c7b\u5b9a\u4e49"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'class UNETLoader:\n    CATEGORY = "advanced/loaders"\n    FUNCTION = "load_unet"\n    RETURN_TYPES = ("MODEL",)\n'})}),"\n",(0,s.jsx)(n.h3,{id:"\u663e\u793a\u540d\u79f0",children:"\u663e\u793a\u540d\u79f0"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"\u5185\u90e8\u540d\u79f0"}),": ",(0,s.jsx)(n.code,{children:"UNETLoader"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"\u663e\u793a\u540d\u79f0"}),": ",(0,s.jsx)(n.code,{children:"Load Diffusion Model"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"\u7c7b\u522b"}),": ",(0,s.jsx)(n.code,{children:"advanced/loaders"})]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"\u8f93\u5165\u8f93\u51fa\u89c4\u683c",children:"\u8f93\u5165\u8f93\u51fa\u89c4\u683c"}),"\n",(0,s.jsx)(n.h3,{id:"\u8f93\u5165\u53c2\u6570\u8be6\u89e3",children:"\u8f93\u5165\u53c2\u6570\u8be6\u89e3"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'@classmethod\ndef INPUT_TYPES(s):\n    return {\n        "required": {\n            "unet_name": (folder_paths.get_filename_list("diffusion_models"), ),\n            "weight_dtype": (["default", "fp8_e4m3fn", "fp8_e4m3fn_fast", "fp8_e5m2"], )\n        }\n    }\n'})}),"\n",(0,s.jsx)(n.h4,{id:"\u53c2\u6570\u8be6\u7ec6\u8bf4\u660e",children:"\u53c2\u6570\u8be6\u7ec6\u8bf4\u660e"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"unet_name"})," (\u9009\u62e9\u5217\u8868)"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u6269\u6563\u6a21\u578b\u6587\u4ef6\u540d"}),"\n",(0,s.jsxs)(n.li,{children:["\u6765\u6e90\uff1a",(0,s.jsx)(n.code,{children:"models/diffusion_models/"})," \u76ee\u5f55"]}),"\n",(0,s.jsxs)(n.li,{children:["\u652f\u6301\u683c\u5f0f\uff1a",(0,s.jsx)(n.code,{children:".safetensors"}),", ",(0,s.jsx)(n.code,{children:".ckpt"}),", ",(0,s.jsx)(n.code,{children:".pt"}),", ",(0,s.jsx)(n.code,{children:".pth"})]}),"\n",(0,s.jsx)(n.li,{children:"\u5305\u542b\u72ec\u7acb\u7684UNET\u6a21\u578b\u6587\u4ef6"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"weight_dtype"})," (\u9009\u62e9\u5217\u8868)"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u6a21\u578b\u6743\u91cd\u6570\u636e\u7c7b\u578b"}),"\n",(0,s.jsxs)(n.li,{children:["\u9009\u9879\uff1a","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"default"}),": \u81ea\u52a8\u9009\u62e9\u6700\u4f18\u6570\u636e\u7c7b\u578b"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"fp8_e4m3fn"}),": 8\u4f4d\u6d6e\u70b9\uff08\u6807\u51c6\uff09"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"fp8_e4m3fn_fast"}),": 8\u4f4d\u6d6e\u70b9\uff08\u4f18\u5316\u7248\uff09"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"fp8_e5m2"}),": 8\u4f4d\u6d6e\u70b9\uff08\u9ad8\u7cbe\u5ea6\uff09"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"\u8f93\u51fa\u7c7b\u578b",children:"\u8f93\u51fa\u7c7b\u578b"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'RETURN_TYPES = ("MODEL",)\n'})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"\u8f93\u51fa\u8bf4\u660e"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"MODEL"}),": \u72ec\u7acb\u7684\u6269\u6563\u6a21\u578b\uff0c\u53ef\u4e0e\u5176\u4ed6CLIP\u548cVAE\u7ec4\u5408\u4f7f\u7528"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"\u6838\u5fc3\u5b9e\u73b0\u5206\u6790",children:"\u6838\u5fc3\u5b9e\u73b0\u5206\u6790"}),"\n",(0,s.jsx)(n.h3,{id:"\u4e3b\u8981\u6267\u884c\u51fd\u6570",children:"\u4e3b\u8981\u6267\u884c\u51fd\u6570"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'def load_unet(self, unet_name, weight_dtype):\n    model_options = {}\n    if weight_dtype == "fp8_e4m3fn":\n        model_options["dtype"] = torch.float8_e4m3fn\n    elif weight_dtype == "fp8_e4m3fn_fast":\n        model_options["dtype"] = torch.float8_e4m3fn\n        model_options["fp8_optimizations"] = True\n    elif weight_dtype == "fp8_e5m2":\n        model_options["dtype"] = torch.float8_e5m2\n\n    unet_path = folder_paths.get_full_path_or_raise("diffusion_models", unet_name)\n    model = comfy.sd.load_diffusion_model(unet_path, model_options=model_options)\n    return (model,)\n'})}),"\n",(0,s.jsx)(n.h3,{id:"\u6267\u884c\u6d41\u7a0b\u56fe",children:"\u6267\u884c\u6d41\u7a0b\u56fe"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-mermaid",children:'flowchart TD\n    A[\u63a5\u6536\u53c2\u6570] --\x3e B[\u5904\u7406weight_dtype]\n    B --\x3e C[\u6784\u5efamodel_options]\n    C --\x3e D[\u83b7\u53d6\u6a21\u578b\u8def\u5f84]\n    D --\x3e E[\u8c03\u7528load_diffusion_model]\n    E --\x3e F[\u8fd4\u56deMODEL]\n    \n    subgraph "\u6570\u636e\u7c7b\u578b\u5904\u7406"\n        B --\x3e B1[default: \u81ea\u52a8\u9009\u62e9]\n        B --\x3e B2[fp8_e4m3fn: \u6807\u51c68\u4f4d]\n        B --\x3e B3[fp8_e4m3fn_fast: \u4f18\u53168\u4f4d]\n        B --\x3e B4[fp8_e5m2: \u9ad8\u7cbe\u5ea68\u4f4d]\n    end\n    \n    subgraph "\u6a21\u578b\u52a0\u8f7d\u8fc7\u7a0b"\n        E --\x3e E1[\u52a0\u8f7dtorch\u6587\u4ef6]\n        E --\x3e E2[\u68c0\u6d4b\u6a21\u578b\u7c7b\u578b]\n        E --\x3e E3[\u914d\u7f6e\u6570\u636e\u7c7b\u578b]\n        E --\x3e E4[\u521b\u5efaModelPatcher]\n    end\n    \n    subgraph "\u4f18\u5316\u9009\u9879"\n        C --\x3e C1[\u8bbe\u7f6edtype]\n        C --\x3e C2[\u542f\u7528fp8\u4f18\u5316]\n        C --\x3e C3[\u81ea\u5b9a\u4e49\u64cd\u4f5c]\n    end\n'})}),"\n",(0,s.jsx)(n.h2,{id:"\u6570\u636e\u7c7b\u578b\u8be6\u89e3",children:"\u6570\u636e\u7c7b\u578b\u8be6\u89e3"}),"\n",(0,s.jsx)(n.h3,{id:"fp8\u6570\u636e\u7c7b\u578b\u5bf9\u6bd4",children:"FP8\u6570\u636e\u7c7b\u578b\u5bf9\u6bd4"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"\u6570\u636e\u7c7b\u578b"}),(0,s.jsx)(n.th,{children:"\u7cbe\u5ea6"}),(0,s.jsx)(n.th,{children:"\u5185\u5b58\u5360\u7528"}),(0,s.jsx)(n.th,{children:"\u901f\u5ea6"}),(0,s.jsx)(n.th,{children:"\u9002\u7528\u573a\u666f"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"default"})}),(0,s.jsx)(n.td,{children:"\u81ea\u52a8"}),(0,s.jsx)(n.td,{children:"\u53d8\u5316"}),(0,s.jsx)(n.td,{children:"\u5e73\u8861"}),(0,s.jsx)(n.td,{children:"\u901a\u7528\u63a8\u8350"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"fp8_e4m3fn"})}),(0,s.jsx)(n.td,{children:"\u6807\u51c6"}),(0,s.jsx)(n.td,{children:"50%\u51cf\u5c11"}),(0,s.jsx)(n.td,{children:"\u5feb"}),(0,s.jsx)(n.td,{children:"\u5185\u5b58\u53d7\u9650"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"fp8_e4m3fn_fast"})}),(0,s.jsx)(n.td,{children:"\u6807\u51c6"}),(0,s.jsx)(n.td,{children:"50%\u51cf\u5c11"}),(0,s.jsx)(n.td,{children:"\u6700\u5feb"}),(0,s.jsx)(n.td,{children:"\u901f\u5ea6\u4f18\u5148"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"fp8_e5m2"})}),(0,s.jsx)(n.td,{children:"\u9ad8\u7cbe\u5ea6"}),(0,s.jsx)(n.td,{children:"50%\u51cf\u5c11"}),(0,s.jsx)(n.td,{children:"\u4e2d\u7b49"}),(0,s.jsx)(n.td,{children:"\u8d28\u91cf\u4f18\u5148"})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"\u6570\u636e\u7c7b\u578b\u9009\u62e9\u7b56\u7565",children:"\u6570\u636e\u7c7b\u578b\u9009\u62e9\u7b56\u7565"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-mermaid",children:'flowchart TD\n    A[\u9009\u62e9\u6570\u636e\u7c7b\u578b] --\x3e B{\u4e3b\u8981\u9700\u6c42?}\n    \n    B --\x3e|\u5185\u5b58\u4e0d\u8db3| C[fp8_e4m3fn]\n    B --\x3e|\u901f\u5ea6\u4f18\u5148| D[fp8_e4m3fn_fast]\n    B --\x3e|\u8d28\u91cf\u4f18\u5148| E[fp8_e5m2]\n    B --\x3e|\u5e73\u8861| F[default]\n    \n    C --\x3e C1[\u51cf\u5c1150%\u5185\u5b58]\n    D --\x3e D1[\u6700\u5feb\u63a8\u7406\u901f\u5ea6]\n    E --\x3e E1[\u66f4\u9ad8\u7cbe\u5ea6]\n    F --\x3e F1[\u81ea\u52a8\u4f18\u5316]\n    \n    subgraph "\u786c\u4ef6\u8981\u6c42"\n        G[\u652f\u6301FP8\u7684GPU]\n        H[RTX 40\u7cfb\u5217]\n        I[H100/A100]\n    end\n'})}),"\n",(0,s.jsx)(n.h2,{id:"\u6df1\u5ea6\u6280\u672f\u5206\u6790",children:"\u6df1\u5ea6\u6280\u672f\u5206\u6790"}),"\n",(0,s.jsx)(n.h3,{id:"1-\u6a21\u578b\u52a0\u8f7d\u673a\u5236",children:"1. \u6a21\u578b\u52a0\u8f7d\u673a\u5236"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'def load_diffusion_model(unet_path, model_options={}):\n    # 1. \u52a0\u8f7d\u72b6\u6001\u5b57\u5178\n    sd = comfy.utils.load_torch_file(unet_path)\n    \n    # 2. \u8c03\u7528\u72b6\u6001\u5b57\u5178\u52a0\u8f7d\u5668\n    model = load_diffusion_model_state_dict(sd, model_options=model_options)\n    \n    # 3. \u9519\u8bef\u5904\u7406\n    if model is None:\n        raise RuntimeError("ERROR: Could not detect model type")\n    \n    return model\n'})}),"\n",(0,s.jsx)(n.h3,{id:"2-\u6a21\u578b\u7c7b\u578b\u68c0\u6d4b",children:"2. \u6a21\u578b\u7c7b\u578b\u68c0\u6d4b"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"def load_diffusion_model_state_dict(sd, model_options={}):\n    # \u68c0\u6d4b\u6a21\u578b\u524d\u7f00\n    diffusion_model_prefix = model_detection.unet_prefix_from_state_dict(sd)\n    \n    # \u8ba1\u7b97\u53c2\u6570\u6570\u91cf\n    parameters = comfy.utils.calculate_parameters(sd, diffusion_model_prefix)\n    \n    # \u68c0\u6d4b\u6743\u91cd\u6570\u636e\u7c7b\u578b\n    weight_dtype = comfy.utils.weight_dtype(sd, diffusion_model_prefix)\n    \n    # \u83b7\u53d6\u6a21\u578b\u914d\u7f6e\n    model_config = model_detection.model_config_from_unet(sd, diffusion_model_prefix)\n    \n    return model_config\n"})}),"\n",(0,s.jsx)(n.h3,{id:"3-\u8bbe\u5907\u548c\u5185\u5b58\u7ba1\u7406",children:"3. \u8bbe\u5907\u548c\u5185\u5b58\u7ba1\u7406"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"class ModelPatcher:\n    def __init__(self, model, load_device, offload_device):\n        self.model = model\n        self.load_device = load_device      # GPU\u8bbe\u5907\n        self.offload_device = offload_device # CPU\u8bbe\u5907\n        self.patches = {}\n        self.backup = {}\n        \n    def load(self, device_to=None, lowvram_model_memory=0, force_patch_weights=False):\n        # \u667a\u80fd\u8bbe\u5907\u7ba1\u7406\n        # \u5185\u5b58\u4f18\u5316\n        # \u6743\u91cd\u52a0\u8f7d\n"})}),"\n",(0,s.jsx)(n.h2,{id:"\u4e0echeckpointloadersimple\u7684\u5bf9\u6bd4",children:"\u4e0eCheckpointLoaderSimple\u7684\u5bf9\u6bd4"}),"\n",(0,s.jsx)(n.h3,{id:"\u529f\u80fd\u5bf9\u6bd4",children:"\u529f\u80fd\u5bf9\u6bd4"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"\u7279\u6027"}),(0,s.jsx)(n.th,{children:"UNETLoader"}),(0,s.jsx)(n.th,{children:"CheckpointLoaderSimple"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"\u8f93\u51fa\u7ec4\u4ef6"})}),(0,s.jsx)(n.td,{children:"\u4ec5MODEL"}),(0,s.jsx)(n.td,{children:"MODEL + CLIP + VAE"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"\u6587\u4ef6\u6765\u6e90"})}),(0,s.jsx)(n.td,{children:"diffusion_models/"}),(0,s.jsx)(n.td,{children:"checkpoints/"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"\u6570\u636e\u7c7b\u578b\u63a7\u5236"})}),(0,s.jsx)(n.td,{children:"\u7cbe\u7ec6\u63a7\u5236"}),(0,s.jsx)(n.td,{children:"\u81ea\u52a8\u9009\u62e9"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"\u5185\u5b58\u4f7f\u7528"})}),(0,s.jsx)(n.td,{children:"\u66f4\u5c11"}),(0,s.jsx)(n.td,{children:"\u66f4\u591a"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"\u7075\u6d3b\u6027"})}),(0,s.jsx)(n.td,{children:"\u9ad8"}),(0,s.jsx)(n.td,{children:"\u4e2d\u7b49"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.strong,{children:"\u4f7f\u7528\u590d\u6742\u5ea6"})}),(0,s.jsx)(n.td,{children:"\u9ad8"}),(0,s.jsx)(n.td,{children:"\u4f4e"})]})]})]}),"\n",(0,s.jsx)(n.h3,{id:"\u4f7f\u7528\u573a\u666f\u5bf9\u6bd4",children:"\u4f7f\u7528\u573a\u666f\u5bf9\u6bd4"}),"\n",(0,s.jsx)(n.h4,{id:"unetloader\u9002\u7528\u573a\u666f",children:"UNETLoader\u9002\u7528\u573a\u666f"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'# \u573a\u666f1: \u81ea\u5b9a\u4e49\u6a21\u578b\u7ec4\u5408\nunet = UNETLoader(unet_name="custom_unet.safetensors", weight_dtype="fp8_e4m3fn")\nclip = CLIPLoader(clip_name="custom_clip.safetensors")\nvae = VAELoader(vae_name="custom_vae.safetensors")\n\n# \u573a\u666f2: \u5185\u5b58\u4f18\u5316\nunet = UNETLoader(unet_name="large_model.safetensors", weight_dtype="fp8_e4m3fn_fast")\n\n# \u573a\u666f3: A/B\u6d4b\u8bd5\u4e0d\u540cUNET\nunet_a = UNETLoader(unet_name="model_a.safetensors", weight_dtype="default")\nunet_b = UNETLoader(unet_name="model_b.safetensors", weight_dtype="default")\n'})}),"\n",(0,s.jsx)(n.h4,{id:"checkpointloadersimple\u9002\u7528\u573a\u666f",children:"CheckpointLoaderSimple\u9002\u7528\u573a\u666f"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'# \u573a\u666f1: \u6807\u51c6\u5de5\u4f5c\u6d41\nmodel, clip, vae = CheckpointLoaderSimple(ckpt_name="sd_xl_base_1.0.safetensors")\n\n# \u573a\u666f2: \u5feb\u901f\u539f\u578b\n# \u4e00\u6b21\u6027\u52a0\u8f7d\u6240\u6709\u7ec4\u4ef6\uff0c\u7b80\u5355\u76f4\u63a5\n'})}),"\n",(0,s.jsx)(n.h2,{id:"\u6027\u80fd\u4f18\u5316\u7b56\u7565",children:"\u6027\u80fd\u4f18\u5316\u7b56\u7565"}),"\n",(0,s.jsx)(n.h3,{id:"1-\u5185\u5b58\u4f18\u5316",children:"1. \u5185\u5b58\u4f18\u5316"}),"\n",(0,s.jsx)(n.h4,{id:"fp8\u91cf\u5316\u6548\u679c",children:"FP8\u91cf\u5316\u6548\u679c"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'# \u5185\u5b58\u4f7f\u7528\u5bf9\u6bd4\uff08\u4ee5SDXL\u4e3a\u4f8b\uff09\nfp32_memory = 6.6  # GB\nfp16_memory = 3.3  # GB\nfp8_memory = 1.65  # GB\n\nmemory_savings = {\n    "fp8_vs_fp32": (fp32_memory - fp8_memory) / fp32_memory * 100,  # 75%\n    "fp8_vs_fp16": (fp16_memory - fp8_memory) / fp16_memory * 100,  # 50%\n}\n'})}),"\n",(0,s.jsx)(n.h4,{id:"\u6279\u5904\u7406\u4f18\u5316",children:"\u6279\u5904\u7406\u4f18\u5316"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'def optimize_batch_size_for_fp8():\n    """FP8\u6a21\u5f0f\u4e0b\u7684\u6279\u5904\u7406\u4f18\u5316"""\n    if weight_dtype.startswith("fp8"):\n        # FP8\u53ef\u4ee5\u652f\u6301\u66f4\u5927\u7684\u6279\u6b21\n        return min(batch_size * 2, max_batch_size)\n    return batch_size\n'})}),"\n",(0,s.jsx)(n.h3,{id:"2-\u901f\u5ea6\u4f18\u5316",children:"2. \u901f\u5ea6\u4f18\u5316"}),"\n",(0,s.jsx)(n.h4,{id:"fp8\u4f18\u5316\u9009\u9879",children:"FP8\u4f18\u5316\u9009\u9879"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'model_options = {\n    "dtype": torch.float8_e4m3fn,\n    "fp8_optimizations": True,  # \u542f\u7528\u989d\u5916\u4f18\u5316\n    "custom_operations": None,  # \u4f7f\u7528\u9ed8\u8ba4\u64cd\u4f5c\n}\n'})}),"\n",(0,s.jsx)(n.h4,{id:"\u9884\u7f16\u8bd1\u4f18\u5316",children:"\u9884\u7f16\u8bd1\u4f18\u5316"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'def enable_torch_compile():\n    """\u542f\u7528PyTorch\u7f16\u8bd1\u4f18\u5316"""\n    if hasattr(torch, \'compile\'):\n        model = torch.compile(model, mode="reduce-overhead")\n    return model\n'})}),"\n",(0,s.jsx)(n.h2,{id:"\u4f7f\u7528\u793a\u4f8b\u548c\u6700\u4f73\u5b9e\u8df5",children:"\u4f7f\u7528\u793a\u4f8b\u548c\u6700\u4f73\u5b9e\u8df5"}),"\n",(0,s.jsx)(n.h3,{id:"\u57fa\u672c\u7528\u6cd5",children:"\u57fa\u672c\u7528\u6cd5"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n    "unet_loader": {\n        "inputs": {\n            "unet_name": "sd_xl_base_1.0_unet.safetensors",\n            "weight_dtype": "default"\n        },\n        "class_type": "UNETLoader"\n    }\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"\u9ad8\u7ea7\u7ec4\u5408\u5de5\u4f5c\u6d41",children:"\u9ad8\u7ea7\u7ec4\u5408\u5de5\u4f5c\u6d41"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n    "unet_loader": {\n        "inputs": {\n            "unet_name": "custom_unet.safetensors",\n            "weight_dtype": "fp8_e4m3fn_fast"\n        },\n        "class_type": "UNETLoader"\n    },\n    "clip_loader": {\n        "inputs": {\n            "clip_name": "custom_clip.safetensors"\n        },\n        "class_type": "CLIPLoader"\n    },\n    "vae_loader": {\n        "inputs": {\n            "vae_name": "custom_vae.safetensors"\n        },\n        "class_type": "VAELoader"\n    },\n    "ksampler": {\n        "inputs": {\n            "model": ["unet_loader", 0],\n            "positive": ["clip_text_encode", 0],\n            "negative": ["clip_text_encode_neg", 0],\n            "latent_image": ["empty_latent", 0]\n        },\n        "class_type": "KSampler"\n    }\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"\u5185\u5b58\u53d7\u9650\u73af\u5883",children:"\u5185\u5b58\u53d7\u9650\u73af\u5883"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n    "low_memory_unet": {\n        "inputs": {\n            "unet_name": "large_model.safetensors",\n            "weight_dtype": "fp8_e4m3fn_fast"\n        },\n        "class_type": "UNETLoader"\n    }\n}\n'})}),"\n",(0,s.jsx)(n.h2,{id:"\u5e38\u89c1\u95ee\u9898\u548c\u89e3\u51b3\u65b9\u6848",children:"\u5e38\u89c1\u95ee\u9898\u548c\u89e3\u51b3\u65b9\u6848"}),"\n",(0,s.jsx)(n.h3,{id:"1-\u6a21\u578b\u52a0\u8f7d\u5931\u8d25",children:"1. \u6a21\u578b\u52a0\u8f7d\u5931\u8d25"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"ERROR: Could not detect model type\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"\u89e3\u51b3\u65b9\u6848"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\u786e\u8ba4\u6587\u4ef6\u5728",(0,s.jsx)(n.code,{children:"models/diffusion_models/"}),"\u76ee\u5f55"]}),"\n",(0,s.jsx)(n.li,{children:"\u68c0\u67e5\u6587\u4ef6\u683c\u5f0f\u662f\u5426\u652f\u6301"}),"\n",(0,s.jsx)(n.li,{children:"\u9a8c\u8bc1\u6587\u4ef6\u5b8c\u6574\u6027"}),"\n",(0,s.jsx)(n.li,{children:"\u786e\u8ba4\u662fUNET\u6a21\u578b\u800c\u975e\u5b8c\u6574\u68c0\u67e5\u70b9"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"2-fp8\u4e0d\u652f\u6301\u9519\u8bef",children:"2. FP8\u4e0d\u652f\u6301\u9519\u8bef"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"FP8 not supported on this device\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"\u89e3\u51b3\u65b9\u6848"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u68c0\u67e5GPU\u662f\u5426\u652f\u6301FP8\uff08RTX 40\u7cfb\u5217+\uff09"}),"\n",(0,s.jsxs)(n.li,{children:["\u4f7f\u7528",(0,s.jsx)(n.code,{children:"default"}),"\u6570\u636e\u7c7b\u578b"]}),"\n",(0,s.jsx)(n.li,{children:"\u66f4\u65b0PyTorch\u5230\u652f\u6301FP8\u7684\u7248\u672c"}),"\n",(0,s.jsx)(n.li,{children:"\u68c0\u67e5CUDA\u7248\u672c\u517c\u5bb9\u6027"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"3-\u5185\u5b58\u4e0d\u8db3",children:"3. \u5185\u5b58\u4e0d\u8db3"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"CUDA out of memory\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"\u89e3\u51b3\u65b9\u6848"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\u4f7f\u7528",(0,s.jsx)(n.code,{children:"fp8_e4m3fn_fast"}),"\u51cf\u5c11\u5185\u5b58"]}),"\n",(0,s.jsxs)(n.li,{children:["\u542f\u7528",(0,s.jsx)(n.code,{children:"--lowvram"}),"\u6a21\u5f0f"]}),"\n",(0,s.jsx)(n.li,{children:"\u51cf\u5c11\u6279\u6b21\u5927\u5c0f"}),"\n",(0,s.jsx)(n.li,{children:"\u4f7f\u7528CPU\u5378\u8f7d"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"4-\u6027\u80fd\u95ee\u9898",children:"4. \u6027\u80fd\u95ee\u9898"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"\u95ee\u9898"}),": FP8\u6a21\u5f0f\u53cd\u800c\u66f4\u6162\n",(0,s.jsx)(n.strong,{children:"\u89e3\u51b3\u65b9\u6848"}),":"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u786e\u8ba4GPU\u652f\u6301FP8\u8ba1\u7b97"}),"\n",(0,s.jsx)(n.li,{children:"\u68c0\u67e5\u6a21\u578b\u5927\u5c0f\u662f\u5426\u9002\u5408FP8"}),"\n",(0,s.jsx)(n.li,{children:"\u5c1d\u8bd5\u4e0d\u540c\u7684FP8\u53d8\u4f53"}),"\n",(0,s.jsx)(n.li,{children:"\u76d1\u63a7GPU\u5229\u7528\u7387"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"\u6587\u4ef6\u7ec4\u7ec7\u6700\u4f73\u5b9e\u8df5",children:"\u6587\u4ef6\u7ec4\u7ec7\u6700\u4f73\u5b9e\u8df5"}),"\n",(0,s.jsx)(n.h3,{id:"\u76ee\u5f55\u7ed3\u6784",children:"\u76ee\u5f55\u7ed3\u6784"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"models/\n\u251c\u2500\u2500 diffusion_models/          # UNETLoader\u4f7f\u7528\n\u2502   \u251c\u2500\u2500 sd15_unet.safetensors\n\u2502   \u251c\u2500\u2500 sdxl_unet.safetensors\n\u2502   \u2514\u2500\u2500 custom_unet.safetensors\n\u251c\u2500\u2500 clip/                      # CLIPLoader\u4f7f\u7528\n\u2502   \u251c\u2500\u2500 sd15_clip.safetensors\n\u2502   \u2514\u2500\u2500 sdxl_clip.safetensors\n\u251c\u2500\u2500 vae/                       # VAELoader\u4f7f\u7528\n\u2502   \u251c\u2500\u2500 sd15_vae.safetensors\n\u2502   \u2514\u2500\u2500 sdxl_vae.safetensors\n\u2514\u2500\u2500 checkpoints/               # CheckpointLoaderSimple\u4f7f\u7528\n    \u251c\u2500\u2500 sd15_full.safetensors\n    \u2514\u2500\u2500 sdxl_full.safetensors\n"})}),"\n",(0,s.jsx)(n.h3,{id:"\u547d\u540d\u89c4\u8303",children:"\u547d\u540d\u89c4\u8303"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"# \u63a8\u8350\u547d\u540d\u683c\u5f0f\n{model_type}_{version}_{component}.safetensors\n\n# \u793a\u4f8b\nsd15_v1.5_unet.safetensors\nsdxl_base_unet.safetensors\nflux_dev_unet.safetensors\n"})}),"\n",(0,s.jsx)(n.h2,{id:"\u9ad8\u7ea7\u5e94\u7528\u573a\u666f",children:"\u9ad8\u7ea7\u5e94\u7528\u573a\u666f"}),"\n",(0,s.jsx)(n.h3,{id:"1-\u6a21\u578b\u5fae\u8c03\u548c\u5b9e\u9a8c",children:"1. \u6a21\u578b\u5fae\u8c03\u548c\u5b9e\u9a8c"}),"\n",(0,s.jsx)(n.h4,{id:"ab\u6d4b\u8bd5\u4e0d\u540cunet",children:"A/B\u6d4b\u8bd5\u4e0d\u540cUNET"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'# \u5de5\u4f5c\u6d41\u8bbe\u8ba1\uff1a\u540c\u65f6\u6d4b\u8bd5\u591a\u4e2aUNET\u6a21\u578b\ndef create_ab_test_workflow():\n    # \u52a0\u8f7d\u4e24\u4e2a\u4e0d\u540c\u7684UNET\n    unet_a = UNETLoader("model_a.safetensors", "fp8_e4m3fn")\n    unet_b = UNETLoader("model_b.safetensors", "fp8_e4m3fn")\n\n    # \u5171\u4eabCLIP\u548cVAE\n    clip = CLIPLoader("shared_clip.safetensors")\n    vae = VAELoader("shared_vae.safetensors")\n\n    # \u5e76\u884c\u751f\u6210\u5bf9\u6bd4\n    return compare_results(unet_a, unet_b, clip, vae)\n'})}),"\n",(0,s.jsx)(n.h4,{id:"\u81ea\u5b9a\u4e49\u6a21\u578b\u7ec4\u5408",children:"\u81ea\u5b9a\u4e49\u6a21\u578b\u7ec4\u5408"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'# \u6df7\u5408\u4e0d\u540c\u6765\u6e90\u7684\u7ec4\u4ef6\nworkflow = {\n    "unet": "flux_dev_unet.safetensors",      # Flux UNET\n    "clip": "sdxl_clip.safetensors",          # SDXL CLIP\n    "vae": "sd15_vae.safetensors",            # SD1.5 VAE\n    "weight_dtype": "fp8_e4m3fn_fast"\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"2-\u751f\u4ea7\u73af\u5883\u4f18\u5316",children:"2. \u751f\u4ea7\u73af\u5883\u4f18\u5316"}),"\n",(0,s.jsx)(n.h4,{id:"\u670d\u52a1\u5668\u90e8\u7f72\u914d\u7f6e",children:"\u670d\u52a1\u5668\u90e8\u7f72\u914d\u7f6e"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'class ProductionUNETConfig:\n    def __init__(self, gpu_memory_gb):\n        self.gpu_memory = gpu_memory_gb\n\n    def get_optimal_config(self):\n        if self.gpu_memory >= 24:\n            return {\n                "weight_dtype": "default",\n                "batch_size": 4,\n                "enable_optimizations": True\n            }\n        elif self.gpu_memory >= 12:\n            return {\n                "weight_dtype": "fp8_e4m3fn",\n                "batch_size": 2,\n                "enable_optimizations": True\n            }\n        else:\n            return {\n                "weight_dtype": "fp8_e4m3fn_fast",\n                "batch_size": 1,\n                "enable_optimizations": True\n            }\n'})}),"\n",(0,s.jsx)(n.h4,{id:"\u6279\u91cf\u5904\u7406\u4f18\u5316",children:"\u6279\u91cf\u5904\u7406\u4f18\u5316"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'def optimize_for_batch_processing():\n    """\u6279\u91cf\u5904\u7406\u7684UNET\u914d\u7f6e"""\n    return {\n        "weight_dtype": "fp8_e4m3fn_fast",  # \u6700\u5feb\u63a8\u7406\n        "model_options": {\n            "fp8_optimizations": True,\n            "custom_operations": None\n        },\n        "memory_management": {\n            "enable_sequential_cpu_offload": True,\n            "enable_attention_slicing": True\n        }\n    }\n'})}),"\n",(0,s.jsx)(n.h3,{id:"3-\u7814\u7a76\u548c\u5f00\u53d1",children:"3. \u7814\u7a76\u548c\u5f00\u53d1"}),"\n",(0,s.jsx)(n.h4,{id:"\u6a21\u578b\u6027\u80fd\u57fa\u51c6\u6d4b\u8bd5",children:"\u6a21\u578b\u6027\u80fd\u57fa\u51c6\u6d4b\u8bd5"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'def benchmark_unet_performance():\n    """UNET\u6027\u80fd\u57fa\u51c6\u6d4b\u8bd5"""\n    test_configs = [\n        {"dtype": "default", "name": "\u9ed8\u8ba4"},\n        {"dtype": "fp8_e4m3fn", "name": "FP8\u6807\u51c6"},\n        {"dtype": "fp8_e4m3fn_fast", "name": "FP8\u5feb\u901f"},\n        {"dtype": "fp8_e5m2", "name": "FP8\u9ad8\u7cbe\u5ea6"}\n    ]\n\n    results = {}\n    for config in test_configs:\n        start_time = time.time()\n        memory_before = torch.cuda.memory_allocated()\n\n        # \u52a0\u8f7d\u548c\u6d4b\u8bd5\n        unet = UNETLoader("test_model.safetensors", config["dtype"])\n        # \u6267\u884c\u63a8\u7406\u6d4b\u8bd5...\n\n        end_time = time.time()\n        memory_after = torch.cuda.memory_allocated()\n\n        results[config["name"]] = {\n            "load_time": end_time - start_time,\n            "memory_usage": memory_after - memory_before,\n            "inference_speed": calculate_inference_speed()\n        }\n\n    return results\n'})}),"\n",(0,s.jsx)(n.h2,{id:"\u6545\u969c\u6392\u9664\u548c\u8c03\u8bd5",children:"\u6545\u969c\u6392\u9664\u548c\u8c03\u8bd5"}),"\n",(0,s.jsx)(n.h3,{id:"\u8bca\u65ad\u5de5\u5177",children:"\u8bca\u65ad\u5de5\u5177"}),"\n",(0,s.jsx)(n.h4,{id:"\u6a21\u578b\u517c\u5bb9\u6027\u68c0\u67e5",children:"\u6a21\u578b\u517c\u5bb9\u6027\u68c0\u67e5"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'def check_unet_compatibility(unet_path):\n    """\u68c0\u67e5UNET\u6a21\u578b\u517c\u5bb9\u6027"""\n    try:\n        sd = comfy.utils.load_torch_file(unet_path)\n\n        # \u68c0\u67e5\u6a21\u578b\u7ed3\u6784\n        model_type = detect_model_type(sd)\n        parameter_count = calculate_parameters(sd)\n        weight_dtype = detect_weight_dtype(sd)\n\n        return {\n            "compatible": True,\n            "model_type": model_type,\n            "parameters": f"{parameter_count/1e9:.1f}B",\n            "weight_dtype": str(weight_dtype),\n            "estimated_memory": f"{parameter_count * 4 / 1e9:.1f}GB"\n        }\n    except Exception as e:\n        return {\n            "compatible": False,\n            "error": str(e),\n            "suggestions": get_compatibility_suggestions(e)\n        }\n'})}),"\n",(0,s.jsx)(n.h4,{id:"fp8\u652f\u6301\u68c0\u6d4b",children:"FP8\u652f\u6301\u68c0\u6d4b"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'def check_fp8_support():\n    """\u68c0\u67e5FP8\u652f\u6301\u60c5\u51b5"""\n    support_info = {\n        "pytorch_version": torch.__version__,\n        "cuda_available": torch.cuda.is_available(),\n        "gpu_name": torch.cuda.get_device_name() if torch.cuda.is_available() else "N/A",\n        "fp8_supported": False,\n        "recommended_dtype": "default"\n    }\n\n    if torch.cuda.is_available():\n        # \u68c0\u67e5GPU\u67b6\u6784\n        gpu_name = torch.cuda.get_device_name().lower()\n        if "rtx 40" in gpu_name or "h100" in gpu_name or "a100" in gpu_name:\n            support_info["fp8_supported"] = True\n            support_info["recommended_dtype"] = "fp8_e4m3fn_fast"\n\n        # \u68c0\u67e5PyTorch\u7248\u672c\n        if hasattr(torch, \'float8_e4m3fn\'):\n            support_info["fp8_available"] = True\n        else:\n            support_info["fp8_available"] = False\n            support_info["upgrade_suggestion"] = "\u5347\u7ea7PyTorch\u52302.1+"\n\n    return support_info\n'})}),"\n",(0,s.jsx)(n.h3,{id:"\u5e38\u89c1\u9519\u8bef\u89e3\u51b3\u65b9\u6848",children:"\u5e38\u89c1\u9519\u8bef\u89e3\u51b3\u65b9\u6848"}),"\n",(0,s.jsx)(n.h4,{id:"\u9519\u8bef\u4ee3\u7801\u5bf9\u7167\u8868",children:"\u9519\u8bef\u4ee3\u7801\u5bf9\u7167\u8868"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"\u9519\u8bef\u4fe1\u606f"}),(0,s.jsx)(n.th,{children:"\u539f\u56e0"}),(0,s.jsx)(n.th,{children:"\u89e3\u51b3\u65b9\u6848"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Could not detect model type"})}),(0,s.jsx)(n.td,{children:"\u6587\u4ef6\u683c\u5f0f\u4e0d\u652f\u6301"}),(0,s.jsx)(n.td,{children:"\u68c0\u67e5\u6587\u4ef6\u662f\u5426\u4e3aUNET\u6a21\u578b"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"FP8 not supported"})}),(0,s.jsx)(n.td,{children:"\u786c\u4ef6\u4e0d\u652f\u6301"}),(0,s.jsx)(n.td,{children:"\u4f7f\u7528default\u6570\u636e\u7c7b\u578b"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"CUDA out of memory"})}),(0,s.jsx)(n.td,{children:"\u5185\u5b58\u4e0d\u8db3"}),(0,s.jsx)(n.td,{children:"\u4f7f\u7528FP8\u6216\u542f\u7528lowvram"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"File not found"})}),(0,s.jsx)(n.td,{children:"\u8def\u5f84\u9519\u8bef"}),(0,s.jsx)(n.td,{children:"\u68c0\u67e5diffusion_models\u76ee\u5f55"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"Invalid state dict"})}),(0,s.jsx)(n.td,{children:"\u6587\u4ef6\u635f\u574f"}),(0,s.jsx)(n.td,{children:"\u91cd\u65b0\u4e0b\u8f7d\u6a21\u578b\u6587\u4ef6"})]})]})]}),"\n",(0,s.jsx)(n.h4,{id:"\u81ea\u52a8\u6545\u969c\u6062\u590d",children:"\u81ea\u52a8\u6545\u969c\u6062\u590d"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'def load_unet_with_fallback(unet_name, preferred_dtype="fp8_e4m3fn_fast"):\n    """\u5e26\u6545\u969c\u6062\u590d\u7684UNET\u52a0\u8f7d"""\n    fallback_sequence = [\n        preferred_dtype,\n        "fp8_e4m3fn",\n        "default"\n    ]\n\n    for dtype in fallback_sequence:\n        try:\n            return UNETLoader(unet_name, dtype)\n        except Exception as e:\n            logging.warning(f"Failed to load with {dtype}: {e}")\n            continue\n\n    raise RuntimeError("All loading attempts failed")\n'})}),"\n",(0,s.jsx)(n.h2,{id:"\u6027\u80fd\u76d1\u63a7\u548c\u4f18\u5316",children:"\u6027\u80fd\u76d1\u63a7\u548c\u4f18\u5316"}),"\n",(0,s.jsx)(n.h3,{id:"\u5b9e\u65f6\u76d1\u63a7\u6307\u6807",children:"\u5b9e\u65f6\u76d1\u63a7\u6307\u6807"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'class UNETPerformanceMonitor:\n    def __init__(self):\n        self.metrics = {\n            "load_times": [],\n            "memory_usage": [],\n            "inference_times": [],\n            "gpu_utilization": []\n        }\n\n    def monitor_loading(self, unet_loader_func):\n        """\u76d1\u63a7UNET\u52a0\u8f7d\u6027\u80fd"""\n        start_time = time.time()\n        start_memory = torch.cuda.memory_allocated()\n\n        result = unet_loader_func()\n\n        end_time = time.time()\n        end_memory = torch.cuda.memory_allocated()\n\n        self.metrics["load_times"].append(end_time - start_time)\n        self.metrics["memory_usage"].append(end_memory - start_memory)\n\n        return result\n\n    def get_performance_report(self):\n        """\u751f\u6210\u6027\u80fd\u62a5\u544a"""\n        return {\n            "avg_load_time": np.mean(self.metrics["load_times"]),\n            "avg_memory_usage": np.mean(self.metrics["memory_usage"]) / 1e9,  # GB\n            "memory_efficiency": self.calculate_memory_efficiency(),\n            "recommendations": self.generate_recommendations()\n        }\n'})}),"\n",(0,s.jsx)(n.h3,{id:"\u4f18\u5316\u5efa\u8bae\u751f\u6210\u5668",children:"\u4f18\u5316\u5efa\u8bae\u751f\u6210\u5668"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'def generate_optimization_suggestions(performance_data, hardware_info):\n    """\u751f\u6210\u4f18\u5316\u5efa\u8bae"""\n    suggestions = []\n\n    # \u5185\u5b58\u4f18\u5316\u5efa\u8bae\n    if performance_data["memory_usage"] > hardware_info["gpu_memory"] * 0.8:\n        suggestions.append({\n            "type": "memory",\n            "priority": "high",\n            "suggestion": "\u4f7f\u7528fp8_e4m3fn_fast\u51cf\u5c11\u5185\u5b58\u4f7f\u7528",\n            "expected_improvement": "50%\u5185\u5b58\u51cf\u5c11"\n        })\n\n    # \u901f\u5ea6\u4f18\u5316\u5efa\u8bae\n    if performance_data["load_time"] > 10:\n        suggestions.append({\n            "type": "speed",\n            "priority": "medium",\n            "suggestion": "\u542f\u7528\u6a21\u578b\u7f13\u5b58\u548c\u9884\u52a0\u8f7d",\n            "expected_improvement": "3-5x\u52a0\u8f7d\u901f\u5ea6\u63d0\u5347"\n        })\n\n    # \u8d28\u91cf\u4f18\u5316\u5efa\u8bae\n    if performance_data["inference_quality"] < 0.9:\n        suggestions.append({\n            "type": "quality",\n            "priority": "medium",\n            "suggestion": "\u8003\u8651\u4f7f\u7528fp8_e5m2\u63d0\u9ad8\u7cbe\u5ea6",\n            "expected_improvement": "\u66f4\u597d\u7684\u751f\u6210\u8d28\u91cf"\n        })\n\n    return suggestions\n'})}),"\n",(0,s.jsx)(n.h2,{id:"\u603b\u7ed3",children:"\u603b\u7ed3"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"UNETLoader"}),"\u662fComfyUI\u4e2d\u7684\u9ad8\u7ea7\u6a21\u578b\u52a0\u8f7d\u5de5\u5177\uff0c\u5b83\uff1a"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"\u4e13\u4e1a\u5316"}),": \u4e13\u95e8\u52a0\u8f7d\u6269\u6563\u6a21\u578b\uff0c\u63d0\u4f9b\u7cbe\u7ec6\u63a7\u5236"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"\u9ad8\u6548\u6027"}),": \u652f\u6301FP8\u91cf\u5316\uff0c\u5927\u5e45\u51cf\u5c11\u5185\u5b58\u4f7f\u7528"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"\u7075\u6d3b\u6027"}),": \u5141\u8bb8\u81ea\u5b9a\u4e49\u6a21\u578b\u7ec4\u5408\u548c\u4f18\u5316\u7b56\u7565"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"\u6027\u80fd\u5bfc\u5411"}),": \u9488\u5bf9\u9ad8\u7ea7\u7528\u6237\u548c\u6027\u80fd\u4f18\u5316\u573a\u666f\u8bbe\u8ba1"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"\u6269\u5c55\u6027"}),": \u4e3a\u590d\u6742\u5de5\u4f5c\u6d41\u548c\u5b9e\u9a8c\u63d0\u4f9b\u57fa\u7840"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"\u7406\u89e3UNETLoader\u7684\u4f7f\u7528\u65b9\u6cd5\u5bf9\u4e8e\uff1a"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u9ad8\u7ea7\u5de5\u4f5c\u6d41\u8bbe\u8ba1"}),"\n",(0,s.jsx)(n.li,{children:"\u5185\u5b58\u548c\u6027\u80fd\u4f18\u5316"}),"\n",(0,s.jsx)(n.li,{children:"\u81ea\u5b9a\u4e49\u6a21\u578b\u7ec4\u5408"}),"\n",(0,s.jsx)(n.li,{children:"\u5b9e\u9a8c\u548c\u7814\u7a76\u5de5\u4f5c"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"\u5177\u6709\u91cd\u8981\u610f\u4e49\u3002\u867d\u7136\u4f7f\u7528\u590d\u6742\u5ea6\u8f83\u9ad8\uff0c\u4f46\u4e3a\u4e13\u4e1a\u7528\u6237\u63d0\u4f9b\u4e86\u5f3a\u5927\u7684\u63a7\u5236\u80fd\u529b\u3002"}),"\n",(0,s.jsx)(n.h2,{id:"\u76f8\u5173\u8d44\u6e90",children:"\u76f8\u5173\u8d44\u6e90"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://arxiv.org/abs/2209.05433",children:"FP8\u91cf\u5316\u8bba\u6587"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://arxiv.org/abs/2006.11239",children:"\u6269\u6563\u6a21\u578b\u67b6\u6784"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://docs.comfy.org/advanced/loaders",children:"ComfyUI\u9ad8\u7ea7\u52a0\u8f7d\u5668\u6587\u6863"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://pytorch.org/docs/stable/notes/numerical_accuracy.html",children:"PyTorch FP8\u652f\u6301"})}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(a,{...e})}):a(e)}}}]);