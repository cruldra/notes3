"use strict";(self.webpackChunknotes_3=self.webpackChunknotes_3||[]).push([[29439],{10854:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>i,contentTitle:()=>c,default:()=>f,frontMatter:()=>a,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"Python/SSE","title":"SSE","description":"\u540e\u7aef","source":"@site/docs/Python/SSE.mdx","sourceDirName":"Python","slug":"/Python/SSE","permalink":"/notes3/docs/Python/SSE","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Python/SSE.mdx","tags":[],"version":"current","frontMatter":{},"sidebar":"python","previous":{"title":"\u5f02\u6b65\u751f\u6210\u5668","permalink":"/notes3/docs/Python/\u5f02\u6b65/\u5f02\u6b65\u751f\u6210\u5668"},"next":{"title":"\u5fae\u4fe1\u5ba2\u670d","permalink":"/notes3/docs/Python/\u5fae\u4fe1\u5ba2\u670d"}}');var s=r(23420),o=r(54213);const a={},c=void 0,i={},d=[{value:"\u540e\u7aef",id:"\u540e\u7aef",level:2},{value:"\u524d\u7aef",id:"\u524d\u7aef",level:2},{value:"<code>React</code>\u7ade\u6001\u6761\u4ef6\u95ee\u9898",id:"react\u7ade\u6001\u6761\u4ef6\u95ee\u9898",level:2}];function l(e){const n={code:"code",h2:"h2",p:"p",pre:"pre",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h2,{id:"\u540e\u7aef",children:"\u540e\u7aef"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'from fastapi import FastAPI, Request, HTTPException, status\r\nfrom sse_starlette.sse import EventSourceResponse\r\nimport asyncio\r\nfrom typing import Dict, Set, Optional\r\nimport json\r\nfrom datetime import datetime\r\nfrom contextlib import asynccontextmanager\r\nfrom loguru import logger\r\n\r\napp = FastAPI()\r\n\r\n# \u5168\u5c40\u8fde\u63a5\u7ba1\u7406\r\nclass ConnectionManager:\r\n    def __init__(self):\r\n        self.active_connections: Dict[str, Set[Request]] = {}\r\n\r\n    async def connect(self, client_id: str, request: Request):\r\n        if client_id not in self.active_connections:\r\n            self.active_connections[client_id] = set()\r\n        self.active_connections[client_id].add(request)\r\n        logger.info(f"Client {client_id} connected. Total connections: {len(self.active_connections)}")\r\n\r\n    async def disconnect(self, client_id: str, request: Request):\r\n        if client_id in self.active_connections:\r\n            self.active_connections[client_id].discard(request)\r\n            if not self.active_connections[client_id]:\r\n                del self.active_connections[client_id]\r\n        logger.info(f"Client {client_id} disconnected. Total connections: {len(self.active_connections)}")\r\n\r\n    def get_connections(self, client_id: str) -> Set[Request]:\r\n        return self.active_connections.get(client_id, set())\r\n\r\nmanager = ConnectionManager()\r\n\r\nasync def event_generator(request: Request, client_id: str) -> AsyncGenerator[str, None]:\r\n    """\u4e8b\u4ef6\u751f\u6210\u5668"""\r\n    try:\r\n        await manager.connect(client_id, request)\r\n        while True:\r\n            if await request.is_disconnected():\r\n                break\r\n\r\n            data = {\r\n                "timestamp": datetime.now().isoformat(),\r\n                "client_id": client_id,\r\n                "data": "Your data here"\r\n            }\r\n\r\n            yield json.dumps({\r\n                "event": "update",\r\n                "data": data,\r\n                "id": str(datetime.now().timestamp())\r\n            })\r\n\r\n            await asyncio.sleep(1)\r\n    except Exception as e:\r\n        logger.error(f"Error in event_generator: {str(e)}")\r\n        raise\r\n    finally:\r\n        await manager.disconnect(client_id, request)\r\n\r\n@app.get("/stream/{client_id}")\r\nasync def stream(request: Request, client_id: str):\r\n    """SSE \u7aef\u70b9"""\r\n    try:\r\n        return EventSourceResponse(\r\n            event_generator(request, client_id),\r\n            ping=20,\r\n            media_type="text/event-stream",\r\n            headers={\r\n                \'Cache-Control\': \'no-cache\',\r\n                \'Connection\': \'keep-alive\',\r\n                \'X-Accel-Buffering\': \'no\'\r\n            }\r\n        )\r\n    except Exception as e:\r\n        logger.error(f"Error in stream endpoint: {str(e)}")\r\n        raise HTTPException(\r\n            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,\r\n            detail="Internal server error"\r\n        )\r\n\r\n# \u5e7f\u64ad\u6d88\u606f\u7ed9\u6240\u6709\u8fde\u63a5\u7684\u5ba2\u6237\u7aef\r\nasync def broadcast_message(client_id: str, message: str):\r\n    """\u5e7f\u64ad\u6d88\u606f"""\r\n    connections = manager.get_connections(client_id)\r\n    for request in connections:\r\n        if not await request.is_disconnected():\r\n            # \u5b9e\u73b0\u6d88\u606f\u5e7f\u64ad\u903b\u8f91\r\n            pass\n'})}),"\n",(0,s.jsx)(n.h2,{id:"\u524d\u7aef",children:"\u524d\u7aef"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"/**\r\n * \u53d1\u9001\u6d88\u606f\u7ed9\u5e94\u7528\uff0c\u5e76\u4ee5SSE\u5f62\u5f0f\u63a5\u6536\u54cd\u5e94\r\n * @param config \u804a\u5929\u8bf7\u6c42\u914d\u7f6e\r\n * @param onMessage \u63a5\u6536\u5230\u6d88\u606f\u65f6\u7684\u56de\u8c03\u51fd\u6570\r\n * @param onError \u53d1\u751f\u9519\u8bef\u65f6\u7684\u56de\u8c03\u51fd\u6570\r\n * @param onComplete SSE\u6d41\u5173\u95ed\u65f6\u7684\u56de\u8c03\u51fd\u6570\r\n */\r\nexport async function sendMessage(\r\n  config: ChatRequestConfig,\r\n  onMessage: (event: MessageEvent) => void,\r\n  onError?: (error: Error) => void,\r\n  onComplete?: () => void\r\n): Promise<void> {\r\n  const token = useUserStore.getState().token;\r\n\r\n  if (!token) {\r\n    throw new Error('\u672a\u627e\u5230\u7528\u6237 token\uff0c\u8bf7\u5148\u767b\u5f55');\r\n  }\r\n\r\n  try {\r\n    const response = await fetch(`${API_BASE_URL}/dify/chat-messages`, {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        'Accept': 'text/event-stream',\r\n        'Authorization': `Bearer ${token}`\r\n      },\r\n      body: JSON.stringify(config)\r\n    });\r\n\r\n    if (!response.ok) {\r\n      throw new Error(`\u53d1\u9001\u6d88\u606f\u5931\u8d25: ${response.statusText}`);\r\n    }\r\n\r\n    if (!response.body) {\r\n      throw new Error('\u672a\u63a5\u6536\u5230\u54cd\u5e94\u6570\u636e');\r\n    }\r\n\r\n    const reader = response.body.getReader();\r\n    const decoder = new TextDecoder();\r\n\r\n    let buffer = '';\r\n    while (true) {\r\n      const { done, value } = await reader.read();\r\n      if (done) {\r\n        onComplete?.();\r\n        break;\r\n      }\r\n\r\n      buffer += decoder.decode(value, { stream: true });\r\n      const lines = buffer.split('\\n');\r\n\r\n      for (const line of lines) {\r\n        if (line.startsWith('data: ')) {\r\n          try {\r\n            const eventData = JSON.parse(line.slice(6)) as MessageEvent;\r\n            onMessage(eventData);\r\n          } catch (error) {\r\n            console.error('\u89e3\u6790\u6d88\u606f\u5931\u8d25:', error);\r\n          }\r\n        }\r\n      }\r\n    }\r\n  } catch (error) {\r\n    onError?.(error instanceof Error ? error : new Error(String(error)));\r\n  }\r\n}\n"})}),"\n",(0,s.jsxs)(n.h2,{id:"react\u7ade\u6001\u6761\u4ef6\u95ee\u9898",children:[(0,s.jsx)(n.code,{children:"React"}),"\u7ade\u6001\u6761\u4ef6\u95ee\u9898"]}),"\n",(0,s.jsxs)(n.p,{children:["\u901a\u8fc7",(0,s.jsx)(n.code,{children:"SSE"}),"\u4ee5\u6d41\u5f0f\u65b9\u5f0f\u77ed\u65f6\u95f4\u5185\u63a8\u9001\u5927\u91cf\u6570\u636e(\u5982\u804a\u5929\u5e94\u7528)\u65f6\u518d\u4f7f\u7528",(0,s.jsx)(n.code,{children:"setState"}),"\u5c31\u53ef\u80fd\u4f1a\u51fa\u73b0\u7ade\u6001\u6761\u4ef6\u95ee\u9898."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:'{"event":"message","conversation_id":"916cc8ce-734f-49b9-9164-5be49481c8da","message_id":"395e56cb-28a7-41fd-b7a9-0f01703095fb","created_at":1739265121,"task_id":"0bf64e7f-6bf0-464c-9215-b1f03df706ff","id":"395e56cb-28a7-41fd-b7a9-0f01703095fb","answer":"\u60a8","from_variable_selector":null}\r\n{"event":"message","conversation_id":"916cc8ce-734f-49b9-9164-5be49481c8da","message_id":"395e56cb-28a7-41fd-b7a9-0f01703095fb","created_at":1739265121,"task_id":"0bf64e7f-6bf0-464c-9215-b1f03df706ff","id":"395e56cb-28a7-41fd-b7a9-0f01703095fb","answer":"\u4f3c","from_variable_selector":null}\r\n{"event":"message","conversation_id":"916cc8ce-734f-49b9-9164-5be49481c8da","message_id":"395e56cb-28a7-41fd-b7a9-0f01703095fb","created_at":1739265121,"task_id":"0bf64e7f-6bf0-464c-9215-b1f03df706ff","id":"395e56cb-28a7-41fd-b7a9-0f01703095fb","answer":"\u4e4e","from_variable_selector":null}\r\n{"event":"message","conversation_id":"916cc8ce-734f-49b9-9164-5be49481c8da","message_id":"395e56cb-28a7-41fd-b7a9-0f01703095fb","created_at":1739265121,"task_id":"0bf64e7f-6bf0-464c-9215-b1f03df706ff","id":"395e56cb-28a7-41fd-b7a9-0f01703095fb","answer":"\u8f93\u5165","from_variable_selector":null}\r\n{"event":"message","conversation_id":"916cc8ce-734f-49b9-9164-5be49481c8da","message_id":"395e56cb-28a7-41fd-b7a9-0f01703095fb","created_at":1739265121,"task_id":"0bf64e7f-6bf0-464c-9215-b1f03df706ff","id":"395e56cb-28a7-41fd-b7a9-0f01703095fb","answer":"\u7684","from_variable_selector":null}\n'})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-ts",children:"(event) => {\r\n                setMessages(prev => {\r\n                    const lastMessage = prev[prev.length - 1];\r\n                    if (lastMessage.role === 'assistant') {\r\n                        return [\r\n                            ...prev.slice(0, -1),\r\n                            {\r\n                                ...lastMessage,\r\n                                content: lastMessage.content + event.answer\r\n                            }\r\n                        ];\r\n                    } else {\r\n                        return [\r\n                            ...prev,\r\n                            convertChatEventToMessage(event)\r\n                        ];\r\n                    }\r\n                });\r\n            },\n"})})]})}function f(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(l,{...e})}):l(e)}},54213:(e,n,r)=>{r.d(n,{R:()=>a,x:()=>c});var t=r(36672);const s={},o=t.createContext(s);function a(e){const n=t.useContext(o);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),t.createElement(o.Provider,{value:n},e.children)}}}]);