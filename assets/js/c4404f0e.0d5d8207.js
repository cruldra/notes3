"use strict";(self.webpackChunknotes_3=self.webpackChunknotes_3||[]).push([[8125],{54213:(n,e,r)=>{r.d(e,{R:()=>i,x:()=>o});var s=r(36672);const a={},t=s.createContext(a);function i(n){const e=s.useContext(t);return s.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function o(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(a):n.components||a:i(n.components),s.createElement(t.Provider,{value:e},n.children)}},92050:(n,e,r)=>{r.r(e),r.d(e,{assets:()=>c,contentTitle:()=>o,default:()=>p,frontMatter:()=>i,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"FrontEnd/Miniapp/Uniapp/\u5fae\u4fe1/\u767b\u5f55","title":"\u767b\u5f55","description":"\u4e3b\u8981\u6d41\u7a0b","source":"@site/docs/FrontEnd/Miniapp/Uniapp/\u5fae\u4fe1/\u767b\u5f55.mdx","sourceDirName":"FrontEnd/Miniapp/Uniapp/\u5fae\u4fe1","slug":"/FrontEnd/Miniapp/Uniapp/\u5fae\u4fe1/\u767b\u5f55","permalink":"/notes3/docs/FrontEnd/Miniapp/Uniapp/\u5fae\u4fe1/\u767b\u5f55","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/FrontEnd/Miniapp/Uniapp/\u5fae\u4fe1/\u767b\u5f55.mdx","tags":[],"version":"current","frontMatter":{},"sidebar":"frontEnd","previous":{"title":"\u5fae\u4fe1","permalink":"/notes3/docs/category/\u5fae\u4fe1"},"next":{"title":"\u8e29\u8fc7\u7684\u5751","permalink":"/notes3/docs/FrontEnd/Miniapp/Uniapp/\u8e29\u8fc7\u7684\u5751"}}');var a=r(23420),t=r(54213);const i={},o=void 0,c={},d=[{value:"\u4e3b\u8981\u6d41\u7a0b",id:"\u4e3b\u8981\u6d41\u7a0b",level:2},{value:"\u524d\u7aef",id:"\u524d\u7aef",level:2},{value:"\u540e\u7aef(Java)",id:"\u540e\u7aefjava",level:2},{value:"\u540e\u7aef(Python)",id:"\u540e\u7aefpython",level:2}];function l(n){const e={a:"a",code:"code",h2:"h2",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",...(0,t.R)(),...n.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(e.h2,{id:"\u4e3b\u8981\u6d41\u7a0b",children:"\u4e3b\u8981\u6d41\u7a0b"}),"\n",(0,a.jsx)(e.p,{children:"\u5fae\u4fe1\u5c0f\u7a0b\u5e8f\u5b9e\u73b0\u767b\u5f55\u4e3b\u8981\u6d41\u7a0b\u5982\u56fe:"}),"\n",(0,a.jsx)(e.p,{children:(0,a.jsx)(e.img,{src:"https://github.com/cruldra/picx-images-hosting/raw/master/image.8ojq2f5yst.webp",alt:""})}),"\n",(0,a.jsx)(e.h2,{id:"\u524d\u7aef",children:"\u524d\u7aef"}),"\n",(0,a.jsxs)(e.ol,{children:["\n",(0,a.jsx)(e.li,{children:"\u5148\u521b\u5efa\u6309\u94ae"}),"\n"]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-html",children:'<button\r\n  v-if="isAgree"\r\n  class="wechat-login-btn"\r\n  :loading="loading"\r\n  open-type="getPhoneNumber"\r\n  @getphonenumber="getPhoneNumber"\r\n>\r\n\u5fae\u4fe1\u4e00\u952e\u767b\u5f55\r\n</button>\r\n<button\r\n  v-else\r\n  class="wechat-login-btn"\r\n  @click="handleDisabledClick"\r\n>\r\n\u5fae\u4fe1\u4e00\u952e\u767b\u5f55\r\n</button>\n'})}),"\n",(0,a.jsxs)(e.ol,{start:"2",children:["\n",(0,a.jsxs)(e.li,{children:["\u5728",(0,a.jsx)(e.code,{children:"script"}),"\u4e2d\u5b9a\u4e49",(0,a.jsx)(e.code,{children:"getPhoneNumber"}),"\u65b9\u6cd5"]}),"\n"]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-js",children:"const getPhoneNumber = async (e: any) => {\r\n  // \u7528\u6237\u62d2\u7edd\u6388\u6743\r\n  if (e.detail.errMsg !== 'getPhoneNumber:ok') {\r\n    await uni.showToast({\r\n      title: '\u767b\u5f55\u5931\u8d25',\r\n      icon: 'none'\r\n    })\r\n    return\r\n  }\r\n\r\n  loading.value = true\r\n  try {\r\n    // 1. \u83b7\u53d6\u767b\u5f55code\r\n    const loginRes = await uni.login()\r\n    // 2. \u8c03\u7528\u540e\u7aef\u63a5\u53e3\uff0c\u4f20\u5165code\u548c\u52a0\u5bc6\u6570\u636e\r\n    const res = (await authService.wxLogin({\r\n      code: loginRes.code,\r\n      encryptedData: e.detail.encryptedData,\r\n      iv: e.detail.iv\r\n    }))\r\n\r\n\r\n    // 3. \u4fdd\u5b58\u767b\u5f55\u6001\r\n    const {token, userInfo} = res.data!!\r\n    uni.setStorageSync('token', token)\r\n    uni.setStorageSync('userInfo', userInfo)\r\n\r\n    // 4. \u767b\u5f55\u6210\u529f\u8df3\u8f6c\r\n    await uni.switchTab({\r\n      url: '/pages/index/index'\r\n    })\r\n\r\n  } catch (error) {\r\n    await uni.showToast({\r\n      title: '\u767b\u5f55\u5931\u8d25\uff0c\u8bf7\u91cd\u8bd5',\r\n      icon: 'none'\r\n    })\r\n  } finally {\r\n    loading.value = false\r\n  }\r\n}\r\nconst handleDisabledClick = () => {\r\n  uni.showToast({\r\n    title: '\u8bf7\u5148\u540c\u610f\u7528\u6237\u534f\u8bae\u548c\u9690\u79c1\u653f\u7b56',\r\n    icon: 'none'\r\n  })\r\n}\n"})}),"\n",(0,a.jsx)(e.h2,{id:"\u540e\u7aefjava",children:"\u540e\u7aef(Java)"}),"\n",(0,a.jsxs)(e.ol,{children:["\n",(0,a.jsxs)(e.li,{children:["\u5f15\u5165",(0,a.jsx)(e.a,{href:"https://github.com/binarywang/WxJava",children:"\u5fae\u4fe1Java\u5f00\u53d1\u5305"})]}),"\n"]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-xml",children:"<dependency>\r\n  <groupId>com.github.binarywang</groupId>\r\n  <artifactId>weixin-java-miniapp</artifactId>\r\n  <version>4.6.0</version>\r\n</dependency>\n"})}),"\n",(0,a.jsxs)(e.ol,{start:"2",children:["\n",(0,a.jsxs)(e.li,{children:["\u521b\u5efa",(0,a.jsx)(e.code,{children:"WxMaService"}),"\u5b9e\u4f8b"]}),"\n"]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-kotlin",children:'val wxMaService: WxMaService = WxMaServiceImpl()\r\nval config = WxMaDefaultConfigImpl()\r\nconfig.appid = "wx123456789"\r\nconfig.secret = "1234567890abcdef"\r\nwxMaService.wxMaConfig = config\n'})}),"\n",(0,a.jsxs)(e.ol,{start:"3",children:["\n",(0,a.jsx)(e.li,{children:"\u83b7\u53d6\u624b\u673a\u53f7\u5b9e\u73b0\u81ea\u52a8\u6ce8\u518c\u767b\u5f55"}),"\n"]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-kotlin",children:'@PostMapping("/auth/wxLogin")\r\nfun wxLogin(ctx: Context) {\r\n    val request = ctx.bodyAsClass<WechatLoginData>()\r\n    log.info("\u4ee3\u7801: ${request.code}")\r\n    // Initialize WxMaService\r\n    val wxService = IOC.getComponent(WxMaService::class.java)\r\n    log.info("appid: ${wxService.wxMaConfig.appid}")\r\n    // Get session info\r\n    val sessionInfo: WxMaJscode2SessionResult = wxService.jsCode2SessionInfo(request.code)\r\n\r\n    // Decrypt user info using sessionKey if needed\r\n    //val userInfo = wxService.userService.getUserInfo(sessionInfo.sessionKey, request.encryptedData, request.iv)\r\n    val wxPhoneInfo = wxService.userService.getPhoneNoInfo(sessionInfo.sessionKey, request.encryptedData, request.iv)\r\n    log.info("openid: ${sessionInfo.openid}")\r\n    ctx.json(\r\n        ResponsePayloads(\r\n            data = WechatLoginResult(\r\n                token = "TODO",\r\n                userInfo = UserInfo(\r\n                    avatar = "userInfo.avatarUrl",\r\n                    nickname = "userInfo.nickName",\r\n                    phoneNumber = wxPhoneInfo.phoneNumber\r\n                )\r\n            )\r\n        )\r\n    )\r\n}\n'})}),"\n",(0,a.jsx)(e.h2,{id:"\u540e\u7aefpython",children:"\u540e\u7aef(Python)"}),"\n",(0,a.jsxs)(e.ol,{children:["\n",(0,a.jsxs)(e.li,{children:["\u5b89\u88c5",(0,a.jsx)(e.code,{children:"pycryptodome"}),"\u7528\u4e8e\u89e3\u51b3\u5fae\u4fe1\u8fd4\u56de\u7684\u6570\u636e"]}),"\n",(0,a.jsxs)(e.li,{children:["\u5b89\u88c5",(0,a.jsx)(e.code,{children:"wechatpy"}),"\u5fae\u4fe1\u5f00\u53d1\u5305"]}),"\n"]}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-bash",children:"pip install pycryptodome wechatpy\n"})}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-python",children:'class WXBizDataCrypt:\r\n    def __init__(self, appId, sessionKey):\r\n        self.appId = appId\r\n        self.sessionKey = sessionKey\r\n\r\n    def decrypt(self, encryptedData, iv):\r\n        # base64 decode\r\n        sessionKey = base64.b64decode(self.sessionKey)\r\n        encryptedData = base64.b64decode(encryptedData)\r\n        iv = base64.b64decode(iv)\r\n\r\n        cipher = AES.new(sessionKey, AES.MODE_CBC, iv)\r\n\r\n        decrypted = json.loads(self._unpad(cipher.decrypt(encryptedData)))\r\n\r\n        if decrypted[\'watermark\'][\'appid\'] != self.appId:\r\n            raise Exception(\'Invalid Buffer\')\r\n\r\n        return decrypted\r\n\r\n    def _unpad(self, s):\r\n        return s[:-ord(s[len(s)-1:])]\r\n\r\n@router.post("/auth/wxLogin")\r\nasync def wx_login(data: WechatLoginData = Body(...)):\r\n    client = WeChatClient(settings.wechat_app_id, settings.wechat_app_secret)\r\n    session_info = client.wxa.code_to_session(data.code)\r\n    wx = WXBizDataCrypt(settings.wechat_app_id, session_info[\'session_key\'])\r\n    decrypted_data = wx.decrypt(data.encryptedData, data.iv)\r\n    print(f"\u624b\u673a\u53f7: {decrypted_data[\'purePhoneNumber\']}")\r\n    print(f"\u56fd\u5bb6\u4ee3\u7801: {decrypted_data[\'countryCode\']}")\r\n    # TODO: Initialize WxMaService equivalent\r\n    # TODO: Get session info using code\r\n\r\n    # Mock response for now\r\n    return ResponsePayloads(\r\n        data=WechatLoginResult(\r\n            token="mock_token",\r\n            userInfo=UserInfo(\r\n                avatar="default_avatar",\r\n                nickname="default_nickname",\r\n                phoneNumber="13800138000"\r\n            )\r\n        )\r\n    )\n'})})]})}function p(n={}){const{wrapper:e}={...(0,t.R)(),...n.components};return e?(0,a.jsx)(e,{...n,children:(0,a.jsx)(l,{...n})}):l(n)}}}]);