"use strict";(self.webpackChunknotes_3=self.webpackChunknotes_3||[]).push([[8011],{36853:(e,n,l)=>{l.r(n),l.d(n,{assets:()=>d,contentTitle:()=>i,default:()=>h,frontMatter:()=>s,metadata:()=>r,toc:()=>t});const r=JSON.parse('{"id":"Tools/Comfyui/LoraLoaderModelOnly\u8282\u70b9\u8be6\u7ec6\u5206\u6790","title":"LoraLoaderModelOnly \u8282\u70b9\u8be6\u7ec6\u5206\u6790","description":"\u6982\u8ff0","source":"@site/docs/Tools/Comfyui/LoraLoaderModelOnly\u8282\u70b9\u8be6\u7ec6\u5206\u6790.md","sourceDirName":"Tools/Comfyui","slug":"/Tools/Comfyui/LoraLoaderModelOnly\u8282\u70b9\u8be6\u7ec6\u5206\u6790","permalink":"/notes3/docs/Tools/Comfyui/LoraLoaderModelOnly\u8282\u70b9\u8be6\u7ec6\u5206\u6790","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Tools/Comfyui/LoraLoaderModelOnly\u8282\u70b9\u8be6\u7ec6\u5206\u6790.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tools","previous":{"title":"KSampler \u8282\u70b9\u8be6\u7ec6\u5206\u6790","permalink":"/notes3/docs/Tools/Comfyui/KSampler\u8282\u70b9\u8be6\u7ec6\u5206\u6790"},"next":{"title":"MMDiT (Multimodal Diffusion Transformer) \u6a21\u578b\u8be6\u89e3","permalink":"/notes3/docs/Tools/Comfyui/MMDiT\u6a21\u578b\u8be6\u89e3"}}');var o=l(23420),a=l(54213);const s={},i="LoraLoaderModelOnly \u8282\u70b9\u8be6\u7ec6\u5206\u6790",d={},t=[{value:"\u6982\u8ff0",id:"\u6982\u8ff0",level:2},{value:"\u8282\u70b9\u57fa\u672c\u4fe1\u606f",id:"\u8282\u70b9\u57fa\u672c\u4fe1\u606f",level:2},{value:"\u7c7b\u5b9a\u4e49",id:"\u7c7b\u5b9a\u4e49",level:3},{value:"\u663e\u793a\u540d\u79f0",id:"\u663e\u793a\u540d\u79f0",level:3},{value:"\u8f93\u5165\u8f93\u51fa\u89c4\u683c",id:"\u8f93\u5165\u8f93\u51fa\u89c4\u683c",level:2},{value:"\u8f93\u5165\u53c2\u6570\u8be6\u89e3",id:"\u8f93\u5165\u53c2\u6570\u8be6\u89e3",level:3},{value:"\u53c2\u6570\u8be6\u7ec6\u8bf4\u660e",id:"\u53c2\u6570\u8be6\u7ec6\u8bf4\u660e",level:4},{value:"\u8f93\u51fa\u7c7b\u578b",id:"\u8f93\u51fa\u7c7b\u578b",level:3},{value:"\u6838\u5fc3\u5b9e\u73b0\u5206\u6790",id:"\u6838\u5fc3\u5b9e\u73b0\u5206\u6790",level:2},{value:"\u4e3b\u8981\u6267\u884c\u51fd\u6570",id:"\u4e3b\u8981\u6267\u884c\u51fd\u6570",level:3},{value:"\u7ee7\u627f\u5173\u7cfb\u548c\u590d\u7528",id:"\u7ee7\u627f\u5173\u7cfb\u548c\u590d\u7528",level:3},{value:"\u6267\u884c\u6d41\u7a0b\u56fe",id:"\u6267\u884c\u6d41\u7a0b\u56fe",level:3},{value:"LoRA\u6280\u672f\u6df1\u5ea6\u89e3\u6790",id:"lora\u6280\u672f\u6df1\u5ea6\u89e3\u6790",level:2},{value:"1. LoRA\u539f\u7406",id:"1-lora\u539f\u7406",level:3},{value:"Low-Rank Adaptation\u6982\u5ff5",id:"low-rank-adaptation\u6982\u5ff5",level:4},{value:"2. LoRA\u6587\u4ef6\u683c\u5f0f",id:"2-lora\u6587\u4ef6\u683c\u5f0f",level:3},{value:"\u6807\u51c6LoRA\u683c\u5f0f",id:"\u6807\u51c6lora\u683c\u5f0f",level:4},{value:"\u652f\u6301\u7684LoRA\u53d8\u4f53",id:"\u652f\u6301\u7684lora\u53d8\u4f53",level:4},{value:"3. \u6743\u91cd\u6620\u5c04\u673a\u5236",id:"3-\u6743\u91cd\u6620\u5c04\u673a\u5236",level:3},{value:"UNET\u6743\u91cd\u6620\u5c04",id:"unet\u6743\u91cd\u6620\u5c04",level:4},{value:"\u4e0eLoraLoader\u7684\u5bf9\u6bd4",id:"\u4e0eloraloader\u7684\u5bf9\u6bd4",level:2},{value:"\u529f\u80fd\u5bf9\u6bd4",id:"\u529f\u80fd\u5bf9\u6bd4",level:3},{value:"\u4f7f\u7528\u573a\u666f\u5bf9\u6bd4",id:"\u4f7f\u7528\u573a\u666f\u5bf9\u6bd4",level:3},{value:"LoraLoader\u9002\u7528\u573a\u666f",id:"loraloader\u9002\u7528\u573a\u666f",level:4},{value:"LoraLoaderModelOnly\u9002\u7528\u573a\u666f",id:"loraloadermodelonly\u9002\u7528\u573a\u666f",level:4},{value:"\u9ad8\u7ea7\u5e94\u7528\u6280\u5de7",id:"\u9ad8\u7ea7\u5e94\u7528\u6280\u5de7",level:2},{value:"1. \u591aLoRA\u53e0\u52a0\u7b56\u7565",id:"1-\u591alora\u53e0\u52a0\u7b56\u7565",level:3},{value:"\u4e32\u884c\u53e0\u52a0",id:"\u4e32\u884c\u53e0\u52a0",level:4},{value:"\u5f3a\u5ea6\u8c03\u8282\u7b56\u7565",id:"\u5f3a\u5ea6\u8c03\u8282\u7b56\u7565",level:4},{value:"2. \u8d1f\u5f3a\u5ea6\u5e94\u7528",id:"2-\u8d1f\u5f3a\u5ea6\u5e94\u7528",level:3},{value:"\u53cd\u5411LoRA\u6548\u679c",id:"\u53cd\u5411lora\u6548\u679c",level:4},{value:"3. \u52a8\u6001\u5f3a\u5ea6\u63a7\u5236",id:"3-\u52a8\u6001\u5f3a\u5ea6\u63a7\u5236",level:3},{value:"\u6761\u4ef6\u5f3a\u5ea6\u5e94\u7528",id:"\u6761\u4ef6\u5f3a\u5ea6\u5e94\u7528",level:4},{value:"\u6027\u80fd\u4f18\u5316\u548c\u5185\u5b58\u7ba1\u7406",id:"\u6027\u80fd\u4f18\u5316\u548c\u5185\u5b58\u7ba1\u7406",level:2},{value:"1. LoRA\u7f13\u5b58\u673a\u5236",id:"1-lora\u7f13\u5b58\u673a\u5236",level:3},{value:"2. \u5185\u5b58\u4f7f\u7528\u4f18\u5316",id:"2-\u5185\u5b58\u4f7f\u7528\u4f18\u5316",level:3},{value:"LoRA\u5185\u5b58\u5360\u7528\u5206\u6790",id:"lora\u5185\u5b58\u5360\u7528\u5206\u6790",level:4},{value:"3. \u6279\u91cf\u5904\u7406\u4f18\u5316",id:"3-\u6279\u91cf\u5904\u7406\u4f18\u5316",level:3},{value:"\u4f7f\u7528\u793a\u4f8b\u548c\u6700\u4f73\u5b9e\u8df5",id:"\u4f7f\u7528\u793a\u4f8b\u548c\u6700\u4f73\u5b9e\u8df5",level:2},{value:"\u57fa\u672c\u7528\u6cd5",id:"\u57fa\u672c\u7528\u6cd5",level:3},{value:"\u591aLoRA\u53e0\u52a0\u5de5\u4f5c\u6d41",id:"\u591alora\u53e0\u52a0\u5de5\u4f5c\u6d41",level:3},{value:"\u7cbe\u786e\u63a7\u5236\u5de5\u4f5c\u6d41",id:"\u7cbe\u786e\u63a7\u5236\u5de5\u4f5c\u6d41",level:3},{value:"\u5e38\u89c1\u95ee\u9898\u548c\u89e3\u51b3\u65b9\u6848",id:"\u5e38\u89c1\u95ee\u9898\u548c\u89e3\u51b3\u65b9\u6848",level:2},{value:"1. LoRA\u4e0d\u751f\u6548",id:"1-lora\u4e0d\u751f\u6548",level:3},{value:"2. \u5185\u5b58\u4e0d\u8db3",id:"2-\u5185\u5b58\u4e0d\u8db3",level:3},{value:"3. \u6743\u91cd\u51b2\u7a81",id:"3-\u6743\u91cd\u51b2\u7a81",level:3},{value:"4. \u6027\u80fd\u95ee\u9898",id:"4-\u6027\u80fd\u95ee\u9898",level:3},{value:"\u9ad8\u7ea7\u8c03\u8bd5\u548c\u5206\u6790",id:"\u9ad8\u7ea7\u8c03\u8bd5\u548c\u5206\u6790",level:2},{value:"1. LoRA\u6743\u91cd\u5206\u6790\u5de5\u5177",id:"1-lora\u6743\u91cd\u5206\u6790\u5de5\u5177",level:3},{value:"\u6743\u91cd\u5206\u5e03\u5206\u6790",id:"\u6743\u91cd\u5206\u5e03\u5206\u6790",level:4},{value:"LoRA\u517c\u5bb9\u6027\u68c0\u67e5",id:"lora\u517c\u5bb9\u6027\u68c0\u67e5",level:4},{value:"2. \u6027\u80fd\u57fa\u51c6\u6d4b\u8bd5",id:"2-\u6027\u80fd\u57fa\u51c6\u6d4b\u8bd5",level:3},{value:"LoRA\u52a0\u8f7d\u6027\u80fd\u6d4b\u8bd5",id:"lora\u52a0\u8f7d\u6027\u80fd\u6d4b\u8bd5",level:4},{value:"\u5185\u5b58\u4f7f\u7528\u76d1\u63a7",id:"\u5185\u5b58\u4f7f\u7528\u76d1\u63a7",level:4},{value:"3. \u9ad8\u7ea7\u5de5\u4f5c\u6d41\u6a21\u5f0f",id:"3-\u9ad8\u7ea7\u5de5\u4f5c\u6d41\u6a21\u5f0f",level:3},{value:"\u6761\u4ef6LoRA\u5e94\u7528",id:"\u6761\u4ef6lora\u5e94\u7528",level:4},{value:"\u81ea\u9002\u5e94\u5f3a\u5ea6\u8c03\u8282",id:"\u81ea\u9002\u5e94\u5f3a\u5ea6\u8c03\u8282",level:4},{value:"4. \u6545\u969c\u6392\u9664\u548c\u8bca\u65ad",id:"4-\u6545\u969c\u6392\u9664\u548c\u8bca\u65ad",level:3},{value:"\u81ea\u52a8\u8bca\u65ad\u5de5\u5177",id:"\u81ea\u52a8\u8bca\u65ad\u5de5\u5177",level:4},{value:"\u5e38\u89c1\u95ee\u9898\u81ea\u52a8\u4fee\u590d",id:"\u5e38\u89c1\u95ee\u9898\u81ea\u52a8\u4fee\u590d",level:4},{value:"\u603b\u7ed3",id:"\u603b\u7ed3",level:2},{value:"\u76f8\u5173\u8d44\u6e90",id:"\u76f8\u5173\u8d44\u6e90",level:2}];function c(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,a.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.header,{children:(0,o.jsx)(n.h1,{id:"loraloadermodelonly-\u8282\u70b9\u8be6\u7ec6\u5206\u6790",children:"LoraLoaderModelOnly \u8282\u70b9\u8be6\u7ec6\u5206\u6790"})}),"\n",(0,o.jsx)(n.h2,{id:"\u6982\u8ff0",children:"\u6982\u8ff0"}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.code,{children:"LoraLoaderModelOnly"})," \u662fComfyUI\u4e2d\u4e13\u95e8\u7528\u4e8e\u4ec5\u5bf9\u6269\u6563\u6a21\u578b\u5e94\u7528LoRA\u6743\u91cd\u7684\u8282\u70b9\u3002\u5b83\u7ee7\u627f\u81ea",(0,o.jsx)(n.code,{children:"LoraLoader"}),"\uff0c\u4f46\u53ea\u5904\u7406\u6a21\u578b\u90e8\u5206\uff0c\u4e0d\u6d89\u53caCLIP\u6587\u672c\u7f16\u7801\u5668\u3002\u8fd9\u4e2a\u8282\u70b9\u7279\u522b\u9002\u7528\u4e8e\u9700\u8981\u7cbe\u786e\u63a7\u5236LoRA\u5e94\u7528\u8303\u56f4\u7684\u9ad8\u7ea7\u5de5\u4f5c\u6d41\u3002"]}),"\n",(0,o.jsx)(n.h2,{id:"\u8282\u70b9\u57fa\u672c\u4fe1\u606f",children:"\u8282\u70b9\u57fa\u672c\u4fe1\u606f"}),"\n",(0,o.jsx)(n.h3,{id:"\u7c7b\u5b9a\u4e49",children:"\u7c7b\u5b9a\u4e49"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:'class LoraLoaderModelOnly(LoraLoader):\n    RETURN_TYPES = ("MODEL",)\n    FUNCTION = "load_lora_model_only"\n'})}),"\n",(0,o.jsx)(n.h3,{id:"\u663e\u793a\u540d\u79f0",children:"\u663e\u793a\u540d\u79f0"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"\u5185\u90e8\u540d\u79f0"}),": ",(0,o.jsx)(n.code,{children:"LoraLoaderModelOnly"})]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"\u663e\u793a\u540d\u79f0"}),": ",(0,o.jsx)(n.code,{children:"Load LoRA (Model Only)"})]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"\u7c7b\u522b"}),": ",(0,o.jsx)(n.code,{children:"loaders"})]}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"\u8f93\u5165\u8f93\u51fa\u89c4\u683c",children:"\u8f93\u5165\u8f93\u51fa\u89c4\u683c"}),"\n",(0,o.jsx)(n.h3,{id:"\u8f93\u5165\u53c2\u6570\u8be6\u89e3",children:"\u8f93\u5165\u53c2\u6570\u8be6\u89e3"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:'@classmethod\ndef INPUT_TYPES(s):\n    return {\n        "required": {\n            "model": ("MODEL",),\n            "lora_name": (folder_paths.get_filename_list("loras"), ),\n            "strength_model": ("FLOAT", {"default": 1.0, "min": -100.0, "max": 100.0, "step": 0.01}),\n        }\n    }\n'})}),"\n",(0,o.jsx)(n.h4,{id:"\u53c2\u6570\u8be6\u7ec6\u8bf4\u660e",children:"\u53c2\u6570\u8be6\u7ec6\u8bf4\u660e"}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.strong,{children:"model"})," (MODEL)"]}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"\u8981\u5e94\u7528LoRA\u7684\u6269\u6563\u6a21\u578b"}),"\n",(0,o.jsx)(n.li,{children:"\u6765\u6e90\uff1aCheckpointLoaderSimple\u3001UNETLoader\u7b49\u8282\u70b9"}),"\n",(0,o.jsx)(n.li,{children:"\u7c7b\u578b\uff1aModelPatcher\u5bf9\u8c61"}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.strong,{children:"lora_name"})," (\u9009\u62e9\u5217\u8868)"]}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"LoRA\u6587\u4ef6\u540d"}),"\n",(0,o.jsxs)(n.li,{children:["\u6765\u6e90\uff1a",(0,o.jsx)(n.code,{children:"models/loras/"})," \u76ee\u5f55"]}),"\n",(0,o.jsxs)(n.li,{children:["\u652f\u6301\u683c\u5f0f\uff1a",(0,o.jsx)(n.code,{children:".safetensors"}),", ",(0,o.jsx)(n.code,{children:".ckpt"}),", ",(0,o.jsx)(n.code,{children:".pt"}),", ",(0,o.jsx)(n.code,{children:".pth"})]}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.strong,{children:"strength_model"})," (FLOAT)"]}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"LoRA\u5bf9\u6a21\u578b\u7684\u5f71\u54cd\u5f3a\u5ea6"}),"\n",(0,o.jsx)(n.li,{children:"\u9ed8\u8ba4\u503c\uff1a1.0"}),"\n",(0,o.jsx)(n.li,{children:"\u8303\u56f4\uff1a-100.0 \u5230 100.0"}),"\n",(0,o.jsx)(n.li,{children:"\u6b65\u957f\uff1a0.01"}),"\n",(0,o.jsx)(n.li,{children:"\u652f\u6301\u8d1f\u503c\uff08\u53cd\u5411\u5e94\u7528\uff09"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,o.jsx)(n.h3,{id:"\u8f93\u51fa\u7c7b\u578b",children:"\u8f93\u51fa\u7c7b\u578b"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:'RETURN_TYPES = ("MODEL",)\n'})}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.strong,{children:"\u8f93\u51fa\u8bf4\u660e"}),":"]}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"MODEL"}),": \u5e94\u7528\u4e86LoRA\u6743\u91cd\u7684\u6269\u6563\u6a21\u578b"]}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"\u6838\u5fc3\u5b9e\u73b0\u5206\u6790",children:"\u6838\u5fc3\u5b9e\u73b0\u5206\u6790"}),"\n",(0,o.jsx)(n.h3,{id:"\u4e3b\u8981\u6267\u884c\u51fd\u6570",children:"\u4e3b\u8981\u6267\u884c\u51fd\u6570"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:"def load_lora_model_only(self, model, lora_name, strength_model):\n    return (self.load_lora(model, None, lora_name, strength_model, 0)[0],)\n"})}),"\n",(0,o.jsx)(n.h3,{id:"\u7ee7\u627f\u5173\u7cfb\u548c\u590d\u7528",children:"\u7ee7\u627f\u5173\u7cfb\u548c\u590d\u7528"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:"class LoraLoaderModelOnly(LoraLoader):\n    # \u7ee7\u627f\u7236\u7c7b\u7684load_lora\u65b9\u6cd5\n    # \u4f46\u53ea\u8fd4\u56de\u6a21\u578b\u90e8\u5206\uff0cCLIP\u8bbe\u4e3aNone\n"})}),"\n",(0,o.jsx)(n.h3,{id:"\u6267\u884c\u6d41\u7a0b\u56fe",children:"\u6267\u884c\u6d41\u7a0b\u56fe"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-mermaid",children:'flowchart TD\n    A[\u63a5\u6536\u53c2\u6570] --\x3e B[\u8c03\u7528\u7236\u7c7bload_lora]\n    B --\x3e C[\u8bbe\u7f6eCLIP\u4e3aNone]\n    C --\x3e D[\u8bbe\u7f6estrength_clip\u4e3a0]\n    D --\x3e E[\u52a0\u8f7dLoRA\u6587\u4ef6]\n    E --\x3e F[\u89e3\u6790LoRA\u6743\u91cd]\n    F --\x3e G[\u5e94\u7528\u5230\u6a21\u578b]\n    G --\x3e H[\u8fd4\u56de\u4fee\u6539\u540e\u7684\u6a21\u578b]\n    \n    subgraph "LoRA\u52a0\u8f7d\u8fc7\u7a0b"\n        E --\x3e E1[\u68c0\u67e5\u7f13\u5b58]\n        E --\x3e E2[\u52a0\u8f7dtorch\u6587\u4ef6]\n        E --\x3e E3[\u66f4\u65b0\u7f13\u5b58]\n    end\n    \n    subgraph "\u6743\u91cd\u5e94\u7528"\n        G --\x3e G1[\u514b\u9686\u6a21\u578b]\n        G --\x3e G2[\u6dfb\u52a0\u8865\u4e01]\n        G --\x3e G3[\u8ba1\u7b97\u6743\u91cd\u5dee\u5f02]\n        G --\x3e G4[\u5e94\u7528\u5f3a\u5ea6\u7cfb\u6570]\n    end\n    \n    subgraph "\u4ec5\u6a21\u578b\u5904\u7406"\n        C --\x3e C1[\u8df3\u8fc7CLIP\u5904\u7406]\n        D --\x3e D2[strength_clip = 0]\n        H --\x3e H1[\u53ea\u8fd4\u56deMODEL]\n    end\n'})}),"\n",(0,o.jsx)(n.h2,{id:"lora\u6280\u672f\u6df1\u5ea6\u89e3\u6790",children:"LoRA\u6280\u672f\u6df1\u5ea6\u89e3\u6790"}),"\n",(0,o.jsx)(n.h3,{id:"1-lora\u539f\u7406",children:"1. LoRA\u539f\u7406"}),"\n",(0,o.jsx)(n.h4,{id:"low-rank-adaptation\u6982\u5ff5",children:"Low-Rank Adaptation\u6982\u5ff5"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:'# LoRA\u7684\u6570\u5b66\u539f\u7406\n# \u539f\u59cb\u6743\u91cd: W \u2208 R^(d\xd7k)\n# LoRA\u5206\u89e3: \u0394W = BA, \u5176\u4e2d B \u2208 R^(d\xd7r), A \u2208 R^(r\xd7k), r << min(d,k)\n# \u6700\u7ec8\u6743\u91cd: W\' = W + \u03b1\u0394W\n\ndef lora_forward(weight, lora_up, lora_down, alpha, strength):\n    """LoRA\u524d\u5411\u4f20\u64ad"""\n    # \u8ba1\u7b97\u4f4e\u79e9\u5206\u89e3\u7684\u6743\u91cd\u5dee\u5f02\n    delta_weight = torch.mm(lora_up, lora_down)\n    \n    # \u5e94\u7528\u7f29\u653e\u56e0\u5b50\n    scale = alpha / lora_down.shape[0]  # rank\n    \n    # \u5e94\u7528\u5f3a\u5ea6\u7cfb\u6570\n    final_weight = weight + strength * scale * delta_weight\n    \n    return final_weight\n'})}),"\n",(0,o.jsx)(n.h3,{id:"2-lora\u6587\u4ef6\u683c\u5f0f",children:"2. LoRA\u6587\u4ef6\u683c\u5f0f"}),"\n",(0,o.jsx)(n.h4,{id:"\u6807\u51c6lora\u683c\u5f0f",children:"\u6807\u51c6LoRA\u683c\u5f0f"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:'lora_structure = {\n    # \u57fa\u7840\u6743\u91cd\n    "lora_unet_down_blocks_0_attentions_0_proj_in.lora_down.weight": tensor,\n    "lora_unet_down_blocks_0_attentions_0_proj_in.lora_up.weight": tensor,\n    "lora_unet_down_blocks_0_attentions_0_proj_in.alpha": scalar,\n    \n    # \u4e0d\u540c\u5c42\u7684\u6743\u91cd\n    "lora_unet_mid_block_attentions_0_proj_out.lora_down.weight": tensor,\n    "lora_unet_mid_block_attentions_0_proj_out.lora_up.weight": tensor,\n    "lora_unet_mid_block_attentions_0_proj_out.alpha": scalar,\n}\n'})}),"\n",(0,o.jsx)(n.h4,{id:"\u652f\u6301\u7684lora\u53d8\u4f53",children:"\u652f\u6301\u7684LoRA\u53d8\u4f53"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:'supported_formats = {\n    "standard": "lora_unet_{layer}.lora_up.weight",\n    "diffusers": "{layer}_lora.up.weight", \n    "diffusers2": "{layer}.lora_B.weight",\n    "kohya": "lora_unet_{layer}",\n    "lycoris": "lycoris_{layer}",\n    "transformers": "{layer}.lora_linear_layer.up.weight"\n}\n'})}),"\n",(0,o.jsx)(n.h3,{id:"3-\u6743\u91cd\u6620\u5c04\u673a\u5236",children:"3. \u6743\u91cd\u6620\u5c04\u673a\u5236"}),"\n",(0,o.jsx)(n.h4,{id:"unet\u6743\u91cd\u6620\u5c04",children:"UNET\u6743\u91cd\u6620\u5c04"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:'def model_lora_keys_unet(model, key_map={}):\n    """\u751f\u6210UNET\u7684LoRA\u952e\u6620\u5c04"""\n    sd = model.state_dict()\n    \n    for k in sd.keys():\n        if k.startswith("diffusion_model.") and k.endswith(".weight"):\n            # \u6807\u51c6\u683c\u5f0f\u6620\u5c04\n            key_lora = k[len("diffusion_model."):-len(".weight")].replace(".", "_")\n            key_map[f"lora_unet_{key_lora}"] = k\n            \n            # \u901a\u7528\u683c\u5f0f\u6620\u5c04\n            key_map[k[:-len(".weight")]] = k\n    \n    return key_map\n'})}),"\n",(0,o.jsx)(n.h2,{id:"\u4e0eloraloader\u7684\u5bf9\u6bd4",children:"\u4e0eLoraLoader\u7684\u5bf9\u6bd4"}),"\n",(0,o.jsx)(n.h3,{id:"\u529f\u80fd\u5bf9\u6bd4",children:"\u529f\u80fd\u5bf9\u6bd4"}),"\n",(0,o.jsxs)(n.table,{children:[(0,o.jsx)(n.thead,{children:(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.th,{children:"\u7279\u6027"}),(0,o.jsx)(n.th,{children:"LoraLoader"}),(0,o.jsx)(n.th,{children:"LoraLoaderModelOnly"})]})}),(0,o.jsxs)(n.tbody,{children:[(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.td,{children:(0,o.jsx)(n.strong,{children:"\u8f93\u5165"})}),(0,o.jsx)(n.td,{children:"MODEL + CLIP"}),(0,o.jsx)(n.td,{children:"\u4ec5MODEL"})]}),(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.td,{children:(0,o.jsx)(n.strong,{children:"\u8f93\u51fa"})}),(0,o.jsx)(n.td,{children:"MODEL + CLIP"}),(0,o.jsx)(n.td,{children:"\u4ec5MODEL"})]}),(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.td,{children:(0,o.jsx)(n.strong,{children:"LoRA\u5e94\u7528\u8303\u56f4"})}),(0,o.jsx)(n.td,{children:"\u6a21\u578b + \u6587\u672c\u7f16\u7801\u5668"}),(0,o.jsx)(n.td,{children:"\u4ec5\u6a21\u578b"})]}),(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.td,{children:(0,o.jsx)(n.strong,{children:"\u53c2\u6570\u6570\u91cf"})}),(0,o.jsx)(n.td,{children:"2\u4e2a\u5f3a\u5ea6\u53c2\u6570"}),(0,o.jsx)(n.td,{children:"1\u4e2a\u5f3a\u5ea6\u53c2\u6570"})]}),(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.td,{children:(0,o.jsx)(n.strong,{children:"\u4f7f\u7528\u590d\u6742\u5ea6"})}),(0,o.jsx)(n.td,{children:"\u4e2d\u7b49"}),(0,o.jsx)(n.td,{children:"\u7b80\u5355"})]}),(0,o.jsxs)(n.tr,{children:[(0,o.jsx)(n.td,{children:(0,o.jsx)(n.strong,{children:"\u5185\u5b58\u4f7f\u7528"})}),(0,o.jsx)(n.td,{children:"\u66f4\u591a"}),(0,o.jsx)(n.td,{children:"\u66f4\u5c11"})]})]})]}),"\n",(0,o.jsx)(n.h3,{id:"\u4f7f\u7528\u573a\u666f\u5bf9\u6bd4",children:"\u4f7f\u7528\u573a\u666f\u5bf9\u6bd4"}),"\n",(0,o.jsx)(n.h4,{id:"loraloader\u9002\u7528\u573a\u666f",children:"LoraLoader\u9002\u7528\u573a\u666f"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:'# \u573a\u666f1: \u5b8c\u6574\u7684\u98ce\u683c\u8f6c\u6362\nmodel, clip = LoraLoader(\n    model=base_model,\n    clip=base_clip,\n    lora_name="anime_style.safetensors",\n    strength_model=1.0,\n    strength_clip=1.0\n)\n\n# \u573a\u666f2: \u5e73\u8861\u7684LoRA\u5e94\u7528\nmodel, clip = LoraLoader(\n    model=base_model,\n    clip=base_clip,\n    lora_name="portrait_lora.safetensors",\n    strength_model=0.8,\n    strength_clip=0.6\n)\n'})}),"\n",(0,o.jsx)(n.h4,{id:"loraloadermodelonly\u9002\u7528\u573a\u666f",children:"LoraLoaderModelOnly\u9002\u7528\u573a\u666f"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:'# \u573a\u666f1: \u4ec5\u4fee\u6539\u751f\u6210\u98ce\u683c\uff0c\u4fdd\u6301\u6587\u672c\u7406\u89e3\nmodel = LoraLoaderModelOnly(\n    model=base_model,\n    lora_name="art_style.safetensors",\n    strength_model=1.2\n)\n# CLIP\u4fdd\u6301\u539f\u59cb\u72b6\u6001\n\n# \u573a\u666f2: \u591aLoRA\u53e0\u52a0\uff08\u4ec5\u6a21\u578b\u90e8\u5206\uff09\nmodel = LoraLoaderModelOnly(\n    model=base_model,\n    lora_name="detail_enhancer.safetensors",\n    strength_model=0.5\n)\n\nmodel = LoraLoaderModelOnly(\n    model=model,  # \u94fe\u5f0f\u5e94\u7528\n    lora_name="color_enhancer.safetensors", \n    strength_model=0.3\n)\n'})}),"\n",(0,o.jsx)(n.h2,{id:"\u9ad8\u7ea7\u5e94\u7528\u6280\u5de7",children:"\u9ad8\u7ea7\u5e94\u7528\u6280\u5de7"}),"\n",(0,o.jsx)(n.h3,{id:"1-\u591alora\u53e0\u52a0\u7b56\u7565",children:"1. \u591aLoRA\u53e0\u52a0\u7b56\u7565"}),"\n",(0,o.jsx)(n.h4,{id:"\u4e32\u884c\u53e0\u52a0",children:"\u4e32\u884c\u53e0\u52a0"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:'def apply_multiple_loras_serial(base_model, lora_configs):\n    """\u4e32\u884c\u5e94\u7528\u591a\u4e2aLoRA"""\n    current_model = base_model\n    \n    for config in lora_configs:\n        current_model = LoraLoaderModelOnly(\n            model=current_model,\n            lora_name=config["name"],\n            strength_model=config["strength"]\n        )\n    \n    return current_model\n\n# \u4f7f\u7528\u793a\u4f8b\nlora_stack = [\n    {"name": "base_style.safetensors", "strength": 1.0},\n    {"name": "detail_enhancer.safetensors", "strength": 0.6},\n    {"name": "color_grading.safetensors", "strength": 0.4}\n]\n\nfinal_model = apply_multiple_loras_serial(base_model, lora_stack)\n'})}),"\n",(0,o.jsx)(n.h4,{id:"\u5f3a\u5ea6\u8c03\u8282\u7b56\u7565",children:"\u5f3a\u5ea6\u8c03\u8282\u7b56\u7565"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:'def calculate_optimal_strength(lora_type, base_strength=1.0):\n    """\u6839\u636eLoRA\u7c7b\u578b\u8ba1\u7b97\u6700\u4f18\u5f3a\u5ea6"""\n    strength_multipliers = {\n        "style": 1.0,      # \u98ce\u683cLoRA\n        "character": 0.8,  # \u89d2\u8272LoRA\n        "detail": 0.6,     # \u7ec6\u8282\u589e\u5f3a\n        "lighting": 0.4,   # \u5149\u7167\u6548\u679c\n        "background": 0.5  # \u80cc\u666fLoRA\n    }\n    \n    return base_strength * strength_multipliers.get(lora_type, 1.0)\n'})}),"\n",(0,o.jsx)(n.h3,{id:"2-\u8d1f\u5f3a\u5ea6\u5e94\u7528",children:"2. \u8d1f\u5f3a\u5ea6\u5e94\u7528"}),"\n",(0,o.jsx)(n.h4,{id:"\u53cd\u5411lora\u6548\u679c",children:"\u53cd\u5411LoRA\u6548\u679c"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:'def apply_negative_lora(model, lora_name, negative_strength=-0.5):\n    """\u5e94\u7528\u8d1f\u5f3a\u5ea6LoRA\u5b9e\u73b0\u53cd\u5411\u6548\u679c"""\n    return LoraLoaderModelOnly(\n        model=model,\n        lora_name=lora_name,\n        strength_model=negative_strength  # \u8d1f\u503c\n    )\n\n# \u4f7f\u7528\u573a\u666f\uff1a\u53bb\u9664\u7279\u5b9a\u98ce\u683c\nmodel_without_anime = apply_negative_lora(\n    model=anime_model,\n    lora_name="anime_style.safetensors",\n    negative_strength=-0.8\n)\n'})}),"\n",(0,o.jsx)(n.h3,{id:"3-\u52a8\u6001\u5f3a\u5ea6\u63a7\u5236",children:"3. \u52a8\u6001\u5f3a\u5ea6\u63a7\u5236"}),"\n",(0,o.jsx)(n.h4,{id:"\u6761\u4ef6\u5f3a\u5ea6\u5e94\u7528",children:"\u6761\u4ef6\u5f3a\u5ea6\u5e94\u7528"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:'def conditional_lora_strength(prompt, lora_configs):\n    """\u6839\u636e\u63d0\u793a\u8bcd\u52a8\u6001\u8c03\u6574LoRA\u5f3a\u5ea6"""\n    strength_adjustments = {}\n    \n    for config in lora_configs:\n        base_strength = config["strength"]\n        \n        # \u6839\u636e\u5173\u952e\u8bcd\u8c03\u6574\u5f3a\u5ea6\n        if any(keyword in prompt.lower() for keyword in config.get("boost_keywords", [])):\n            strength_adjustments[config["name"]] = base_strength * 1.3\n        elif any(keyword in prompt.lower() for keyword in config.get("reduce_keywords", [])):\n            strength_adjustments[config["name"]] = base_strength * 0.7\n        else:\n            strength_adjustments[config["name"]] = base_strength\n    \n    return strength_adjustments\n'})}),"\n",(0,o.jsx)(n.h2,{id:"\u6027\u80fd\u4f18\u5316\u548c\u5185\u5b58\u7ba1\u7406",children:"\u6027\u80fd\u4f18\u5316\u548c\u5185\u5b58\u7ba1\u7406"}),"\n",(0,o.jsx)(n.h3,{id:"1-lora\u7f13\u5b58\u673a\u5236",children:"1. LoRA\u7f13\u5b58\u673a\u5236"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:'class LoraCache:\n    def __init__(self):\n        self.loaded_lora = None  # (path, lora_data)\n    \n    def load_lora_with_cache(self, lora_path):\n        """\u5e26\u7f13\u5b58\u7684LoRA\u52a0\u8f7d"""\n        if self.loaded_lora is not None:\n            if self.loaded_lora[0] == lora_path:\n                return self.loaded_lora[1]  # \u4f7f\u7528\u7f13\u5b58\n            else:\n                self.loaded_lora = None  # \u6e05\u9664\u65e7\u7f13\u5b58\n        \n        # \u52a0\u8f7d\u65b0LoRA\n        lora = comfy.utils.load_torch_file(lora_path, safe_load=True)\n        self.loaded_lora = (lora_path, lora)\n        return lora\n'})}),"\n",(0,o.jsx)(n.h3,{id:"2-\u5185\u5b58\u4f7f\u7528\u4f18\u5316",children:"2. \u5185\u5b58\u4f7f\u7528\u4f18\u5316"}),"\n",(0,o.jsx)(n.h4,{id:"lora\u5185\u5b58\u5360\u7528\u5206\u6790",children:"LoRA\u5185\u5b58\u5360\u7528\u5206\u6790"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:'def analyze_lora_memory_usage(lora_path):\n    """\u5206\u6790LoRA\u7684\u5185\u5b58\u4f7f\u7528"""\n    lora = comfy.utils.load_torch_file(lora_path)\n    \n    total_params = 0\n    memory_usage = 0\n    \n    for key, tensor in lora.items():\n        if isinstance(tensor, torch.Tensor):\n            params = tensor.numel()\n            memory = params * tensor.element_size()\n            \n            total_params += params\n            memory_usage += memory\n    \n    return {\n        "total_parameters": total_params,\n        "memory_usage_mb": memory_usage / (1024 * 1024),\n        "estimated_vram_mb": memory_usage * 2 / (1024 * 1024)  # \u8003\u8651\u68af\u5ea6\n    }\n'})}),"\n",(0,o.jsx)(n.h3,{id:"3-\u6279\u91cf\u5904\u7406\u4f18\u5316",children:"3. \u6279\u91cf\u5904\u7406\u4f18\u5316"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:'def batch_apply_loras(models, lora_configs):\n    """\u6279\u91cf\u5e94\u7528LoRA\u5230\u591a\u4e2a\u6a21\u578b"""\n    results = []\n    \n    # \u9884\u52a0\u8f7d\u6240\u6709LoRA\n    lora_cache = {}\n    for config in lora_configs:\n        if config["name"] not in lora_cache:\n            lora_path = folder_paths.get_full_path("loras", config["name"])\n            lora_cache[config["name"]] = comfy.utils.load_torch_file(lora_path)\n    \n    # \u6279\u91cf\u5e94\u7528\n    for model in models:\n        current_model = model\n        for config in lora_configs:\n            current_model = apply_cached_lora(current_model, lora_cache[config["name"]], config["strength"])\n        results.append(current_model)\n    \n    return results\n'})}),"\n",(0,o.jsx)(n.h2,{id:"\u4f7f\u7528\u793a\u4f8b\u548c\u6700\u4f73\u5b9e\u8df5",children:"\u4f7f\u7528\u793a\u4f8b\u548c\u6700\u4f73\u5b9e\u8df5"}),"\n",(0,o.jsx)(n.h3,{id:"\u57fa\u672c\u7528\u6cd5",children:"\u57fa\u672c\u7528\u6cd5"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-json",children:'{\n    "lora_model_only": {\n        "inputs": {\n            "model": ["checkpoint_loader", 0],\n            "lora_name": "style_lora.safetensors",\n            "strength_model": 1.0\n        },\n        "class_type": "LoraLoaderModelOnly"\n    }\n}\n'})}),"\n",(0,o.jsx)(n.h3,{id:"\u591alora\u53e0\u52a0\u5de5\u4f5c\u6d41",children:"\u591aLoRA\u53e0\u52a0\u5de5\u4f5c\u6d41"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-json",children:'{\n    "lora_1": {\n        "inputs": {\n            "model": ["checkpoint_loader", 0],\n            "lora_name": "base_style.safetensors",\n            "strength_model": 1.0\n        },\n        "class_type": "LoraLoaderModelOnly"\n    },\n    "lora_2": {\n        "inputs": {\n            "model": ["lora_1", 0],\n            "lora_name": "detail_enhancer.safetensors", \n            "strength_model": 0.6\n        },\n        "class_type": "LoraLoaderModelOnly"\n    },\n    "ksampler": {\n        "inputs": {\n            "model": ["lora_2", 0],\n            "positive": ["clip_text_encode", 0],\n            "negative": ["clip_text_encode_neg", 0],\n            "latent_image": ["empty_latent", 0]\n        },\n        "class_type": "KSampler"\n    }\n}\n'})}),"\n",(0,o.jsx)(n.h3,{id:"\u7cbe\u786e\u63a7\u5236\u5de5\u4f5c\u6d41",children:"\u7cbe\u786e\u63a7\u5236\u5de5\u4f5c\u6d41"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-json",children:'{\n    "model_lora": {\n        "inputs": {\n            "model": ["unet_loader", 0],\n            "lora_name": "model_specific.safetensors",\n            "strength_model": 0.8\n        },\n        "class_type": "LoraLoaderModelOnly"\n    },\n    "clip_separate": {\n        "inputs": {\n            "clip_name": "custom_clip.safetensors"\n        },\n        "class_type": "CLIPLoader"\n    }\n}\n'})}),"\n",(0,o.jsx)(n.h2,{id:"\u5e38\u89c1\u95ee\u9898\u548c\u89e3\u51b3\u65b9\u6848",children:"\u5e38\u89c1\u95ee\u9898\u548c\u89e3\u51b3\u65b9\u6848"}),"\n",(0,o.jsx)(n.h3,{id:"1-lora\u4e0d\u751f\u6548",children:"1. LoRA\u4e0d\u751f\u6548"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"LoRA loaded but no visible effect\n"})}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.strong,{children:"\u89e3\u51b3\u65b9\u6848"}),":"]}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"\u68c0\u67e5strength_model\u662f\u5426\u4e3a0"}),"\n",(0,o.jsx)(n.li,{children:"\u786e\u8ba4LoRA\u4e0e\u6a21\u578b\u517c\u5bb9\u6027"}),"\n",(0,o.jsx)(n.li,{children:"\u9a8c\u8bc1LoRA\u6587\u4ef6\u5b8c\u6574\u6027"}),"\n",(0,o.jsx)(n.li,{children:"\u68c0\u67e5\u6743\u91cd\u6620\u5c04\u662f\u5426\u6b63\u786e"}),"\n"]}),"\n",(0,o.jsx)(n.h3,{id:"2-\u5185\u5b58\u4e0d\u8db3",children:"2. \u5185\u5b58\u4e0d\u8db3"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"CUDA out of memory when loading LoRA\n"})}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.strong,{children:"\u89e3\u51b3\u65b9\u6848"}),":"]}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"\u51cf\u5c11\u540c\u65f6\u52a0\u8f7d\u7684LoRA\u6570\u91cf"}),"\n",(0,o.jsx)(n.li,{children:"\u964d\u4f4eLoRA\u5f3a\u5ea6\u51cf\u5c11\u8ba1\u7b97\u5f00\u9500"}),"\n",(0,o.jsx)(n.li,{children:"\u4f7f\u7528LoRA\u7f13\u5b58\u673a\u5236"}),"\n",(0,o.jsx)(n.li,{children:"\u542f\u7528\u6a21\u578b\u5378\u8f7d"}),"\n"]}),"\n",(0,o.jsx)(n.h3,{id:"3-\u6743\u91cd\u51b2\u7a81",children:"3. \u6743\u91cd\u51b2\u7a81"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"Multiple LoRA conflicts\n"})}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.strong,{children:"\u89e3\u51b3\u65b9\u6848"}),":"]}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"\u8c03\u6574LoRA\u5e94\u7528\u987a\u5e8f"}),"\n",(0,o.jsx)(n.li,{children:"\u964d\u4f4e\u51b2\u7a81LoRA\u7684\u5f3a\u5ea6"}),"\n",(0,o.jsx)(n.li,{children:"\u4f7f\u7528\u8d1f\u5f3a\u5ea6\u62b5\u6d88\u6548\u679c"}),"\n",(0,o.jsx)(n.li,{children:"\u9009\u62e9\u517c\u5bb9\u7684LoRA\u7ec4\u5408"}),"\n"]}),"\n",(0,o.jsx)(n.h3,{id:"4-\u6027\u80fd\u95ee\u9898",children:"4. \u6027\u80fd\u95ee\u9898"}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.strong,{children:"\u95ee\u9898"}),": LoRA\u52a0\u8f7d\u901f\u5ea6\u6162\n",(0,o.jsx)(n.strong,{children:"\u89e3\u51b3\u65b9\u6848"}),":"]}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"\u542f\u7528LoRA\u7f13\u5b58"}),"\n",(0,o.jsx)(n.li,{children:"\u4f7f\u7528SSD\u5b58\u50a8LoRA\u6587\u4ef6"}),"\n",(0,o.jsx)(n.li,{children:"\u9884\u52a0\u8f7d\u5e38\u7528LoRA"}),"\n",(0,o.jsx)(n.li,{children:"\u4f18\u5316\u6587\u4ef6\u683c\u5f0f"}),"\n"]}),"\n",(0,o.jsx)(n.h2,{id:"\u9ad8\u7ea7\u8c03\u8bd5\u548c\u5206\u6790",children:"\u9ad8\u7ea7\u8c03\u8bd5\u548c\u5206\u6790"}),"\n",(0,o.jsx)(n.h3,{id:"1-lora\u6743\u91cd\u5206\u6790\u5de5\u5177",children:"1. LoRA\u6743\u91cd\u5206\u6790\u5de5\u5177"}),"\n",(0,o.jsx)(n.h4,{id:"\u6743\u91cd\u5206\u5e03\u5206\u6790",children:"\u6743\u91cd\u5206\u5e03\u5206\u6790"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:'def analyze_lora_weights(lora_path):\n    """\u5206\u6790LoRA\u6743\u91cd\u5206\u5e03"""\n    lora = comfy.utils.load_torch_file(lora_path)\n\n    analysis = {\n        "layers": {},\n        "statistics": {},\n        "compatibility": {}\n    }\n\n    for key, tensor in lora.items():\n        if "lora_up" in key or "lora_down" in key:\n            layer_name = key.split(\'.\')[0]\n\n            if layer_name not in analysis["layers"]:\n                analysis["layers"][layer_name] = {}\n\n            analysis["layers"][layer_name][key] = {\n                "shape": list(tensor.shape),\n                "mean": float(tensor.mean()),\n                "std": float(tensor.std()),\n                "min": float(tensor.min()),\n                "max": float(tensor.max())\n            }\n\n    return analysis\n'})}),"\n",(0,o.jsx)(n.h4,{id:"lora\u517c\u5bb9\u6027\u68c0\u67e5",children:"LoRA\u517c\u5bb9\u6027\u68c0\u67e5"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:'def check_lora_compatibility(model, lora_path):\n    """\u68c0\u67e5LoRA\u4e0e\u6a21\u578b\u7684\u517c\u5bb9\u6027"""\n    model_state = model.model.state_dict()\n    lora = comfy.utils.load_torch_file(lora_path)\n\n    compatibility_report = {\n        "compatible_layers": [],\n        "incompatible_layers": [],\n        "missing_layers": [],\n        "coverage_percentage": 0\n    }\n\n    # \u751f\u6210\u952e\u6620\u5c04\n    key_map = comfy.lora.model_lora_keys_unet(model.model, {})\n\n    total_lora_keys = 0\n    matched_keys = 0\n\n    for lora_key in lora.keys():\n        if "lora_up" in lora_key or "lora_down" in lora_key:\n            total_lora_keys += 1\n            base_key = lora_key.replace(".lora_up.weight", "").replace(".lora_down.weight", "")\n\n            if base_key in key_map:\n                model_key = key_map[base_key]\n                if model_key in model_state:\n                    compatibility_report["compatible_layers"].append(base_key)\n                    matched_keys += 1\n                else:\n                    compatibility_report["missing_layers"].append(base_key)\n            else:\n                compatibility_report["incompatible_layers"].append(base_key)\n\n    compatibility_report["coverage_percentage"] = (matched_keys / total_lora_keys * 100) if total_lora_keys > 0 else 0\n\n    return compatibility_report\n'})}),"\n",(0,o.jsx)(n.h3,{id:"2-\u6027\u80fd\u57fa\u51c6\u6d4b\u8bd5",children:"2. \u6027\u80fd\u57fa\u51c6\u6d4b\u8bd5"}),"\n",(0,o.jsx)(n.h4,{id:"lora\u52a0\u8f7d\u6027\u80fd\u6d4b\u8bd5",children:"LoRA\u52a0\u8f7d\u6027\u80fd\u6d4b\u8bd5"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:'def benchmark_lora_loading():\n    """LoRA\u52a0\u8f7d\u6027\u80fd\u57fa\u51c6\u6d4b\u8bd5"""\n    import time\n\n    test_configs = [\n        {"name": "small_lora.safetensors", "expected_size": "< 100MB"},\n        {"name": "medium_lora.safetensors", "expected_size": "100-500MB"},\n        {"name": "large_lora.safetensors", "expected_size": "> 500MB"}\n    ]\n\n    results = {}\n\n    for config in test_configs:\n        # \u6d4b\u8bd5\u51b7\u52a0\u8f7d\n        start_time = time.time()\n        model = LoraLoaderModelOnly(\n            model=base_model,\n            lora_name=config["name"],\n            strength_model=1.0\n        )\n        cold_load_time = time.time() - start_time\n\n        # \u6d4b\u8bd5\u70ed\u52a0\u8f7d\uff08\u7f13\u5b58\uff09\n        start_time = time.time()\n        model = LoraLoaderModelOnly(\n            model=base_model,\n            lora_name=config["name"],\n            strength_model=1.0\n        )\n        hot_load_time = time.time() - start_time\n\n        results[config["name"]] = {\n            "cold_load_time": cold_load_time,\n            "hot_load_time": hot_load_time,\n            "cache_speedup": cold_load_time / hot_load_time if hot_load_time > 0 else float(\'inf\')\n        }\n\n    return results\n'})}),"\n",(0,o.jsx)(n.h4,{id:"\u5185\u5b58\u4f7f\u7528\u76d1\u63a7",children:"\u5185\u5b58\u4f7f\u7528\u76d1\u63a7"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:'def monitor_lora_memory_usage():\n    """\u76d1\u63a7LoRA\u5185\u5b58\u4f7f\u7528"""\n    import psutil\n    import torch\n\n    def get_memory_info():\n        return {\n            "cpu_memory_gb": psutil.virtual_memory().used / 1024**3,\n            "gpu_memory_gb": torch.cuda.memory_allocated() / 1024**3 if torch.cuda.is_available() else 0\n        }\n\n    baseline = get_memory_info()\n\n    # \u52a0\u8f7dLoRA\n    model = LoraLoaderModelOnly(\n        model=base_model,\n        lora_name="test_lora.safetensors",\n        strength_model=1.0\n    )\n\n    after_load = get_memory_info()\n\n    memory_impact = {\n        "cpu_increase_gb": after_load["cpu_memory_gb"] - baseline["cpu_memory_gb"],\n        "gpu_increase_gb": after_load["gpu_memory_gb"] - baseline["gpu_memory_gb"],\n        "total_increase_gb": (after_load["cpu_memory_gb"] + after_load["gpu_memory_gb"]) -\n                           (baseline["cpu_memory_gb"] + baseline["gpu_memory_gb"])\n    }\n\n    return memory_impact\n'})}),"\n",(0,o.jsx)(n.h3,{id:"3-\u9ad8\u7ea7\u5de5\u4f5c\u6d41\u6a21\u5f0f",children:"3. \u9ad8\u7ea7\u5de5\u4f5c\u6d41\u6a21\u5f0f"}),"\n",(0,o.jsx)(n.h4,{id:"\u6761\u4ef6lora\u5e94\u7528",children:"\u6761\u4ef6LoRA\u5e94\u7528"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:'def conditional_lora_workflow(prompt, model, lora_rules):\n    """\u6839\u636e\u63d0\u793a\u8bcd\u6761\u4ef6\u5e94\u7528LoRA"""\n\n    applied_loras = []\n    current_model = model\n\n    for rule in lora_rules:\n        should_apply = False\n\n        # \u68c0\u67e5\u89e6\u53d1\u6761\u4ef6\n        if rule["type"] == "keyword":\n            should_apply = any(keyword.lower() in prompt.lower() for keyword in rule["keywords"])\n        elif rule["type"] == "regex":\n            import re\n            should_apply = bool(re.search(rule["pattern"], prompt, re.IGNORECASE))\n        elif rule["type"] == "length":\n            should_apply = len(prompt.split()) >= rule["min_words"]\n\n        if should_apply:\n            current_model = LoraLoaderModelOnly(\n                model=current_model,\n                lora_name=rule["lora_name"],\n                strength_model=rule["strength"]\n            )\n            applied_loras.append(rule["lora_name"])\n\n    return current_model, applied_loras\n\n# \u4f7f\u7528\u793a\u4f8b\nlora_rules = [\n    {\n        "type": "keyword",\n        "keywords": ["anime", "manga", "cartoon"],\n        "lora_name": "anime_style.safetensors",\n        "strength": 1.0\n    },\n    {\n        "type": "keyword",\n        "keywords": ["portrait", "face", "headshot"],\n        "lora_name": "portrait_enhancer.safetensors",\n        "strength": 0.8\n    },\n    {\n        "type": "regex",\n        "pattern": r"\\b(oil painting|watercolor|acrylic)\\b",\n        "lora_name": "traditional_art.safetensors",\n        "strength": 0.9\n    }\n]\n'})}),"\n",(0,o.jsx)(n.h4,{id:"\u81ea\u9002\u5e94\u5f3a\u5ea6\u8c03\u8282",children:"\u81ea\u9002\u5e94\u5f3a\u5ea6\u8c03\u8282"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:'def adaptive_lora_strength(model, lora_name, target_similarity=0.8):\n    """\u81ea\u9002\u5e94\u8c03\u8282LoRA\u5f3a\u5ea6\u4ee5\u8fbe\u5230\u76ee\u6807\u76f8\u4f3c\u5ea6"""\n\n    def calculate_similarity(model1, model2, test_input):\n        """\u8ba1\u7b97\u4e24\u4e2a\u6a21\u578b\u8f93\u51fa\u7684\u76f8\u4f3c\u5ea6"""\n        with torch.no_grad():\n            output1 = model1(test_input)\n            output2 = model2(test_input)\n            similarity = torch.cosine_similarity(output1.flatten(), output2.flatten(), dim=0)\n        return float(similarity)\n\n    # \u751f\u6210\u6d4b\u8bd5\u8f93\u5165\n    test_input = torch.randn(1, 4, 64, 64)  # \u793a\u4f8b\u6f5c\u5728\u7a7a\u95f4\u8f93\u5165\n\n    # \u4e8c\u5206\u641c\u7d22\u6700\u4f18\u5f3a\u5ea6\n    low_strength = 0.0\n    high_strength = 2.0\n    optimal_strength = 1.0\n\n    for _ in range(10):  # \u6700\u591a10\u6b21\u8fed\u4ee3\n        mid_strength = (low_strength + high_strength) / 2\n\n        lora_model = LoraLoaderModelOnly(\n            model=model,\n            lora_name=lora_name,\n            strength_model=mid_strength\n        )\n\n        similarity = calculate_similarity(model, lora_model, test_input)\n\n        if abs(similarity - target_similarity) < 0.05:  # \u5bb9\u5dee\n            optimal_strength = mid_strength\n            break\n        elif similarity > target_similarity:\n            high_strength = mid_strength\n        else:\n            low_strength = mid_strength\n\n    return optimal_strength\n'})}),"\n",(0,o.jsx)(n.h3,{id:"4-\u6545\u969c\u6392\u9664\u548c\u8bca\u65ad",children:"4. \u6545\u969c\u6392\u9664\u548c\u8bca\u65ad"}),"\n",(0,o.jsx)(n.h4,{id:"\u81ea\u52a8\u8bca\u65ad\u5de5\u5177",children:"\u81ea\u52a8\u8bca\u65ad\u5de5\u5177"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:'def diagnose_lora_issues(model, lora_name, strength_model):\n    """\u81ea\u52a8\u8bca\u65adLoRA\u95ee\u9898"""\n\n    diagnosis = {\n        "file_check": "PASS",\n        "compatibility_check": "PASS",\n        "memory_check": "PASS",\n        "strength_check": "PASS",\n        "warnings": [],\n        "errors": [],\n        "suggestions": []\n    }\n\n    try:\n        # 1. \u6587\u4ef6\u5b58\u5728\u6027\u68c0\u67e5\n        lora_path = folder_paths.get_full_path("loras", lora_name)\n        if not os.path.exists(lora_path):\n            diagnosis["file_check"] = "FAIL"\n            diagnosis["errors"].append(f"LoRA file not found: {lora_name}")\n            return diagnosis\n\n        # 2. \u6587\u4ef6\u5b8c\u6574\u6027\u68c0\u67e5\n        try:\n            lora = comfy.utils.load_torch_file(lora_path)\n        except Exception as e:\n            diagnosis["file_check"] = "FAIL"\n            diagnosis["errors"].append(f"Failed to load LoRA file: {str(e)}")\n            return diagnosis\n\n        # 3. \u517c\u5bb9\u6027\u68c0\u67e5\n        compatibility = check_lora_compatibility(model, lora_path)\n        if compatibility["coverage_percentage"] < 50:\n            diagnosis["compatibility_check"] = "WARNING"\n            diagnosis["warnings"].append(f"Low compatibility: {compatibility[\'coverage_percentage\']:.1f}%")\n\n        # 4. \u5f3a\u5ea6\u68c0\u67e5\n        if abs(strength_model) > 2.0:\n            diagnosis["strength_check"] = "WARNING"\n            diagnosis["warnings"].append(f"High strength value: {strength_model}")\n            diagnosis["suggestions"].append("Consider using strength between -2.0 and 2.0")\n\n        # 5. \u5185\u5b58\u68c0\u67e5\n        memory_usage = analyze_lora_memory_usage(lora_path)\n        if memory_usage["memory_usage_mb"] > 1000:  # 1GB\n            diagnosis["memory_check"] = "WARNING"\n            diagnosis["warnings"].append(f"Large LoRA file: {memory_usage[\'memory_usage_mb\']:.1f}MB")\n            diagnosis["suggestions"].append("Consider using model offloading for large LoRAs")\n\n    except Exception as e:\n        diagnosis["errors"].append(f"Diagnosis failed: {str(e)}")\n\n    return diagnosis\n'})}),"\n",(0,o.jsx)(n.h4,{id:"\u5e38\u89c1\u95ee\u9898\u81ea\u52a8\u4fee\u590d",children:"\u5e38\u89c1\u95ee\u9898\u81ea\u52a8\u4fee\u590d"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-python",children:'def auto_fix_lora_issues(model, lora_name, strength_model):\n    """\u81ea\u52a8\u4fee\u590d\u5e38\u89c1LoRA\u95ee\u9898"""\n\n    fixes_applied = []\n\n    # \u8bca\u65ad\u95ee\u9898\n    diagnosis = diagnose_lora_issues(model, lora_name, strength_model)\n\n    # \u81ea\u52a8\u4fee\u590d\n    fixed_strength = strength_model\n\n    # \u4fee\u590d\u8fc7\u9ad8\u7684\u5f3a\u5ea6\n    if abs(strength_model) > 2.0:\n        fixed_strength = 2.0 if strength_model > 0 else -2.0\n        fixes_applied.append(f"Clamped strength from {strength_model} to {fixed_strength}")\n\n    # \u4fee\u590d\u96f6\u5f3a\u5ea6\n    if strength_model == 0:\n        fixed_strength = 1.0\n        fixes_applied.append("Changed zero strength to 1.0")\n\n    # \u5e94\u7528\u4fee\u590d\u540e\u7684LoRA\n    try:\n        fixed_model = LoraLoaderModelOnly(\n            model=model,\n            lora_name=lora_name,\n            strength_model=fixed_strength\n        )\n\n        return {\n            "success": True,\n            "model": fixed_model,\n            "fixes_applied": fixes_applied,\n            "final_strength": fixed_strength\n        }\n    except Exception as e:\n        return {\n            "success": False,\n            "error": str(e),\n            "fixes_applied": fixes_applied\n        }\n'})}),"\n",(0,o.jsx)(n.h2,{id:"\u603b\u7ed3",children:"\u603b\u7ed3"}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.code,{children:"LoraLoaderModelOnly"}),"\u662fComfyUI\u4e2d\u7684\u4e13\u4e1a\u5316LoRA\u52a0\u8f7d\u5de5\u5177\uff0c\u5b83\uff1a"]}),"\n",(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"\u4e13\u6ce8\u6027"}),": \u4ec5\u5904\u7406\u6269\u6563\u6a21\u578b\uff0c\u4e0d\u6d89\u53caCLIP"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"\u7cbe\u786e\u6027"}),": \u63d0\u4f9b\u7cbe\u786e\u7684\u6a21\u578b\u6743\u91cd\u63a7\u5236"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"\u9ad8\u6548\u6027"}),": \u51cf\u5c11\u4e0d\u5fc5\u8981\u7684CLIP\u5904\u7406\u5f00\u9500"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"\u7075\u6d3b\u6027"}),": \u652f\u6301\u591aLoRA\u53e0\u52a0\u548c\u8d1f\u5f3a\u5ea6\u5e94\u7528"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"\u4e13\u4e1a\u6027"}),": \u9002\u5408\u9ad8\u7ea7\u7528\u6237\u548c\u590d\u6742\u5de5\u4f5c\u6d41"]}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"\u7406\u89e3LoraLoaderModelOnly\u7684\u4f7f\u7528\u65b9\u6cd5\u5bf9\u4e8e\uff1a"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"\u7cbe\u786e\u7684\u98ce\u683c\u63a7\u5236"}),"\n",(0,o.jsx)(n.li,{children:"\u590d\u6742\u7684LoRA\u7ec4\u5408"}),"\n",(0,o.jsx)(n.li,{children:"\u6027\u80fd\u4f18\u5316\u9700\u6c42"}),"\n",(0,o.jsx)(n.li,{children:"\u4e13\u4e1a\u5de5\u4f5c\u6d41\u8bbe\u8ba1"}),"\n"]}),"\n",(0,o.jsx)(n.p,{children:"\u5177\u6709\u91cd\u8981\u610f\u4e49\u3002\u5b83\u4e3a\u9700\u8981\u7cbe\u7ec6\u63a7\u5236LoRA\u5e94\u7528\u8303\u56f4\u7684\u7528\u6237\u63d0\u4f9b\u4e86\u5f3a\u5927\u7684\u5de5\u5177\u3002"}),"\n",(0,o.jsx)(n.h2,{id:"\u76f8\u5173\u8d44\u6e90",children:"\u76f8\u5173\u8d44\u6e90"}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"https://arxiv.org/abs/2106.09685",children:"LoRA\u8bba\u6587"})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"https://docs.comfy.org/essentials/lora",children:"ComfyUI LoRA\u6587\u6863"})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"https://github.com/cloneofsimo/lora",children:"LoRA\u8bad\u7ec3\u6307\u5357"})}),"\n",(0,o.jsx)(n.li,{children:(0,o.jsx)(n.a,{href:"https://arxiv.org/abs/2205.05638",children:"\u6743\u91cd\u9002\u914d\u5668\u6280\u672f"})}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(c,{...e})}):c(e)}},54213:(e,n,l)=>{l.d(n,{R:()=>s,x:()=>i});var r=l(36672);const o={},a=r.createContext(o);function s(e){const n=r.useContext(a);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:s(e.components),r.createElement(a.Provider,{value:n},e.children)}}}]);