"use strict";(self.webpackChunknotes_3=self.webpackChunknotes_3||[]).push([[5482],{30925:(n,e,t)=>{t.r(e),t.d(e,{assets:()=>l,contentTitle:()=>c,default:()=>u,frontMatter:()=>i,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"Tools/\u6570\u636e\u5e93/Postgres/\u5206\u6790\u6570\u636e\u5e93\u8fde\u63a5","title":"\u5206\u6790\u6570\u636e\u5e93\u8fde\u63a5","description":"\u67e5\u770b\u5f53\u524d\u6240\u6709\u8fde\u63a5\u8be6\u7ec6\u4fe1\u606f","source":"@site/docs/Tools/\u6570\u636e\u5e93/Postgres/\u5206\u6790\u6570\u636e\u5e93\u8fde\u63a5.mdx","sourceDirName":"Tools/\u6570\u636e\u5e93/Postgres","slug":"/Tools/\u6570\u636e\u5e93/Postgres/\u5206\u6790\u6570\u636e\u5e93\u8fde\u63a5","permalink":"/notes3/docs/Tools/\u6570\u636e\u5e93/Postgres/\u5206\u6790\u6570\u636e\u5e93\u8fde\u63a5","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Tools/\u6570\u636e\u5e93/Postgres/\u5206\u6790\u6570\u636e\u5e93\u8fde\u63a5.mdx","tags":[],"version":"current","frontMatter":{},"sidebar":"tools","previous":{"title":"Postgres","permalink":"/notes3/docs/category/postgres"},"next":{"title":"\u5b89\u88c5","permalink":"/notes3/docs/Tools/\u6570\u636e\u5e93/Postgres/\u5b89\u88c5"}}');var a=t(23420),s=t(54213);const i={},c=void 0,l={},d=[{value:"\u67e5\u770b\u5f53\u524d\u6240\u6709\u8fde\u63a5\u8be6\u7ec6\u4fe1\u606f",id:"\u67e5\u770b\u5f53\u524d\u6240\u6709\u8fde\u63a5\u8be6\u7ec6\u4fe1\u606f",level:2},{value:"\u67e5\u770b\u6bcf\u4e2a\u6570\u636e\u5e93\u7684\u8fde\u63a5\u6570",id:"\u67e5\u770b\u6bcf\u4e2a\u6570\u636e\u5e93\u7684\u8fde\u63a5\u6570",level:2},{value:"\u67e5\u770b\u6700\u5927\u8fde\u63a5\u6570\u914d\u7f6e",id:"\u67e5\u770b\u6700\u5927\u8fde\u63a5\u6570\u914d\u7f6e",level:2},{value:"\u67e5\u770b\u7a7a\u95f2\u8fde\u63a5",id:"\u67e5\u770b\u7a7a\u95f2\u8fde\u63a5",level:2},{value:"\u67e5\u770b\u6b63\u5728\u6267\u884c\u7684\u67e5\u8be2",id:"\u67e5\u770b\u6b63\u5728\u6267\u884c\u7684\u67e5\u8be2",level:2},{value:"\u8fde\u63a5\u6c60\u7edf\u8ba1",id:"\u8fde\u63a5\u6c60\u7edf\u8ba1",level:2},{value:"\u7ec8\u6b62\u8fde\u63a5\u7684\u547d\u4ee4",id:"\u7ec8\u6b62\u8fde\u63a5\u7684\u547d\u4ee4",level:2},{value:"\u76d1\u63a7\u8fde\u63a5\u53d8\u5316",id:"\u76d1\u63a7\u8fde\u63a5\u53d8\u5316",level:2},{value:"\u6027\u80fd\u76f8\u5173\u67e5\u8be2",id:"\u6027\u80fd\u76f8\u5173\u67e5\u8be2",level:2},{value:"\u5b9a\u671f\u6e05\u7406\u811a\u672c",id:"\u5b9a\u671f\u6e05\u7406\u811a\u672c",level:2}];function o(n){const e={code:"code",h2:"h2",pre:"pre",...(0,s.R)(),...n.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(e.h2,{id:"\u67e5\u770b\u5f53\u524d\u6240\u6709\u8fde\u63a5\u8be6\u7ec6\u4fe1\u606f",children:"\u67e5\u770b\u5f53\u524d\u6240\u6709\u8fde\u63a5\u8be6\u7ec6\u4fe1\u606f"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"SELECT\r\n    pid,\r\n    usename as username,\r\n    datname as database,\r\n    client_addr as client_ip,\r\n    application_name,\r\n    backend_start,\r\n    state,\r\n    state_change,\r\n    wait_event_type,\r\n    wait_event,\r\n    query\r\nFROM pg_stat_activity;\n"})}),"\n",(0,a.jsx)(e.h2,{id:"\u67e5\u770b\u6bcf\u4e2a\u6570\u636e\u5e93\u7684\u8fde\u63a5\u6570",children:"\u67e5\u770b\u6bcf\u4e2a\u6570\u636e\u5e93\u7684\u8fde\u63a5\u6570"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"SELECT\r\n    datname as database,\r\n    count(*) as connection_count\r\nFROM pg_stat_activity\r\nGROUP BY datname;\n"})}),"\n",(0,a.jsx)(e.h2,{id:"\u67e5\u770b\u6700\u5927\u8fde\u63a5\u6570\u914d\u7f6e",children:"\u67e5\u770b\u6700\u5927\u8fde\u63a5\u6570\u914d\u7f6e"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"-- \u67e5\u770b\u6700\u5927\u8fde\u63a5\u6570\u8bbe\u7f6e\r\nSHOW max_connections;\r\n\r\n-- \u67e5\u770b\u6bcf\u79cd\u7c7b\u578b\u7684\u6700\u5927\u8fde\u63a5\u6570\r\nSHOW superuser_reserved_connections;\n"})}),"\n",(0,a.jsx)(e.h2,{id:"\u67e5\u770b\u7a7a\u95f2\u8fde\u63a5",children:"\u67e5\u770b\u7a7a\u95f2\u8fde\u63a5"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"-- \u67e5\u770b\u7a7a\u95f2\u8fde\u63a5\r\nSELECT\r\n    pid,\r\n    usename,\r\n    datname,\r\n    state,\r\n    current_timestamp - state_change as idle_time\r\nFROM pg_stat_activity\r\nWHERE state = 'idle';\r\n\r\n-- \u67e5\u770b\u957f\u65f6\u95f4\u7a7a\u95f2\u7684\u8fde\u63a5(\u8d85\u8fc75\u5206\u949f)\r\nSELECT *\r\nFROM pg_stat_activity\r\nWHERE state = 'idle'\r\nAND current_timestamp - state_change > interval '5 minutes';\n"})}),"\n",(0,a.jsx)(e.h2,{id:"\u67e5\u770b\u6b63\u5728\u6267\u884c\u7684\u67e5\u8be2",children:"\u67e5\u770b\u6b63\u5728\u6267\u884c\u7684\u67e5\u8be2"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"-- \u67e5\u770b\u5f53\u524d\u6b63\u5728\u6267\u884c\u7684\u67e5\u8be2\r\nSELECT\r\n    pid,\r\n    usename,\r\n    query_start,\r\n    now() - query_start as duration,\r\n    query\r\nFROM pg_stat_activity\r\nWHERE state = 'active';\r\n\r\n-- \u67e5\u770b\u957f\u65f6\u95f4\u8fd0\u884c\u7684\u67e5\u8be2(\u8d85\u8fc71\u5206\u949f)\r\nSELECT\r\n    pid,\r\n    usename,\r\n    query_start,\r\n    now() - query_start as duration,\r\n    query\r\nFROM pg_stat_activity\r\nWHERE state = 'active'\r\nAND now() - query_start > interval '1 minute';\n"})}),"\n",(0,a.jsx)(e.h2,{id:"\u8fde\u63a5\u6c60\u7edf\u8ba1",children:"\u8fde\u63a5\u6c60\u7edf\u8ba1"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"-- \u67e5\u770b\u7b49\u5f85\u8fde\u63a5\u7684\u6570\u91cf\r\nSELECT count(*)\r\nFROM pg_stat_activity\r\nWHERE wait_event_type = 'Client';\r\n\r\n-- \u67e5\u770b\u5404\u79cd\u72b6\u6001\u7684\u8fde\u63a5\u6570\u91cf\r\nSELECT\r\n    state,\r\n    count(*)\r\nFROM pg_stat_activity\r\nGROUP BY state;\n"})}),"\n",(0,a.jsx)(e.h2,{id:"\u7ec8\u6b62\u8fde\u63a5\u7684\u547d\u4ee4",children:"\u7ec8\u6b62\u8fde\u63a5\u7684\u547d\u4ee4"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"-- \u7ec8\u6b62\u6307\u5b9a\u8fde\u63a5\r\nSELECT pg_terminate_backend(pid)\r\nFROM pg_stat_activity\r\nWHERE state = 'idle'\r\nAND pid <> pg_backend_pid();\r\n\r\n-- \u7ec8\u6b62\u6307\u5b9a\u6570\u636e\u5e93\u7684\u6240\u6709\u8fde\u63a5\r\nSELECT pg_terminate_backend(pid)\r\nFROM pg_stat_activity\r\nWHERE datname = 'database_name';\r\n\r\n-- \u7ec8\u6b62\u7a7a\u95f2\u8d85\u8fc710\u5206\u949f\u7684\u8fde\u63a5\r\nSELECT pg_terminate_backend(pid)\r\nFROM pg_stat_activity\r\nWHERE state = 'idle'\r\nAND current_timestamp - state_change > interval '10 minutes';\n"})}),"\n",(0,a.jsx)(e.h2,{id:"\u76d1\u63a7\u8fde\u63a5\u53d8\u5316",children:"\u76d1\u63a7\u8fde\u63a5\u53d8\u5316"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"-- \u521b\u5efa\u76d1\u63a7\u89c6\u56fe\r\nCREATE VIEW connection_stats AS\r\nSELECT\r\n    datname,\r\n    usename,\r\n    count(*) as total_connections,\r\n    sum(CASE WHEN state = 'active' THEN 1 ELSE 0 END) as active_connections,\r\n    sum(CASE WHEN state = 'idle' THEN 1 ELSE 0 END) as idle_connections\r\nFROM pg_stat_activity\r\nGROUP BY datname, usename;\r\n\r\n-- \u67e5\u770b\u8fde\u63a5\u7edf\u8ba1\r\nSELECT * FROM connection_stats;\n"})}),"\n",(0,a.jsx)(e.h2,{id:"\u6027\u80fd\u76f8\u5173\u67e5\u8be2",children:"\u6027\u80fd\u76f8\u5173\u67e5\u8be2"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"-- \u67e5\u770b\u7b49\u5f85\u4e8b\u4ef6\r\nSELECT\r\n    wait_event_type,\r\n    wait_event,\r\n    count(*)\r\nFROM pg_stat_activity\r\nWHERE wait_event is not null\r\nGROUP BY wait_event_type, wait_event;\r\n\r\n-- \u67e5\u770b\u8fde\u63a5\u65f6\u957f\u5206\u5e03\r\nSELECT\r\n    datname,\r\n    extract(epoch from now() - backend_start)::integer / 60 as minutes_connected,\r\n    count(*)\r\nFROM pg_stat_activity\r\nGROUP BY datname, minutes_connected\r\nORDER BY datname, minutes_connected;\n"})}),"\n",(0,a.jsx)(e.h2,{id:"\u5b9a\u671f\u6e05\u7406\u811a\u672c",children:"\u5b9a\u671f\u6e05\u7406\u811a\u672c"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"-- \u521b\u5efa\u6e05\u7406\u51fd\u6570\r\nCREATE OR REPLACE FUNCTION cleanup_idle_connections()\r\nRETURNS void AS $$\r\nBEGIN\r\n    PERFORM pg_terminate_backend(pid)\r\n    FROM pg_stat_activity\r\n    WHERE state = 'idle'\r\n    AND current_timestamp - state_change > interval '30 minutes'\r\n    AND pid <> pg_backend_pid();\r\nEND;\r\n$$ LANGUAGE plpgsql;\r\n\r\n-- \u4f7f\u7528\r\nSELECT cleanup_idle_connections();\n"})})]})}function u(n={}){const{wrapper:e}={...(0,s.R)(),...n.components};return e?(0,a.jsx)(e,{...n,children:(0,a.jsx)(o,{...n})}):o(n)}},54213:(n,e,t)=>{t.d(e,{R:()=>i,x:()=>c});var r=t(36672);const a={},s=r.createContext(a);function i(n){const e=r.useContext(s);return r.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function c(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(a):n.components||a:i(n.components),r.createElement(s.Provider,{value:e},n.children)}}}]);