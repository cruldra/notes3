"use strict";(self.webpackChunknotes_3=self.webpackChunknotes_3||[]).push([[61264],{54213:(e,n,r)=>{r.d(n,{R:()=>i,x:()=>l});var s=r(36672);const t={},d=s.createContext(t);function i(e){const n=s.useContext(d);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:i(e.components),s.createElement(d.Provider,{value:n},e.children)}},64727:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>l,default:()=>h,frontMatter:()=>i,metadata:()=>s,toc:()=>o});const s=JSON.parse('{"id":"AI/Pytorch/\u5206\u5e03\u5f0f\u8bad\u7ec3/DistributedDataParallel","title":"DistributedDataParallel","description":"1. \u6982\u8ff0","source":"@site/docs/AI/Pytorch/\u5206\u5e03\u5f0f\u8bad\u7ec3/DistributedDataParallel.md","sourceDirName":"AI/Pytorch/\u5206\u5e03\u5f0f\u8bad\u7ec3","slug":"/AI/Pytorch/\u5206\u5e03\u5f0f\u8bad\u7ec3/DistributedDataParallel","permalink":"/notes3/docs/AI/Pytorch/\u5206\u5e03\u5f0f\u8bad\u7ec3/DistributedDataParallel","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/AI/Pytorch/\u5206\u5e03\u5f0f\u8bad\u7ec3/DistributedDataParallel.md","tags":[],"version":"current","frontMatter":{},"sidebar":"ai","previous":{"title":"\u7b80\u4ecb","permalink":"/notes3/docs/AI/Pytorch/\u4f18\u5316/\u7b80\u4ecb"},"next":{"title":"torch_distributed","permalink":"/notes3/docs/AI/Pytorch/\u5206\u5e03\u5f0f\u8bad\u7ec3/torch_distributed"}}');var t=r(23420),d=r(54213);const i={},l=void 0,c={},o=[{value:"1. \u6982\u8ff0",id:"1-\u6982\u8ff0",level:2},{value:"2. \u6838\u5fc3\u67b6\u6784\u4e0e\u5de5\u4f5c\u6d41",id:"2-\u6838\u5fc3\u67b6\u6784\u4e0e\u5de5\u4f5c\u6d41",level:2},{value:"2.1 \u9884\u5907\u4e0e\u6784\u5efa (Prerequisite &amp; Construction)",id:"21-\u9884\u5907\u4e0e\u6784\u5efa-prerequisite--construction",level:3},{value:"2.2 \u524d\u5411\u4f20\u64ad (Forward Pass)",id:"22-\u524d\u5411\u4f20\u64ad-forward-pass",level:3},{value:"2.3 \u53cd\u5411\u4f20\u64ad (Backward Pass) \u2014\u2014 \u6838\u5fc3\u673a\u5236",id:"23-\u53cd\u5411\u4f20\u64ad-backward-pass--\u6838\u5fc3\u673a\u5236",level:3},{value:"2.4 \u4f18\u5316\u6b65\u9aa4 (Optimizer Step)",id:"24-\u4f18\u5316\u6b65\u9aa4-optimizer-step",level:3},{value:"3. \u5173\u952e\u4f18\u5316\u6280\u672f",id:"3-\u5173\u952e\u4f18\u5316\u6280\u672f",level:2},{value:"3.1 \u68af\u5ea6\u5206\u6876 (Gradient Bucketing)",id:"31-\u68af\u5ea6\u5206\u6876-gradient-bucketing",level:3},{value:"3.2 \u8ba1\u7b97\u4e0e\u901a\u4fe1\u91cd\u53e0 (Communication-Computation Overlap)",id:"32-\u8ba1\u7b97\u4e0e\u901a\u4fe1\u91cd\u53e0-communication-computation-overlap",level:3},{value:"3.3 \u68af\u5ea6\u7d2f\u79ef\u4e0e <code>no_sync</code>",id:"33-\u68af\u5ea6\u7d2f\u79ef\u4e0e-no_sync",level:3},{value:"4. \u5b8c\u6574\u4ee3\u7801\u5b9e\u8df5 (Code Implementation)",id:"4-\u5b8c\u6574\u4ee3\u7801\u5b9e\u8df5-code-implementation",level:2},{value:"4.1 \u4ee3\u7801\u5173\u952e\u70b9\u89e3\u6790",id:"41-\u4ee3\u7801\u5173\u952e\u70b9\u89e3\u6790",level:3},{value:"5. \u67b6\u6784\u793a\u610f\u56fe",id:"5-\u67b6\u6784\u793a\u610f\u56fe",level:2},{value:"6. \u5b9e\u73b0\u7ec6\u8282\u4e0e\u7ec4\u4ef6",id:"6-\u5b9e\u73b0\u7ec6\u8282\u4e0e\u7ec4\u4ef6",level:2},{value:"7. \u53c2\u8003\u8d44\u6599",id:"7-\u53c2\u8003\u8d44\u6599",level:2}];function a(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,d.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h2,{id:"1-\u6982\u8ff0",children:"1. \u6982\u8ff0"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"torch.nn.parallel.DistributedDataParallel"})," (DDP) \u662f PyTorch \u5b98\u65b9\u63a8\u8350\u7684\u5206\u5e03\u5f0f\u8bad\u7ec3\u89e3\u51b3\u65b9\u6848\u3002\u4e0e\u5355\u8fdb\u7a0b\u591a\u7ebf\u7a0b\u7684 ",(0,t.jsx)(n.code,{children:"DataParallel"})," \u4e0d\u540c\uff0cDDP \u91c7\u7528",(0,t.jsx)(n.strong,{children:"\u591a\u8fdb\u7a0b\u67b6\u6784"}),"\uff08Multi-Process\uff09\uff0c\u6bcf\u4e2a GPU \u5bf9\u5e94\u4e00\u4e2a\u72ec\u7acb\u7684\u8fdb\u7a0b\u3002\u8fd9\u79cd\u67b6\u6784\u4e0d\u4ec5\u907f\u514d\u4e86 Python GIL\uff08\u5168\u5c40\u89e3\u91ca\u5668\u9501\uff09\u5e26\u6765\u7684\u6027\u80fd\u9650\u5236\uff0c\u8fd8\u652f\u6301\u8de8\u591a\u8282\u70b9\u7684\u6269\u5c55\u3002"]}),"\n",(0,t.jsxs)(n.p,{children:["DDP \u7684\u6838\u5fc3\u76ee\u6807\u662f\u5b9e\u73b0",(0,t.jsx)(n.strong,{children:"\u900f\u660e\u7684"}),"\u5206\u5e03\u5f0f\u6570\u636e\u5e76\u884c\u8bad\u7ec3\uff1a\u5b83\u81ea\u52a8\u7ba1\u7406\u6a21\u578b\u526f\u672c\u7684\u521d\u59cb\u5316\u3001\u68af\u5ea6\u7684\u540c\u6b65\u4ee5\u53ca\u901a\u4fe1\u4e0e\u8ba1\u7b97\u7684\u91cd\u53e0\uff0c\u4f7f\u5f97\u7528\u6237\u7f16\u5199\u5206\u5e03\u5f0f\u8bad\u7ec3\u4ee3\u7801\u65f6\uff0c\u51e0\u4e4e\u611f\u89c9\u4e0d\u5230\u4e0e\u5355\u5361\u8bad\u7ec3\u7684\u533a\u522b\u3002"]}),"\n",(0,t.jsx)(n.h2,{id:"2-\u6838\u5fc3\u67b6\u6784\u4e0e\u5de5\u4f5c\u6d41",children:"2. \u6838\u5fc3\u67b6\u6784\u4e0e\u5de5\u4f5c\u6d41"}),"\n",(0,t.jsx)(n.p,{children:"DDP \u7684\u5de5\u4f5c\u6d41\u7a0b\u53ef\u4ee5\u5206\u4e3a\u6784\u5efa\uff08Construction\uff09\u3001\u524d\u5411\u4f20\u64ad\uff08Forward Pass\uff09\u3001\u53cd\u5411\u4f20\u64ad\uff08Backward Pass\uff09\u548c\u4f18\u5316\u6b65\u9aa4\uff08Optimizer Step\uff09\u56db\u4e2a\u9636\u6bb5\u3002"}),"\n",(0,t.jsx)(n.h3,{id:"21-\u9884\u5907\u4e0e\u6784\u5efa-prerequisite--construction",children:"2.1 \u9884\u5907\u4e0e\u6784\u5efa (Prerequisite & Construction)"}),"\n",(0,t.jsxs)(n.p,{children:["DDP \u4f9d\u8d56\u4e8e ",(0,t.jsx)(n.code,{children:"c10d"})," \u5e93\u4e2d\u7684 ",(0,t.jsx)(n.code,{children:"ProcessGroup"})," \u8fdb\u884c\u5e95\u5c42\u901a\u4fe1\uff08\u901a\u5e38\u4f7f\u7528 NCCL \u540e\u7aef\u4ee5\u83b7\u5f97\u6700\u4f73 GPU \u6027\u80fd\uff09\u3002"]}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"\u8fdb\u7a0b\u7ec4\u521d\u59cb\u5316"}),"\uff1a\u5728\u6784\u5efa DDP \u5b9e\u4f8b\u524d\uff0c\u5fc5\u987b\u5148\u521d\u59cb\u5316 ",(0,t.jsx)(n.code,{children:"ProcessGroup"}),"\u3002"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"\u72b6\u6001\u5e7f\u64ad (State Broadcast)"}),"\uff1aDDP \u6784\u9020\u51fd\u6570\u4f1a\u5c06 ",(0,t.jsx)(n.code,{children:"rank 0"})," \u8fdb\u7a0b\u4e0a\u7684\u6a21\u578b ",(0,t.jsx)(n.code,{children:"state_dict()"})," \u5e7f\u64ad\u5230\u6240\u6709\u5176\u4ed6\u8fdb\u7a0b\uff0c\u786e\u4fdd\u6240\u6709\u6a21\u578b\u526f\u672c\u5728\u8bad\u7ec3\u5f00\u59cb\u65f6\u5177\u6709\u5b8c\u5168\u4e00\u81f4\u7684\u6743\u91cd\u3002"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Reducer \u521d\u59cb\u5316\u4e0e\u5206\u6876 (Bucketing)"}),"\uff1a","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\u6bcf\u4e2a DDP \u8fdb\u7a0b\u4f1a\u521b\u5efa\u4e00\u4e2a\u672c\u5730\u7684 ",(0,t.jsx)(n.code,{children:"Reducer"}),"\u3002"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"Reducer"})," \u8d1f\u8d23\u5728\u53cd\u5411\u4f20\u64ad\u671f\u95f4\u540c\u6b65\u68af\u5ea6\u3002"]}),"\n",(0,t.jsxs)(n.li,{children:["\u4e3a\u4e86\u63d0\u9ad8\u901a\u4fe1\u6548\u7387\uff0c\u53c2\u6570\u7684\u68af\u5ea6\u88ab\u7ec4\u7ec7\u6210",(0,t.jsx)(n.strong,{children:"\u6876 (Buckets)"}),"\u3002DDP \u6309\u7167\u6a21\u578b\u53c2\u6570\u7684\u9006\u5e8f\uff08\u5927\u81f4\u5bf9\u5e94\u53cd\u5411\u4f20\u64ad\u7684\u987a\u5e8f\uff09\u5c06\u5b83\u4eec\u5206\u914d\u5230\u4e0d\u540c\u7684\u6876\u4e2d\u3002"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"Reducer"})," \u4e3a\u6bcf\u4e2a\u53c2\u6570\u6ce8\u518c ",(0,t.jsx)(n.strong,{children:"Autograd Hooks"}),"\u3002"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"22-\u524d\u5411\u4f20\u64ad-forward-pass",children:"2.2 \u524d\u5411\u4f20\u64ad (Forward Pass)"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"DDP \u5c06\u8f93\u5165\u6570\u636e\u4f20\u9012\u7ed9\u672c\u5730\u6a21\u578b\u526f\u672c\u3002"}),"\n",(0,t.jsxs)(n.li,{children:["\u5982\u679c ",(0,t.jsx)(n.code,{children:"find_unused_parameters=True"}),"\uff0cDDP \u4f1a\u5728\u672c\u5730\u6a21\u578b\u8f93\u51fa\u540e\u904d\u5386 Autograd \u56fe\uff0c\u6807\u8bb0\u90a3\u4e9b\u672a\u53c2\u4e0e\u8ba1\u7b97\u7684\u53c2\u6570\u4e3a\u201cReady\u201d\uff0c\u4ee5\u4fbf Reducer \u4e0d\u4f1a\u65e0\u9650\u671f\u7b49\u5f85\u5b83\u4eec\u7684\u68af\u5ea6\u3002\u8fd9\u4f1a\u5e26\u6765\u989d\u5916\u7684\u5f00\u9500\u3002"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"23-\u53cd\u5411\u4f20\u64ad-backward-pass--\u6838\u5fc3\u673a\u5236",children:"2.3 \u53cd\u5411\u4f20\u64ad (Backward Pass) \u2014\u2014 \u6838\u5fc3\u673a\u5236"}),"\n",(0,t.jsxs)(n.p,{children:["\u8fd9\u662f DDP \u8fd9\u79cd\u67b6\u6784\u6700\u590d\u6742\u4e5f\u6700\u7cbe\u5f69\u7684\u90e8\u5206\u3002",(0,t.jsx)(n.code,{children:"backward()"})," \u76f4\u63a5\u5728 Loss Tensor \u4e0a\u8c03\u7528\uff0cDDP \u901a\u8fc7\u4e4b\u524d\u6ce8\u518c\u7684 Autograd Hooks \u4ecb\u5165\u3002"]}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"\u68af\u5ea6\u5c31\u7eea (Gradient Ready)"}),"\uff1a\u5f53\u67d0\u4e2a\u53c2\u6570\u7684\u68af\u5ea6\u8ba1\u7b97\u5b8c\u6210\u65f6\uff0c\u5bf9\u5e94\u7684 Hook \u88ab\u89e6\u53d1\uff0c\u8be5\u53c2\u6570\u5728 ",(0,t.jsx)(n.code,{children:"Reducer"})," \u4e2d\u88ab\u6807\u8bb0\u4e3a Ready\u3002"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"\u6876\u5c31\u7eea\u4e0e\u5f02\u6b65\u901a\u4fe1"}),"\uff1a\u5f53\u4e00\u4e2a\u6876\u5185\u7684\u6240\u6709\u53c2\u6570\u68af\u5ea6\u90fd Ready \u540e\uff0c",(0,t.jsx)(n.code,{children:"Reducer"})," \u7acb\u5373\u542f\u52a8\u8be5\u6876\u7684\u5f02\u6b65 ",(0,t.jsx)(n.code,{children:"AllReduce"})," \u64cd\u4f5c\uff08\u8ba1\u7b97\u6240\u6709\u8fdb\u7a0b\u68af\u5ea6\u7684\u5e73\u5747\u503c\uff09\u3002"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"\u8ba1\u7b97\u4e0e\u901a\u4fe1\u91cd\u53e0 (Overlap)"}),"\uff1a\u7531\u4e8e ",(0,t.jsx)(n.code,{children:"AllReduce"})," \u662f\u5f02\u6b65\u7684\uff0c\u540e\u7eed\u5c42\u7684\u68af\u5ea6\u8ba1\u7b97\u53ef\u4ee5\u4e0e\u5f53\u524d\u5c42\u7684\u68af\u5ea6\u901a\u4fe1\u5e76\u884c\u8fdb\u884c\u3002\u8fd9\u662f DDP \u9ad8\u6548\u7684\u5173\u952e\u3002"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"\u7b49\u5f85\u540c\u6b65"}),"\uff1a\u5728\u6240\u6709\u6876\u7684 ",(0,t.jsx)(n.code,{children:"AllReduce"})," \u542f\u52a8\u540e\uff0c",(0,t.jsx)(n.code,{children:"Reducer"})," \u4f1a\u963b\u585e\u7b49\u5f85\u6240\u6709\u901a\u4fe1\u5b8c\u6210\uff0c\u5e76\u5c06\u5e73\u5747\u540e\u7684\u68af\u5ea6\u5199\u56de ",(0,t.jsx)(n.code,{children:"param.grad"}),"\u3002"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"24-\u4f18\u5316\u6b65\u9aa4-optimizer-step",children:"2.4 \u4f18\u5316\u6b65\u9aa4 (Optimizer Step)"}),"\n",(0,t.jsxs)(n.p,{children:["\u7531\u4e8e\u6b64\u65f6\u6240\u6709\u8fdb\u7a0b\u4e0a\u7684 ",(0,t.jsx)(n.code,{children:"param.grad"})," \u5df2\u7ecf\u662f\u5168\u5c40\u5e73\u5747\u540e\u7684\u68af\u5ea6\uff08\u4e14\u6240\u6709\u8fdb\u7a0b\u5b8c\u5168\u4e00\u81f4\uff09\uff0c\u4f18\u5316\u5668\u5728\u6bcf\u4e2a\u8fdb\u7a0b\u4e0a\u72ec\u7acb\u6267\u884c ",(0,t.jsx)(n.code,{children:"step()"})," \u66f4\u65b0\u53c2\u6570\uff0c\u5373\u53ef\u4fdd\u8bc1\u6a21\u578b\u526f\u672c\u5728\u66f4\u65b0\u540e\u4f9d\u7136\u4fdd\u6301\u4e00\u81f4\u3002"]}),"\n",(0,t.jsx)(n.h2,{id:"3-\u5173\u952e\u4f18\u5316\u6280\u672f",children:"3. \u5173\u952e\u4f18\u5316\u6280\u672f"}),"\n",(0,t.jsx)(n.h3,{id:"31-\u68af\u5ea6\u5206\u6876-gradient-bucketing",children:"3.1 \u68af\u5ea6\u5206\u6876 (Gradient Bucketing)"}),"\n",(0,t.jsxs)(n.p,{children:["\u5982\u679c\u5bf9\u6bcf\u4e2a\u53c2\u6570\u5355\u72ec\u8fdb\u884c ",(0,t.jsx)(n.code,{children:"AllReduce"}),"\uff0c\u4f1a\u4ea7\u751f\u6570\u4ee5\u5343\u8ba1\u7684\u5c0f\u578b\u901a\u4fe1\u64cd\u4f5c\uff0c\u5bfc\u81f4\u4e25\u91cd\u7684\u7f51\u7edc\u5ef6\u8fdf\u548c\u5f00\u9500\u3002DDP \u5c06\u591a\u4e2a\u53c2\u6570\u7684\u68af\u5ea6\u6253\u5305\u8fdb\u4e00\u4e2a ",(0,t.jsx)(n.strong,{children:"Bucket"}),"\uff08\u9ed8\u8ba4\u5927\u5c0f 25MB\uff09\uff0c\u5bf9\u6574\u4e2a Bucket \u6267\u884c\u4e00\u6b21 ",(0,t.jsx)(n.code,{children:"AllReduce"}),"\u3002"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"\u9006\u5e8f\u5206\u6876"}),"\uff1aDDP \u5c1d\u8bd5\u6309\u53c2\u6570\u5728\u7f51\u7edc\u4e2d",(0,t.jsx)(n.strong,{children:"\u53cd\u5411"}),"\u51fa\u73b0\u7684\u987a\u5e8f\u8fdb\u884c\u5206\u6876\u3002"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"\u4f18\u52bf"}),"\uff1a\u9760\u8fd1\u8f93\u51fa\u5c42\u7684\u53c2\u6570\u68af\u5ea6\u6700\u5148\u8ba1\u7b97\u5b8c\u6210\uff0c\u5b83\u4eec\u6240\u5728\u7684 Bucket \u53ef\u4ee5\u5c3d\u65e9\u53d1\u9001\uff0c\u6700\u5927\u5316\u91cd\u53e0\u65f6\u95f4\u3002"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"32-\u8ba1\u7b97\u4e0e\u901a\u4fe1\u91cd\u53e0-communication-computation-overlap",children:"3.2 \u8ba1\u7b97\u4e0e\u901a\u4fe1\u91cd\u53e0 (Communication-Computation Overlap)"}),"\n",(0,t.jsxs)(n.p,{children:["DDP \u4e0d\u9700\u8981\u7b49\u5f85\u6574\u4e2a Backward Pass \u7ed3\u675f\u624d\u5f00\u59cb\u540c\u6b65\u3002\n\u5982\u4e0b\u56fe\u6240\u793a\uff0c",(0,t.jsx)(n.code,{children:"Layer 1"})," \u7684\u68af\u5ea6\u8ba1\u7b97\u5b8c\u6210\u540e\uff0c\u7acb\u5373\u5f00\u59cb\u901a\u4fe1\uff1b\u4e0e\u6b64\u540c\u65f6\uff0cGPU \u7ee7\u7eed\u8ba1\u7b97 ",(0,t.jsx)(n.code,{children:"Layer 2"})," \u7684\u68af\u5ea6\u3002"]}),"\n",(0,t.jsx)(n.mermaid,{value:"gantt\n    dateFormat  s\n    axisFormat  %S\n    title DDP Backward Pass: Overlap Mechanism\n    \n    section Compute (GPU)\n    Grad Layer N      :active,  0, 1\n    Grad Layer N-1    :active,  1, 2\n    Grad Layer N-2    :active,  2, 3\n    Grad Layer ...    :active,  3, 4\n    \n    section Comm (NCCL)\n    Wait              :done,    0, 1\n    AllReduce Bkt 1   :crit,    1, 3\n    AllReduce Bkt 2   :crit,    3, 5"}),"\n",(0,t.jsxs)(n.h3,{id:"33-\u68af\u5ea6\u7d2f\u79ef\u4e0e-no_sync",children:["3.3 \u68af\u5ea6\u7d2f\u79ef\u4e0e ",(0,t.jsx)(n.code,{children:"no_sync"})]}),"\n",(0,t.jsxs)(n.p,{children:["\u5728\u8fdb\u884c\u68af\u5ea6\u7d2f\u79ef\uff08Gradient Accumulation\uff09\u65f6\uff0c\u6211\u4eec\u4e0d\u5e0c\u671b\u6bcf\u4e00\u6b65\u90fd\u8fdb\u884c\u901a\u4fe1\u3002DDP \u63d0\u4f9b\u4e86 ",(0,t.jsx)(n.code,{children:"no_sync"})," \u4e0a\u4e0b\u6587\u7ba1\u7406\u5668\u3002\n\u5728 ",(0,t.jsx)(n.code,{children:"no_sync"})," \u5757\u5185\uff0cDDP \u7684 Autograd Hooks \u4e0d\u4f1a\u89e6\u53d1\u68af\u5ea6\u540c\u6b65\uff0c\u68af\u5ea6\u53ea\u4f1a\u5728\u672c\u5730\u7d2f\u52a0\u3002\u53ea\u6709\u5728 ",(0,t.jsx)(n.code,{children:"no_sync"})," \u5757\u4e4b\u5916\u7684\u6700\u540e\u4e00\u6b21 backward \u65f6\uff0c\u624d\u4f1a\u89e6\u53d1\u540c\u6b65\u3002"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:"model = DDP(model)\nwith model.no_sync():\n    for _ in range(accumulation_steps - 1):\n        loss = model(inputs)\n        loss.backward()  # \u53ea\u7d2f\u79ef\uff0c\u4e0d\u901a\u4fe1\n# \u6700\u540e\u4e00\u6b65\uff0c\u901a\u4fe1\u5e76\u66f4\u65b0\nloss = model(inputs)\nloss.backward()\noptimizer.step()\n"})}),"\n",(0,t.jsx)(n.h2,{id:"4-\u5b8c\u6574\u4ee3\u7801\u5b9e\u8df5-code-implementation",children:"4. \u5b8c\u6574\u4ee3\u7801\u5b9e\u8df5 (Code Implementation)"}),"\n",(0,t.jsx)(n.p,{children:"\u4ee5\u4e0b\u662f\u4e00\u4e2a\u5b8c\u6574\u7684\u5355\u673a\u591a\u5361\uff08Single-Node Multi-GPU\uff09DDP \u8bad\u7ec3\u793a\u4f8b\u3002\u5b83\u5c55\u793a\u4e86\u4ece\u8fdb\u7a0b\u7ec4\u521d\u59cb\u5316\u3001\u6570\u636e\u5206\u7247\u3001\u6a21\u578b\u5305\u88c5\u5230\u8bad\u7ec3\u5faa\u73af\u7684\u6807\u51c6\u6d41\u7a0b\u3002"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'import os\nimport torch\nimport torch.distributed as dist\nimport torch.multiprocessing as mp\nimport torch.nn as nn\nimport torch.optim as optim\nfrom torch.nn.parallel import DistributedDataParallel as DDP\nfrom torch.utils.data import DataLoader, DistributedSampler, TensorDataset\n\ndef setup(rank, world_size):\n    """\n    \u521d\u59cb\u5316\u5206\u5e03\u5f0f\u8fdb\u7a0b\u7ec4\u3002\n    \n    Args:\n        rank: \u5f53\u524d\u8fdb\u7a0b\u7684\u5168\u5c40\u5e8f\u53f7 (0 ~ world_size-1)\n        world_size: \u603b\u8fdb\u7a0b\u6570 (\u901a\u5e38\u7b49\u4e8e GPU \u6570\u91cf)\n    """\n    os.environ[\'MASTER_ADDR\'] = \'localhost\'\n    os.environ[\'MASTER_PORT\'] = \'12355\'\n\n    # \u521d\u59cb\u5316\u8fdb\u7a0b\u7ec4\n    # backend: GPU \u8bad\u7ec3\u5f3a\u70c8\u63a8\u8350\u4f7f\u7528 \'nccl\'\n    # init_method: \u521d\u59cb\u5316\u65b9\u6cd5\uff0c\u8fd9\u91cc\u4f7f\u7528\u73af\u5883\u53d8\u91cf\n    dist.init_process_group("nccl", rank=rank, world_size=world_size)\n    \n    # \u8bbe\u7f6e\u5f53\u524d\u8fdb\u7a0b\u4f7f\u7528\u7684 GPU \u8bbe\u5907\n    torch.cuda.set_device(rank)\n\ndef cleanup():\n    """\u9500\u6bc1\u8fdb\u7a0b\u7ec4\uff0c\u91ca\u653e\u8d44\u6e90"""\n    dist.destroy_process_group()\n\nclass ToyModel(nn.Module):\n    def __init__(self):\n        super(ToyModel, self).__init__()\n        self.net1 = nn.Linear(10, 10)\n        self.relu = nn.ReLU()\n        self.net2 = nn.Linear(10, 5)\n\n    def forward(self, x):\n        return self.net2(self.relu(self.net1(x)))\n\ndef demo_basic(rank, world_size):\n    """\n    DDP \u8bad\u7ec3\u4e3b\u51fd\u6570\uff0c\u5c06\u5728\u6bcf\u4e2a\u8fdb\u7a0b\u4e2d\u8fd0\u884c\u3002\n    """\n    print(f"Running basic DDP example on rank {rank}.")\n    setup(rank, world_size)\n\n    # 1. \u51c6\u5907\u6a21\u578b\n    # \u5c06\u6a21\u578b\u79fb\u52a8\u5230\u5bf9\u5e94\u7684 GPU\n    model = ToyModel().to(rank)\n    # \u4f7f\u7528 DDP \u5305\u88c5\u6a21\u578b\n    # device_ids: \u6307\u5b9a\u6a21\u578b\u6240\u5728\u7684 GPU\n    ddp_model = DDP(model, device_ids=[rank])\n\n    # 2. \u51c6\u5907\u6570\u636e\n    # \u521b\u5efa\u6a21\u62df\u6570\u636e\u96c6\n    dataset = TensorDataset(torch.randn(100, 10), torch.randn(100, 5))\n    \n    # \u5173\u952e\uff1a\u4f7f\u7528 DistributedSampler\n    # \u5b83\u8d1f\u8d23\u5c06\u6570\u636e\u96c6\u5207\u5206\uff0c\u786e\u4fdd\u6bcf\u4e2a\u8fdb\u7a0b\u8bfb\u53d6\u4e0d\u540c\u7684\u6570\u636e\u5b50\u96c6\n    sampler = DistributedSampler(dataset, num_replicas=world_size, rank=rank)\n    \n    # DataLoader \u9700\u8981\u8bbe\u7f6e shuffle=False (shuffle \u7531 sampler \u63a7\u5236)\n    dataloader = DataLoader(dataset, batch_size=20, sampler=sampler)\n\n    # 3. \u5b9a\u4e49\u635f\u5931\u51fd\u6570\u548c\u4f18\u5316\u5668\n    loss_fn = nn.MSELoss()\n    optimizer = optim.SGD(ddp_model.parameters(), lr=0.001)\n\n    # 4. \u8bad\u7ec3\u5faa\u73af\n    for epoch in range(10):\n        # \u5173\u952e\uff1a\u6bcf\u4e2a epoch \u5f00\u59cb\u524d\u8bbe\u7f6e sampler \u7684 epoch\n        # \u8fd9\u6837\u80fd\u4fdd\u8bc1\u6bcf\u4e2a epoch \u7684\u6570\u636e shuffle \u65b9\u5f0f\u4e0d\u540c\n        sampler.set_epoch(epoch)\n        \n        for batch_idx, (data, target) in enumerate(dataloader):\n            # \u5c06\u6570\u636e\u79fb\u52a8\u5230\u5bf9\u5e94\u7684 GPU\n            data, target = data.to(rank), target.to(rank)\n            \n            optimizer.zero_grad()\n            output = ddp_model(data)\n            loss = loss_fn(output, target)\n            loss.backward()\n            optimizer.step()\n            \n            if rank == 0 and batch_idx % 2 == 0:\n                print(f"Epoch {epoch} | Batch {batch_idx} | Loss {loss.item()}")\n\n    cleanup()\n\ndef run_demo():\n    """\n    \u542f\u52a8\u591a\u8fdb\u7a0b\u8bad\u7ec3\u3002\n    \u5047\u8bbe\u6211\u4eec\u6709 2 \u4e2a GPU\u3002\n    """\n    n_gpus = torch.cuda.device_count()\n    if n_gpus < 2:\n        print(f"Requires at least 2 GPUs to run, but got {n_gpus}.")\n        return\n\n    world_size = n_gpus\n    # mp.spawn \u81ea\u52a8\u751f\u6210 world_size \u4e2a\u8fdb\u7a0b\n    # \u6bcf\u4e2a\u8fdb\u7a0b\u6267\u884c demo_basic(rank, world_size)\n    mp.spawn(demo_basic,\n             args=(world_size,),\n             nprocs=world_size,\n             join=True)\n\nif __name__ == "__main__":\n    # \u5b9e\u9645\u8fd0\u884c\u65f6\u8c03\u7528 run_demo()\n    # run_demo() \n    pass\n'})}),"\n",(0,t.jsx)(n.h3,{id:"41-\u4ee3\u7801\u5173\u952e\u70b9\u89e3\u6790",children:"4.1 \u4ee3\u7801\u5173\u952e\u70b9\u89e3\u6790"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"DistributedSampler"}),": \u8fd9\u662f\u6570\u636e\u5e76\u884c\u7684\u5173\u952e\u3002\u5b83\u6839\u636e ",(0,t.jsx)(n.code,{children:"rank"})," \u548c ",(0,t.jsx)(n.code,{children:"world_size"})," \u5c06\u6570\u636e\u96c6\u5212\u5206\u4e3a\u4e0d\u91cd\u53e0\u7684\u5b50\u96c6\u3002\u52a1\u5fc5\u5728\u6bcf\u4e2a epoch \u5f00\u59cb\u65f6\u8c03\u7528 ",(0,t.jsx)(n.code,{children:"sampler.set_epoch(epoch)"})," \u4ee5\u83b7\u5f97\u968f\u673a\u7684 shuffle \u6548\u679c\u3002"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"DDP Wrapper"}),": ",(0,t.jsx)(n.code,{children:"DDP(model, device_ids=[rank])"})," \u8d1f\u8d23\u5904\u7406\u68af\u5ea6\u7684 all-reduce\u3002\u6ce8\u610f ",(0,t.jsx)(n.code,{children:"device_ids"})," \u5fc5\u987b\u6b63\u786e\u8bbe\u7f6e\u3002"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"setup/cleanup"}),": \u5206\u5e03\u5f0f\u73af\u5883\u7684\u751f\u547d\u5468\u671f\u7ba1\u7406\u662f\u5fc5\u987b\u7684\u3002"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"5-\u67b6\u6784\u793a\u610f\u56fe",children:"5. \u67b6\u6784\u793a\u610f\u56fe"}),"\n",(0,t.jsx)(n.mermaid,{value:"flowchart TD\n    subgraph Process 0\n        M0[Model Replica]\n        G0[Gradients]\n        B0[Buckets]\n        R0[Reducer]\n    end\n    \n    subgraph Process 1\n        M1[Model Replica]\n        G1[Gradients]\n        B1[Buckets]\n        R1[Reducer]\n    end\n    \n    %% Forward Flow\n    Input --\x3e M0\n    Input --\x3e M1\n    \n    %% Backward Flow\n    M0 -- Backward --\x3e G0\n    M1 -- Backward --\x3e G1\n    \n    %% Bucketing\n    G0 -- Grouping --\x3e B0\n    G1 -- Grouping --\x3e B1\n    \n    %% Reducer Hook\n    B0 -- Trigger --\x3e R0\n    B1 -- Trigger --\x3e R1\n    \n    %% Communication\n    R0 <== AllReduce (NCCL) ==> R1\n    \n    %% Update\n    R0 -- Avg Grads --\x3e M0\n    R1 -- Avg Grads --\x3e M1"}),"\n",(0,t.jsx)(n.h2,{id:"6-\u5b9e\u73b0\u7ec6\u8282\u4e0e\u7ec4\u4ef6",children:"6. \u5b9e\u73b0\u7ec6\u8282\u4e0e\u7ec4\u4ef6"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{style:{textAlign:"left"},children:"\u7ec4\u4ef6"}),(0,t.jsx)(n.th,{style:{textAlign:"left"},children:"\u63cf\u8ff0"}),(0,t.jsx)(n.th,{style:{textAlign:"left"},children:"\u6e90\u7801\u4f4d\u7f6e"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.strong,{children:"distributed.py"})}),(0,t.jsxs)(n.td,{style:{textAlign:"left"},children:["Python \u5165\u53e3\uff0c\u5b9e\u73b0 ",(0,t.jsx)(n.code,{children:"nn.Module"})," \u5305\u88c5\uff0c\u8d1f\u8d23\u521d\u59cb\u5316\u548c Forward \u8c03\u7528\u3002"]}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"torch/nn/parallel/distributed.py"})})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.strong,{children:"Reducer"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"C++ \u6838\u5fc3\u7ec4\u4ef6\uff0c\u7ba1\u7406 Buckets\uff0c\u6ce8\u518c Autograd Hooks\uff0c\u6267\u884c AllReduce\u3002"}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"torch/csrc/distributed/c10d/reducer.h"})})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.strong,{children:"ProcessGroup"})}),(0,t.jsxs)(n.td,{style:{textAlign:"left"},children:["\u62bd\u8c61\u901a\u4fe1\u63a5\u53e3\uff0c\u63d0\u4f9b ",(0,t.jsx)(n.code,{children:"broadcast"}),", ",(0,t.jsx)(n.code,{children:"allreduce"})," \u7b49\u539f\u8bed\u3002\u5b9e\u73b0\u5305\u62ec NCCL, Gloo, MPI\u3002"]}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"torch/lib/c10d/ProcessGroup.hpp"})})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.strong,{children:"comm.h"})}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:"\u63d0\u4f9b Coalesced Broadcast \u8f85\u52a9\u51fd\u6570\uff0c\u7528\u4e8e\u521d\u59cb\u5316\u65f6\u7684\u72b6\u6001\u540c\u6b65\u3002"}),(0,t.jsx)(n.td,{style:{textAlign:"left"},children:(0,t.jsx)(n.code,{children:"torch/csrc/distributed/c10d/comm.h"})})]})]})]}),"\n",(0,t.jsx)(n.h2,{id:"7-\u53c2\u8003\u8d44\u6599",children:"7. \u53c2\u8003\u8d44\u6599"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://docs.pytorch.org/docs/main/notes/ddp.html",children:"PyTorch Documentation: Distributed Data Parallel"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://medium.com/@arjunsrinivasan.a/demystifying-pytorch-distributed-data-parallel-ddp-an-inside-look-6d0d42a645ff",children:"Medium: Demystifying PyTorch Distributed Data Parallel (DDP)"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"https://arxiv.org/abs/2006.15704",children:"arXiv:2006.15704: PyTorch Distributed: Experiences on Accelerating Data Parallel Training"})}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,d.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(a,{...e})}):a(e)}}}]);