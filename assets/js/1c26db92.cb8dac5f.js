"use strict";(self.webpackChunknotes_3=self.webpackChunknotes_3||[]).push([[65080],{54213:(e,n,t)=>{t.d(n,{R:()=>s,x:()=>o});var r=t(36672);const c={},i=r.createContext(c);function s(e){const n=r.useContext(i);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(c):e.components||c:s(e.components),r.createElement(i.Provider,{value:n},e.children)}},62797:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>x,frontMatter:()=>s,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"Python/\u5185\u7f6e\u6a21\u5757/contextlib","title":"contextlib","description":"1. \u6982\u8ff0 (Overview)","source":"@site/docs/Python/\u5185\u7f6e\u6a21\u5757/contextlib.md","sourceDirName":"Python/\u5185\u7f6e\u6a21\u5757","slug":"/Python/\u5185\u7f6e\u6a21\u5757/contextlib","permalink":"/notes3/docs/Python/\u5185\u7f6e\u6a21\u5757/contextlib","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Python/\u5185\u7f6e\u6a21\u5757/contextlib.md","tags":[],"version":"current","frontMatter":{},"sidebar":"python","previous":{"title":"configparser","permalink":"/notes3/docs/Python/\u5185\u7f6e\u6a21\u5757/configparser"},"next":{"title":"subprocess","permalink":"/notes3/docs/Python/\u5185\u7f6e\u6a21\u5757/subprocess"}}');var c=t(23420),i=t(54213);const s={},o=void 0,l={},d=[{value:"1. \u6982\u8ff0 (Overview)",id:"1-\u6982\u8ff0-overview",level:2},{value:"2. \u6838\u5fc3\u534f\u8bae\u4e0e\u5e95\u5c42\u673a\u5236 (Core Protocol &amp; Internals)",id:"2-\u6838\u5fc3\u534f\u8bae\u4e0e\u5e95\u5c42\u673a\u5236-core-protocol--internals",level:2},{value:"2.1 \u534f\u8bae\u5b9a\u4e49",id:"21-\u534f\u8bae\u5b9a\u4e49",level:3},{value:"2.2 <code>@contextmanager</code> \u88c5\u9970\u5668\u539f\u7406",id:"22-contextmanager-\u88c5\u9970\u5668\u539f\u7406",level:3},{value:"\u6267\u884c\u6d41\u7a0b\u56fe",id:"\u6267\u884c\u6d41\u7a0b\u56fe",level:4},{value:"\u5b9e\u73b0\u7ec6\u8282",id:"\u5b9e\u73b0\u7ec6\u8282",level:4},{value:"3. \u5e38\u7528\u5de5\u5177\u8be6\u89e3 (Utilities)",id:"3-\u5e38\u7528\u5de5\u5177\u8be6\u89e3-utilities",level:2},{value:"3.1 \u8d44\u6e90\u7ba1\u7406",id:"31-\u8d44\u6e90\u7ba1\u7406",level:3},{value:"3.2 \u5f02\u5e38\u5904\u7406",id:"32-\u5f02\u5e38\u5904\u7406",level:3},{value:"3.3 \u6d41\u91cd\u5b9a\u5411",id:"33-\u6d41\u91cd\u5b9a\u5411",level:3},{value:"4. \u9ad8\u7ea7\u6a21\u5f0f\uff1a\u52a8\u6001\u4e0a\u4e0b\u6587\u6808 (ExitStack)",id:"4-\u9ad8\u7ea7\u6a21\u5f0f\u52a8\u6001\u4e0a\u4e0b\u6587\u6808-exitstack",level:2},{value:"4.1 \u6838\u5fc3\u7279\u6027",id:"41-\u6838\u5fc3\u7279\u6027",level:3},{value:"4.2 \u5178\u578b\u5e94\u7528\u573a\u666f\uff1a\u6279\u91cf\u6587\u4ef6\u6253\u5f00",id:"42-\u5178\u578b\u5e94\u7528\u573a\u666f\u6279\u91cf\u6587\u4ef6\u6253\u5f00",level:3},{value:"4.3 \u67b6\u6784\u793a\u610f",id:"43-\u67b6\u6784\u793a\u610f",level:3},{value:"5. \u6df7\u5408\u6a21\u5f0f\uff1aContextDecorator",id:"5-\u6df7\u5408\u6a21\u5f0fcontextdecorator",level:2},{value:"6. \u5f02\u6b65\u652f\u6301 (Async Context Managers)",id:"6-\u5f02\u6b65\u652f\u6301-async-context-managers",level:2},{value:"7. \u53c2\u8003\u8d44\u6599 (References)",id:"7-\u53c2\u8003\u8d44\u6599-references",level:2}];function a(e){const n={a:"a",code:"code",h2:"h2",h3:"h3",h4:"h4",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,c.jsxs)(c.Fragment,{children:[(0,c.jsx)(n.h2,{id:"1-\u6982\u8ff0-overview",children:"1. \u6982\u8ff0 (Overview)"}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.code,{children:"contextlib"})," \u662f Python \u6807\u51c6\u5e93\u4e2d\u7528\u4e8e\u589e\u5f3a ",(0,c.jsx)(n.code,{children:"with"})," \u8bed\u53e5\u529f\u80fd\u7684\u5b9e\u7528\u6a21\u5757\u3002\u5b83\u4e0d\u4ec5\u63d0\u4f9b\u4e86\u521b\u5efa\u4e0a\u4e0b\u6587\u7ba1\u7406\u5668\uff08Context Manager\uff09\u7684\u58f0\u660e\u5f0f\u5de5\u5177\uff0c\u8fd8\u5305\u542b\u4e86\u4e00\u7cfb\u5217\u7528\u4e8e\u8d44\u6e90\u7ba1\u7406\u3001\u5f02\u5e38\u5904\u7406\u548c\u91cd\u5b9a\u5411\u7684\u9ad8\u7ea7\u62bd\u8c61\u3002"]}),"\n",(0,c.jsxs)(n.p,{children:["\u5728 Python \u7f16\u7a0b\u4e2d\uff0c\u4e0a\u4e0b\u6587\u7ba1\u7406\u5668\u662f\u5b9e\u73b0\u201c\u8d44\u6e90\u83b7\u53d6\u5373\u521d\u59cb\u5316\u201d\uff08RAII, Resource Acquisition Is Initialization\uff09\u6a21\u5f0f\u7684\u6838\u5fc3\u673a\u5236\u3002",(0,c.jsx)(n.code,{children:"contextlib"})," \u901a\u8fc7\u7b80\u5316\u4e0a\u4e0b\u6587\u7ba1\u7406\u5668\u7684\u7f16\u5199\uff08\u5982 ",(0,c.jsx)(n.code,{children:"@contextmanager"}),"\uff09\u548c\u63d0\u4f9b\u7ec4\u5408\u5f0f\u7ba1\u7406\u5de5\u5177\uff08\u5982 ",(0,c.jsx)(n.code,{children:"ExitStack"}),"\uff09\uff0c\u6781\u5927\u5730\u63d0\u5347\u4e86\u4ee3\u7801\u7684\u5065\u58ee\u6027\u4e0e\u53ef\u8bfb\u6027\u3002"]}),"\n",(0,c.jsx)(n.h2,{id:"2-\u6838\u5fc3\u534f\u8bae\u4e0e\u5e95\u5c42\u673a\u5236-core-protocol--internals",children:"2. \u6838\u5fc3\u534f\u8bae\u4e0e\u5e95\u5c42\u673a\u5236 (Core Protocol & Internals)"}),"\n",(0,c.jsxs)(n.p,{children:["\u7406\u89e3 ",(0,c.jsx)(n.code,{children:"contextlib"})," \u7684\u524d\u63d0\u662f\u638c\u63e1 Python \u7684\u4e0a\u4e0b\u6587\u7ba1\u7406\u534f\u8bae\u3002\u4efb\u4f55\u5b9e\u73b0\u4e86 ",(0,c.jsx)(n.code,{children:"__enter__"})," \u548c ",(0,c.jsx)(n.code,{children:"__exit__"})," \u65b9\u6cd5\u7684\u5bf9\u8c61\u5747\u53ef\u88ab\u89c6\u4e3a\u4e0a\u4e0b\u6587\u7ba1\u7406\u5668\u3002"]}),"\n",(0,c.jsx)(n.h3,{id:"21-\u534f\u8bae\u5b9a\u4e49",children:"2.1 \u534f\u8bae\u5b9a\u4e49"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.strong,{children:(0,c.jsx)(n.code,{children:"__enter__(self)"})}),": \u8fdb\u5165\u4e0a\u4e0b\u6587\u65f6\u8c03\u7528\u3002\u8fd4\u56de\u503c\u4f1a\u88ab\u8d4b\u503c\u7ed9 ",(0,c.jsx)(n.code,{children:"as"})," \u540e\u7684\u53d8\u91cf\u3002"]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.strong,{children:(0,c.jsx)(n.code,{children:"__exit__(self, exc_type, exc_value, traceback)"})}),": \u9000\u51fa\u4e0a\u4e0b\u6587\u65f6\u8c03\u7528\u3002","\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:["\u82e5\u65e0\u5f02\u5e38\uff0c\u4e09\u4e2a\u53c2\u6570\u5747\u4e3a ",(0,c.jsx)(n.code,{children:"None"}),"\u3002"]}),"\n",(0,c.jsx)(n.li,{children:"\u82e5\u6709\u5f02\u5e38\uff0c\u53c2\u6570\u4e3a\u5f02\u5e38\u4fe1\u606f\u3002"}),"\n",(0,c.jsxs)(n.li,{children:["\u8fd4\u56de ",(0,c.jsx)(n.code,{children:"True"})," \u8868\u793a\u5f02\u5e38\u5df2\u88ab\u5904\u7406\uff08\u6291\u5236\uff09\uff0c\u8fd4\u56de ",(0,c.jsx)(n.code,{children:"False"})," \u6216 ",(0,c.jsx)(n.code,{children:"None"})," \u5219\u5f02\u5e38\u4f1a\u5411\u5916\u4f20\u64ad\u3002"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,c.jsxs)(n.h3,{id:"22-contextmanager-\u88c5\u9970\u5668\u539f\u7406",children:["2.2 ",(0,c.jsx)(n.code,{children:"@contextmanager"})," \u88c5\u9970\u5668\u539f\u7406"]}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.code,{children:"contextlib.contextmanager"})," \u662f\u8be5\u6a21\u5757\u6700\u5e38\u7528\u7684\u5de5\u5177\uff0c\u5b83\u5141\u8bb8\u5c06\u4e00\u4e2a\u751f\u6210\u5668\uff08Generator\uff09\u51fd\u6570\u8f6c\u6362\u4e3a\u4e0a\u4e0b\u6587\u7ba1\u7406\u5668\uff0c\u514d\u53bb\u4e86\u7f16\u5199\u7c7b\u7684\u7e41\u7410\u3002"]}),"\n",(0,c.jsx)(n.h4,{id:"\u6267\u884c\u6d41\u7a0b\u56fe",children:"\u6267\u884c\u6d41\u7a0b\u56fe"}),"\n",(0,c.jsx)(n.mermaid,{value:"sequenceDiagram\n    participant Caller as \u8c03\u7528\u8005 (with \u8bed\u53e5)\n    participant Decorator as @contextmanager \u5305\u88c5\u5668\n    participant Generator as \u7528\u6237\u751f\u6210\u5668\u51fd\u6570\n\n    Caller->>Decorator: __enter__()\n    Decorator->>Generator: next() (\u542f\u52a8\u751f\u6210\u5668)\n    Note over Generator: \u6267\u884c yield \u4e4b\u524d\u7684\u4ee3\u7801 (Setup)\n    Generator--\x3e>Decorator: yield resource\n    Decorator--\x3e>Caller: return resource\n    \n    rect rgb(240, 248, 255)\n        Note over Caller: \u6267\u884c with \u8bed\u53e5\u5757\n        alt \u6b63\u5e38\u7ed3\u675f\n            Caller->>Decorator: __exit__(None, None, None)\n            Decorator->>Generator: next() (\u6062\u590d\u751f\u6210\u5668)\n            Note over Generator: \u6267\u884c yield \u4e4b\u540e\u7684\u4ee3\u7801 (Teardown)\n            Generator--\x3e>Decorator: StopIteration\n            Decorator--\x3e>Caller: return False\n        else \u53d1\u751f\u5f02\u5e38\n            Caller->>Decorator: __exit__(ExcType, ExcVal, Tb)\n            Decorator->>Generator: throw(ExcType, ExcVal, Tb)\n            Note over Generator: \u5728 yield \u5904\u629b\u51fa\u5f02\u5e38\n            Generator--\x3e>Decorator: StopIteration (\u6216\u518d\u6b21\u629b\u51fa)\n            Decorator--\x3e>Caller: return False (\u9664\u975e\u663e\u5f0f\u6291\u5236)\n        end\n    end"}),"\n",(0,c.jsx)(n.h4,{id:"\u5b9e\u73b0\u7ec6\u8282",children:"\u5b9e\u73b0\u7ec6\u8282"}),"\n",(0,c.jsxs)(n.p,{children:["\u8be5\u88c5\u9970\u5668\u5c06\u751f\u6210\u5668\u51fd\u6570\u5305\u88c5\u5728\u4e00\u4e2a\u5b9e\u73b0\u4e86 ",(0,c.jsx)(n.code,{children:"__enter__"})," \u548c ",(0,c.jsx)(n.code,{children:"__exit__"})," \u7684\u7c7b\uff08",(0,c.jsx)(n.code,{children:"_GeneratorContextManager"}),"\uff09\u4e2d\uff1a"]}),"\n",(0,c.jsxs)(n.ol,{children:["\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.strong,{children:(0,c.jsx)(n.code,{children:"__enter__"})}),": \u8c03\u7528 ",(0,c.jsx)(n.code,{children:"next(generator)"}),"\uff0c\u83b7\u53d6 ",(0,c.jsx)(n.code,{children:"yield"})," \u7684\u503c\u5e76\u8fd4\u56de\u3002"]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.strong,{children:(0,c.jsx)(n.code,{children:"__exit__"})}),":","\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:["\u5982\u679c\u6709\u5f02\u5e38\uff0c\u901a\u8fc7 ",(0,c.jsx)(n.code,{children:"generator.throw()"})," \u5c06\u5f02\u5e38\u6ce8\u5165\u5230\u751f\u6210\u5668\u5185\u90e8\u7684 ",(0,c.jsx)(n.code,{children:"yield"})," \u5904\u3002"]}),"\n",(0,c.jsxs)(n.li,{children:["\u5982\u679c\u65e0\u5f02\u5e38\uff0c\u8c03\u7528 ",(0,c.jsx)(n.code,{children:"next(generator)"})," \u7ee7\u7eed\u6267\u884c\u6e05\u7406\u4ee3\u7801\u3002"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,c.jsx)(n.h2,{id:"3-\u5e38\u7528\u5de5\u5177\u8be6\u89e3-utilities",children:"3. \u5e38\u7528\u5de5\u5177\u8be6\u89e3 (Utilities)"}),"\n",(0,c.jsx)(n.h3,{id:"31-\u8d44\u6e90\u7ba1\u7406",children:"3.1 \u8d44\u6e90\u7ba1\u7406"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:["\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.strong,{children:(0,c.jsx)(n.code,{children:"closing(thing)"})}),": \u4e3a\u6ca1\u6709\u5b9e\u73b0\u4e0a\u4e0b\u6587\u534f\u8bae\u4f46\u6709 ",(0,c.jsx)(n.code,{children:"close()"})," \u65b9\u6cd5\u7684\u5bf9\u8c61\uff08\u5982 ",(0,c.jsx)(n.code,{children:"urllib.urlopen"})," \u8fd4\u56de\u7684\u5bf9\u8c61\uff09\u521b\u5efa\u4e0a\u4e0b\u6587\u3002"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-python",children:"from contextlib import closing\nfrom urllib.request import urlopen\n\nwith closing(urlopen('https://www.python.org')) as page:\n    for line in page:\n        print(line)\n# page.close() \u4f1a\u88ab\u81ea\u52a8\u8c03\u7528\n"})}),"\n"]}),"\n",(0,c.jsxs)(n.li,{children:["\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.strong,{children:(0,c.jsx)(n.code,{children:"nullcontext(enter_result=None)"})}),": \u4e00\u4e2a\u201c\u7a7a\u201d\u4e0a\u4e0b\u6587\u7ba1\u7406\u5668\uff0c\u4ec0\u4e48\u90fd\u4e0d\u505a\u3002\u5e38\u7528\u4e8e\u6761\u4ef6\u5f0f\u4e0a\u4e0b\u6587\u7ba1\u7406\u3002"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-python",children:"from contextlib import nullcontext\n\nctx = open('file.txt') if use_file else nullcontext()\nwith ctx as f:\n    pass # f \u53ef\u80fd\u662f\u6587\u4ef6\u5bf9\u8c61\uff0c\u4e5f\u53ef\u80fd\u662f None\n"})}),"\n"]}),"\n"]}),"\n",(0,c.jsx)(n.h3,{id:"32-\u5f02\u5e38\u5904\u7406",children:"3.2 \u5f02\u5e38\u5904\u7406"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.strong,{children:(0,c.jsx)(n.code,{children:"suppress(*exceptions)"})}),": \u663e\u5f0f\u6291\u5236\u6307\u5b9a\u7c7b\u578b\u7684\u5f02\u5e38\u3002\u66ff\u4ee3\u5197\u957f\u7684 ",(0,c.jsx)(n.code,{children:"try-except-pass"})," \u7ed3\u6784\u3002","\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-python",children:"from contextlib import suppress\nimport os\n\nwith suppress(FileNotFoundError):\n    os.remove('somefile.tmp')\n"})}),"\n"]}),"\n"]}),"\n",(0,c.jsx)(n.h3,{id:"33-\u6d41\u91cd\u5b9a\u5411",children:"3.3 \u6d41\u91cd\u5b9a\u5411"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.strong,{children:(0,c.jsx)(n.code,{children:"redirect_stdout(new_target)"})})," / ",(0,c.jsx)(n.strong,{children:(0,c.jsx)(n.code,{children:"redirect_stderr(new_target)"})}),": \u4e34\u65f6\u5c06\u6807\u51c6\u8f93\u51fa/\u9519\u8bef\u91cd\u5b9a\u5411\u5230\u6587\u4ef6\u6216\u7c7b\u6587\u4ef6\u5bf9\u8c61\u3002","\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-python",children:"from contextlib import redirect_stdout\nimport io\n\nf = io.StringIO()\nwith redirect_stdout(f):\n    print('foobar')\nassert f.getvalue() == 'foobar\\n'\n"})}),"\n"]}),"\n"]}),"\n",(0,c.jsx)(n.h2,{id:"4-\u9ad8\u7ea7\u6a21\u5f0f\u52a8\u6001\u4e0a\u4e0b\u6587\u6808-exitstack",children:"4. \u9ad8\u7ea7\u6a21\u5f0f\uff1a\u52a8\u6001\u4e0a\u4e0b\u6587\u6808 (ExitStack)"}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.code,{children:"ExitStack"})," \u662f ",(0,c.jsx)(n.code,{children:"contextlib"})," \u4e2d\u6700\u5f3a\u5927\u7684\u5de5\u5177\uff0c\u7528\u4e8e\u7a0b\u5e8f\u5316\u5730\u7ba1\u7406\u52a8\u6001\u6570\u91cf\u7684\u4e0a\u4e0b\u6587\u7ba1\u7406\u5668\u3002\u5b83\u89e3\u51b3\u4e86\u201c\u5982\u4f55\u5728\u4e00\u4e2a ",(0,c.jsx)(n.code,{children:"with"})," \u8bed\u53e5\u4e2d\u7ba1\u7406\u672a\u77e5\u6570\u91cf\u7684\u8d44\u6e90\u201d\u8fd9\u4e00\u96be\u9898\u3002"]}),"\n",(0,c.jsx)(n.h3,{id:"41-\u6838\u5fc3\u7279\u6027",children:"4.1 \u6838\u5fc3\u7279\u6027"}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.strong,{children:"LIFO \u987a\u5e8f"}),": \u50cf\u6808\u4e00\u6837\uff0c\u540e\u8fdb\u5165\u7684\u4e0a\u4e0b\u6587\u5148\u9000\u51fa\u3002"]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.strong,{children:"\u5f02\u5e38\u5408\u5e76"}),": \u6b63\u786e\u5904\u7406\u591a\u5c42\u4e0a\u4e0b\u6587\u4e2d\u7684\u5f02\u5e38\u4f20\u64ad\u548c\u6291\u5236\u3002"]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.strong,{children:"\u7075\u6d3b\u6ce8\u518c"}),": \u652f\u6301 ",(0,c.jsx)(n.code,{children:"enter_context"})," (\u5b8c\u6574\u8fdb\u5165), ",(0,c.jsx)(n.code,{children:"push"})," (\u4ec5\u6ce8\u518c\u6e05\u7406), ",(0,c.jsx)(n.code,{children:"callback"})," (\u6ce8\u518c\u4efb\u610f\u56de\u8c03)\u3002"]}),"\n"]}),"\n",(0,c.jsx)(n.h3,{id:"42-\u5178\u578b\u5e94\u7528\u573a\u666f\u6279\u91cf\u6587\u4ef6\u6253\u5f00",children:"4.2 \u5178\u578b\u5e94\u7528\u573a\u666f\uff1a\u6279\u91cf\u6587\u4ef6\u6253\u5f00"}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-python",children:"from contextlib import ExitStack\n\ndef process_files(filenames):\n    with ExitStack() as stack:\n        # \u52a8\u6001\u6253\u5f00\u591a\u4e2a\u6587\u4ef6\n        files = [stack.enter_context(open(fname)) for fname in filenames]\n        \n        # \u6b64\u65f6\u6240\u6709\u6587\u4ef6\u90fd\u5df2\u6253\u5f00\u3002\n        # \u5982\u679c\u4e2d\u95f4\u53d1\u751f\u5f02\u5e38\uff0cExitStack \u4f1a\u81ea\u52a8\u5173\u95ed\u5df2\u6253\u5f00\u7684\u6587\u4ef6\u3002\n        \n        for f in files:\n            process(f)\n"})}),"\n",(0,c.jsx)(n.h3,{id:"43-\u67b6\u6784\u793a\u610f",children:"4.3 \u67b6\u6784\u793a\u610f"}),"\n",(0,c.jsx)(n.mermaid,{value:'classDiagram\n    class ExitStack {\n        -list _exit_callbacks\n        +enter_context(cm)\n        +push(exit_method)\n        +callback(func, *args)\n        +pop_all()\n        +close()\n        +__enter__()\n        +__exit__()\n    }\n    \n    note for ExitStack "\u7ef4\u62a4\u4e00\u4e2a\u56de\u8c03\u6808\\n__exit__ \u65f6\u9006\u5e8f\u8c03\u7528"'}),"\n",(0,c.jsx)(n.h2,{id:"5-\u6df7\u5408\u6a21\u5f0fcontextdecorator",children:"5. \u6df7\u5408\u6a21\u5f0f\uff1aContextDecorator"}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.code,{children:"ContextDecorator"})," \u662f\u4e00\u4e2a\u57fa\u7c7b\uff0c\u5141\u8bb8\u5b9a\u4e49\u65e2\u53ef\u4ee5\u7528\u4f5c ",(0,c.jsx)(n.code,{children:"with"})," \u8bed\u53e5\uff0c\u53c8\u53ef\u4ee5\u7528\u4f5c\u51fd\u6570\u88c5\u9970\u5668\u7684\u4e0a\u4e0b\u6587\u7ba1\u7406\u5668\u3002"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-python",children:"from contextlib import ContextDecorator\n\nclass mycontext(ContextDecorator):\n    def __enter__(self):\n        print('Starting')\n        return self\n    def __exit__(self, *exc):\n        print('Finishing')\n        return False\n\n@mycontext()\ndef function():\n    print('The bit in the middle')\n\nfunction()\n# \u8f93\u51fa:\n# Starting\n# The bit in the middle\n# Finishing\n"})}),"\n",(0,c.jsxs)(n.p,{children:[(0,c.jsx)(n.strong,{children:"\u6ce8\u610f"}),": \u5f53\u7528\u4f5c\u88c5\u9970\u5668\u65f6\uff0c",(0,c.jsx)(n.code,{children:"__enter__"})," \u7684\u8fd4\u56de\u503c\u65e0\u6cd5\u88ab\u51fd\u6570\u5185\u90e8\u83b7\u53d6\u3002"]}),"\n",(0,c.jsx)(n.h2,{id:"6-\u5f02\u6b65\u652f\u6301-async-context-managers",children:"6. \u5f02\u6b65\u652f\u6301 (Async Context Managers)"}),"\n",(0,c.jsxs)(n.p,{children:["\u81ea Python 3.7 \u8d77\uff0c",(0,c.jsx)(n.code,{children:"contextlib"})," \u589e\u52a0\u4e86\u5bf9\u5f02\u6b65\u7f16\u7a0b\u7684\u652f\u6301\uff1a"]}),"\n",(0,c.jsxs)(n.ul,{children:["\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.strong,{children:(0,c.jsx)(n.code,{children:"AbstractAsyncContextManager"})}),": \u5f02\u6b65\u4e0a\u4e0b\u6587\u7ba1\u7406\u5668\u57fa\u7c7b\uff0c\u9700\u5b9e\u73b0 ",(0,c.jsx)(n.code,{children:"__aenter__"})," \u548c ",(0,c.jsx)(n.code,{children:"__aexit__"}),"\u3002"]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.strong,{children:(0,c.jsx)(n.code,{children:"@asynccontextmanager"})}),": \u5bf9\u5e94 ",(0,c.jsx)(n.code,{children:"@contextmanager"})," \u7684\u5f02\u6b65\u7248\u672c\uff0c\u7528\u4e8e\u88c5\u9970 ",(0,c.jsx)(n.code,{children:"async def"})," \u751f\u6210\u5668\u3002"]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.strong,{children:(0,c.jsx)(n.code,{children:"AsyncExitStack"})}),": \u5bf9\u5e94 ",(0,c.jsx)(n.code,{children:"ExitStack"})," \u7684\u5f02\u6b65\u7248\u672c\uff0c\u652f\u6301\u7ba1\u7406\u5f02\u6b65\u548c\u540c\u6b65\u4e0a\u4e0b\u6587\u7ba1\u7406\u5668\u3002"]}),"\n"]}),"\n",(0,c.jsx)(n.pre,{children:(0,c.jsx)(n.code,{className:"language-python",children:'from contextlib import asynccontextmanager\n\n@asynccontextmanager\nasync def get_connection():\n    conn = await create_db_connection()\n    try:\n        yield conn\n    finally:\n        await conn.close()\n\nasync def main():\n    async with get_connection() as conn:\n        await conn.execute("SELECT * ...")\n'})}),"\n",(0,c.jsx)(n.h2,{id:"7-\u53c2\u8003\u8d44\u6599-references",children:"7. \u53c2\u8003\u8d44\u6599 (References)"}),"\n",(0,c.jsxs)(n.ol,{children:["\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.strong,{children:"Python Official Documentation"}),": ",(0,c.jsx)(n.a,{href:"https://docs.python.org/3/library/contextlib.html",children:"contextlib \u2014 Utilities for with-statement contexts"})]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.strong,{children:"PEP 343"}),": ",(0,c.jsx)(n.a,{href:"https://peps.python.org/pep-0343/",children:'The "with" Statement'})]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.strong,{children:"Real Python"}),": ",(0,c.jsx)(n.a,{href:"https://realpython.com/python-with-statement/",children:"Python's with Statement: Manage External Resources Safely"})]}),"\n",(0,c.jsxs)(n.li,{children:[(0,c.jsx)(n.strong,{children:"PyMOTW-3"}),": ",(0,c.jsx)(n.a,{href:"https://pymotw.com/3/contextlib/",children:"contextlib \u2014 Context Manager Utilities"})]}),"\n"]})]})}function x(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,c.jsx)(n,{...e,children:(0,c.jsx)(a,{...e})}):a(e)}}}]);