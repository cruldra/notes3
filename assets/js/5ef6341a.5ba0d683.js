"use strict";(self.webpackChunknotes_3=self.webpackChunknotes_3||[]).push([[8298],{54213:(n,e,r)=>{r.d(e,{R:()=>t,x:()=>l});var i=r(36672);const s={},d=i.createContext(s);function t(n){const e=i.useContext(d);return i.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function l(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(s):n.components||s:t(n.components),i.createElement(d.Provider,{value:e},n.children)}},85385:(n,e,r)=>{r.r(e),r.d(e,{assets:()=>a,contentTitle:()=>l,default:()=>h,frontMatter:()=>t,metadata:()=>i,toc:()=>o});const i=JSON.parse('{"id":"AI/Pytorch/\u4ece\u5934\u5f00\u59cb\u8bad\u7ec3\u81ea\u5df1\u7684\u5927\u6a21\u578b","title":"\u4ece\u5934\u5f00\u59cb\u8bad\u7ec3\u81ea\u5df1\u7684\u5927\u6a21\u578b - \u6d41\u7a0b\u56fe","description":"\u57fa\u4e8e \u4ece\u5934\u5f00\u59cb\u8bad\u7ec3\u81ea\u5df1\u7684\u5927\u6a21\u578b.py \u4ee3\u7801\u7684\u8bad\u7ec3\u6d41\u7a0b\u5206\u6790\u3002","source":"@site/docs/AI/Pytorch/\u4ece\u5934\u5f00\u59cb\u8bad\u7ec3\u81ea\u5df1\u7684\u5927\u6a21\u578b.md","sourceDirName":"AI/Pytorch","slug":"/AI/Pytorch/\u4ece\u5934\u5f00\u59cb\u8bad\u7ec3\u81ea\u5df1\u7684\u5927\u6a21\u578b","permalink":"/notes3/docs/AI/Pytorch/\u4ece\u5934\u5f00\u59cb\u8bad\u7ec3\u81ea\u5df1\u7684\u5927\u6a21\u578b","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/AI/Pytorch/\u4ece\u5934\u5f00\u59cb\u8bad\u7ec3\u81ea\u5df1\u7684\u5927\u6a21\u578b.md","tags":[],"version":"current","frontMatter":{},"sidebar":"ai","previous":{"title":"Random Functions","permalink":"/notes3/docs/AI/Pytorch/random_functions"},"next":{"title":"\u7b80\u4ecb","permalink":"/notes3/docs/AI/Pytorch/\u4f18\u5316/\u7b80\u4ecb"}}');var s=r(23420),d=r(54213);const t={},l="\u4ece\u5934\u5f00\u59cb\u8bad\u7ec3\u81ea\u5df1\u7684\u5927\u6a21\u578b - \u6d41\u7a0b\u56fe",a={},o=[{value:"1. \u6574\u4f53\u8bad\u7ec3\u6d41\u7a0b",id:"1-\u6574\u4f53\u8bad\u7ec3\u6d41\u7a0b",level:2},{value:"2. \u8bad\u7ec3\u5faa\u73af\u8be6\u60c5 (train_epoch)",id:"2-\u8bad\u7ec3\u5faa\u73af\u8be6\u60c5-train_epoch",level:2},{value:"3. \u6a21\u578b\u7ec4\u4ef6\u67b6\u6784 (Class Diagram)",id:"3-\u6a21\u578b\u7ec4\u4ef6\u67b6\u6784-class-diagram",level:2},{value:"4. \u5173\u952e\u7ec4\u4ef6\u8bf4\u660e",id:"4-\u5173\u952e\u7ec4\u4ef6\u8bf4\u660e",level:2},{value:"1. \u4ec0\u4e48\u662f Tokenizer (\u5206\u8bcd\u5668)\uff1f",id:"1-\u4ec0\u4e48\u662f-tokenizer-\u5206\u8bcd\u5668",level:2},{value:"2. \u5236\u4f5c\u7ec3\u4e60\u518c\uff1a<code>PretrainDataset</code>",id:"2-\u5236\u4f5c\u7ec3\u4e60\u518cpretraindataset",level:2},{value:"\u539f\u59cb\u4ee3\u7801",id:"\u539f\u59cb\u4ee3\u7801",level:3},{value:"\u901a\u4fd7\u89e3\u91ca",id:"\u901a\u4fd7\u89e3\u91ca",level:3},{value:"3. \u65ad\u70b9\u7eed\u5b66\uff1a<code>SkipBatchSampler</code>",id:"3-\u65ad\u70b9\u7eed\u5b66skipbatchsampler",level:2},{value:"\u539f\u59cb\u4ee3\u7801",id:"\u539f\u59cb\u4ee3\u7801-1",level:3},{value:"\u901a\u4fd7\u89e3\u91ca",id:"\u901a\u4fd7\u89e3\u91ca-1",level:3},{value:"4. \u53d1\u5377\u5b50\uff1a<code>DataLoader</code>",id:"4-\u53d1\u5377\u5b50dataloader",level:2},{value:"\u539f\u59cb\u4ee3\u7801",id:"\u539f\u59cb\u4ee3\u7801-2",level:3},{value:"\u901a\u4fd7\u89e3\u91ca",id:"\u901a\u4fd7\u89e3\u91ca-2",level:3}];function c(n){const e={code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,d.R)(),...n.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(e.header,{children:(0,s.jsx)(e.h1,{id:"\u4ece\u5934\u5f00\u59cb\u8bad\u7ec3\u81ea\u5df1\u7684\u5927\u6a21\u578b---\u6d41\u7a0b\u56fe",children:"\u4ece\u5934\u5f00\u59cb\u8bad\u7ec3\u81ea\u5df1\u7684\u5927\u6a21\u578b - \u6d41\u7a0b\u56fe"})}),"\n",(0,s.jsxs)(e.p,{children:["\u57fa\u4e8e ",(0,s.jsx)(e.code,{children:"\u4ece\u5934\u5f00\u59cb\u8bad\u7ec3\u81ea\u5df1\u7684\u5927\u6a21\u578b.py"})," \u4ee3\u7801\u7684\u8bad\u7ec3\u6d41\u7a0b\u5206\u6790\u3002"]}),"\n",(0,s.jsx)(e.h2,{id:"1-\u6574\u4f53\u8bad\u7ec3\u6d41\u7a0b",children:"1. \u6574\u4f53\u8bad\u7ec3\u6d41\u7a0b"}),"\n",(0,s.jsx)(e.mermaid,{value:"flowchart TD\n    Start([\u5f00\u59cb]) --\x3e InitEnv[\u521d\u59cb\u5316\u5206\u5e03\u5f0f\u73af\u5883]\n    InitEnv --\x3e SetSeed[\u8bbe\u7f6e\u968f\u673a\u79cd\u5b50]\n    SetSeed --\x3e Config[\u5b9a\u4e49\u6a21\u578b\u914d\u7f6e MiniMindConfig]\n    Config --\x3e CheckCKP[\u68c0\u67e5\u68c0\u67e5\u70b9 lm_checkpoint]\n    CheckCKP --\x3e InitModel[\u521d\u59cb\u5316\u6a21\u578b\u4e0e\u5206\u8bcd\u5668 init_model]\n    InitModel --\x3e InitData[\u52a0\u8f7d\u6570\u636e\u96c6 PretrainDataset]\n    InitData --\x3e InitOpt[\u521d\u59cb\u5316\u4f18\u5316\u5668\u4e0eScaler]\n    InitOpt --\x3e LoadState{\u662f\u5426\u5b58\u5728\u68c0\u67e5\u70b9?}\n    \n    LoadState -- \u662f --\x3e RestoreState[\u6062\u590d\u6a21\u578b/\u4f18\u5316\u5668\u72b6\u6001]\n    LoadState -- \u5426 --\x3e DDPWrap\n    RestoreState --\x3e DDPWrap\n    \n    DDPWrap{\u662f\u5426\u5206\u5e03\u5f0f\u73af\u5883?} -- \u662f --\x3e DDP[DistributedDataParallel \u5c01\u88c5]\n    DDPWrap -- \u5426 --\x3e LoopStart\n    DDP --\x3e LoopStart\n    \n    LoopStart[\u5f00\u59cb Epoch \u5faa\u73af] --\x3e SetSampler[\u8bbe\u7f6e Sampler Epoch]\n    SetSampler --\x3e CheckResume{\u662f\u5426\u9996\u4e2aEpoch\u4e14\u9700\u8df3\u8fc7Step?}\n    \n    CheckResume -- \u662f --\x3e SkipSampler[\u4f7f\u7528 SkipBatchSampler]\n    CheckResume -- \u5426 --\x3e NormalLoader[\u5e38\u89c4 DataLoader]\n    \n    SkipSampler --\x3e TrainEpoch[[\u8c03\u7528 train_epoch]]\n    NormalLoader --\x3e TrainEpoch\n    \n    TrainEpoch --\x3e StepEnd{Epoch \u5faa\u73af\u7ed3\u675f?}\n    StepEnd -- \u5426 --\x3e LoopStart\n    StepEnd -- \u662f --\x3e Cleanup[\u6e05\u7406\u5206\u5e03\u5f0f\u8fdb\u7a0b]\n    Cleanup --\x3e End([\u7ed3\u675f])"}),"\n",(0,s.jsx)(e.h2,{id:"2-\u8bad\u7ec3\u5faa\u73af\u8be6\u60c5-train_epoch",children:"2. \u8bad\u7ec3\u5faa\u73af\u8be6\u60c5 (train_epoch)"}),"\n",(0,s.jsx)(e.mermaid,{value:'flowchart TD\n    Start([\u5f00\u59cb train_epoch]) --\x3e StepStart(\u5f00\u59cb Step)\n    StepStart --\x3e MoveData[\u6570\u636e\u79fb\u81f3 GPU]\n    MoveData --\x3e CalcLR[\u8ba1\u7b97\u5e76\u66f4\u65b0\u5b66\u4e60\u7387]\n    CalcLR --\x3e Forward[\u524d\u5411\u4f20\u64ad Autocast]\n    Forward --\x3e CalcLoss["\u8ba1\u7b97 Loss (Loss + AuxLoss)"]\n    CalcLoss --\x3e Backward[\u53cd\u5411\u4f20\u64ad Backward]\n    Backward --\x3e OptStep{\u662f\u5426\u6bcf8\u6b65\u66f4\u65b0?}\n    \n    OptStep -- \u662f --\x3e ClipGrad[\u68af\u5ea6\u88c1\u526a]\n    ClipGrad --\x3e UpdateParam[\u53c2\u6570\u66f4\u65b0 Scaler.step]\n    UpdateParam --\x3e ZeroGrad[\u6e05\u7a7a\u68af\u5ea6]\n    ZeroGrad --\x3e CheckLog\n    OptStep -- \u5426 --\x3e CheckLog\n    \n    CheckLog{\u662f\u5426\u6253\u5370\u65e5\u5fd7?} -- \u662f --\x3e LogInfo[\u6253\u5370 Loss/LR/Time/WandB]\n    CheckLog -- \u5426 --\x3e CheckSave\n    LogInfo --\x3e CheckSave\n    \n    CheckSave{\u662f\u5426\u4fdd\u5b58\u68c0\u67e5\u70b9?} -- \u662f --\x3e SaveCKP[\u4fdd\u5b58\u6a21\u578b\u6743\u91cd\u4e0e\u8bad\u7ec3\u72b6\u6001]\n    CheckSave -- \u5426 --\x3e NextStep\n    SaveCKP --\x3e NextStep\n    \n    NextStep{Step \u5faa\u73af\u7ed3\u675f?} -- \u5426 --\x3e StepStart\n    NextStep -- \u662f --\x3e End([\u7ed3\u675f train_epoch])'}),"\n",(0,s.jsx)(e.h2,{id:"3-\u6a21\u578b\u7ec4\u4ef6\u67b6\u6784-class-diagram",children:"3. \u6a21\u578b\u7ec4\u4ef6\u67b6\u6784 (Class Diagram)"}),"\n",(0,s.jsx)(e.mermaid,{value:'classDiagram\n    note "MiniMind \u6a21\u578b\u6838\u5fc3\u7c7b\u7ed3\u6784"\n    \n    %% \u914d\u7f6e\u4e0e\u9876\u5c42\n    class MiniMindConfig {\n        +int hidden_size\n        +int num_hidden_layers\n        +int num_attention_heads\n        +bool use_moe\n        +int vocab_size\n    }\n\n    class MiniMindForCausalLM {\n        +MiniMindConfig config\n        +MiniMindModel model\n        +Linear lm_head\n        +forward()\n    }\n\n    %% \u57fa\u7840\u6a21\u578b\u7ed3\u6784\n    class MiniMindModel {\n        +Embedding embed_tokens\n        +ModuleList layers\n        +RMSNorm norm\n        +forward()\n    }\n\n    class MiniMindBlock {\n        +int layer_id\n        +Attention self_attn\n        +RMSNorm input_layernorm\n        +RMSNorm post_attention_layernorm\n        +Module mlp\n        +forward()\n    }\n\n    %% \u6838\u5fc3\u8ba1\u7b97\u7ec4\u4ef6\n    class Attention {\n        +Linear q_proj\n        +Linear k_proj\n        +Linear v_proj\n        +Linear o_proj\n        +apply_rotary_pos_emb()\n        +forward()\n    }\n\n    class FeedForward {\n        +Linear gate_proj\n        +Linear up_proj\n        +Linear down_proj\n        +forward()\n    }\n\n    class RMSNorm {\n        +Parameter weight\n        +forward()\n    }\n\n    %% MoE \u7ec4\u4ef6\n    class MOEFeedForward {\n        +MoEGate gate\n        +ModuleList experts\n        +ModuleList shared_experts\n        +forward()\n        +moe_infer()\n    }\n\n    class MoEGate {\n        +Linear weight\n        +forward()\n    }\n\n    %% \u5173\u7cfb\u56fe\n    MiniMindForCausalLM o-- MiniMindConfig : \u914d\u7f6e\u4f9d\u8d56\n    MiniMindForCausalLM *-- MiniMindModel : \u5305\u542b\n    MiniMindModel "1" *-- "N" MiniMindBlock : \u5806\u53e0\u5c42\n    \n    MiniMindBlock *-- Attention : \u81ea\u6ce8\u610f\u529b\n    MiniMindBlock *-- RMSNorm : \u5f52\u4e00\u5316\n    \n    %% FFN \u7684\u4e24\u79cd\u5b9e\u73b0\n    MiniMindBlock *-- FeedForward : FFN (\u5f53 use_moe=False)\n    MiniMindBlock *-- MOEFeedForward : FFN (\u5f53 use_moe=True)\n    \n    MOEFeedForward *-- MoEGate : \u8def\u7531\u95e8\u63a7\n    MOEFeedForward o-- FeedForward : \u5305\u542b\u591a\u4e2a\u4e13\u5bb6'}),"\n",(0,s.jsx)(e.h2,{id:"4-\u5173\u952e\u7ec4\u4ef6\u8bf4\u660e",children:"4. \u5173\u952e\u7ec4\u4ef6\u8bf4\u660e"}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"MiniMindConfig"}),": \u6a21\u578b\u7684\u914d\u7f6e\u4e2d\u5fc3\uff0c\u5b9a\u4e49\u4e86\u6a21\u578b\u5927\u5c0f\u3001\u5c42\u6570\u3001\u5934\u6570\u4ee5\u53ca\u662f\u5426\u5f00\u542f MoE \u7b49\u5173\u952e\u8d85\u53c2\u6570\u3002"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"MiniMindForCausalLM"}),": \u9876\u5c42\u5c01\u88c5\uff0c\u5305\u542b\u57fa\u7840 Transformer \u6a21\u578b (",(0,s.jsx)(e.code,{children:"MiniMindModel"}),") \u548c\u8bed\u8a00\u6a21\u578b\u5934 (",(0,s.jsx)(e.code,{children:"lm_head"}),")\uff0c\u7528\u4e8e\u751f\u6210\u4efb\u52a1\u3002"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"MiniMindModel"}),": \u4e0d\u542b Head \u7684\u57fa\u7840\u6a21\u578b\uff0c\u8d1f\u8d23 Token Embedding\u3001\u591a\u5c42 Decoder \u5806\u53e0\u4ee5\u53ca\u6700\u7ec8\u7684 RMSNorm\u3002"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"MiniMindBlock"}),": \u5355\u4e2a Transformer Decoder \u5c42\uff0c\u91c7\u7528 Pre-Norm \u7ed3\u6784\uff0c\u5305\u542b Self-Attention \u548c FFN/MoE\u3002"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"Attention"}),": \u652f\u6301 GQA (Grouped Query Attention) \u548c RoPE (Rotary Positional Embeddings) \u7684\u6ce8\u610f\u529b\u673a\u5236\uff0c\u5305\u542b Flash Attention \u4f18\u5316\u3002"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"FeedForward (SwiGLU)"}),": \u6807\u51c6\u7684 SwiGLU \u524d\u9988\u7f51\u7edc\uff0c\u7528\u4e8e Dense \u6a21\u5f0f\u6216\u4f5c\u4e3a MoE \u7684\u4e13\u5bb6\u5355\u5143\u3002"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"MOEFeedForward"}),": \u6df7\u5408\u4e13\u5bb6\u6a21\u5757\uff0c\u5305\u542b\u4e00\u4e2a\u95e8\u63a7\u7f51\u7edc (",(0,s.jsx)(e.code,{children:"MoEGate"}),") \u548c\u591a\u4e2a\u4e13\u5bb6\u7f51\u7edc (",(0,s.jsx)(e.code,{children:"experts"}),"/",(0,s.jsx)(e.code,{children:"shared_experts"}),")\u3002"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"MoEGate"}),": \u8def\u7531\u7f51\u7edc\uff0c\u8ba1\u7b97\u8f93\u5165 Token \u5bf9\u5404\u4e2a\u4e13\u5bb6\u7684\u6743\u91cd\uff08Top-K \u8def\u7531\uff09\u3002"]}),"\n"]}),"\n",(0,s.jsx)(e.hr,{}),"\n",(0,s.jsx)(e.h1,{id:"\u4ee3\u7801\u901a\u4fd7\u89e3\u8bfb\u6559\u5c0f\u660e\u5b66\u5199\u5c0f\u8bf4-\u7b2c\u4e00\u8bdd\u51c6\u5907\u6559\u6750",children:"\u4ee3\u7801\u901a\u4fd7\u89e3\u8bfb\uff1a\u6559\u5c0f\u660e\u5b66\u5199\u5c0f\u8bf4 (\u7b2c\u4e00\u8bdd\uff1a\u51c6\u5907\u6559\u6750)"}),"\n",(0,s.jsxs)(e.p,{children:["\u4e3a\u4e86\u8ba9\u4f60\u5f7b\u5e95\u770b\u61c2\u8fd9\u6bb5\u4ee3\u7801\uff0c\u6211\u4eec\u5c06\u8d2f\u7a7f\u4f7f\u7528\u4e00\u4e2a\u6838\u5fc3\u4f8b\u5b50\uff1a",(0,s.jsx)(e.strong,{children:"\u6559\u4e00\u4e2a\u5b8c\u5168\u4e0d\u61c2\u4e2d\u6587\u7684\u5916\u56fd\u7559\u5b66\u751f\u201c\u5c0f\u660e\u201d\uff08MiniMind\uff09\u5b66\u4e60\u5199\u4e2d\u6587\u5c0f\u8bf4\u3002"})]}),"\n",(0,s.jsx)(e.p,{children:"\u8fd9\u4e00\u8bdd\uff0c\u6211\u4eec\u5148\u8bb2\u8bb2\u600e\u4e48\u7ed9\u5c0f\u660e\u51c6\u5907\u6559\u6750\uff08\u6570\u636e\u8f7d\u5165\uff09\u3002"}),"\n",(0,s.jsx)(e.h2,{id:"1-\u4ec0\u4e48\u662f-tokenizer-\u5206\u8bcd\u5668",children:"1. \u4ec0\u4e48\u662f Tokenizer (\u5206\u8bcd\u5668)\uff1f"}),"\n",(0,s.jsxs)(e.p,{children:["\u5728\u4ee3\u7801\u91cc\uff0c\u4f60\u4f1a\u770b\u5230 ",(0,s.jsx)(e.code,{children:"tokenizer"})," \u8fd9\u4e2a\u4e1c\u897f\u3002"]}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-python",children:"# \u4ee3\u7801\u7247\u6bb5 (init_model \u51fd\u6570\u4e2d)\ntokenizer = AutoTokenizer.from_pretrained(tokenizer_path)\n"})}),"\n",(0,s.jsxs)(e.p,{children:[(0,s.jsx)(e.strong,{children:"\u901a\u4fd7\u89e3\u91ca"}),"\uff1a\n\u5c0f\u660e\u662f\u5916\u56fd\u4eba\uff0c\u4ed6\u770b\u4e0d\u61c2\u6c49\u5b57\u201c\u82f9\u679c\u201d\uff0c\u4f46\u4ed6\u80fd\u770b\u61c2\u6570\u5b57\u3002\n",(0,s.jsx)(e.strong,{children:"Tokenizer \u5c31\u662f\u4e00\u672c\u300a\u6c49\u5b57-\u6570\u5b57\u5bf9\u7167\u5b57\u5178\u300b\u3002"})]}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u5b83\u67e5\u5230\u201c\u82f9\u201d\u662f\u7b2c 1023 \u53f7\uff0c\u201c\u679c\u201d\u662f\u7b2c 45 \u53f7\u3002"}),"\n",(0,s.jsxs)(e.li,{children:["\u6240\u4ee5\uff0c\u5f53\u4f60\u7ed9\u5c0f\u660e\u770b\u201c\u82f9\u679c\u201d\u65f6\uff0c\u5176\u5b9e\u662f\u585e\u7ed9\u4ed6\u4e00\u5f20\u7eb8\u6761\uff0c\u4e0a\u9762\u5199\u7740 ",(0,s.jsx)(e.code,{children:"[1023, 45]"}),"\u3002"]}),"\n"]}),"\n",(0,s.jsx)(e.hr,{}),"\n",(0,s.jsxs)(e.h2,{id:"2-\u5236\u4f5c\u7ec3\u4e60\u518cpretraindataset",children:["2. \u5236\u4f5c\u7ec3\u4e60\u518c\uff1a",(0,s.jsx)(e.code,{children:"PretrainDataset"})]}),"\n",(0,s.jsxs)(e.p,{children:["\u5149\u6709\u5b57\u5178\u4e0d\u884c\uff0c\u8fd8\u5f97\u6709\u8bfe\u672c\u3002",(0,s.jsx)(e.code,{children:"PretrainDataset"})," \u5c31\u662f\u8d1f\u8d23\u628a\u4e71\u4e03\u516b\u7cdf\u7684\u5c0f\u8bf4\u6587\u672c\uff0c\u6574\u7406\u6210\u5c0f\u660e\u80fd\u505a\u7684",(0,s.jsx)(e.strong,{children:"\u7ec3\u4e60\u9898"}),"\u3002"]}),"\n",(0,s.jsx)(e.h3,{id:"\u539f\u59cb\u4ee3\u7801",children:"\u539f\u59cb\u4ee3\u7801"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-python",children:"class PretrainDataset(Dataset):\n    def __init__(self, data_path, tokenizer, max_length=512):\n        super().__init__()\n        self.tokenizer = tokenizer\n        self.max_length = max_length\n        # 1. \u52a0\u8f7d\u6240\u6709\u7684\u6587\u672c\u6570\u636e (\u6bd4\u5982\u51e0\u5343\u672c\u5c0f\u8bf4)\n        self.samples = load_dataset('json', data_files=data_path, split='train')\n\n    def __len__(self):\n        return len(self.samples)\n\n    def __getitem__(self, index):\n        sample = self.samples[index]\n        # 2. \u628a\u6587\u5b57\u53d8\u6210\u6570\u5b57 (\u67e5\u5b57\u5178)\n        # padding='max_length': \u4e0d\u591f\u957f\u5c31\u88650\n        # truncation=True: \u592a\u957f\u4e86\u5c31\u5494\u5693\u526a\u6389\n        encoding = self.tokenizer(\n            str(sample['text']),\n            max_length=self.max_length,\n            padding='max_length',\n            truncation=True,\n            return_tensors='pt'\n        )\n        input_ids = encoding.input_ids.squeeze()\n        labels = input_ids.clone()\n        # 3. \u628a\u88650\u7684\u5730\u65b9\u6807\u8bb0\u4e3a -100 (\u4e0d\u7528\u8003)\n        labels[input_ids == self.tokenizer.pad_token_id] = -100\n        return input_ids, labels\n"})}),"\n",(0,s.jsx)(e.h3,{id:"\u901a\u4fd7\u89e3\u91ca",children:"\u901a\u4fd7\u89e3\u91ca"}),"\n",(0,s.jsxs)(e.p,{children:[(0,s.jsx)(e.strong,{children:"\u573a\u666f"}),"\uff1a\u4f60\u8981\u7ed9\u5c0f\u660e\u51fa\u586b\u7a7a\u9898\u3002"]}),"\n",(0,s.jsxs)(e.ol,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsxs)(e.strong,{children:[(0,s.jsx)(e.code,{children:"load_dataset"})," (\u4e70\u4e66)"]}),"\uff1a\u4f60\u53bb\u4e66\u5e97\u4e70\u4e86\u4e00\u5806\u5c0f\u8bf4\u56de\u6765\uff0c\u6bd4\u5982\u300a\u897f\u6e38\u8bb0\u300b\u3001\u300a\u7ea2\u697c\u68a6\u300b\u3002"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsxs)(e.strong,{children:[(0,s.jsx)(e.code,{children:"__getitem__"})," (\u51fa\u9898)"]}),"\uff1a","\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:"\u62bd\u4e00\u7bc7"}),"\uff1a\u4f60\u968f\u624b\u62ff\u8d77\u4e00\u672c\u300a\u897f\u6e38\u8bb0\u300b\u7684\u67d0\u4e00\u7ae0\u3002"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsxs)(e.strong,{children:[(0,s.jsx)(e.code,{children:"self.tokenizer"})," (\u7ffb\u8bd1)"]}),"\uff1a\u628a\u8fd9\u4e00\u7ae0\u7684\u6c49\u5b57\u5168\u90e8\u67e5\u5b57\u5178\u53d8\u6210\u6570\u5b57\u3002"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsxs)(e.strong,{children:[(0,s.jsx)(e.code,{children:"max_length=512"})," & ",(0,s.jsx)(e.code,{children:"truncation"})," (\u526a\u88c1)"]}),"\uff1a\u5c0f\u660e\u7684\u684c\u5b50\u53ea\u6709 512 \u683c\u90a3\u4e48\u5927\u3002\u5982\u679c\u8fd9\u7ae0\u6709 1000 \u5b57\uff0c\u591a\u51fa\u6765\u7684\u5494\u5693\u526a\u6389\uff1b\u5982\u679c\u53ea\u6709 100 \u5b57\uff0c\u540e\u9762\u7559\u7a7a\u3002"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsxs)(e.strong,{children:[(0,s.jsx)(e.code,{children:"padding"})," (\u8865\u5168)"]}),"\uff1a\u5bf9\u4e8e\u4e0d\u591f\u957f\u7684\u6587\u7ae0\uff0c\u540e\u9762\u7684\u683c\u5b50\u586b\u4e0a ",(0,s.jsx)(e.code,{children:"0"})," (\u4ee3\u8868\u7a7a\u767d)\u3002"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsxs)(e.strong,{children:[(0,s.jsx)(e.code,{children:"labels"})," (\u6807\u51c6\u7b54\u6848)"]}),"\uff1a","\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u5c0f\u660e\u7684\u4efb\u52a1\u662f\uff1a\u770b\u7740\u73b0\u5728\u7684\u5b57\uff0c\u731c\u4e0b\u4e00\u4e2a\u5b57\u3002"}),"\n",(0,s.jsxs)(e.li,{children:["\u6240\u4ee5",(0,s.jsx)(e.strong,{children:"\u9898\u76ee"}),"\u662f\u6574\u7bc7\u6587\u7ae0\uff0c",(0,s.jsx)(e.strong,{children:"\u7b54\u6848"}),"\u4e5f\u662f\u6574\u7bc7\u6587\u7ae0\uff08\u7a0d\u5fae\u9519\u4f4d\u4e00\u4e0b\uff0c\u6a21\u578b\u5185\u90e8\u4f1a\u81ea\u52a8\u5904\u7406\u8fd9\u4e2a\u9519\u4f4d\uff09\u3002"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsxs)(e.strong,{children:[(0,s.jsx)(e.code,{children:"-100"})," \u662f\u4ec0\u4e48\uff1f"]})," \u5bf9\u4e8e\u90a3\u4e9b\u8865\u5168\u7684 ",(0,s.jsx)(e.code,{children:"0"})," (\u7a7a\u767d\u683c)\uff0c\u8001\u5e08\u4e0d\u9700\u8981\u5c0f\u660e\u53bb\u731c\uff0c\u6240\u4ee5\u628a\u7b54\u6848\u6807\u8bb0\u4e3a ",(0,s.jsx)(e.code,{children:"-100"}),"\uff0c\u610f\u601d\u662f\u201c\u8fd9\u9898\u4e0d\u7b97\u5206\uff0c\u4e0d\u7528\u505a\u201d\u3002"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(e.hr,{}),"\n",(0,s.jsxs)(e.h2,{id:"3-\u65ad\u70b9\u7eed\u5b66skipbatchsampler",children:["3. \u65ad\u70b9\u7eed\u5b66\uff1a",(0,s.jsx)(e.code,{children:"SkipBatchSampler"})]}),"\n",(0,s.jsx)(e.p,{children:"\u5982\u679c\u5c0f\u660e\u5b66\u5230\u4e00\u534a\u505c\u7535\u4e86\uff0c\u7b2c\u4e8c\u5929\u600e\u4e48\u63a5\u7740\u5b66\uff1f"}),"\n",(0,s.jsx)(e.h3,{id:"\u539f\u59cb\u4ee3\u7801-1",children:"\u539f\u59cb\u4ee3\u7801"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-python",children:"class SkipBatchSampler(Sampler):\n    def __init__(self, sampler, batch_size, skip_batches=0):\n        self.sampler = sampler\n        self.batch_size = batch_size\n        self.skip_batches = skip_batches # \u4e4b\u524d\u5b66\u8fc7\u591a\u5c11\u6346\n\n    def __iter__(self):\n        batch = []\n        skipped = 0\n        for idx in self.sampler:\n            batch.append(idx)\n            if len(batch) == self.batch_size:\n                # \u5982\u679c\u8fd9\u6346\u662f\u4e4b\u524d\u5b66\u8fc7\u7684\uff0c\u76f4\u63a5\u6254\u6389\n                if skipped < self.skip_batches:\n                    skipped += 1\n                    batch = []\n                    continue\n                yield batch # \u6ca1\u5b66\u8fc7\u7684\uff0c\u62ff\u53bb\u7ed9\u5c0f\u660e\n                batch = []\n        # ...\n"})}),"\n",(0,s.jsx)(e.h3,{id:"\u901a\u4fd7\u89e3\u91ca-1",children:"\u901a\u4fd7\u89e3\u91ca"}),"\n",(0,s.jsxs)(e.p,{children:[(0,s.jsx)(e.strong,{children:"\u573a\u666f"}),"\uff1a"]}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:"\u6628\u5929\u5c0f\u660e\u5df2\u7ecf\u5b66\u4e86 100 \u6346\u7ec3\u4e60\u9898\u3002"}),"\n",(0,s.jsx)(e.li,{children:"\u4eca\u5929\u91cd\u65b0\u5f00\u59cb\u4e0a\u8bfe\uff0c\u4f60\u4e0d\u60f3\u8ba9\u4ed6\u4ece\u7b2c 1 \u6346\u5f00\u59cb\u91cd\u505a\u3002"}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.strong,{children:(0,s.jsx)(e.code,{children:"SkipBatchSampler"})})," \u5c31\u662f\u4e00\u4e2a",(0,s.jsx)(e.strong,{children:"\u8bb0\u6027\u597d\u7684\u52a9\u6559"}),"\u3002\u4ed6\u4f1a\u6570\u6570\uff1a\u201c\u7b2c 1 \u6346...\u5b66\u8fc7\u4e86\uff0c\u6254\u6389\uff1b\u7b2c 2 \u6346...\u5b66\u8fc7\u4e86\uff0c\u6254\u6389... \u7b2c 101 \u6346\uff01\u597d\u7684\uff0c\u8fd9\u4e2a\u6ca1\u5b66\u8fc7\uff0c\u5c0f\u660e\u7ed9\u4f60\uff01\u201d"]}),"\n"]}),"\n",(0,s.jsx)(e.hr,{}),"\n",(0,s.jsxs)(e.h2,{id:"4-\u53d1\u5377\u5b50dataloader",children:["4. \u53d1\u5377\u5b50\uff1a",(0,s.jsx)(e.code,{children:"DataLoader"})]}),"\n",(0,s.jsx)(e.p,{children:"\u6700\u540e\uff0c\u600e\u4e48\u628a\u8fd9\u4e9b\u9898\u76ee\u53d1\u7ed9\u5c0f\u660e\uff1f"}),"\n",(0,s.jsx)(e.h3,{id:"\u539f\u59cb\u4ee3\u7801-2",children:"\u539f\u59cb\u4ee3\u7801"}),"\n",(0,s.jsx)(e.pre,{children:(0,s.jsx)(e.code,{className:"language-python",children:"# \u4e3b\u7a0b\u5e8f\u4e2d\u7684\u4ee3\u7801\nloader = DataLoader(\n    train_ds, \n    batch_size=batch_size, \n    shuffle=(train_sampler is None),\n    num_workers=num_workers, \n    pin_memory=True\n)\n"})}),"\n",(0,s.jsx)(e.h3,{id:"\u901a\u4fd7\u89e3\u91ca-2",children:"\u901a\u4fd7\u89e3\u91ca"}),"\n",(0,s.jsxs)(e.p,{children:[(0,s.jsx)(e.strong,{children:"\u573a\u666f"}),"\uff1a"]}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsxs)(e.strong,{children:[(0,s.jsx)(e.code,{children:"batch_size=32"})," (\u6279\u91cf)"]}),"\uff1a\u4f60\u89c9\u5f97\u5c0f\u660e\u5982\u679c\u4e00\u5f20\u4e00\u5f20\u505a\u9898\u592a\u6162\u4e86\u3002\u4e8e\u662f\u4f60\u89c4\u5b9a\uff1a",(0,s.jsx)(e.strong,{children:"\u4e00\u6b21\u53d1 32 \u5f20\u5377\u5b50"}),"\u3002\u5c0f\u660e\u53ef\u4ee5\u540c\u65f6\u626b\u89c6\u8fd9 32 \u5f20\u5377\u5b50\uff0c\u5229\u7528\u4ed6\u7684\u201c\u5e76\u884c\u5927\u8111\u201d\uff08GPU\uff09\u4e00\u8d77\u601d\u8003\u3002\u8fd9\u6837\u6548\u7387\u9ad8\u5f88\u591a\u3002"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsxs)(e.strong,{children:[(0,s.jsx)(e.code,{children:"shuffle=True"})," (\u6d17\u724c)"]}),"\uff1a\u4e3a\u4e86\u9632\u6b62\u5c0f\u660e\u6b7b\u8bb0\u786c\u80cc\uff08\u6bd4\u5982\u8bb0\u4f4f\u7b2c\u4e00\u9898\u7b54\u6848\u6c38\u8fdc\u662fA\uff09\uff0c\u4f60\u6bcf\u6b21\u53d1\u5377\u5b50\u524d\u90fd\u628a\u987a\u5e8f",(0,s.jsx)(e.strong,{children:"\u6253\u4e71"}),"\u3002"]}),"\n",(0,s.jsxs)(e.li,{children:[(0,s.jsxs)(e.strong,{children:[(0,s.jsx)(e.code,{children:"num_workers=8"})," (\u52a9\u6559\u56e2)"]}),"\uff1a\u4f60\u81ea\u5df1\u4e00\u4e2a\u4eba\u4ece\u4e66\u67b6\u4e0a\u62ff\u4e66\u3001\u7ffb\u8bd1\u3001\u526a\u88c1\u592a\u6162\u4e86\uff0c\u8ddf\u4e0d\u4e0a\u5c0f\u660e\u505a\u9898\u7684\u901f\u5ea6\u3002\u6240\u4ee5\u4f60\u96c7\u4e86 ",(0,s.jsx)(e.strong,{children:"8 \u4e2a\u52a9\u6559"}),"\uff0c\u4ed6\u4eec\u5728\u540e\u53f0\u62fc\u547d\u5730\u51c6\u5907\u5377\u5b50\uff0c\u6574\u7406\u597d\u4e00\u6346\u4e00\u6346\u5730\u9012\u7ed9\u4f60\uff0c\u786e\u4fdd\u5c0f\u660e\u7684\u624b\u6c38\u8fdc\u4e0d\u95f2\u7740\u3002"]}),"\n"]}),"\n",(0,s.jsx)(e.hr,{}),"\n",(0,s.jsxs)(e.p,{children:[(0,s.jsx)(e.strong,{children:"\u4e0b\u96c6\u9884\u544a"}),"\uff1a\n\u6559\u6750\u51c6\u5907\u597d\u4e86\uff0c\u5c0f\u660e\u600e\u4e48\u5f00\u59cb\u52a8\u8111\u5b50\u505a\u9898\uff1f\u4ec0\u4e48\u662f\u201c\u6ce8\u610f\u529b\u201d\uff1f\u8bf7\u770b\u4e0b\u4e00\u8bdd\uff1a",(0,s.jsx)(e.strong,{children:"\u6a21\u578b\u67b6\u6784\u7bc7"}),"\u3002"]})]})}function h(n={}){const{wrapper:e}={...(0,d.R)(),...n.components};return e?(0,s.jsx)(e,{...n,children:(0,s.jsx)(c,{...n})}):c(n)}}}]);