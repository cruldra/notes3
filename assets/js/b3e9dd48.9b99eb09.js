"use strict";(self.webpackChunknotes_3=self.webpackChunknotes_3||[]).push([[5808],{54213:(e,n,l)=>{l.d(n,{R:()=>d,x:()=>i});var s=l(36672);const r={},c=s.createContext(r);function d(e){const n=s.useContext(c);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:d(e.components),s.createElement(c.Provider,{value:n},e.children)}},75074:(e,n,l)=>{l.r(n),l.d(n,{assets:()=>t,contentTitle:()=>i,default:()=>x,frontMatter:()=>d,metadata:()=>s,toc:()=>o});const s=JSON.parse('{"id":"AI/Pytorch/\u5206\u5e03\u5f0f\u8bad\u7ec3/\u793a\u4f8b1","title":"\u793a\u4f8b1","description":"\u6267\u884c\u6d41\u7a0b","source":"@site/docs/AI/Pytorch/\u5206\u5e03\u5f0f\u8bad\u7ec3/\u793a\u4f8b1.md","sourceDirName":"AI/Pytorch/\u5206\u5e03\u5f0f\u8bad\u7ec3","slug":"/AI/Pytorch/\u5206\u5e03\u5f0f\u8bad\u7ec3/\u793a\u4f8b1","permalink":"/notes3/docs/AI/Pytorch/\u5206\u5e03\u5f0f\u8bad\u7ec3/\u793a\u4f8b1","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/AI/Pytorch/\u5206\u5e03\u5f0f\u8bad\u7ec3/\u793a\u4f8b1.md","tags":[],"version":"current","frontMatter":{},"sidebar":"ai","previous":{"title":"PyTorch \u5206\u5e03\u5f0f\u901a\u4fe1\u539f\u8bed\u4e0e\u5e38\u7528 API \u8be6\u89e3","permalink":"/notes3/docs/AI/Pytorch/\u5206\u5e03\u5f0f\u8bad\u7ec3/torch_distributed_api"},"next":{"title":"\u4ec0\u4e48\u662f\u201cGPU \u52a0\u901f\u5f20\u91cf\u8ba1\u7b97\u201d\uff1f","permalink":"/notes3/docs/AI/Pytorch/\u53c2\u8003/1"}}');var r=l(23420),c=l(54213);const d={},i=void 0,t={},o=[{value:"\u6267\u884c\u6d41\u7a0b",id:"\u6267\u884c\u6d41\u7a0b",level:3},{value:"\u4ee3\u7801\u89e3\u91ca",id:"\u4ee3\u7801\u89e3\u91ca",level:3},{value:"1. \u68c0\u67e5\u662f\u5426\u4e3a\u5206\u5e03\u5f0f\u73af\u5883",id:"1-\u68c0\u67e5\u662f\u5426\u4e3a\u5206\u5e03\u5f0f\u73af\u5883",level:4},{value:"2. \u521d\u59cb\u5316\u8fdb\u7a0b\u7ec4",id:"2-\u521d\u59cb\u5316\u8fdb\u7a0b\u7ec4",level:4},{value:"3. \u83b7\u53d6 Local Rank \u5e76\u7ed1\u5b9a\u8bbe\u5907",id:"3-\u83b7\u53d6-local-rank-\u5e76\u7ed1\u5b9a\u8bbe\u5907",level:4},{value:"4. \u8fd4\u56de\u8bbe\u5907 ID",id:"4-\u8fd4\u56de\u8bbe\u5907-id",level:4},{value:"\u8865\u5145\uff1a\u5173\u4e8e RANK \u548c LOCAL_RANK",id:"\u8865\u5145\u5173\u4e8e-rank-\u548c-local_rank",level:3},{value:"1. RANK \u4e0e LOCAL_RANK \u7684\u533a\u522b",id:"1-rank-\u4e0e-local_rank-\u7684\u533a\u522b",level:4},{value:"2. \u4e3e\u4f8b\u8bf4\u660e\uff08\u591a\u673a\u591a\u5361\uff09",id:"2-\u4e3e\u4f8b\u8bf4\u660e\u591a\u673a\u591a\u5361",level:4}];function h(e){const n={blockquote:"blockquote",code:"code",h3:"h3",h4:"h4",li:"li",mermaid:"mermaid",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,c.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'\ndef init_distributed_mode():\n    if int(os.environ.get("RANK", -1)) == -1:\n        return 0  # \u975eDDP\u6a21\u5f0f\n\n    dist.init_process_group(backend="nccl")\n    local_rank = int(os.environ["LOCAL_RANK"])\n    torch.cuda.set_device(local_rank)\n    return local_rank\n\n'})}),"\n",(0,r.jsx)(n.h3,{id:"\u6267\u884c\u6d41\u7a0b",children:"\u6267\u884c\u6d41\u7a0b"}),"\n",(0,r.jsx)(n.mermaid,{value:"graph TD\n    A([Start: init_distributed_mode]) --\x3e B{\u68c0\u67e5\u73af\u5883\u53d8\u91cf RANK<br>os.environ.get 'RANK'}\n    B -- \u4e0d\u5b58\u5728 / -1 --\x3e C[\u975e DDP \u6a21\u5f0f<br>\u5355\u673a\u5355\u5361]\n    C --\x3e D[\u8fd4\u56de 0]\n    \n    B -- \u5b58\u5728 --\x3e E[DDP \u5206\u5e03\u5f0f\u6a21\u5f0f]\n    E --\x3e F[\u521d\u59cb\u5316\u8fdb\u7a0b\u7ec4<br>dist.init_process_group backend='nccl']\n    F --\x3e G[\u83b7\u53d6 LOCAL_RANK<br>os.environ 'LOCAL_RANK']\n    G --\x3e H[\u7ed1\u5b9a\u5f53\u524d\u8fdb\u7a0b\u5230\u6307\u5b9a GPU<br>torch.cuda.set_device]\n    H --\x3e I[\u8fd4\u56de local_rank]\n    \n    D --\x3e J([End])\n    I --\x3e J"}),"\n",(0,r.jsx)(n.h3,{id:"\u4ee3\u7801\u89e3\u91ca",children:"\u4ee3\u7801\u89e3\u91ca"}),"\n",(0,r.jsx)(n.p,{children:"\u8fd9\u6bb5\u4ee3\u7801\u7528\u4e8e\u521d\u59cb\u5316 PyTorch \u5206\u5e03\u5f0f\u8bad\u7ec3\u73af\u5883\uff08DDP - DistributedDataParallel\uff09\u3002"}),"\n",(0,r.jsx)(n.h4,{id:"1-\u68c0\u67e5\u662f\u5426\u4e3a\u5206\u5e03\u5f0f\u73af\u5883",children:"1. \u68c0\u67e5\u662f\u5426\u4e3a\u5206\u5e03\u5f0f\u73af\u5883"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'if int(os.environ.get("RANK", -1)) == -1:\n    return 0  # \u975eDDP\u6a21\u5f0f\n'})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.code,{children:'os.environ.get("RANK", -1)'})}),": \u5c1d\u8bd5\u83b7\u53d6\u73af\u5883\u53d8\u91cf ",(0,r.jsx)(n.code,{children:"RANK"}),"\u3002"]}),"\n",(0,r.jsx)(n.li,{children:"\u5982\u679c\u83b7\u53d6\u4e0d\u5230\uff0c\u8bf4\u660e\u5f53\u524d\u672a\u901a\u8fc7\u5206\u5e03\u5f0f\u542f\u52a8\u5668\u8fd0\u884c\uff0c\u76f4\u63a5\u8fd4\u56de 0\uff08\u9ed8\u8ba4\u4e3a\u5355\u5361\u6a21\u5f0f\uff09\u3002"}),"\n"]}),"\n",(0,r.jsx)(n.h4,{id:"2-\u521d\u59cb\u5316\u8fdb\u7a0b\u7ec4",children:"2. \u521d\u59cb\u5316\u8fdb\u7a0b\u7ec4"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'dist.init_process_group(backend="nccl")\n'})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.code,{children:"dist.init_process_group"})}),": \u542f\u7528\u5206\u5e03\u5f0f\u901a\u4fe1\u7684\u6838\u5fc3\u6b65\u9aa4\u3002"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.code,{children:'backend="nccl"'})}),": \u6307\u5b9a\u901a\u4fe1\u540e\u7aef\u3002",(0,r.jsx)(n.code,{children:"nccl"})," (NVIDIA Collective Communications Library) \u662f NVIDIA GPU \u5206\u5e03\u5f0f\u8bad\u7ec3\u63a8\u8350\u7684\u540e\u7aef\uff0c\u6027\u80fd\u6700\u4f73\u3002"]}),"\n"]}),"\n",(0,r.jsx)(n.h4,{id:"3-\u83b7\u53d6-local-rank-\u5e76\u7ed1\u5b9a\u8bbe\u5907",children:"3. \u83b7\u53d6 Local Rank \u5e76\u7ed1\u5b9a\u8bbe\u5907"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'local_rank = int(os.environ["LOCAL_RANK"])\ntorch.cuda.set_device(local_rank)\n'})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.code,{children:"LOCAL_RANK"})}),": \u8868\u793a\u5f53\u524d\u8fdb\u7a0b\u5728**\u5f53\u524d\u7269\u7406\u8282\u70b9\uff08\u673a\u5668\uff09**\u4e0a\u7684\u5e8f\u53f7\u3002"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:(0,r.jsx)(n.code,{children:"torch.cuda.set_device(local_rank)"})}),": ",(0,r.jsx)(n.strong,{children:"\u5173\u952e\u6b65\u9aa4"}),"\u3002\u5c06\u5f53\u524d\u8fdb\u7a0b\u7ed1\u5b9a\u5230\u5bf9\u5e94\u7684 GPU \u4e0a\uff0c\u9632\u6b62\u6240\u6709\u8fdb\u7a0b\u4e89\u62a2\u9ed8\u8ba4\u7684 0 \u53f7\u663e\u5361\u3002"]}),"\n"]}),"\n",(0,r.jsx)(n.h4,{id:"4-\u8fd4\u56de\u8bbe\u5907-id",children:"4. \u8fd4\u56de\u8bbe\u5907 ID"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"return local_rank\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\u8fd4\u56de ",(0,r.jsx)(n.code,{children:"local_rank"})," \u4f9b\u540e\u7eed\u4ee3\u7801\u4f7f\u7528\u3002"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"\u8865\u5145\u5173\u4e8e-rank-\u548c-local_rank",children:"\u8865\u5145\uff1a\u5173\u4e8e RANK \u548c LOCAL_RANK"}),"\n",(0,r.jsxs)(n.p,{children:["\u8fd9\u4e24\u4e2a\u73af\u5883\u53d8\u91cf\u901a\u5e38",(0,r.jsx)(n.strong,{children:"\u4e0d\u662f\u7531\u5f00\u53d1\u8005\u624b\u52a8\u8bbe\u7f6e\u7684"}),"\uff0c\u800c\u662f\u7531 ",(0,r.jsx)(n.strong,{children:"PyTorch \u7684\u5206\u5e03\u5f0f\u542f\u52a8\u5de5\u5177"}),"\uff08\u5982 ",(0,r.jsx)(n.code,{children:"torchrun"}),"\uff09\u5728\u542f\u52a8\u65f6\u81ea\u52a8\u6ce8\u5165\u5230\u6bcf\u4e2a\u5b50\u8fdb\u7a0b\u4e2d\u7684\u3002"]}),"\n",(0,r.jsx)(n.h4,{id:"1-rank-\u4e0e-local_rank-\u7684\u533a\u522b",children:"1. RANK \u4e0e LOCAL_RANK \u7684\u533a\u522b"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{style:{textAlign:"left"},children:"\u53d8\u91cf\u540d"}),(0,r.jsx)(n.th,{style:{textAlign:"left"},children:"\u5b9a\u4e49"}),(0,r.jsx)(n.th,{style:{textAlign:"left"},children:"\u4f5c\u7528"}),(0,r.jsx)(n.th,{style:{textAlign:"left"},children:"\u53d6\u503c\u8303\u56f4"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{style:{textAlign:"left"},children:(0,r.jsx)(n.strong,{children:"RANK"})}),(0,r.jsx)(n.td,{style:{textAlign:"left"},children:(0,r.jsx)(n.strong,{children:"\u5168\u5c40\u8fdb\u7a0b ID"})}),(0,r.jsx)(n.td,{style:{textAlign:"left"},children:"\u6574\u4e2a\u5206\u5e03\u5f0f\u4efb\u52a1\u4e2d\u552f\u4e00\u7684\u8eab\u4efd\u6807\u8bc6\u3002\u7528\u4e8e\u8fdb\u7a0b\u95f4\u901a\u4fe1\uff08\u5982 AllReduce\uff09\u3002"}),(0,r.jsxs)(n.td,{style:{textAlign:"left"},children:[(0,r.jsx)(n.code,{children:"0"})," \u5230 ",(0,r.jsx)(n.code,{children:"WORLD_SIZE - 1"})]})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{style:{textAlign:"left"},children:(0,r.jsx)(n.strong,{children:"LOCAL_RANK"})}),(0,r.jsx)(n.td,{style:{textAlign:"left"},children:(0,r.jsx)(n.strong,{children:"\u672c\u5730\u8fdb\u7a0b ID"})}),(0,r.jsxs)(n.td,{style:{textAlign:"left"},children:["\u5f53\u524d\u7269\u7406\u673a\u5668\uff08Node\uff09\u4e0a\u7684\u8fdb\u7a0b\u5e8f\u53f7\u3002\u7528\u4e8e",(0,r.jsx)(n.strong,{children:"\u9009\u62e9 GPU \u8bbe\u5907"}),"\u3002"]}),(0,r.jsxs)(n.td,{style:{textAlign:"left"},children:[(0,r.jsx)(n.code,{children:"0"})," \u5230 ",(0,r.jsx)(n.code,{children:"NPROC_PER_NODE - 1"})]})]})]})]}),"\n",(0,r.jsx)(n.h4,{id:"2-\u4e3e\u4f8b\u8bf4\u660e\u591a\u673a\u591a\u5361",children:"2. \u4e3e\u4f8b\u8bf4\u660e\uff08\u591a\u673a\u591a\u5361\uff09"}),"\n",(0,r.jsxs)(n.p,{children:["\u5047\u8bbe\u4f60\u8fdb\u884c",(0,r.jsx)(n.strong,{children:"\u53cc\u673a\u8bad\u7ec3"}),"\uff0c\u6bcf\u53f0\u673a\u5668\u6709 ",(0,r.jsx)(n.strong,{children:"4 \u5f20\u663e\u5361"}),"\uff08\u603b\u5171 8 \u5f20\u5361\uff0c8 \u4e2a\u8fdb\u7a0b\uff09\u3002"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"\u673a\u5668 A (Node 0)"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\u663e\u5361 0: ",(0,r.jsx)(n.code,{children:"RANK=0"}),", ",(0,r.jsx)(n.code,{children:"LOCAL_RANK=0"})]}),"\n",(0,r.jsxs)(n.li,{children:["\u663e\u5361 1: ",(0,r.jsx)(n.code,{children:"RANK=1"}),", ",(0,r.jsx)(n.code,{children:"LOCAL_RANK=1"})]}),"\n",(0,r.jsxs)(n.li,{children:["\u663e\u5361 2: ",(0,r.jsx)(n.code,{children:"RANK=2"}),", ",(0,r.jsx)(n.code,{children:"LOCAL_RANK=2"})]}),"\n",(0,r.jsxs)(n.li,{children:["\u663e\u5361 3: ",(0,r.jsx)(n.code,{children:"RANK=3"}),", ",(0,r.jsx)(n.code,{children:"LOCAL_RANK=3"})]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"\u673a\u5668 B (Node 1)"}),":"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\u663e\u5361 0: ",(0,r.jsx)(n.code,{children:"RANK=4"}),", ",(0,r.jsx)(n.code,{children:"LOCAL_RANK=0"}),"  \u2190 ",(0,r.jsx)(n.strong,{children:"\u6ce8\u610f\uff1aLOCAL_RANK \u91cd\u65b0\u4ece 0 \u5f00\u59cb"})]}),"\n",(0,r.jsxs)(n.li,{children:["\u663e\u5361 1: ",(0,r.jsx)(n.code,{children:"RANK=5"}),", ",(0,r.jsx)(n.code,{children:"LOCAL_RANK=1"})]}),"\n",(0,r.jsxs)(n.li,{children:["\u663e\u5361 2: ",(0,r.jsx)(n.code,{children:"RANK=6"}),", ",(0,r.jsx)(n.code,{children:"LOCAL_RANK=2"})]}),"\n",(0,r.jsxs)(n.li,{children:["\u663e\u5361 3: ",(0,r.jsx)(n.code,{children:"RANK=7"}),", ",(0,r.jsx)(n.code,{children:"LOCAL_RANK=3"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsx)(n.p,{children:(0,r.jsxs)(n.strong,{children:["\u4e3a\u4ec0\u4e48\u4ee3\u7801\u4e2d\u4f7f\u7528 ",(0,r.jsx)(n.code,{children:"LOCAL_RANK"})," \u6765\u8bbe\u7f6e\u8bbe\u5907\uff1f"]})}),"\n",(0,r.jsxs)(n.p,{children:["\u5728\u673a\u5668 B \u4e0a\uff0c\u867d\u7136\u5168\u5c40 ",(0,r.jsx)(n.code,{children:"RANK"})," \u662f 4\uff0c\u4f46\u8fd9\u53f0\u673a\u5668\u4e0a\u53ea\u6709 ID \u4e3a 0, 1, 2, 3 \u7684\u7269\u7406\u663e\u5361\u3002\u5982\u679c\u4f7f\u7528 ",(0,r.jsx)(n.code,{children:"RANK"})," (4) \u53bb\u8c03\u7528 ",(0,r.jsx)(n.code,{children:"torch.cuda.set_device(4)"}),"\uff0c\u4f1a\u56e0\u4e3a\u627e\u4e0d\u5230\u7b2c 4 \u53f7\u663e\u5361\u800c\u62a5\u9519\u3002\u56e0\u6b64\u5fc5\u987b\u4f7f\u7528 ",(0,r.jsx)(n.code,{children:"LOCAL_RANK"})," (0) \u6765\u7ed1\u5b9a\u5230\u673a\u5668 B \u7684\u7b2c 1 \u5f20\u5361\u3002"]}),"\n"]})]})}function x(e={}){const{wrapper:n}={...(0,c.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(h,{...e})}):h(e)}}}]);